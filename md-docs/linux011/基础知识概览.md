
# 基础知识概览

本文为前五章的内容摘要, 由于笔者水平有限, 对硬件设备也并不熟悉, 所以仅作一个基础知识层面的概述

第一章主要介绍了一下 Linux 的一些历史故事, 有关 Unix Minix Linux GNU POSIX 等等的一些故事, 读者感兴趣的话可以自己阅读一下, 除此之外笔者之前有做过一期相关的视频, 读者也可参考

> [【技术杂谈】Unix 到 GNU/Linux的操作系统历史](https://www.bilibili.com/video/BV1Mv4y127wA/)

## 微型计算机组成结构

一个传统微型计算机硬件组成结构如下图所示

![20230619140525](https://raw.githubusercontent.com/learner-lu/picbed/master/20230619140525.png)

CPU 通过地址线、数据线和控制信号线组成的本地总线（或称为内部总线）与系统其他部分进行数据通信。

- 地址线用于提供内存或I/O设备的地址，即指明需要读/写数据的具体位置。
- 数据线用于在 CPU 和内存或 I/O 设备之间提供数据传输的通道，
- 控制线用于指挥执行的具体读/写操作

对于 80386 CPU 的PC机, 其内部地址线和数据线都分别有 32 根，即都是 32 位的。因此地址寻址空间范围有 2^32 字节，从 0 到 4GB. 对于现代的计算机则都是 64 位系统, 64 位总线(地址总线/数据总线, 控制总线的位数可以因系统设计和需求而异。它们可能会比数据总线和地址总线少得多，通常在几位到数十位之间).

> 一般我们常说的64位&32位机器中位数是由CPU决定的。这个位数指的是CPU GPRs(General-Purpose Registers，通用寄存器)的数据宽度为64位，64位指令集就是运行64位数据的指令，也就是说处理器一次可以运行64bit数据。64位平台不管是在性能上，还是在功能上，都要领先于目前的32位平台，目前主流的32位处理器在性能执行模式方面存在一个严重的缺陷：当面临大量的数据流时，32位的寄存器和指令集不能及时进行相应的处理运算。32位处理器一次只能处理32位，也就是4个字节的数据；而64位处理器一次就能处理64位，即8个字节的数据。如果将总长128位的指令分别按16位、32位、64位为单位进行编辑的话：32位的处理器需要4个指令，而64位处理器则只要两个指令。显然，在工作频率相同的情况下，64位处理器的处理速度比32位的更快。配备 64 位处理器的计算机可以安装 64 位或 32 位版本的操作系统。但是，对于 32 位操作系统，64 位处理器无法发挥其全部功能
> 
> 除了运算能力之外，与32位处理器相比，64位处理器的优势还体现在系统对内存的控制上。由于地址使用的是特殊的整数，而64位处理器的一个ALU（算术逻辑运算器）和寄存器可以处理更大的整数，也就是更大的地址。传统32位处理器的寻址空间最大为4GB，而64位的处理器在理论上则可以达到1800万个TB（1TB=1024GB）。
>
> 要存取数据或指令就要知道数据或指令存放的位置，地址寄存器存储的就是CPU当前要存取的数据或指令的地址，该地址是由地址总线传输到地址寄存器上的。假设地址总线有n位，即共有n位二进制位来表示地址，那么最多可以表示2^n个地址，另外，由于计算机以一个字节为寻址单位，所以CPU的寻址能力或者说最大寻址范围为2^n个字节。综上，地址总线的位数决定了CPU的寻址能力。
> 
> 字长指CPU同一时间内可以处理的二进制数的位数，**数据总线传输的数据或指令的位数要与字长一致**。否则，如果数据总线宽度大于字长则一条数据或指令要分多次传输，则分开传输的几组数据也就没有意义了；如果数据总线宽度小于字长，则CPU的利用率要降低，对资源是种浪费。**如果字长为n位，一般称CPU是n位的。所以说数据总线的宽度与字长及CPU的位数是一致的。**

图中上部控制器和存储器接口通常都集成在计算机主板上，这些控制器分别都是以一块大规模集成电路芯片为主组成的功能电路. 图中下方的控制卡（或者称为适配器）则是通过扩展插槽与主板上系统总线连接。总线插槽是系统地址总线、数据总线和控制线的与扩展设备控制器的标准连接接口。这些总线接口标准通常有

- 工业标准结构 ISA（Industry Standard Architecture）总线
- 扩展工业标准结构总线 EISA（Extented ISA）
- 外围组件互连 PCI（Peripheral Component Interconnect）总线
- 加速图形端口 AGP（Accelerated Graphics Port）视频总线

这些总线接口的主要区别在于数据传输速率和控制灵活性方面, 随着计算机硬件的发展，传输速率更高、控制更灵活的总线接口还在不断推出，例如采用串行通信点对点技术的高速 PCIE（PCI Express）总线。

再后来随着计算机技术的发展，很多原来使用控制卡来完成的功能（例如硬盘控制器功能）**都已经集成在计算机主机板上少数几个超大规模集成电路芯片中**，几个甚至是一个这样的芯片就确定了主机板的主要特性和功能

因此为了让系统的不同部分都能达到其最高传输速率，总线结构也发生了很大变化. 下图是现代 PC 机的组成结构

![20230619144745](https://raw.githubusercontent.com/learner-lu/picbed/master/20230619144745.png)

除了 CPU 以外，现代 PC 机主板主要使用 2 个超大规模芯片构成的芯片组或芯片集（Chipsets）组成：**北桥（Northbridge）芯片**和**南桥（Southbridge）芯片**。

- 北桥芯片用于与 CPU、内存和 AGP 视频接口交互，这些接口具有很高的传输速率。北桥芯片还起着存储器控制作用，因此Intel 把该芯片标号为 MCH（Memory Controller Hub）芯片。
- 南桥芯片用来管理低、中速的组件，例如，PCI 总线、IDE 硬盘接口、USB 端口等，因此南桥芯片的名称为 ICH（I/O Controller Hub）。

> 之所以用“南、北”桥来分别统称这两个芯片，是由于在 Intel 公司公布的典型 PC 机主板上，它们分别位于主版的下端和上端（即地图上的南部和北部）位置，并起着与 CPU 进行通道桥接的作用。

所以大体上说：北桥负责与CPU通信，并且连接高速设备（内存/显卡），并且与南桥通信；南桥负责与低速设备（硬盘/USB）通信，时钟/BIOS/系统管理/旧式设备控制，并且与北桥通信.

再后来 Intel从第一代Core i7 (i7 9xx)开始，**将原属于北桥功能的内存控制器整合到CPU当中**; AMD平台的发展轨迹类似，在K8架构（第一代AMD64处理器）开始就把内存控制器集成到CPU内部，后来先是APU再是桌面的FX系列，陆陆续续把PCI-e控制器也整合到CPU中, 所以现在已经看不到北桥芯片只剩下南桥芯片了, 甚至今后南桥芯片也可能会被合并进去也未可知...

## 端口和寻址

CPU 为了访问 I/O 接口控制器或控制卡上的数据和状态信息，需要首先指定它们的地址。这种地址就称为 **I/O 端口地址或者简称端口**。端口地址的设置方法一般有两种：**统一编址**和**独立编址**

对于CPU而言，如果它要发数据到某个设备，其实是发到对应的接口，访问设备实际上是访问相关的端口，所有的信息会由接口转给它的设备。那么CPU会准备数据到数据总线，但是诸多接口，该发给谁呢？**这时就须要为各接口分配一个地址，然后把地址放在地址总线上，需要的控制信息放到控制总线上，就可以和设备通信了**

对一个系统而言，通常会有多个外设，每个外设的接口电路中，又会有多个端口，每个端口都需要一个地址，CPU 需要为它们标识一个具体的地址值，与此同时，内存条有 8GB/16GB 的内存单元, 每一个地址也都需要分配一个标识值，另外，很多外设有自己的内存、缓冲区，就像你的内存条一样，你同样需要为它们分配内存……你的CPU可能需要和它们的每一个字节都打交道

- 统一编址

  外设接口中的IO寄存器（即IO端口）与主存单元一样看待，每个端口占用一个存储单元的地址，将主存的一部分划出来用作IO地址空间. 即内存和外设的编址放到一起来规划，被外设用了的地址就不能给内存了

  优点: 可以利用存储器的寻址方式来寻址I/O端口。

  缺点: I/O端口占用了存储空间，而且进行I/O操作时，因地址编码较长，将导致速度较慢。

- 独立编址

  IO地址与存储地址分开独立编址，I/O端口地址不占用存储空间的地址范围. 独立编址下，地址总线上过来一个地址，设备不知道是给IO端口的、还是给存储器的，于是处理器通过 `MEMR/MEMW` 和 `IOR/IOW` 两组控制信号来实现对I/O端口和存储器的不同寻址

  优点: 不占用内存空间；使用I／O指令，程序清晰，很容易看出是I／O操作还是存储器操作；译码电路比较简单(因为I/O端口的地址空间一般较小，所用地址线也就较少)

  缺点: 只能用专门的I/O指令，访问端口的方法不如访问存储器的方法多。

对于某一既定的系统，它要么是独立编址、要么是统一编址，具体采用哪种则取决于CPU的体系结构。Intel 80x86就采用单独编址，CPU内存和I/O是一起编址的，就是说内存一部分的地址和I/O地址是重叠的。对于x86架构来说，通过IN/OUT指令访问. Samsung的S3C2440，是32位ARM处理器，它的4GB地址空间被外设、RAM等瓜分

> 不过Intel x86平台普通使用了名为内存映射(MMIO)的技术，该技术是PCI规范的一部分，IO设备端口被映射到内存空间，映射后，CPU访问IO端口就如同访问内存一样

![20230619224508](https://raw.githubusercontent.com/learner-lu/picbed/master/20230619224508.png)

> 除此之外可以使用 cat /proc/ioports 来查看 x86_64 独立编址的地址范围

PC 机 I/O 接口数据传输控制方式一般可采用程序循环查询方式、中断处理方式和 DMA 传输方式

- 循环查询方式是指 CPU 通过在程序中循环查询指定设备控制器中的状态来判断是否可以与设备进行数据交换。这种方式不需要过多硬件支持，使用和编程都比较简单，**但是特别耗费 CPU 宝贵时间**。因此在多任务操作系统中除非等待时间极短或必须，否则就不应该使用这种方式。在 Linux 操作系统中，只有在设备或控制器能够立刻返回信息时才会在很少的几个地方采用这种方式
- 中断处理控制方式需要有中断控制器的支持。在这种控制方式下，只有当 I/O 设备通过中断向 CPU 提出处理请求时，CPU 才会暂时中断当前执行的程序转而去执行相应的 I/O 中断处理服务过程。当执行完该中断处理服务过程后，CPU 又会继续执行刚才被中断的程序。在 I/O 控制器或设备发出中断请求时，CPU通过使用**中断向量表**（或中断描述符表）来寻址相应的中断处理服务过程的入口地址。因此采用中断控制方式时需要首先设置好中断向量表，并编制好相应的中断处理服务过程。**Linux 操作系统中大多数设备 I/O控制都采用中断处理方式。**
- 直接存储器访问 DMA（Direct Memory Access）方式用于 I/O 设备与系统内存之间进行批量数据传送，**整个操作过程需要使用专门的 DMA 控制器来进行而无需 CPU 插手**。由于在传输过程中无须软件介入，因此操作效率很高。在 Linux 操作系统中，软盘驱动程序使用中断和 DMA 方式配合来实现数据的传输工作

## 存储器

典型 PC 机上通常含有三种类型的存储器，一种是用来运行程序和临时保存数据的内存存储器，一种是存放着系统开机诊断和初始化硬件程序的 ROM，另一种是用来存放存计算机实时时钟信息和系统硬件配置信息的少量 CMOS 存储器。

1981 年 IBM PC 机刚推出时系统只带有 640KB 的 RAM 主存储器（简称内存）。由于所采用的 8088/8086 CPU 只有 20 根地址线，因此内存寻址范围最高为 1024KB（1MB）。在当时 DOS 操作系统流行年代，640K 或 1MB 内存容量基本上能满足普通应用程序的运行。随着计算机软件和硬件技术的高速发展，目前的计算机通常都配置有 512MB 或者更多的物理内存容量，并且都采用 Intel 32 位 CPU，即都是 PC/AT 计算机。因此 CPU 的物理内存寻址范围已经高达 4GB（通过采用 CPU 的新特性，系统甚至可以寻址 64GB 的物理内存容量）。**但是为了与原来的 PC 机在软件上兼容，系统 1MB 以下物理内存使用分配上仍然保持与原来的 PC 机基本一致**

![20230625173321](https://raw.githubusercontent.com/learner-lu/picbed/master/20230625173321.png)

## 

## 参考

- [64位CPU和数据/地址总线的关系](https://www.cnblogs.com/doggod/p/13403622.html)
- [Difference between 32-bit and 64-bit operating systems](https://www.geeksforgeeks.org/difference-32-bit-64-bit-operating-systems/)
- [主板上的南北桥是什么东西](https://www.zhihu.com/question/66881178/answer/246813653)
- [理解“统一编址与独立编址、I/O端口与I/O内存”](https://www.cnblogs.com/armlinux/archive/2010/11/26/2396888.html)