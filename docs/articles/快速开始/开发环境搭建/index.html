<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/tree.css /><link rel='stylesheet' href=../../../css/txt.css /><link rel='stylesheet' href=../../../css/x86asm.css /><link rel='stylesheet' href=../../../css/yaml.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">开发环境搭建</a><ul><li><a href="#h2-1">Ubuntu 云镜像</a></li></ul><ul><li><a href="#h2-2">启动镜像</a></li></ul><ul><li><a href="#h2-3">基本环境配置</a><ul><li><a href="#h3-4">磁盘扩容</a></li></ul><ul><li><a href="#h3-5">磁盘挂载</a></li></ul><ul><li><a href="#h3-6">磁盘安装内核模块</a></li></ul></li></ul><ul><li><a href="#h2-7">网络配置</a><ul><li><a href="#h3-8">网卡驱动</a></li></ul><ul><li><a href="#h3-9">User 模式</a></li></ul><ul><li><a href="#h3-10">tap 模式</a></li></ul></li></ul><ul><li><a href="#h2-11">磁盘扩容</a></li></ul><ul><li><a href="#h2-12">Ubuntu iso 安装</a></li></ul><ul><li><a href="#h2-13">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">开发环境搭建</h1><p>在<a href="../../快速开始/调试内核" target="_self">调试内核</a>一节中我们使用 initramfs + bzImage 构建了一个基础的 linux kernel 调试环境, 但是目前的所有操作都只会保存在 initramfs 中, 目前可用的软件很少, 没有编译器, 没有联网, 没有 apt 包管理工具, 不能持久化存储</p><p>本文介绍如何使用 qemu 模拟更加复杂的环境, 以及如何利用现有的 Linux 发行版根文件系统(比如说 Ubuntu 的基础软件包)来搭建一个可用的 linux 开发环境, 并且使用自己编译的内核启动</p><h2 id="h2-1">Ubuntu 云镜像</h2><p>手动构建软件包环境是十分繁琐的, 读者感兴趣的话可以了解一下 <a href="https://lfs.xry111.site/zh_CN/12.4-systemd/" target="_blank">linux from scratch</a> 项目，lfs 介绍的非常完善，您可以从软件代码开始一点一点编译得到一个真正的可以使用的 linux 发行版。这非常有趣！</p><p>本文介绍一种比较简单直接的方式，即利用现有的 Linux 发行版提供的系统映像安装, 这里以 Ubuntu 为例。Ubuntu 提供了已经构建好的云镜像 <a href="https://cloud-images.ubuntu.com/" target="_blank">ubuntu cloud-images</a>。</p><p>这个网址有很多目录，按照不同的 ubuntu 版本名区分，这里读者可以自行选择希望使用的版本，笔者这里选用一个较为稳定且年轻的版本 ubuntu22.04(jammy)</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20251031141024.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20251031141024.png" alt="20251031141024" class="pic-big"></a></p><p>点进去之后可以看到很多日期，ubuntu 云镜像的构建是比较频繁的，基本上隔几天就会自动构建一次。这里随便选一个新的即可。里面可以看到不同架构(amd64/arm64/riscv64)等，对应后面有介绍说明，我们下载 .img 镜像。它是一个 <b>QCow2 UEFI/GPT Bootable disk image</b>，也就是说我们可以直接通过 qemu 启动这个镜像。</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20251031141335.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20251031141335.png" alt="20251031141335" class="pic-big"></a></p><p>同理我们可以在 minimal 目录下的 release/jammy 下载一个最小化的镜像（290M），<b>本文后续会使用这个镜像作为演示完成基础配置</b>，基础配置大同小异，并无很大差别，读者可以放心阅读。</p><pre class="language-shell"><code><span class="Token ID">wget</span><span class="Token SPACE"> </span><span class="Token Url ID">https://cloud-images.ubuntu.com/minimal/releases/jammy/release-20251001/ubuntu-22.04-minimal-cloudimg-amd64.img</span></code></pre><blockquote style="border-left-color: #1a7f37; background-color: #e5f6ea;"><div style="color: #1a7f37;"><img class="icon-tip" loading="lazy" src="../../../img/tip.svg" alt="[!TIP]"> TIP </div><p> 直接使用 wget 下载速度可能有点慢，国内下载可以使用清华源 <a href="https://mirrors.tuna.tsinghua.edu.cn/" target="_blank">tuna mirrors</a>，mirror 中搜索 ubuntu 选择 <a href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cloud-images/" target="_blank">ubuntu-cloud-images</a> 即可，它的目录结构和 ubuntu 官方源是一样的</p></blockquote><h2 id="h2-2">启动镜像</h2><p>前文<a href="../../快速开始/调试内核" target="_self">调试内核</a>中介绍了一个使用 initramfs 启动调试内核的 Makefile，但是现在有了一个完整的 linux 发行版镜像我们就不再需要自己构建的 initramfs 了，我们将 Makefile 更新如下。其中 IMG 修改为你的镜像名即可</p><pre class="language-makefile"><code><span class="Token Mission ID">.PHONY</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">init</span><span class="Token SPACE"> </span><span class="Token ID">qemu</span><span class="Token SPACE"> </span><span class="Token ID">clean</span><span class="Token SPACE"> </span><span class="Token ID">debug</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Variable ID">KERNEL</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token ID">bzImage</span><span class="Token LF">
</span><span class="Token Variable ID">QEMU</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token ID">qemu-system-x86_64</span><span class="Token LF">
</span><span class="Token Variable ID">IMG</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token ID">jammy-minimal-cloudimg-amd64.img</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Mission ID">disk</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">QEMU</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-enable-kvm</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">KERNEL</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">qcow2</span><span class="Token COMMA">,</span><span class="Token ID">file</span><span class="Token ASSIGN">=</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">IMG</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token STRING">&quot;root=/dev/sda1 console=ttyS0&quot;</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token OPTION">-no-reboot</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">guest_errors</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Mission ID">debug</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">QEMU</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-enable-kvm</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">KERNEL</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">qcow2</span><span class="Token COMMA">,</span><span class="Token ID">file</span><span class="Token ASSIGN">=</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">IMG</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token STRING">&quot;root=/dev/sda1 console=ttyS0&quot;</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token OPTION">-no-reboot</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">guest_errors</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-S</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span></code></pre><p>接着可以启动 qemu 了，这里我们使用了 -enable-kvm 进行加速（如果kvm需要sudo那就加上）</p><blockquote style="border-left-color: #1a7f37; background-color: #e5f6ea;"><div style="color: #1a7f37;"><img class="icon-tip" loading="lazy" src="../../../img/tip.svg" alt="[!TIP]"> TIP </div><p> 启动镜像会发现内核日志正常启动，然后 systemd 启动各种服务 ok，然后在一个地方卡了许久 &quot;A-start-job-is-running-for-wait-for-network-to-be-configured-ubuntu-server&quot; 这是因为当前的宿主机没有联网</p></blockquote><blockquote style="border-left-color: #9a6700; background-color: #fff4dd;"><div style="color: #9a6700;"><img class="icon-warning" loading="lazy" src="../../../img/warning.svg" alt="[!WARNING]"> WARNING </div><p> 如果启动失败了，那么先看一下内核的报错日志能否解决，大概率是因为缺少了相关的内核模块，因为部分内核模块是在核外编译的，需要把它们安装到内核 /lib/modules/ 下面之后才可以完成装载。可以先跳过此步完成后面的磁盘扩容/挂载/安装内核模块之后再次尝试启动。或者删除掉 --kernel 和 --append 参数采用镜像默认的内核启动</p></blockquote><p>之后进入了登录页面，要求我们输入用户名和密码</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20251030235213.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20251030235213.png" alt="20251030235213" class="pic-big"></a></p><p>这时你会发现怎么输入都不对，因为这个镜像并没有配置默认的密码，我们需要使用 <code>virt-customize</code> 来为镜像初始化密码，首先安装 virt-customize 所属的软件包</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">guestfs-tools</span></code></pre><p>使用 virt-customize 为当前镜像重新设置 root 密码，然后就可以通过 root + 密码登陆了</p><pre class="language-shell"><code><span class="Token ID">virt-customize</span><span class="Token SPACE"> </span><span class="Token OPTION">-a</span><span class="Token SPACE"> </span><span class="Token ID">jammy-minimal-cloudimg-amd64.img</span><span class="Token SPACE"> </span><span class="Token OPTION">--root-password</span><span class="Token SPACE"> </span><span class="Token ID">password:</span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">your-passwd</span><span class="Token REDIRECT_TO">&gt;</span></code></pre><blockquote style="border-left-color: #0969da; background-color: #e8f3ff;"><div style="color: #0969da;"><img class="icon-note" loading="lazy" src="../../../img/note.svg" alt="[!NOTE]"> NOTE </div><p> virt-customize 是一个处理磁盘镜像很好用的工具，除了修改密码它还有很多有趣的功能（包括拷贝删除文件，安装软件包等等）。它本质是使用了 supermin + libguestfs，在一个微型虚拟机（appliance VM）中挂载磁盘并修改</p></blockquote><blockquote style="border-left-color: #9a6700; background-color: #fff4dd;"><div style="color: #9a6700;"><img class="icon-warning" loading="lazy" src="../../../img/warning.svg" alt="[!WARNING]"> WARNING </div><p> virt-customize 在 WSL 中不生效，因为 WSL 不能支持 libguestfs，你可以把镜像拷贝到一个真实的 ubuntu 服务器上操作完成再回到 wsl</p></blockquote><p>如果读者使用 df 查看当前存储系统可以发现这个系统竟然有 2GB 的磁盘空间？但是明明我下载的 img 没有这么大啊？</p><pre class="language-shell"><code><span class="Token HOST_NAME">root@ubuntu</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">#</span><span class="Token SPACE"> </span><span class="Token ID">df</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token LF">
</span><span class="Token ID">Filesystem</span><span class="Token SPACE">      </span><span class="Token ID">Size</span><span class="Token SPACE">  </span><span class="Token ID">Used</span><span class="Token SPACE"> </span><span class="Token ID">Avail</span><span class="Token SPACE"> </span><span class="Token ID">Use</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token ID">Mounted</span><span class="Token SPACE"> </span><span class="Token ID">on</span><span class="Token LF">
</span><span class="Token DIV">/</span><span class="Token ID">dev/root</span><span class="Token SPACE">       </span><span class="Token NUMBER">2.0G</span><span class="Token SPACE">  </span><span class="Token NUMBER">860M</span><span class="Token SPACE">  </span><span class="Token NUMBER">1.2G</span><span class="Token SPACE">  </span><span class="Token NUMBER">44</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">           </span><span class="Token NUMBER">2.0G</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2.0G</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/shm</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">           </span><span class="Token NUMBER">787M</span><span class="Token SPACE">  </span><span class="Token NUMBER">420K</span><span class="Token SPACE">  </span><span class="Token NUMBER">786M</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">           </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">  </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run/lock</span><span class="Token LF">
</span><span class="Token DIV">/</span><span class="Token ID">dev/sda15</span><span class="Token SPACE">      </span><span class="Token NUMBER">105M</span><span class="Token SPACE">  </span><span class="Token NUMBER">6.1M</span><span class="Token SPACE">   </span><span class="Token NUMBER">99M</span><span class="Token SPACE">   </span><span class="Token NUMBER">6</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">boot/efi</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">           </span><span class="Token NUMBER">394M</span><span class="Token SPACE">  </span><span class="Token NUMBER">4.0K</span><span class="Token SPACE">  </span><span class="Token NUMBER">394M</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run/user/0</span></code></pre><p>这是因为 .img 是 QCOW2，这种格式是<b>稀疏，按需分配</b>的。宿主机上看到的 319M 是已经分配的数据量，虚拟机内部看到的 2.2G 是“虚拟磁盘的逻辑大小 (virtual size)”</p><pre class="language-shell"><code><span class="Token DOLLAR">$</span><span class="Token SPACE"> </span><span class="Token ID">qemu-img</span><span class="Token SPACE"> </span><span class="Token ID">info</span><span class="Token SPACE"> </span><span class="Token ID">jammy-minimal-cloudimg-amd64.img</span><span class="Token LF">
</span><span class="Token ID">image:</span><span class="Token SPACE"> </span><span class="Token ID">jammy-minimal-cloudimg-amd64.img</span><span class="Token LF">
</span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format:</span><span class="Token SPACE"> </span><span class="Token ID">qcow2</span><span class="Token LF">
</span><span class="Token ID">virtual</span><span class="Token SPACE"> </span><span class="Token ID">size:</span><span class="Token SPACE"> </span><span class="Token NUMBER">2.2</span><span class="Token SPACE"> </span><span class="Token ID">GiB</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token NUMBER">2361393152</span><span class="Token SPACE"> </span><span class="Token ID">bytes</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token ID">disk</span><span class="Token SPACE"> </span><span class="Token ID">size:</span><span class="Token SPACE"> </span><span class="Token NUMBER">318</span><span class="Token SPACE"> </span><span class="Token ID">MiB</span><span class="Token LF">
</span><span class="Token ID">cluster_size:</span><span class="Token SPACE"> </span><span class="Token NUMBER">65536</span><span class="Token LF">
</span><span class="Token ID">Format</span><span class="Token SPACE"> </span><span class="Token ID">specific</span><span class="Token SPACE"> </span><span class="Token ID">information:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">compat:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0.10</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">compression</span><span class="Token SPACE"> </span><span class="Token ID">type:</span><span class="Token SPACE"> </span><span class="Token ID">zlib</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">refcount</span><span class="Token SPACE"> </span><span class="Token ID">bits:</span><span class="Token SPACE"> </span><span class="Token NUMBER">16</span><span class="Token LF">
</span><span class="Token ID">Child</span><span class="Token SPACE"> </span><span class="Token ID">node</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token DIV">/</span><span class="Token ID">file</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">filename:</span><span class="Token SPACE"> </span><span class="Token ID">jammy-minimal-cloudimg-amd64.img</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">protocol</span><span class="Token SPACE"> </span><span class="Token ID">type:</span><span class="Token SPACE"> </span><span class="Token ID">file</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">length:</span><span class="Token SPACE"> </span><span class="Token NUMBER">318</span><span class="Token SPACE"> </span><span class="Token ID">MiB</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token NUMBER">333774848</span><span class="Token SPACE"> </span><span class="Token ID">bytes</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">disk</span><span class="Token SPACE"> </span><span class="Token ID">size:</span><span class="Token SPACE"> </span><span class="Token NUMBER">318</span><span class="Token SPACE"> </span><span class="Token ID">MiB</span></code></pre><h2 id="h2-3">基本环境配置</h2><p>初始下载的镜像是一个 minimal 的镜像，还并不能像一个成熟的发行版一样使用，下面我们依次解决磁盘和网络的配置问题</p><h3 id="h3-4">磁盘扩容</h3><p>初始磁盘容量一般不大，联网之后稍微下载几个文件就满了。为磁盘扩容非常简单，使用 <code>qemu-img</code> 为当前镜像 +8GB 磁盘容量</p><pre class="language-shell"><code><span class="Token ID">qemu-img</span><span class="Token SPACE"> </span><span class="Token ID">resize</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">img</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token NUMBER">8G</span><span class="Token LF">
</span><span class="Token COMMENT"># 直接 resize 到 10G</span><span class="Token LF">
</span><span class="Token ID">qemu-img</span><span class="Token SPACE"> </span><span class="Token ID">resize</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">img</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token NUMBER">10G</span></code></pre><p>但是进入虚拟机之后 df -h 虽然可以看到 /dev/sda 变大了，但是显示的磁盘容量还是 2.2GB？</p><p>上文 qemu-img info 的信息我们可以看到，一个<b>虚拟磁盘</b>（qcow2/raw）实际上是一个<b>容器</b>，里面包含：</p><ol start="1"><li>分区表（MBR 或 GPT）</li></ol><ol start="2"><li>分区（比如 /dev/sda1）</li></ol><ol start="3"><li>分区内部的文件系统（ext4/xfs/btrfs 等）</li></ol><p>而 qemu-img resize <b>只改了虚拟磁盘大小</b>，没有改分区表、文件系统。所以当前的容器状态可以理解为 2.2GB 之后加了一段 free 的空闲磁盘，但是并没有划分分区也没有创建文件系统</p><pre class="language-txt"><code><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token ID">qcow2</span><span class="Token SPACE"> </span><span class="Token ID">image</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token ID">sda1</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token NUMBER">2.2G</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token ID">free</span><span class="Token SPACE"> </span><span class="Token NUMBER">8G</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token PIPE">|</span></code></pre><p>此时需要在虚拟机内部执行</p><pre class="language-shell"><code><span class="Token ID">growpart</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/sda</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token ID">resize2fs</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/sda1</span></code></pre><p>其中第一步 growpart 用于修改分区表，让 /dev/sda1 从 2.2GB 到占满整个磁盘</p><pre class="language-txt"><code><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token ID">qcow2</span><span class="Token SPACE"> </span><span class="Token ID">image</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token ID">sda1</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token NUMBER">2.2G</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token ID">free</span><span class="Token SPACE"> </span><span class="Token NUMBER">8G</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token PIPE">|</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token DOLLAR">$</span><span class="Token SPACE"> </span><span class="Token ID">growpart</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev</span><span class="Token DIV">/</span><span class="Token ID">sda</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token ID">sda1</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token NUMBER">10.2G</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token PIPE">|</span></code></pre><p>growpart 扩大了 sda 分区，但是此时 free 磁盘部分还没有被文件系统使用，所以我们需要 resize2fs /dev/sda1 来扩展文件系统的元数据和数据区，让文件系统（一般来说是ext4）真正使用新的空间</p><blockquote><p>文件系统需要初始化磁盘划分 inode/data block 之后才能正常存储数据，并不是直接拿来空磁盘就可以直接使用的，详见<a href="../../fs/disk-layout" target="_self">文件系统磁盘布局</a></p></blockquote><blockquote style="border-left-color: #0969da; background-color: #e8f3ff;"><div style="color: #0969da;"><img class="icon-note" loading="lazy" src="../../../img/note.svg" alt="[!NOTE]"> NOTE </div><p> 简单总结一下，磁盘扩容需要三步</p><pre class="language-shell"><code><span class="Token ID">qemu-img</span><span class="Token SPACE"> </span><span class="Token ID">resize</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">img</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token NUMBER">8G</span><span class="Token LF">
</span><span class="Token ID">growpart</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/sda</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token ID">resize2fs</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/sda1</span></code></pre><ul><li>qemu-img resize 扩大的是“虚拟磁盘容器”</li></ul><ul><li>growpart 扩大的是“分区”</li></ul><ul><li>resize2fs 扩大的是“文件系统”</li></ul><p>多块磁盘或者多个分区只需要调整 /dev/xxx 即可</p></blockquote><h3 id="h3-5">磁盘挂载</h3><p>有时候我们希望添加一些在磁盘镜像中添加一些内容, 比如希望把本机上面的文件拷贝到虚拟机中，一种可用的方式当然是通过网络(ftp/scp)，另一种更简单性能更好的方式就是挂载磁盘镜像然后直接复制过去。</p><p>要把 <b>QCOW2 磁盘镜像挂载到本地</b>（像挂载普通目录一样访问）很简单，最常用、最稳定的方法是 使用 <b>qemu-nbd</b>。这是官方推荐方式，不需要转换格式，也不需要复制磁盘。</p><ul><li>步骤 1：加载 nbd 模块<pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">modprobe</span><span class="Token SPACE"> </span><span class="Token ID">nbd</span><span class="Token SPACE"> </span><span class="Token ID">max_part</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">8</span></code></pre></li></ul><ul><li>步骤 2：将 qcow2 镜像绑定到 /dev/nbd0<pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">qemu-nbd</span><span class="Token SPACE"> </span><span class="Token OPTION">--connect</span><span class="Token ASSIGN">=</span><span class="Token DIV">/</span><span class="Token ID">dev/nbd0</span><span class="Token SPACE"> </span><span class="Token ID">your.qcow2</span></code></pre><p>此时我们可以查看分区信息</p><pre class="language-shell"><code><span class="Token DOLLAR">$</span><span class="Token SPACE"> </span><span class="Token ID">lsblk</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/nbd0</span><span class="Token LF">
</span><span class="Token ID">nbd0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8G</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token ID">nbd0p1</span><span class="Token SPACE"> </span><span class="Token NUMBER">1G</span><span class="Token LF">
</span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token ID">nbd0p2</span><span class="Token SPACE"> </span><span class="Token NUMBER">7G</span></code></pre></li></ul><ul><li>步骤 3：挂载分区<pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">mount</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/nbd0p1</span><span class="Token SPACE"> </span><span class="Token ID">mnt/</span></code></pre></li></ul><ul><li>卸载<pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">umount</span><span class="Token SPACE"> </span><span class="Token ID">mnt</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">qemu-nbd</span><span class="Token SPACE"> </span><span class="Token OPTION">--disconnect</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/nbd0</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">rmmod</span><span class="Token SPACE"> </span><span class="Token ID">nbd</span></code></pre></li></ul><p>另一种方式是使用 guestmount</p><pre class="language-shell"><code><span class="Token COMMENT"># 安装</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">libguestfs-tools</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># 挂载</span><span class="Token LF">
</span><span class="Token ID">guestmount</span><span class="Token SPACE"> </span><span class="Token OPTION">-a</span><span class="Token SPACE"> </span><span class="Token ID">your.qcow2</span><span class="Token SPACE"> </span><span class="Token OPTION">-i</span><span class="Token SPACE"> </span><span class="Token ID">my_mnt</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># 卸载</span><span class="Token LF">
</span><span class="Token ID">guestunmount</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">mnt</span></code></pre><blockquote style="border-left-color: #1a7f37; background-color: #e5f6ea;"><div style="color: #1a7f37;"><img class="icon-tip" loading="lazy" src="../../../img/tip.svg" alt="[!TIP]"> TIP </div><p> 虽然看上去好像 guestmount 步骤少了很多，但是你用一下就会发现拷贝文件等操作非常慢，因为 guestmount 本质上是 libguestfs + FUSE 文件系统，libguestfs 内部会运行一个轻量化 QEMU，FUSE 有多次用户态/内核态切换，以及 guestmount 默认的安全模式（甚至root用户都不能cp，只能调用guestmount的普通用户才有权限）都会拉低性能</p><p>所以建议使用 qemu-nbd 的方式</p></blockquote><p>如果磁盘并不是 qcow2 格式，例如读者使用了一个 raw 格式的磁盘安装 iso 得到的镜像，那么需要先查看一下该磁盘的分区，因为安装 ubuntu 的话默认第一个分区是 /boot 的分区不能直接挂载</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">fdisk</span><span class="Token SPACE"> </span><span class="Token OPTION">-l</span><span class="Token SPACE"> </span><span class="Token ID">ubuntu.raw</span></code></pre><p>此时发现该磁盘有两个分区, 第二个分区为根分区, 所以应该跳过第一个分区, 找到对应的偏移量开始挂载</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240613182359.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240613182359.png" alt="20240613182359" class="pic-big"></a></p><p>偏移量计算为 (4095 + 1) * 512 = 2097152，每个扇区 512 字节，需要跳过前面 4095 个扇区，第 4096 个扇区是对应的根分区起始地址</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">loop</span><span class="Token COMMA">,</span><span class="Token ID">offset</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">2097152</span><span class="Token SPACE"> </span><span class="Token ID">ubuntu.raw</span><span class="Token SPACE"> </span><span class="Token ID">tmp</span></code></pre><blockquote><p>关于挂载的更多内容详见<a href="../../fs/mount" target="_self">mount</a></p></blockquote><h3 id="h3-6">磁盘安装内核模块</h3><p>内核中有一些组件并不是直接编译进内核的, 绝大部分内核模块都是核外编译保存的，它们可以在合适的时机装载进内核，在内核启动之后也会加载一些内核模块。</p><p>我们在之前的 Makefile 中使用了 --kernel 参数传递了自己编译的内核，如果使用 uname -r 查看应该是 6.6.0+ 版本</p><pre class="language-shell"><code><span class="Token HOST_NAME">root@ubuntu</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">#</span><span class="Token SPACE"> </span><span class="Token ID">uname</span><span class="Token SPACE"> </span><span class="Token OPTION">-r</span><span class="Token LF">
</span><span class="Token NUMBER">6.6</span><span class="Token ID">.0+</span></code></pre><p>默认所有内核模块都会被安装到 /lib/modules/$(uname -r) 下，这个目录下目前只有一个 <code>5.15.0-1088-kvm</code>，它是这个镜像默认使用的内核</p><p>首先挂载镜像，然后在内核的源码库下执行</p><pre class="language-shell"><code><span class="Token ID">make</span><span class="Token SPACE"> </span><span class="Token ID">modules_install</span><span class="Token SPACE"> </span><span class="Token ID">INSTALL_MOD_PATH</span><span class="Token ASSIGN">=</span><span class="Token DIV">/</span><span class="Token ID">path/to/mnt</span></code></pre><p>将 modules 目录下的格式如下, kernel 目录下是所有的内核模块，build 目录是一个指向源码目录的软链接，如果要在虚拟机内编译对应的内核模块可以考虑将内核源码树拷贝进去。当然也可以选择在外侧编译然后把编译好的模块拷贝进去。本系列文章选择使用在外侧编译，内核模块编译方法详见<a href="../../快速开始/内核模块编译" target="_self">内核模块编译</a></p><pre class="language-tree"><code><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">lib</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">modules</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">6.6.0+</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token File Link ID">build</span><span class="Token SPACE"> </span><span class="Token POINT">-&gt;</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token File ID">home/kamilu/klinux</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">kernel</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">drivers</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">net</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">ethernet</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">intel</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token File ID">e1000</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">thermal</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token File ID">intel</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">fs</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token File ID">efivarfs</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">net</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Dir ID">ipv4</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token File ID">netfilter</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token File ID">netfilter</span></code></pre><p>将该目录 copy 到磁盘镜像的 /lib/modules 下即可</p><p>进去之后发现终端没有彩色输出, 修改 .bashrc, 找一个 ubuntu 默认的 .bashrc 拷贝过来 <a href="https://gist.github.com/marioBonales/1637696" target="_blank">github gist</a></p><pre class="language-shell"><code><span class="Token Keyword EXPORT">export</span><span class="Token SPACE"> </span><span class="Token ID">TERM</span><span class="Token ASSIGN">=</span><span class="Token ID">xterm-256color</span></code></pre><p>这一步我们选择一个比较老的 <a href="http://archive.ubuntu.com/ubuntu/dists/bionic-updates/main/installer-amd64/current/images/netboot/mini.iso" target="_blank">Ubuntu 18.04 mini.iso</a>, 只有 70MB 大小, 其余软件是从网络上下载的</p><p>这个版本的镜像没有安装 openssh, 需要先安装</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">net-tools</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt-get</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">openssh-client</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt-get</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">openssh-server</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">etc/init.d/ssh</span><span class="Token SPACE"> </span><span class="Token ID">restart</span></code></pre><p>最后检查一下防火墙是不是关闭了</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">ufw</span><span class="Token SPACE"> </span><span class="Token ID">status</span><span class="Token LF">
</span><span class="Token COMMENT"># inactive 表示关闭</span></code></pre><p>接下来就可以使用 ssh 从外部连接了</p><h2 id="h2-7">网络配置</h2><p>qemu 的网络配置比较复杂, 可以做很多模式的连接, 这里简单介绍一下最基础的联网配置, 至少可以用 apt 下载软件包了</p><h3 id="h3-8">网卡驱动</h3><p>大部分情况我们需要使用自己编译的内核, 在编译内核的时候选择 E1000 网卡驱动</p><pre class="language-txt"><code><span class="Token MINUS">-</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Device</span><span class="Token SPACE"> </span><span class="Token ID">Drivers</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token MINUS">-</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Network</span><span class="Token SPACE"> </span><span class="Token ID">device</span><span class="Token SPACE"> </span><span class="Token ID">support</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">NETDEVICES</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">      </span><span class="Token MINUS">-</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Ethernet</span><span class="Token SPACE"> </span><span class="Token ID">driver</span><span class="Token SPACE"> </span><span class="Token ID">support</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">ETHERNET</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">         </span><span class="Token MINUS">-</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Intel</span><span class="Token SPACE"> </span><span class="Token ID">devices</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">NET_VENDOR_INTEL</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token MINUS">-</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Intel</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">R</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token ID">PRO</span><span class="Token DIV">/</span><span class="Token NUMBER">1000</span><span class="Token SPACE"> </span><span class="Token ID">Gigabit</span><span class="Token SPACE"> </span><span class="Token ID">Ethernet</span><span class="Token SPACE"> </span><span class="Token ID">support</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">E1000</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 RPAREN">)</span></code></pre><p>也可以作为模块编译, 不过建议编译进内核比较省事</p><h3 id="h3-9">User 模式</h3><p>启动 qemu 时添加如下参数</p><pre class="language-shell"><code><span class="Token ID">qemu-system-x86_64</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">home/kamilu/klinux/arch/x86/boot/bzImage</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">raw</span><span class="Token COMMA">,</span><span class="Token ID">file</span><span class="Token ASSIGN">=</span><span class="Token ID">disk/ubuntu.raw</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;root=/dev/sda2 console=ttyS0&quot;</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token OPTION">-no-reboot</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">guest_errors</span><span class="Token SPACE"> </span><span class="Token OPTION">-serial</span><span class="Token SPACE"> </span><span class="Token ID">mon:stdio</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token HighlightLine SPACE">        </span><span class="Token HighlightLine OPTION">-netdev</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">user</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine ID">id</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">net0</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine ID">hostfwd</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">tcp:127.0.0.1:2222-:22</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine OPTION">-device</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">e1000</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine ID">netdev</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">net0</span></code></pre><p>查看网络配置, 不出意外的话网卡名应该是 enp0s3, 如果不是的话下面对应的名字也替换一下</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">a</span><span class="Token LF">
</span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">lo:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">LOOPBACK</span><span class="Token COMMA">,</span><span class="Token ID">UP</span><span class="Token COMMA">,</span><span class="Token ID">LOWER_UP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">65536</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">noqueue</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">UNKNOWN</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">...</span><span class="Token LF">
</span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">enp0s3:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">BROADCAST</span><span class="Token COMMA">,</span><span class="Token ID">MULTICAST</span><span class="Token COMMA">,</span><span class="Token ID">UP</span><span class="Token COMMA">,</span><span class="Token ID">LOWER_UP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">1500</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">pfifo_fast</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">UP</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token ID">...</span><span class="Token LF">
</span><span class="Token NUMBER">3</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">sit0@NONE:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">NOARP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">1480</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">noop</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">DOWN</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">link/sit</span><span class="Token SPACE"> </span><span class="Token NUMBER">0.0</span><span class="Token ID">.0.0</span><span class="Token SPACE"> </span><span class="Token ID">brd</span><span class="Token SPACE"> </span><span class="Token NUMBER">0.0</span><span class="Token ID">.0.0</span></code></pre><p>其中 enp0s3 网卡还并未配置, 创建一个网卡配置文件</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">vim</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">etc/netplan/01-netcfg.yaml</span></code></pre><p>写入如下内容, 需要注意的是 YAML 对缩进非常敏感, 直接复制进去可能会有缩进问题, 建议手打</p><pre class="language-yaml"><code><span class="Token Key ID">network</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Key ID">version</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Key ID">ethernets</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Key ID">enp0s3</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">      </span><span class="Token Key ID">addresses</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token NUMBER">10.0</span><span class="Token NUMBER">.2</span><span class="Token NUMBER">.15/</span><span class="Token NUMBER">24</span><span class="Token LF">
</span><span class="Token SPACE">      </span><span class="Token Key ID">routes</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Key ID">to</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token Key ID">via</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">10.0</span><span class="Token NUMBER">.2</span><span class="Token NUMBER">.2</span><span class="Token LF">
</span><span class="Token SPACE">      </span><span class="Token Key ID">nameservers</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Key ID">addresses</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token NUMBER">8.8</span><span class="Token NUMBER">.8</span><span class="Token TIME NUMBER">.8</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token NUMBER">8.8</span><span class="Token NUMBER">.4</span><span class="Token NUMBER">.4</span></code></pre><p>修改文件权限</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">chmod</span><span class="Token SPACE"> </span><span class="Token NUMBER">600</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">etc/netplan/01-netcfg.yaml</span></code></pre><p>应用 Netplan 配置</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">netplan</span><span class="Token SPACE"> </span><span class="Token ID">apply</span></code></pre><p>此时网络就已经完成了配置, 再次查看网络配置</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">a</span><span class="Token LF">
</span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">lo:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">LOOPBACK</span><span class="Token COMMA">,</span><span class="Token ID">UP</span><span class="Token COMMA">,</span><span class="Token ID">LOWER_UP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">65536</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">noqueue</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">UNKNOWN</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">link/loopback</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token ID">brd</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">inet</span><span class="Token SPACE"> </span><span class="Token NUMBER">127.0</span><span class="Token ID">.0.1/8</span><span class="Token SPACE"> </span><span class="Token ID">scope</span><span class="Token SPACE"> </span><span class="Token ID">host</span><span class="Token SPACE"> </span><span class="Token ID">lo</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token ID">valid_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token SPACE"> </span><span class="Token ID">preferred_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">inet6</span><span class="Token SPACE"> </span><span class="Token COLON">:</span><span class="Token COLON">:</span><span class="Token NUMBER">1</span><span class="Token DIV">/</span><span class="Token NUMBER">128</span><span class="Token SPACE"> </span><span class="Token ID">scope</span><span class="Token SPACE"> </span><span class="Token ID">host</span><span class="Token SPACE"> </span><span class="Token ID">noprefixroute</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token ID">valid_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token SPACE"> </span><span class="Token ID">preferred_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token LF">
</span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">enp0s3:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">BROADCAST</span><span class="Token COMMA">,</span><span class="Token ID">MULTICAST</span><span class="Token COMMA">,</span><span class="Token ID">UP</span><span class="Token COMMA">,</span><span class="Token ID">LOWER_UP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">1500</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">pfifo_fast</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">UP</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">link/ether</span><span class="Token SPACE"> </span><span class="Token NUMBER">52</span><span class="Token COLON">:</span><span class="Token NUMBER">54</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">12</span><span class="Token COLON">:</span><span class="Token NUMBER">34</span><span class="Token COLON">:</span><span class="Token NUMBER">56</span><span class="Token SPACE"> </span><span class="Token ID">brd</span><span class="Token SPACE"> </span><span class="Token ID">ff:ff:ff:ff:ff:ff</span><span class="Token LF">
</span><span class="Token HighlightLine SPACE">    </span><span class="Token HighlightLine ID">inet</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine NUMBER">10.0</span><span class="Token HighlightLine ID">.2.15/24</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">brd</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine NUMBER">10.0</span><span class="Token HighlightLine ID">.2.255</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">scope</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">global</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">enp0s3</span><span class="Token HighlightLine LF">
</span><span class="Token SPACE">       </span><span class="Token ID">valid_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token SPACE"> </span><span class="Token ID">preferred_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">inet6</span><span class="Token SPACE"> </span><span class="Token ID">fec0::5054:ff:fe12:3456/64</span><span class="Token SPACE"> </span><span class="Token ID">scope</span><span class="Token SPACE"> </span><span class="Token ID">site</span><span class="Token SPACE"> </span><span class="Token ID">dynamic</span><span class="Token SPACE"> </span><span class="Token ID">mngtmpaddr</span><span class="Token SPACE"> </span><span class="Token ID">noprefixroute</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token ID">valid_lft</span><span class="Token SPACE"> </span><span class="Token NUMBER">86274s</span><span class="Token ID">ec</span><span class="Token SPACE"> </span><span class="Token ID">preferred_lft</span><span class="Token SPACE"> </span><span class="Token NUMBER">14274s</span><span class="Token ID">ec</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">inet6</span><span class="Token SPACE"> </span><span class="Token ID">fe80::5054:ff:fe12:3456/64</span><span class="Token SPACE"> </span><span class="Token ID">scope</span><span class="Token SPACE"> </span><span class="Token ID">link</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token ID">valid_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token SPACE"> </span><span class="Token ID">preferred_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token LF">
</span><span class="Token NUMBER">3</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">sit0@NONE:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">NOARP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">1480</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">noop</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">DOWN</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">link/sit</span><span class="Token SPACE"> </span><span class="Token NUMBER">0.0</span><span class="Token ID">.0.0</span><span class="Token SPACE"> </span><span class="Token ID">brd</span><span class="Token SPACE"> </span><span class="Token NUMBER">0.0</span><span class="Token ID">.0.0</span></code></pre><p>然后就可以正常联网使用了, 再次启动也会自动联网</p><h3 id="h3-10">tap 模式</h3><blockquote style="border-left-color: #9a6700; background-color: #fff4dd;"><div style="color: #9a6700;"><img class="icon-warning" loading="lazy" src="../../../img/warning.svg" alt="[!WARNING]"> WARNING </div><p> 存疑, 还有问题! 不要用!</p></blockquote><blockquote><p>一般的网络配置建议直接使用 user</p></blockquote><p>-netdev user 模式适用于简单的网络需求,但如果你需要更复杂的网络配置或完整的桥接网络连接,可以考虑使用桥接模式。</p><p>首先在你的主机上创建 tap0 接口,并将其添加到一个网桥中</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">tuntap</span><span class="Token SPACE"> </span><span class="Token ID">add</span><span class="Token SPACE"> </span><span class="Token ID">tap0</span><span class="Token SPACE"> </span><span class="Token ID">mode</span><span class="Token SPACE"> </span><span class="Token ID">tap</span><span class="Token SPACE"> </span><span class="Token ID">user</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">whoami</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">link</span><span class="Token SPACE"> </span><span class="Token ID">set</span><span class="Token SPACE"> </span><span class="Token ID">tap0</span><span class="Token SPACE"> </span><span class="Token ID">up</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">brctl</span><span class="Token SPACE"> </span><span class="Token ID">addbr</span><span class="Token SPACE"> </span><span class="Token ID">br0</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">brctl</span><span class="Token SPACE"> </span><span class="Token ID">addif</span><span class="Token SPACE"> </span><span class="Token ID">br0</span><span class="Token SPACE"> </span><span class="Token ID">tap0</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">dhclient</span><span class="Token SPACE"> </span><span class="Token ID">br0</span></code></pre><p>其中最后一步可能会卡住, 通常是因为网桥 <code>br0</code> 没有正确配置或没有有效的网络接口连接, 可以尝试为网桥 <code>br0</code> 手动分配静态 IP 地址,避免依赖 DHCP:</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">addr</span><span class="Token SPACE"> </span><span class="Token ID">add</span><span class="Token SPACE"> </span><span class="Token NUMBER">192.168</span><span class="Token ID">.1.100/24</span><span class="Token SPACE"> </span><span class="Token ID">dev</span><span class="Token SPACE"> </span><span class="Token ID">br0</span><span class="Token SPACE">  </span><span class="Token COMMENT"># 替换为你网络的 IP 地址段</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">link</span><span class="Token SPACE"> </span><span class="Token ID">set</span><span class="Token SPACE"> </span><span class="Token ID">br0</span><span class="Token SPACE"> </span><span class="Token ID">up</span></code></pre><p>要配置桥接网络,修改启动参数</p><pre class="language-shell"><code><span class="Token ID">qemu-system-x86_64</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">home/kamilu/klinux/arch/x86/boot/bzImage</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">raw</span><span class="Token COMMA">,</span><span class="Token ID">file</span><span class="Token ASSIGN">=</span><span class="Token ID">disk/ubuntu.raw</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;root=/dev/sda2 console=ttyS0&quot;</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token OPTION">-no-reboot</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">guest_errors</span><span class="Token SPACE"> </span><span class="Token OPTION">-serial</span><span class="Token SPACE"> </span><span class="Token ID">mon:stdio</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token HighlightLine SPACE">        </span><span class="Token HighlightLine OPTION">-netdev</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">tap</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine ID">id</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">net0</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine ID">ifname</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">tap0</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine ID">script</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">no</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine ID">downscript</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">no</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine OPTION">-device</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">e1000</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine ID">netdev</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">net0</span></code></pre><h2 id="h2-11">磁盘扩容</h2><p>如果初始创建的磁盘镜像随着使用发现空间不足, 可以比较方便的扩容</p><p>第一步将磁盘镜像文件的大小从 20GB 扩展到 50GB</p><pre class="language-shell"><code><span class="Token ID">qemu-img</span><span class="Token SPACE"> </span><span class="Token ID">resize</span><span class="Token SPACE"> </span><span class="Token ID">ubuntu.raw</span><span class="Token SPACE"> </span><span class="Token NUMBER">50G</span></code></pre><p>扩展磁盘后,还需要在虚拟机内部调整分区和文件系统以使用新增的空间, 使用 cfdisk 调整分区 /dev/sda</p><blockquote><p>如果是用的 if=virtio 那么是 /dev/vda</p></blockquote><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">cfdisk</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/sda</span></code></pre><p>选择 /dev/sda2 分区将其扩容至 50GB</p><p>使用 df -h 查看磁盘剩余容量, 发现还是 20G</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404-VM</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token ID">df</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token LF">
</span><span class="Token ID">Filesystem</span><span class="Token SPACE">      </span><span class="Token ID">Size</span><span class="Token SPACE">  </span><span class="Token ID">Used</span><span class="Token SPACE"> </span><span class="Token ID">Avail</span><span class="Token SPACE"> </span><span class="Token ID">Use</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token ID">Mounted</span><span class="Token SPACE"> </span><span class="Token ID">on</span><span class="Token LF">
</span><span class="Token DIV">/</span><span class="Token ID">dev/root</span><span class="Token SPACE">        </span><span class="Token NUMBER">20G</span><span class="Token SPACE">  </span><span class="Token NUMBER">8.2G</span><span class="Token SPACE">   </span><span class="Token NUMBER">11G</span><span class="Token SPACE">  </span><span class="Token NUMBER">45</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">95G</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">95G</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/shm</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">38G</span><span class="Token SPACE">  </span><span class="Token NUMBER">892K</span><span class="Token SPACE">   </span><span class="Token NUMBER">38G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">           </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">  </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run/lock</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">12K</span><span class="Token SPACE">   </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run/user/1000</span></code></pre><p>但是 lsblk 可以看到分区信息已经更新</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404-VM</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token ID">lsblk</span><span class="Token LF">
</span><span class="Token ID">NAME</span><span class="Token SPACE">   </span><span class="Token ID">MAJ:MIN</span><span class="Token SPACE"> </span><span class="Token ID">RM</span><span class="Token SPACE">  </span><span class="Token ID">SIZE</span><span class="Token SPACE"> </span><span class="Token ID">RO</span><span class="Token SPACE"> </span><span class="Token ID">TYPE</span><span class="Token SPACE"> </span><span class="Token ID">MOUNTPOINTS</span><span class="Token LF">
</span><span class="Token ID">sda</span><span class="Token SPACE">      </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">50G</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">disk</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token ID">sda1</span><span class="Token SPACE">   </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token NUMBER">1</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">1M</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">part</span><span class="Token LF">
</span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token ID">sda2</span><span class="Token SPACE">   </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token NUMBER">2</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">50G</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">part</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token LF">
</span><span class="Token ID">sr0</span><span class="Token SPACE">     </span><span class="Token NUMBER">11</span><span class="Token COLON">:</span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token NUMBER">1024M</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">rom</span></code></pre><p>这是因为文件系统的信息还没有更新, 查看根目录的文件系统类型(默认是ext4)</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404-VM</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token ID">df</span><span class="Token SPACE"> </span><span class="Token OPTION">-Th</span><span class="Token LF">
</span><span class="Token ID">Filesystem</span><span class="Token SPACE">     </span><span class="Token ID">Type</span><span class="Token SPACE">   </span><span class="Token ID">Size</span><span class="Token SPACE">  </span><span class="Token ID">Used</span><span class="Token SPACE"> </span><span class="Token ID">Avail</span><span class="Token SPACE"> </span><span class="Token ID">Use</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token ID">Mounted</span><span class="Token SPACE"> </span><span class="Token ID">on</span><span class="Token LF">
</span><span class="Token DIV">/</span><span class="Token ID">dev/root</span><span class="Token SPACE">      </span><span class="Token ID">ext4</span><span class="Token SPACE">    </span><span class="Token NUMBER">20G</span><span class="Token SPACE">  </span><span class="Token NUMBER">8.2G</span><span class="Token SPACE">   </span><span class="Token NUMBER">11G</span><span class="Token SPACE">  </span><span class="Token NUMBER">45</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">          </span><span class="Token ID">tmpfs</span><span class="Token SPACE">   </span><span class="Token NUMBER">95G</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">95G</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/shm</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">          </span><span class="Token ID">tmpfs</span><span class="Token SPACE">   </span><span class="Token NUMBER">38G</span><span class="Token SPACE">  </span><span class="Token NUMBER">892K</span><span class="Token SPACE">   </span><span class="Token NUMBER">38G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">          </span><span class="Token ID">tmpfs</span><span class="Token SPACE">  </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">  </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run/lock</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">          </span><span class="Token ID">tmpfs</span><span class="Token SPACE">   </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">12K</span><span class="Token SPACE">   </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run/user/1000</span></code></pre><p>重新更新文件系统信息</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">resize2fs</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/sda2</span></code></pre><p>ext4 更新块信息后再次查看发现磁盘大小正常</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404-VM</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token ID">df</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token LF">
</span><span class="Token ID">Filesystem</span><span class="Token SPACE">      </span><span class="Token ID">Size</span><span class="Token SPACE">  </span><span class="Token ID">Used</span><span class="Token SPACE"> </span><span class="Token ID">Avail</span><span class="Token SPACE"> </span><span class="Token ID">Use</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token ID">Mounted</span><span class="Token SPACE"> </span><span class="Token ID">on</span><span class="Token LF">
</span><span class="Token DIV">/</span><span class="Token ID">dev/root</span><span class="Token SPACE">        </span><span class="Token NUMBER">50G</span><span class="Token SPACE">  </span><span class="Token NUMBER">8.2G</span><span class="Token SPACE">   </span><span class="Token NUMBER">39G</span><span class="Token SPACE">  </span><span class="Token NUMBER">18</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">95G</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">95G</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/shm</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">38G</span><span class="Token SPACE">  </span><span class="Token NUMBER">892K</span><span class="Token SPACE">   </span><span class="Token NUMBER">38G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">           </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">  </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run/lock</span><span class="Token LF">
</span><span class="Token ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">12K</span><span class="Token SPACE">   </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run/user/1000</span></code></pre><h2 id="h2-12">Ubuntu iso 安装</h2><p>也有一些读者可能就像手动安装一下，当然也可以，在 <a href="https://ubuntu.com/download/server#manual-install" target="_blank">ubuntu server</a> 查找到 Ubuntu 的 server 镜像 iso 文件，也有一些其他存档镜像:</p><ul><li><a href="https://askubuntu.com/a/1233750" target="_blank">archive ubuntu</a></li></ul><ul><li><a href="https://releases.ubuntu.com/jammy/" target="_blank">ubuntu releases</a> <a href="https://releases.ubuntu.com/jammy/ubuntu-22.04.4-live-server-amd64.iso" target="_blank">ubuntu server iso</a></li></ul><p>下载的 iso 是光盘 CD/DVD 映像, 需要先创建一个存储介质用于安装系统</p><pre class="language-shell"><code><span class="Token ID">qemu-img</span><span class="Token SPACE"> </span><span class="Token ID">create</span><span class="Token SPACE"> </span><span class="Token ID">ubuntu.raw</span><span class="Token SPACE"> </span><span class="Token OPTION">-f</span><span class="Token SPACE"> </span><span class="Token ID">raw</span><span class="Token SPACE"> </span><span class="Token NUMBER">20G</span></code></pre><p>安装系统, 其中 <code>-drive</code> <code>-cdrom</code> 的路径自行调整</p><pre class="language-shell"><code><span class="Token ID">qemu-system-x86_64</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">raw</span><span class="Token COMMA">,</span><span class="Token ID">file</span><span class="Token ASSIGN">=</span><span class="Token ID">disk/ubuntu.raw</span><span class="Token COMMA">,</span><span class="Token Keyword IF">if</span><span class="Token ASSIGN">=</span><span class="Token ID">virtio</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token OPTION">-cdrom</span><span class="Token SPACE"> </span><span class="Token ID">iso/ubuntu-24.04-live-server-amd64.iso</span></code></pre><p>具体的安装过程略过, <b>注意不要开启 LVM, 启用 OpenSSH</b></p><p>安装完成之后就不再需要 <code>-cdrom</code> 了, 可以直接通过磁盘启动</p><pre class="language-shell"><code><span class="Token ID">qemu-system-x86_64</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">raw</span><span class="Token COMMA">,</span><span class="Token ID">file</span><span class="Token ASSIGN">=</span><span class="Token ID">disk/ubuntu.raw</span><span class="Token COMMA">,</span><span class="Token Keyword IF">if</span><span class="Token ASSIGN">=</span><span class="Token ID">virtio</span></code></pre><blockquote><p>启动会有点慢, 耐心一些</p></blockquote><p>启动之后可以使用 lsblk 看一下当前的所有磁盘, 启动 sr0 代表第一个光盘驱动器(CD-ROM Drive), vda 代表第一个 Virtio 磁盘设备</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@kamilu</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token ID">lsblk</span><span class="Token LF">
</span><span class="Token ID">NAME</span><span class="Token SPACE">   </span><span class="Token ID">MAJ:MIN</span><span class="Token SPACE"> </span><span class="Token ID">RM</span><span class="Token SPACE">  </span><span class="Token ID">SIZE</span><span class="Token SPACE"> </span><span class="Token ID">RO</span><span class="Token SPACE"> </span><span class="Token ID">TYPE</span><span class="Token SPACE"> </span><span class="Token ID">MOUNTPOINTS</span><span class="Token LF">
</span><span class="Token ID">sr0</span><span class="Token SPACE">     </span><span class="Token NUMBER">11</span><span class="Token COLON">:</span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token NUMBER">1024M</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">rom</span><span class="Token LF">
</span><span class="Token ID">vda</span><span class="Token SPACE">    </span><span class="Token NUMBER">253</span><span class="Token COLON">:</span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">20G</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">disk</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token ID">vda1</span><span class="Token SPACE"> </span><span class="Token NUMBER">253</span><span class="Token COLON">:</span><span class="Token NUMBER">1</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">1M</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">part</span><span class="Token LF">
</span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token ID">vda2</span><span class="Token SPACE"> </span><span class="Token NUMBER">253</span><span class="Token COLON">:</span><span class="Token NUMBER">2</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">20G</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">part</span><span class="Token SPACE"> </span><span class="Token DIV">/</span></code></pre><blockquote><p>由于命令行中设置参数中 if(interface) 指定为 <code>if=virtio</code> 所以这里显示的是 vda, 如果设置为 <code>if=sd</code> 则这里应该是 sda, 这里设置为 virtio 可以让设备通过允许客体系统直接与主机通信而绕过仿真层, 以实现高效的磁盘I</p></blockquote><p>可以看到 <code>/dev/vda1</code> 是用于启动的 /boot 分区, <code>/dev/vda2</code> 是挂载的根分区, <b>也是后面启动时需要手动指定的分区</b></p><h2 id="h2-13">参考</h2><ul><li><a href="https://lfs.xry111.site/zh_CN/12.4-systemd/" target="_blank">linux from scratch</a></li></ul><ul><li><a href="https://ubuntu.com/server/docs/virtualisation-with-qemu" target="_blank">ubuntu virtualisation-with-qemu</a></li></ul><ul><li><a href="https://linux-tips.com/t/booting-from-an-iso-image-using-qemu/136" target="_blank">Booting from an ISO image using qemu</a></li></ul><ul><li><a href="https://stackoverflow.com/questions/17242403/linux-running-self-compiled-kernel-in-qemu-vfs-unable-to-mount-root-fs-on-unk" target="_blank">linux running self compiled kernel in qemu vfs unable to mount root fs on unk</a></li></ul><ul><li><a href="https://serverfault.com/questions/471719/how-to-start-qemu-directly-in-the-console-not-in-curses-or-sdl" target="_blank">serverfault how-to-start-qemu-directly-in-the-console-not-in-curses-or-sdl</a></li></ul><ul><li><a href="https://web.archive.org/web/20180104171638/http://nairobi-embedded.org/qemu_monitor_console.html" target="_blank">QEMU Human Monitor Interface</a></li></ul><ul><li><a href="https://tech.joellemena.com/ubuntu/ubuntu-22-04-mini-iso/" target="_blank">Ubuntu 22.04 Mini Iso</a></li></ul><ul><li><a href="https://askubuntu.com/questions/1233746/download-ubuntu-minimal-iso-20-04lts" target="_blank">askubuntu download-ubuntu-minimal-iso-20-04lts</a></li></ul><ul><li><a href="https://www.bilibili.com/video/BV1Yz421S7vK/" target="_blank">18-Linux 操作系统 (initramfs; 最小 Linux 世界) [南京大学2024操作系统]</a></li></ul><ul><li><a href="https://zhou-yuxin.github.io/articles/2018/%E5%AE%89%E8%A3%85qemu-kvm%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C/index.html" target="_blank">安装qemu-kvm以及配置桥接网络</a></li></ul><ul><li><a href="https://vaaandark.top/en/posts/linux-startup/" target="_blank">vaaandark linux-startup</a></li></ul></div>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var markdownBody = document.querySelector('.markdown-body');
                    var giscusDiv = markdownBody.querySelector('.giscus');
                    var referenceHtml = `<div class="references-tabs-container">
<div class="references-tabs-nav">
<button class="references-tab-btn active" data-tab="references-out">本文引用</button>
</div>
<div class="references-tabs-content">
<div class="references-tab-pane active" id="references-out">
<ul class="reference-list">
<li><a href="../../快速开始/调试内核"><span class="reference-icon" aria-hidden="true"></span><span class="reference-title">调试内核</span></a></li>
<li><a href="../../fs/disk-layout"><span class="reference-icon" aria-hidden="true"></span><span class="reference-title">disk-layout</span></a></li>
<li><a href="../../fs/mount"><span class="reference-icon" aria-hidden="true"></span><span class="reference-title">mount</span></a></li>
<li><a href="../../快速开始/内核模块编译"><span class="reference-icon" aria-hidden="true"></span><span class="reference-title">内核模块编译</span></a></li>
</ul>
</div>
</div>
</div>`;
                    
                    if (giscusDiv) {
                        giscusDiv.insertAdjacentHTML('beforebegin', referenceHtml);
                    } else {
                        markdownBody.insertAdjacentHTML('beforeend', referenceHtml);
                    }
                    
                    // 添加选项卡切换功能
                    setTimeout(function() {
                        var tabButtons = document.querySelectorAll('.references-tab-btn');
                        var tabPanes = document.querySelectorAll('.references-tab-pane');
                        
                        tabButtons.forEach(function(button) {
                            button.addEventListener('click', function() {
                                var targetTab = this.getAttribute('data-tab');
                                
                                // 移除所有active类
                                tabButtons.forEach(btn => btn.classList.remove('active'));
                                tabPanes.forEach(pane => pane.classList.remove('active'));
                                
                                // 添加active类到当前选中的选项卡
                                this.classList.add('active');
                                var targetPane = document.getElementById(targetTab);
                                if (targetPane) {
                                    targetPane.classList.add('active');
                                }
                            });
                        });
                    }, 100);
                });
                </script>
                
    <div id="dir-tree-placeholder"></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/dir_tree_toggle.js"></script><script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../快速开始/调试内核","../../快速开始/安装内核与救火","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/clipboard.svg","../../../img/clipboard-check.svg");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script>
            <script src="https://giscus.app/client.js" data-repo="luzhixing12345/klinux" 
            data-repo-id="R_kgDOJIKiEw" data-category="Q&A" data-category-id="DIC_kwDOJIKiE84CgFwK" data-mapping="pathname" data-strict="0"
            data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom"
            data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
            </script>
            <script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
<script>
    const ws = new WebSocket("ws://127.0.0.1:8765");
    ws.onmessage = (event) => {
        if (event.data === "reload") location.reload();
    };
</script>
    
</body>

</html>