<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">调试内核</a><ul><li><a href="#h2-1">qemu</a></li></ul><ul><li><a href="#h2-2">busybox</a></li></ul><ul><li><a href="#h2-3">制作initramfs</a></li></ul><ul><li><a href="#h2-4">QEMU 启动</a><ul><li><a href="#h3-5">编译依赖</a></li></ul></li></ul><ul><li><a href="#h2-6">Vscode + gdb</a><ul><li><a href="#h3-7">生成 compile_commands.json</a></li></ul></li></ul><ul><li><a href="#h2-8">gdb config</a></li></ul><ul><li><a href="#h2-9">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">调试内核</h1><p>本文默认读者已经通过 linux 源码编译得到内核镜像了, 即用于调试的 vmlinux 和 用于启动的 bzImage</p><p>笔者使用 docker 制作了一个内核调试的镜像, 如果读者不想一步一步制作可以直接下载使用</p><pre class="language-shell"><code><span class="Token Program ID">docker</span><span class="Token SPACE"> </span><span class="Token ID">pull</span><span class="Token SPACE"> </span><span class="Token PATH">kamidalu/kernel-debug</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># 启动容器</span><span class="Token LF">
</span><span class="Token Program ID">docker</span><span class="Token SPACE"> </span><span class="Token ID">run</span><span class="Token SPACE"> </span><span class="Token OPTION">--name</span><span class="Token SPACE"> </span><span class="Token ID">kernel-debug</span><span class="Token SPACE"> </span><span class="Token OPTION">-itd</span><span class="Token SPACE"> </span><span class="Token PATH">kamidalu/kernel-debug</span><span class="Token SPACE"> </span><span class="Token PATH">/bin/bash</span><span class="Token LF">
</span><span class="Token Program ID">docker</span><span class="Token SPACE"> </span><span class="Token ID">exec</span><span class="Token SPACE"> </span><span class="Token OPTION">-it</span><span class="Token SPACE"> </span><span class="Token ID">kernel-debug</span><span class="Token SPACE"> </span><span class="Token PATH">/bin/bash</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># 调试</span><span class="Token LF">
</span><span class="Token Keyword CD">cd</span><span class="Token LF">
</span><span class="Token Keyword CD">cd</span><span class="Token SPACE"> </span><span class="Token ID">workspace</span><span class="Token LF">
</span><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">debug</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># 然后使用 vscode 打开 linux6.6 的目录, 点击左侧调试即可</span></code></pre><blockquote><p>镜像体积 5GB, 因为安装了很多依赖项, 并未做精简</p></blockquote><h2 id="h2-1">qemu</h2><p><a href="https://www.qemu.org/" target="_blank">QEMU</a> 是一个非常健壮的模拟器和仿真器, 对虚拟化技术的支持很好, 可以直接使用 apt 安装</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">qemu</span><span class="Token SPACE"> </span><span class="Token ID">qemu-system</span><span class="Token SPACE"> </span><span class="Token ID">qemu-kvm</span></code></pre><h2 id="h2-2">busybox</h2><p><a href="https://busybox.net/" target="_blank">BusyBox</a> 是一个轻量级的 Unix 工具箱,它集成了许多标准 Unix 工具的功能,并且可以运行在资源受限的系统上,例如嵌入式设备和网络路由器等.BusyBox 能够代替大多数标准 Unix 工具集的实现,从而减少了系统空间和资源的需求.</p><p>BusyBox 的工具集包括了数百个 Unix 工具,如 ls/cp/cat/grep/tar/gzip/awk/sed/vi/ping/telnet 等,<b>它们都被打包成一个可执行文件</b>.BusyBox 本身只有一个可执行文件,但它包含了大量的 Unix 工具,并且可以通过命令行参数来指定使用哪些工具.</p><pre class="language-shell"><code><span class="Token Program ID">wget</span><span class="Token SPACE"> </span><span class="Token Url ID">https://busybox.net/downloads/busybox-1.36.0.tar.bz2</span><span class="Token LF">
</span><span class="Token Program ID">tar</span><span class="Token SPACE"> </span><span class="Token ID">xf</span><span class="Token SPACE"> </span><span class="Token ID">busybox-1.36.0.tar.bz2</span><span class="Token LF">
</span><span class="Token Keyword CD">cd</span><span class="Token SPACE"> </span><span class="Token PATH">busybox-1.36.0/</span><span class="Token LF">
</span><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">menuconfig</span></code></pre><p>配置选项中勾选 Build Static Lib, 因为这一步只是制作一个简单的根文件系统, 此时还没有 glibc 等重要的 C 运行库, 所以没办法动态链接的运行, 暂时用静态链接将 glibc 打包进可执行文件</p><pre class="language-shell"><code><span class="Token MINUS">-</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token Program ID">Settings</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token MINUS">-</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token MUL">*</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">Build</span><span class="Token SPACE"> </span><span class="Token ID">static</span><span class="Token SPACE"> </span><span class="Token Function ID">binary</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">no</span><span class="Token SPACE"> </span><span class="Token ID">shared</span><span class="Token SPACE"> </span><span class="Token ID">libs</span><span class="Token BraceDepth-0 RPAREN">)</span></code></pre><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230314191937.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230314191937.png" alt="20230314191937"></a></p><blockquote><p>如果要编译 32 位的 busybox, 需要在 settings 中为 <code>CFLAGS</code> <code>LDFLAGS</code> 添加 <code>-m32</code> 选项, 并且安装 32 位编译环境</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240306183920.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240306183920.png" alt="20240306183920"></a></p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt-get</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">gcc-multilib</span></code></pre></blockquote><pre class="language-shell"><code><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token OPTION">-j</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">nproc</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">install</span></code></pre><p>make 结束的时候会有如下的警告, 忽略即可</p><pre class="language-shell"><code><span class="Token Program ID">Static</span><span class="Token SPACE"> </span><span class="Token ID">linking</span><span class="Token SPACE"> </span><span class="Token ID">against</span><span class="Token SPACE"> </span><span class="Token ID">glibc</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">can</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">t</span><span class="Token SPACE"> </span><span class="Token ID">use</span><span class="Token SPACE"> </span><span class="Token OPTION">--gc-sections</span><span class="Token LF">
</span><span class="Token Program ID">Trying</span><span class="Token SPACE"> </span><span class="Token ID">libraries:</span><span class="Token SPACE"> </span><span class="Token ID">crypt</span><span class="Token SPACE"> </span><span class="Token ID">m</span><span class="Token SPACE"> </span><span class="Token ID">resolv</span><span class="Token SPACE"> </span><span class="Token ID">rt</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token Program ID">Library</span><span class="Token SPACE"> </span><span class="Token ID">crypt</span><span class="Token SPACE"> </span><span class="Token ID">is</span><span class="Token SPACE"> </span><span class="Token ID">not</span><span class="Token SPACE"> </span><span class="Token ID">needed</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">excluding</span><span class="Token SPACE"> </span><span class="Token ID">it</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token Program ID">Library</span><span class="Token SPACE"> </span><span class="Token ID">m</span><span class="Token SPACE"> </span><span class="Token ID">is</span><span class="Token SPACE"> </span><span class="Token ID">needed</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">can</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">t</span><span class="Token SPACE"> </span><span class="Token ID">exclude</span><span class="Token SPACE"> </span><span class="Token Function ID">it</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">yet</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token Program ID">Library</span><span class="Token SPACE"> </span><span class="Token ID">resolv</span><span class="Token SPACE"> </span><span class="Token ID">is</span><span class="Token SPACE"> </span><span class="Token ID">needed</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">can</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">t</span><span class="Token SPACE"> </span><span class="Token ID">exclude</span><span class="Token SPACE"> </span><span class="Token Function ID">it</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">yet</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token Program ID">Library</span><span class="Token SPACE"> </span><span class="Token ID">rt</span><span class="Token SPACE"> </span><span class="Token ID">is</span><span class="Token SPACE"> </span><span class="Token ID">not</span><span class="Token SPACE"> </span><span class="Token ID">needed</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">excluding</span><span class="Token SPACE"> </span><span class="Token ID">it</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token Program ID">Library</span><span class="Token SPACE"> </span><span class="Token ID">m</span><span class="Token SPACE"> </span><span class="Token ID">is</span><span class="Token SPACE"> </span><span class="Token ID">needed</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">can</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">t</span><span class="Token SPACE"> </span><span class="Token ID">exclude</span><span class="Token SPACE"> </span><span class="Token Function ID">it</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">yet</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token Program ID">Library</span><span class="Token SPACE"> </span><span class="Token ID">resolv</span><span class="Token SPACE"> </span><span class="Token ID">is</span><span class="Token SPACE"> </span><span class="Token ID">needed</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">can</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">t</span><span class="Token SPACE"> </span><span class="Token ID">exclude</span><span class="Token SPACE"> </span><span class="Token Function ID">it</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">yet</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token Program ID">Final</span><span class="Token SPACE"> </span><span class="Token ID">link</span><span class="Token SPACE"> </span><span class="Token ID">with:</span><span class="Token SPACE"> </span><span class="Token ID">m</span><span class="Token SPACE"> </span><span class="Token ID">resolv</span></code></pre><p>编译得到的可执行文件保存在 <code>_install/</code> 目录下, 我们可以进入这个目录的bin文件夹下使用 <code>ll</code> 看到一个busybox可执行文件和众多链接文件, 这个 busybox 就是之后需要使用的工具</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230314192159.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230314192159.png" alt="20230314192159"></a></p><h2 id="h2-3">制作initramfs</h2><p>操作系统内核仅仅用于提供管理CPU/内存/磁盘等最基本的能力, 裸内核仍然需要一些软件环境才能够使用,但是没有发行版附带的各种软件,我们是无法正常使用裸内核的. 因此需要一个根文件系统(root file system)来提供文件系统的支持.根文件系统是操作系统文件系统的基础,它包含操作系统所需的文件和目录,并提供了文件系统层次结构的根节点, 例如 <code>/root /home /dev /usr /bin</code> 等. 大多数 Linux 发行版都遵循文件系统层次结构标准(<a href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard" target="_blank">Filesystem Hierarchy Standard</a>), 并声明它自己的策略来维护 FHS 合规性</p><p>initramfs 包含了一个最小的文件系统,它包括一些基本的工具和驱动程序,以便在系统启动后能够挂载更完整的文件系统.</p><blockquote><p>对于Linux系统而言,通常使用的是initramfs(Initial RAM File System)来作为临时的根文件系统. 正常的发行版启动都会经过两步,第一步是先用 initramfs 启动裸内核,第二步是 在initramfs 中挂载真正的发行版根文件系统,并chroot过去</p></blockquote><p><b>这里仅仅创建一个非常简单的 initramfs 作为裸内核启动时可用的一个迷你发行版</b>, 关于文件系统的更多知识见 &quot;制作文件系统&quot; 和 &quot;制作linux发行版&quot;</p><p>新建一个文件夹(workspace)用于后续的工作区</p><pre class="language-shell"><code><span class="Token Program ID">mkdir</span><span class="Token SPACE"> </span><span class="Token ID">workspace</span><span class="Token LF">
</span><span class="Token Keyword CD">cd</span><span class="Token SPACE"> </span><span class="Token ID">workspace</span></code></pre><p>将之前的 linux kernel中的 <code>arch/x86/boot/bzImage</code> 和 <code>_install/bin/busybox</code> 拷贝到此目录下</p><blockquote><p>前者可以创建软链接, 后者最好直接复制过来</p></blockquote><p>此时的目录结构:</p><pre class="language-shell"><code><span class="Token Program ID">.</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">bzImage</span><span class="Token LF">
</span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">busybox</span></code></pre><p>新建一些目录, 用于文件结构, 软链接busybox</p><pre class="language-shell"><code><span class="Token Program ID">mkdir</span><span class="Token SPACE"> </span><span class="Token ID">initramfs</span><span class="Token LF">
</span><span class="Token Keyword CD">cd</span><span class="Token SPACE"> </span><span class="Token ID">initramfs</span><span class="Token LF">
</span><span class="Token Program ID">mkdir</span><span class="Token SPACE"> </span><span class="Token OPTION">-p</span><span class="Token SPACE"> </span><span class="Token ID">bin</span><span class="Token SPACE"> </span><span class="Token ID">dev</span><span class="Token SPACE"> </span><span class="Token ID">etc</span><span class="Token SPACE"> </span><span class="Token ID">lib</span><span class="Token SPACE"> </span><span class="Token ID">mnt</span><span class="Token SPACE"> </span><span class="Token ID">proc</span><span class="Token SPACE"> </span><span class="Token ID">sbin</span><span class="Token SPACE"> </span><span class="Token ID">sys</span><span class="Token SPACE"> </span><span class="Token ID">tmp</span><span class="Token SPACE"> </span><span class="Token ID">var</span><span class="Token LF">
</span><span class="Token Program ID">mv</span><span class="Token SPACE"> </span><span class="Token PATH">../busybox</span><span class="Token SPACE"> </span><span class="Token PATH">bin/</span><span class="Token LF">
</span><span class="Token Keyword CD">cd</span><span class="Token SPACE"> </span><span class="Token ID">bin</span><span class="Token LF">
</span><span class="Token Program ID">ln</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token ID">busybox</span><span class="Token SPACE"> </span><span class="Token ID">mount</span><span class="Token LF">
</span><span class="Token Program ID">ln</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token ID">busybox</span><span class="Token SPACE"> </span><span class="Token ID">sh</span><span class="Token LF">
</span><span class="Token Keyword CD">cd</span><span class="Token SPACE"> </span><span class="Token ID">..</span></code></pre><p><code>ln -s busybox mount</code> 的作用是在当前目录下创建一个名为 mount 的符号链接,指向系统中已安装的 busybox 可执行文件.这个符号链接可以使得在执行 mount 命令时,实际上是执行的 busybox mount 命令,从而利用 BusyBox 工具箱中的 mount 工具来完成相应操作.</p><p><code>ln -s busybox sh</code> 同理,这种创建符号链接的方式可以使得使用者可以方便地使用 BusyBox 中提供的工具,而不需要输入完整的 BusyBox 工具箱中的工具名称.同时,符号链接的创建也可以在磁盘上节省空间,因为多个工具可以共用同一个可执行文件</p><p>此时的文件结构如下所示</p><pre class="language-shell"><code><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">bzImage</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">initramfs</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">bin</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">busybox</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">mount</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">busybox</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">sh</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">busybox</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">dev</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">etc</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">lib</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">mnt</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">proc</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">sbin</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">sys</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">tmp</span><span class="Token LF">
</span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">var</span></code></pre><p>在 initramfs/ 中新建 <code>init</code> 文件用于启动, 将下面的内容复制到init中, 它的作用是设置一些基本的环境和挂载文件系统,并最终执行一个shell, 以便于在引导过程中提供一个临时的操作环境,以便进行一些必要的操作或调试</p><pre class="language-shell"><code><span class="Token COMMENT">#!/bin/busybox sh</span><span class="Token LF">
</span><span class="Token Program PATH">/bin/busybox</span><span class="Token SPACE"> </span><span class="Token OPTION">--install</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token PATH">/bin</span><span class="Token LF">
</span><span class="Token Program ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-t</span><span class="Token SPACE"> </span><span class="Token ID">devtmpfs</span><span class="Token SPACE">  </span><span class="Token ID">devtmpfs</span><span class="Token SPACE">  </span><span class="Token PATH">/dev</span><span class="Token LF">
</span><span class="Token Program ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-t</span><span class="Token SPACE"> </span><span class="Token ID">proc</span><span class="Token SPACE">      </span><span class="Token ID">proc</span><span class="Token SPACE">      </span><span class="Token PATH">/proc</span><span class="Token LF">
</span><span class="Token Program ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-t</span><span class="Token SPACE"> </span><span class="Token ID">sysfs</span><span class="Token SPACE">     </span><span class="Token ID">sysfs</span><span class="Token SPACE">     </span><span class="Token PATH">/sys</span><span class="Token LF">
</span><span class="Token Program ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-t</span><span class="Token SPACE"> </span><span class="Token ID">tmpfs</span><span class="Token SPACE">     </span><span class="Token ID">tmpfs</span><span class="Token SPACE">     </span><span class="Token PATH">/tmp</span><span class="Token LF">
</span><span class="Token Program ID">setsid</span><span class="Token SPACE"> </span><span class="Token ID">cttyhack</span><span class="Token SPACE"> </span><span class="Token ID">sh</span><span class="Token LF">
</span><span class="Token Program ID">exec</span><span class="Token SPACE"> </span><span class="Token PATH">/bin/sh</span></code></pre><p>修改init的权限</p><pre class="language-shell"><code><span class="Token Program ID">chmod</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token ID">x</span><span class="Token SPACE"> </span><span class="Token ID">init</span></code></pre><p>这个脚本的主要作用是启动一个基本的 Linux 环境,包括挂载常见的文件系统和启动一个 shell 终端</p><ul><li><code>/bin/busybox --install -s /bin</code>: 这条命令的作用是将 BusyBox 工具箱中的所有工具复制到 /bin 目录下,并创建符号链接,使得这些工具可以直接使用.其中,--install 参数表示安装 BusyBox 工具箱中的所有命令,-s 参数表示使用符号链接.</li></ul><ul><li><code>mount</code> 命令用于挂载文件系统,这里使用了四个 mount 命令挂载了常见的文件系统:<p><code>mount -t devtmpfs devtmpfs /dev</code> 命令用于挂载 devtmpfs 文件系统到 /dev 目录,devtmpfs 文件系统是 Linux 内核提供的一个虚拟文件系统,用于管理设备节点文件.</p><p>proc sysfs tmpfs 同理</p></li></ul><ul><li><code>setsid cttyhack sh</code> 命令用于启动一个新的 shell 终端,其中 setsid 命令用于启动一个新的会话,cttyhack 命令用于将当前的控制终端(tty)绑定到新的会话中,从而让新的 shell 终端成为前台进程组的控制终端.</li></ul><ul><li><code>exec /bin/sh</code> 命令用于执行 /bin/sh 命令,即启动一个新的 shell 终端.由于使用了 exec 命令,原始的 shell 进程会被替换成新的 shell 进程,因此新的 shell 终端成为整个系统的主进程,其 PID 为 1.这是启动一个基本的 Linux 环境的最后一步</li></ul><blockquote><p>这里补充说明一下: initd(或者叫init)是系统引导过程的第一个用户空间进程,负责启动和管理系统中的各个服务和进程.它通常由操作系统提供,并且具有更复杂的功能和管理能力,如根据不同的运行级别加载和管理服务.initd通常使用一系列的启动脚本来管理服务的启动/停止和重启等操作.给出的脚本不是initd进程本身,而是一个在引导过程中执行的自定义脚本,它可能具有特定的目的或需求,但不具备initd进程的全部功能和特性</p><p>当然, 除了 initd 现代 linux 发行版一般用的都是 systemd 作为守护进程</p></blockquote><p>修改完init的权限之后在根目录新建 Makefile, 复制如下内容</p><p>注意这里的路径是 <code>~/qemu/bin/qemu-system-x86_64</code>, 如果你的qemu装在了不同的地方记得修改路径</p><blockquote><p>注意下面的 Makefile 代码复制过去之后还需要手动改一下空格为 \t, 不然会出错</p></blockquote><pre class="language-makefile"><code><span class="Token Mission ID">.PHONY</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">init</span><span class="Token SPACE"> </span><span class="Token ID">qemu</span><span class="Token SPACE"> </span><span class="Token ID">clean</span><span class="Token SPACE"> </span><span class="Token ID">debug</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Variable ID">KERNEL</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token ID">bzImage</span><span class="Token LF">
</span><span class="Token Variable ID">INITRAMFS</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token ID">initramfs.img</span><span class="Token LF">
</span><span class="Token Variable ID">QEMU</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token ID">qemu-system-x86_64</span><span class="Token LF">
</span><span class="Token COMMENT"># 如果是自己编译的 qemu 可以使用自己的路径</span><span class="Token LF">
</span><span class="Token COMMENT"># QEMU = ~/qemu/bin/qemu-system-x86_64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Mission ID">init</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">cd</span><span class="Token SPACE"> </span><span class="Token ID">./initramfs</span><span class="Token SPACE"> </span><span class="Token AMPERSAND">&amp;</span><span class="Token AMPERSAND">&amp;</span><span class="Token SPACE"> </span><span class="Token ID">find</span><span class="Token SPACE"> </span><span class="Token ID">.</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">cpio</span><span class="Token SPACE"> </span><span class="Token OPTION">-ov</span><span class="Token SPACE"> </span><span class="Token OPTION">--format</span><span class="Token ASSIGN">=</span><span class="Token ID">newc</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">gzip</span><span class="Token SPACE"> </span><span class="Token Variable ID">-9</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">../</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">INITRAMFS</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Mission ID">qemu</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">QEMU</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">KERNEL</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-initrd</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">INITRAMFS</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token Variable ID">G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token STRING">&quot;earlyprintk=serial,ttyS0 console=ttyS0&quot;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Mission ID">debug</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">QEMU</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">KERNEL</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-initrd</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">INITRAMFS</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token Variable ID">G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token STRING">&quot;earlyprintk=serial,ttyS0 console=ttyS0&quot;</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-S</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-s</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Mission ID">clean</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">rm</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">INITRAMFS</span><span class="Token BraceDepth-0 RPAREN">)</span></code></pre><p>简单解释一下这里的命令的含义</p><ul><li>首先是后面这一段很长的<code>find . | cpio -ov --format=newc | gzip -9 &gt; ../initramfs.img</code><p>这个命令的作用是将当前目录下的所有文件和子目录,打包成一个 cpio 归档文件,并使用 gzip 压缩成一个压缩文件,最后保存到上级目录的 initramfs.img 文件中, 用于创建初始化内存文件系统(initramfs)</p><ul><li><code>find .</code>: 查找当前目录(以及其子目录)下的所有文件和目录,输出它们的路径.</li></ul><ul><li><code>cpio -ov --format=newc</code>: 将 find 命令输出的路径列表作为输入,创建一个 cpio 归档文件.-o 表示创建归档文件,-v 表示显示详细信息,<code>--format=newc</code> 表示使用 newc 格式创建归档文件,该格式通常用于初始化内存文件系统(initramfs).</li></ul><ul><li><code>gzip -9</code>: 对 cpio 归档文件进行压缩,并且使用最高压缩比 -9 以达到最小化文件大小.</li></ul><ul><li>最后将压缩后的数据流输出到上级目录中的 initramfs.img 文件中,使用重定向符号 &gt; 来实现.</li></ul></li></ul><ul><li><code>~/qemu/bin/qemu-system-x86_64</code> 表示使用 QEMU 模拟器来模拟一个 x86_64 架构的虚拟机.</li></ul><ul><li><code>-kernel bzImage</code> 表示指定 Linux 内核文件为 bzImage,bzImage 是经过压缩的 Linux 内核文件,通常位于 arch/x86_64/boot/bzImage 目录下.</li></ul><ul><li><code>-initrd initramfs.img</code> 表示指定 initramfs 文件系统为 initramfs.img,initramfs.img 是经过压缩的文件系统,包含了一些必要的文件和工具,用于启动 Linux 系统.</li></ul><ul><li><code>-m 1G</code> 表示指定虚拟机的内存大小为 1GB.</li></ul><ul><li><code>-nographic</code> 表示在终端中以无图形模式启动虚拟机,不使用图形界面.</li></ul><ul><li><code>-append &quot;earlyprintk=serial,ttyS0 console=ttyS0&quot;</code> 表示向内核传递启动参数.其中,earlyprintk=serial,ttyS0 表示启用串口输出信息,console=ttyS0 表示将控制台输出定向到串口终端(ttyS0)上.</li></ul><p>最终的文件结构如下所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230314202620.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230314202620.png" alt="20230314202620"></a></p><h2 id="h2-4">QEMU 启动</h2><p>制作initramfs</p><pre class="language-shell"><code><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">init</span></code></pre><blockquote><p>如果报错 cpio 找不到的话先下载 <code>sudo apt install cpio</code></p></blockquote><p>执行之后会得到 <code>initramfs.img</code></p><p>使用qemu开始模拟</p><pre class="language-shell"><code><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">qemu</span></code></pre><p>成功启动后按下enter进入命令行, 使用ls查看目录结构, 也可以在这个命令行中测试一些内容, 这些常用命令都是 busybox 提供的支持</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230518133704.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230518133704.png" alt="20230518133704"></a></p><p>退出 QEMU 模拟: 使用 <kbd>ctrl</kbd> + <kbd>A</kbd> 然后按下 <kbd>x</kbd></p><blockquote><p>如果您选择下载编译好的二进制文件可以直接跳过这一部分</p></blockquote><p>下面介绍一下如何从源码编译, 文章编写之际qemu的最新版本为7.2.0, 也是本文采用的版本. 读者可以尝试使用当前最新的版本</p><blockquote><p><a href="https://download.qemu.org/" target="_blank">qemu历史版本</a></p><p>前几天试了一下 qemu8.0 版本, 报了一个 SDL.h 的问题</p></blockquote><pre class="language-shell"><code><span class="Token Program ID">wget</span><span class="Token SPACE"> </span><span class="Token Url ID">https://download.qemu.org/qemu-7.2.0.tar.xz</span><span class="Token LF">
</span><span class="Token Program ID">tar</span><span class="Token SPACE"> </span><span class="Token ID">xvJf</span><span class="Token SPACE"> </span><span class="Token ID">qemu-7.2.0.tar.xz</span><span class="Token LF">
</span><span class="Token Keyword CD">cd</span><span class="Token SPACE"> </span><span class="Token ID">qemu-7.2.0</span></code></pre><h3 id="h3-5">编译依赖</h3><p>qemu在编译时候使用到了ninja</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt-get</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">ninja-build</span></code></pre><p>Ninja 是一个高效的构建系统,用于编译大型的软件项目, 这里就不过多介绍了. 然后安装依赖</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt-get</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">build-essential</span><span class="Token SPACE"> </span><span class="Token ID">pkg-config</span><span class="Token SPACE"> </span><span class="Token ID">zlib1g-dev</span><span class="Token SPACE"> </span><span class="Token ID">libglib2.0-dev</span><span class="Token SPACE"> </span><span class="Token ID">libpixman-1-dev</span><span class="Token SPACE"> </span><span class="Token ID">libsdl1.2-dev</span><span class="Token SPACE"> </span><span class="Token ID">libspice-server-dev</span><span class="Token SPACE"> </span><span class="Token ID">gdb</span></code></pre><blockquote><p>这里有可能存在冲突, 解决起来有点费劲..., 或许可以换源试试, 要不就选高版本的ubuntu</p></blockquote><p>这里笔者选择将qemu的安装目录放在 <code>~/qemu</code> , 你可以替换为你期望的路径. 第一步的时候会检查是否满足了所有的编译要求</p><pre class="language-shell"><code><span class="Token Program PATH">./configure</span><span class="Token SPACE"> </span><span class="Token OPTION">--prefix</span><span class="Token ASSIGN">=</span><span class="Token TILDE">~</span><span class="Token PATH">/qemu</span><span class="Token SPACE"> </span><span class="Token OPTION">--enable-kvm</span><span class="Token SPACE">  </span><span class="Token OPTION">--target-list</span><span class="Token ASSIGN">=</span><span class="Token ID">x86_64-softmmu</span><span class="Token LF">
</span><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token OPTION">-j</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">nproc</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">install</span></code></pre><p>这时候 <code>~/qemu/bin/</code> 就是需要的可执行文件 <code>qemu-system-x86_64</code> 所在的路径了</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/qemu/bin</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">tree</span><span class="Token SPACE"> </span><span class="Token ID">.</span><span class="Token LF">
</span><span class="Token Program ID">.</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">elf2dmp</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">qemu-edid</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">qemu-ga</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">qemu-img</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">qemu-io</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">qemu-keymap</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">qemu-nbd</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">qemu-pr-helper</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">qemu-storage-daemon</span><span class="Token LF">
</span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">qemu-system-x86_64</span></code></pre><h2 id="h2-6">Vscode + gdb</h2><p>启用调试内核只需要</p><pre class="language-shell"><code><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">debug</span></code></pre><p>&quot;-S&quot;选项表示在启动时暂停虚拟机的执行.它使得虚拟机在启动后立即进入调试模式,并等待调试器连接. &quot;-s&quot;选项表示在启动时打开一个GDB服务器,监听本地的1234端口.这个选项与&quot;-S&quot;选项一起使用,用于配合调试器进行调试</p><blockquote><p>如果没有冲突的话默认使用 1234 端口即可, 否则添加 <code>-gdb tcp::12345</code> 进行端口调整</p></blockquote><ul><li>你可以在一个终端中在 workspace 目前下使用 <code>make qemu</code>, 此时运行会卡住</li></ul><ul><li>然后再另一个终端中在 linux6.6 目前下使用 <code>gdb vmlinux</code> 调试<p>进入gdb后连接1234端口</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">gdb</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token ID">target</span><span class="Token SPACE"> </span><span class="Token ID">remote</span><span class="Token SPACE"> </span><span class="Token COLON">:</span><span class="Token NUMBER">1234</span></code></pre><p>在start_kernel处打一个断点(此函数位于init/main.c), 然后继续</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">gdb</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token ID">b</span><span class="Token SPACE"> </span><span class="Token ID">start_kernel</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">gdb</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token ID">c</span></code></pre></li></ul><p>当然, 这种方法很原始, 笔者更倾向于使用带 GUI 的更加方便的vscode来进行调试</p><h3 id="h3-7">生成 compile_commands.json</h3><p>首先阅读代码的时候没有什么智能提示和补全, 这是因为需要生成智能补全的头文件, 高版本的内核提供了一个脚本就可以直接得到 <code>compile_commands.json</code></p><pre class="language-shell"><code><span class="Token Program ID">python3</span><span class="Token SPACE"> </span><span class="Token PATH">./scripts/clang-tools/gen_compile_commands.py</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># 如果是老版本linux这个文件的位置在</span><span class="Token LF">
</span><span class="Token Program ID">python3</span><span class="Token SPACE"> </span><span class="Token PATH">./scripts/gen_compile_commands.py</span></code></pre><p>等待一段时间运行结束之后得到 <code>compile_commands.json</code></p><p>如果没有找到这个脚本可以使用 <a href="https://github.com/rizsotto/Bear" target="_blank">Bear</a> 来在编译时生成脚本</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">bear</span><span class="Token LF">
</span><span class="Token Program ID">bear</span><span class="Token SPACE"> </span><span class="Token OPTION">--</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">之前的</span><span class="Token SPACE"> </span><span class="Token ID">make</span><span class="Token SPACE"> </span><span class="Token ID">命令</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token LF">
</span><span class="Token COMMENT"># bear -- make -j`nproc`</span></code></pre><p>如果是使用微软的C++插件, 新建 <code>.vscode/c_cpp_properties.json</code>, 这里的compileCommands添加补全的路径</p><pre class="language-json"><code><span class="Token Object BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Object LF">
</span><span class="Token Object SPACE">    </span><span class="Token String Key Pair STRING">&quot;configurations&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Array Pair LF">
</span><span class="Token Array Pair SPACE">        </span><span class="Token Object BraceDepth-2 LCURLY_BRACE">{</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;name&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;Linux&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;includePath&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Array Pair LF">
</span><span class="Token Array Pair SPACE">                </span><span class="Token String STRING">&quot;${workspaceFolder}/**&quot;</span><span class="Token String LF">
</span><span class="Token String SPACE">            </span><span class="Token Array Pair BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;defines&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Array Pair BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;compilerPath&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;/usr/bin/gcc&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;cStandard&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;c17&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;cppStandard&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;gnu++14&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;intelliSenseMode&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;linux-gcc-x64&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;compileCommands&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;${workspaceFolder}/compile_commands.json&quot;</span><span class="Token String Pair LF">
</span><span class="Token String Pair SPACE">        </span><span class="Token Object BraceDepth-2 RCURLY_BRACE">}</span><span class="Token Object LF">
</span><span class="Token Object SPACE">    </span><span class="Token Array Pair BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">    </span><span class="Token String Key Pair STRING">&quot;version&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Number Pair NUMBER">4</span><span class="Token Number Pair LF">
</span><span class="Token Object BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>如果是 clangd, 新建 <code>.vscode/settings.json</code></p><pre class="language-json"><code><span class="Token Object BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Object LF">
</span><span class="Token Object SPACE">    </span><span class="Token String Key Pair STRING">&quot;clangd.arguments&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Array Pair LF">
</span><span class="Token Array Pair SPACE">        </span><span class="Token String STRING">&quot;--query-driver=/usr/bin/gcc&quot;</span><span class="Token Array Pair COMMA">,</span><span class="Token Array Pair LF">
</span><span class="Token Array Pair SPACE">        </span><span class="Token String STRING">&quot;--compile-commands-dir=${workspaceFolder}&quot;</span><span class="Token String LF">
</span><span class="Token String SPACE">    </span><span class="Token Array Pair BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token Array Pair LF">
</span><span class="Token Object BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>对于 clangd 来说, 还是会有一些报错如下所示, 这是因为 compile_commands.json 中的编译选项有一些无法识别的东西</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230518140756.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230518140756.png" alt="20230518140756"></a></p><p>笔者目前的解决办法是手动将这个文件中的这几个编译选项删除</p><pre class="language-txt"><code><span class="Token MINUS">-</span><span class="Token ID">mpreferred</span><span class="Token MINUS">-</span><span class="Token ID">stack</span><span class="Token MINUS">-</span><span class="Token ID">boundary</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token MINUS">-</span><span class="Token ID">mindirect</span><span class="Token MINUS">-</span><span class="Token ID">branch</span><span class="Token ASSIGN">=</span><span class="Token ID">thunk</span><span class="Token MINUS">-</span><span class="Token ID">extern</span><span class="Token LF">
</span><span class="Token MINUS">-</span><span class="Token ID">mindirect</span><span class="Token MINUS">-</span><span class="Token ID">branch</span><span class="Token MINUS">-</span><span class="Token ID">register</span><span class="Token LF">
</span><span class="Token MINUS">-</span><span class="Token ID">mindirect</span><span class="Token MINUS">-</span><span class="Token ID">branch</span><span class="Token MINUS">-</span><span class="Token ID">cs</span><span class="Token MINUS">-</span><span class="Token ID">prefix</span><span class="Token LF">
</span><span class="Token MINUS">-</span><span class="Token ID">fno</span><span class="Token MINUS">-</span><span class="Token ID">allow</span><span class="Token MINUS">-</span><span class="Token ID">store</span><span class="Token MINUS">-</span><span class="Token ID">data</span><span class="Token MINUS">-</span><span class="Token ID">races</span><span class="Token LF">
</span><span class="Token MINUS">-</span><span class="Token ID">fconserve</span><span class="Token MINUS">-</span><span class="Token ID">stack</span></code></pre><p>使用如下命令直接修改 <code>compile_commands.json</code></p><pre class="language-shell"><code><span class="Token Program ID">sed</span><span class="Token SPACE"> </span><span class="Token OPTION">-i</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token PATH">s/</span><span class="Token BACK_SLASH">\</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token OPTION">-mpreferred-stack-boundary</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">3</span><span class="Token BACK_SLASH">\</span><span class="Token PIPE">|</span><span class="Token OPTION">-mindirect-branch</span><span class="Token ASSIGN">=</span><span class="Token Program ID">thunk-extern</span><span class="Token BACK_SLASH">\</span><span class="Token PIPE">|</span><span class="Token OPTION">-mindirect-branch-register</span><span class="Token BACK_SLASH">\</span><span class="Token PIPE">|</span><span class="Token OPTION">-mindirect-branch-cs-prefix</span><span class="Token BACK_SLASH">\</span><span class="Token PIPE">|</span><span class="Token OPTION">-fno-allow-store-data-races</span><span class="Token BACK_SLASH">\</span><span class="Token PIPE">|</span><span class="Token OPTION">-fconserve-stack</span><span class="Token BACK_SLASH">\</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token Program PATH">//g</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">compile_commands.json</span></code></pre><p>然后就没有报错了, 整个代码看起来很清爽</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230518224144.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230518224144.png" alt="20230518224144"></a></p><p>考虑到其他内核版本可能使用了不同的编译选项, 读者可以根据 clangd 的提示信息从中删除或修改对应的内容</p><pre class="language-shell"><code><span class="Token Program ID">sed</span><span class="Token SPACE"> </span><span class="Token OPTION">-i</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token PATH">s/your</span><span class="Token SPACE"> </span><span class="Token ID">warnning</span><span class="Token SPACE"> </span><span class="Token PATH">command//g</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">compile_commands.json</span></code></pre><hr><p>接下来配置调试程序, 新建<code>.vscode/launch.json</code>, 复制如下的代码, 设置调试的名称是 <code>qemu-kernel-gdb</code>, 使用本机的1234端口映射, 调试 vmlinux 文件</p><pre class="language-json"><code><span class="Token Object BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Object LF">
</span><span class="Token Object SPACE">    </span><span class="Token String Key Pair STRING">&quot;version&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;0.2.0&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">    </span><span class="Token String Key Pair STRING">&quot;configurations&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Array Pair LF">
</span><span class="Token Array Pair SPACE">        </span><span class="Token Object BraceDepth-2 LCURLY_BRACE">{</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;name&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;qemu-kernel-gdb&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;type&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;cppdbg&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;request&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;launch&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;miDebuggerServerAddress&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;127.0.0.1:1234&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;program&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;${workspaceFolder}/vmlinux&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;args&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Array Pair BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;stopAtEntry&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Keyword Pair FALSE">false</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;cwd&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;${workspaceFolder}&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;environment&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Array Pair BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;externalConsole&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Keyword Pair FALSE">false</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;logging&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Object Pair BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Object Pair LF">
</span><span class="Token Object Pair SPACE">                </span><span class="Token String Key Pair STRING">&quot;engineLogging&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Keyword Pair FALSE">false</span><span class="Token Keyword Pair LF">
</span><span class="Token Keyword Pair SPACE">            </span><span class="Token Object Pair BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;MIMode&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;gdb&quot;</span><span class="Token String Pair LF">
</span><span class="Token String Pair SPACE">        </span><span class="Token Object BraceDepth-2 RCURLY_BRACE">}</span><span class="Token Object LF">
</span><span class="Token Object SPACE">    </span><span class="Token Array Pair BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token Array Pair LF">
</span><span class="Token Object BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>至此已经全部结束了, 试着在 <code>init/main.c</code> 中搜索 <code>start_kernel</code>, 在下面打一个断点试试?</p><p>在目录 workspace 下执行 <code>make debug</code> 开启 qemu 模拟, 并把内核的调试信息通过 1234 端口转发出去, 然后点击 vscode 的调试以连接 1234 端口使用 gdb 调试</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230518224436.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230518224436.png" alt="20230518224436"></a></p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230518224610.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230518224610.png" alt="20230518224610"></a></p><h2 id="h2-8">gdb config</h2><p>gdb 还有一些其他的配置选项, 您可以创建 <code>.gdbinit</code> 文件(参考 xv6) 来辅助调试, 比如说如果要调试一个 i386 的 kernel, 需要额外添加一些 gdb 的配置信息 <code>set archi i386:x86-64</code></p><blockquote><p>上述情况是指使用 <code>qemu-system-x86_64</code> 来调试 <code>x86</code> 内核的情况, 需要指定 archi 为 <code>i386</code>, 如果是使用 <code>qemu-system-i386</code> 来调试 <code>x86</code> 则不需要添加信息</p></blockquote><pre class="language-json"><code><span class="Token Object BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Object LF">
</span><span class="Token Object SPACE">    </span><span class="Token String Key Pair STRING">&quot;version&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;0.2.0&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">    </span><span class="Token String Key Pair STRING">&quot;configurations&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Array Pair LF">
</span><span class="Token Array Pair SPACE">        </span><span class="Token Object BraceDepth-2 LCURLY_BRACE">{</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;name&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;qemu-kernel-gdb&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;type&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;cppdbg&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;request&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;launch&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;miDebuggerServerAddress&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;127.0.0.1:1234&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;program&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;${workspaceFolder}/vmlinux&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;args&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Array Pair BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;stopAtEntry&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Keyword Pair FALSE">false</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;cwd&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;${workspaceFolder}&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;environment&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Array Pair BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;externalConsole&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Keyword Pair FALSE">false</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;logging&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Object Pair BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Object Pair LF">
</span><span class="Token Object Pair SPACE">                </span><span class="Token String Key Pair STRING">&quot;engineLogging&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Keyword Pair FALSE">false</span><span class="Token Keyword Pair LF">
</span><span class="Token Keyword Pair SPACE">            </span><span class="Token Object Pair BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;MIMode&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;gdb&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token String Key Pair STRING">&quot;setupCommands&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Array Pair BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Array Pair LF">
</span><span class="Token Array Pair SPACE">                </span><span class="Token Object BraceDepth-1 LCURLY_BRACE">{</span><span class="Token Object LF">
</span><span class="Token Object SPACE">                    </span><span class="Token String Key Pair STRING">&quot;description&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;Enable pretty-printing for gdb&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">                    </span><span class="Token String Key Pair STRING">&quot;text&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;-enable-pretty-printing&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">                    </span><span class="Token String Key Pair STRING">&quot;ignoreFailures&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Keyword Pair TRUE">true</span><span class="Token Keyword Pair LF">
</span><span class="Token Keyword Pair SPACE">                </span><span class="Token Object BraceDepth-1 RCURLY_BRACE">}</span><span class="Token Array Pair COMMA">,</span><span class="Token Array Pair LF">
</span><span class="Token Array Pair SPACE">                </span><span class="Token Object BraceDepth-1 LCURLY_BRACE">{</span><span class="Token Object LF">
</span><span class="Token Object SPACE">                    </span><span class="Token String Key Pair STRING">&quot;description&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;Set debuggee architecture&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">                    </span><span class="Token String Key Pair STRING">&quot;text&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token String Pair STRING">&quot;set archi i386:x86-64&quot;</span><span class="Token Object COMMA">,</span><span class="Token Object LF">
</span><span class="Token Object SPACE">                    </span><span class="Token String Key Pair STRING">&quot;ignoreFailures&quot;</span><span class="Token Pair COLON">:</span><span class="Token Pair SPACE"> </span><span class="Token Keyword Pair TRUE">true</span><span class="Token Keyword Pair LF">
</span><span class="Token Keyword Pair SPACE">                </span><span class="Token Object BraceDepth-1 RCURLY_BRACE">}</span><span class="Token Object LF">
</span><span class="Token Object SPACE">            </span><span class="Token Array Pair BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Array Pair LF">
</span><span class="Token Array Pair SPACE">        </span><span class="Token Object BraceDepth-2 RCURLY_BRACE">}</span><span class="Token Object LF">
</span><span class="Token Object SPACE">    </span><span class="Token Array Pair BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token Array Pair LF">
</span><span class="Token Object BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p><a href="https://github.com/microsoft/vscode/issues/45097" target="_blank">targetArchitecture in launch.json not working</a></p></blockquote><h2 id="h2-9">参考</h2><ul><li><a href="https://howardlau.me/programming/debugging-linux-kernel-with-vscode-qemu.html" target="_blank">使用 VSCode + qemu 搭建 Linux 内核调试环境</a></li></ul><ul><li><a href="https://www.yuque.com/wwyf/blog/og2h3r" target="_blank">如何舒服地调试 Linux 内核</a></li></ul><ul><li><a href="https://www.bilibili.com/video/BV1dY411f75B" target="_blank">[Linux Kernel] 通过 VS Code 和 QEMU 调试 Linux 内核(QEMU;GDB;VS Code;Linux)</a></li></ul><ul><li><a href="https://unix.stackexchange.com/questions/122100/why-do-i-need-initramfs" target="_blank">为什么需要 initramfs</a></li></ul><ul><li><a href="https://www.kernel.org/doc/Documentation/filesystems/ramfs-rootfs-initramfs.txt" target="_blank">kernel ramfs-rootfs-initramfs.txt</a></li></ul><ul><li><a href="https://wiki.gentoo.org/wiki/Custom_Initramfs" target="_blank">gentoo wiki initramfs</a></li></ul><ul><li><a href="https://nickdesaulniers.github.io/blog/2018/10/24/booting-a-custom-linux-kernel-in-qemu-and-debugging-it-with-gdb/" target="_blank">booting-a-custom-linux-kernel-in-qemu-and-debugging-it-with-gdb</a></li></ul><ul><li><a href="https://consen.github.io/2018/01/17/debug-linux-kernel-with-qemu-and-gdb/" target="_blank">debug-linux-kernel-with-qemu-and-gdb</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../快速开始/编译内核" >快速开始</a><ul><li><a href="../../快速开始/编译内核" >编译内核</a></li></ul><ul><li><a href="../../快速开始/调试内核" >调试内核</a></li></ul><ul><li><a href="../../快速开始/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../快速开始/邮件订阅" >邮件订阅</a></li></ul><ul><li><a href="../../快速开始/patch" >patch</a></li></ul></li></ul><ul><li><a href="../../mm/detect" >mm</a><ul><li><a href="../../mm/detect" >detect</a></li></ul><ul><li><a href="../../mm/va_trans" >va_trans</a></li></ul><ul><li><a href="../../mm/numa" >numa</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab" >slab</a></li></ul><ul><li><a href="../../mm/compaction" >compaction</a></li></ul><ul><li><a href="../../mm/tier" >tier</a></li></ul><ul><li><a href="../../mm/migration" >migration</a></li></ul><ul><li><a href="../../mm/mm_struct" >mm_struct</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul><ul><li><a href="../../fs/filesystem" >filesystem</a></li></ul><ul><li><a href="../../fs/fd" >fd</a></li></ul><ul><li><a href="../../fs/inode" >inode</a></li></ul><ul><li><a href="../../fs/directory" >directory</a></li></ul><ul><li><a href="../../fs/disk-layout" >disk-layout</a></li></ul><ul><li><a href="../../fs/mount" >mount</a></li></ul><ul><li><a href="../../fs/vfs" >vfs</a></li></ul><ul><li><a href="../../fs/ext4" >ext4</a></li></ul><ul><li><a href="../../fs/fuse" >fuse</a></li></ul><ul><li><a href="../../fs/distribute-fs" >distribute-fs</a></li></ul></li></ul><ul><li><a href="../../runtime/proc" >runtime</a><ul><li><a href="../../runtime/proc" >proc</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul><ul><li><a href="../../runtime/elf_format" >elf_format</a></li></ul><ul><li><a href="../../runtime/elf_loader" >elf_loader</a></li></ul><ul><li><a href="../../runtime/ld" >ld</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul><ul><li><a href="../../kernel/rcu" >rcu</a></li></ul><ul><li><a href="../../kernel/workqueue" >workqueue</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cc" >cc</a></li></ul><ul><li><a href="../../arch/mc" >mc</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/interrupt" >interrupt</a></li></ul></li></ul><ul><li><a href="../../proc/schedule" >proc</a><ul><li><a href="../../proc/schedule" >schedule</a></li></ul><ul><li><a href="../../proc/nice" >nice</a></li></ul><ul><li><a href="../../proc/manage" >manage</a></li></ul><ul><li><a href="../../proc/signal" >signal</a></li></ul><ul><li><a href="../../proc/cgroup" >cgroup</a></li></ul><ul><li><a href="../../proc/task_struct" >task_struct</a></li></ul><ul><li><a href="../../proc/rb-tree" >rb-tree</a></li></ul></li></ul><ul><li><a href="../../device/io" >device</a><ul><li><a href="../../device/io" >io</a></li></ul><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul><ul><li><a href="../../device/driver" >driver</a></li></ul><ul><li><a href="../../device/io_uring" >io_uring</a></li></ul></li></ul><ul><li><a href="../../others/safety" >others</a><ul><li><a href="../../others/safety" >safety</a></li></ul><ul><li><a href="../../others/Q&A" >Q&A</a></li></ul></li></ul><ul><li><a href="../../driver/intro" >driver</a><ul><li><a href="../../driver/intro" >intro</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../快速开始/编译内核","../../快速开始/制作linux发行版","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>