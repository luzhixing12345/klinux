<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/tree.css /><link rel='stylesheet' href=../../../css/txt.css /><link rel='stylesheet' href=../../../css/x86asm.css /><link rel='stylesheet' href=../../../css/yaml.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">安装内核与救火</a><ul><li><a href="#h2-1">安装内核</a></li></ul><ul><li><a href="#h2-2">安装到其他目录</a></li></ul><ul><li><a href="#h2-3">为其他机器安装</a><ul><li><a href="#h3-4">.config</a></li></ul><ul><li><a href="#h3-5">Ubuntu 替换内核</a></li></ul></li></ul><ul><li><a href="#h2-6">深入initramfs</a><ul><li><a href="#h3-7">initrd和initramfs</a></li></ul><ul><li><a href="#h3-8">ubuntu /init</a></li></ul></li></ul><ul><li><a href="#h2-9">替换内核</a></li></ul><ul><li><a href="#h2-10">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">安装内核与救火</h1><blockquote style="border-left-color: #1a7f37; background-color: #e5f6ea;"><div style="color: #1a7f37;"><img class="icon-tip" loading="lazy" src="../../../img/tip.svg" alt="[!TIP]"> TIP </div><p> 本文适用于希望在物理机器上安装使用新内核的情况，记录一些笔者遇到过的问题。如果读者只是通过 qemu 模拟器进行内核学习并不需要阅读此节</p></blockquote><p>假定读者已经完成<a href="../../快速开始/编译内核" target="_self">编译内核</a>并且成功得到了一个属于自己独立编译出来的 linux kernel，拿到新玩具当然要试一试啦，接下来希望可以在机器安装使用我们的新内核</p><h2 id="h2-1">安装内核</h2><p>仅安装内核是不够的，相信读者在编译的时候一定注意到了很多带有 [M] 的信息，它表示代码会被编译为内核模块而并不是直接被编译进内核，他往往需要在内核启动之后才会被装载(insmod)到内核</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">make</span><span class="Token SPACE"> </span><span class="Token ID">modules_install</span></code></pre><p>编译好的模块会被 cp 到 <code>/lib/modules/</code> 下，实际上内核大量的代码都是内核模块的形式（各种驱动），包括 USB 驱动，硬盘网卡设备驱动等等等等，这些驱动对于一个真实的系统来说是必不可少的</p><p>安装内核，install 不会替换掉原有的内核, 只会将内核以及符号表等放到 <code>/boot</code> 目录下, 并更新 <code>/boot/grub/grub.cfg</code></p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">make</span><span class="Token SPACE"> </span><span class="Token ID">install</span></code></pre><p>更新 grub 启动项</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">update-grub</span></code></pre><p>如果要使用新的内核只需要重启电脑然后进入 GRUB 中选择新的内核版本即可</p><blockquote><p>如果使用真机的话长按 <kbd>F12</kbd>, 如果是 Vmware 的话长按 shift 进入 grub, 对于 Ubuntu 来说选择第二个 <code>Advanced options for Ubuntu</code></p></blockquote><h2 id="h2-2">安装到其他目录</h2><p>或者额外新建两个目录, 分别用于保存安装内核所需的文件和所有的模块</p><pre class="language-shell"><code><span class="Token ID">mkdir</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token LF">
</span><span class="Token ID">mkdir</span><span class="Token SPACE"> </span><span class="Token ID">modules</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">make</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">INSTALL_PATH</span><span class="Token ASSIGN">=</span><span class="Token ID">install/</span><span class="Token LF">
</span><span class="Token ID">make</span><span class="Token SPACE"> </span><span class="Token ID">modules_install</span><span class="Token SPACE"> </span><span class="Token ID">INSTALL_MOD_PATH</span><span class="Token ASSIGN">=</span><span class="Token ID">modules/</span></code></pre><p>其中 install/ 下保存着内核文件 <code>vmlinuz-6.6.0</code>, 系统符号表 <code>System.map-6.6.0</code>(并非 Linux 启动所必须的) 和编译内核的配置文件 <code>config-6.6.0</code></p><p>modules/ 下保存着所有的模块, 它们可以在内核启动之后通过 insmod 动态的加载到内核中</p><h2 id="h2-3">为其他机器安装</h2><h3 id="h3-4">.config</h3><p>按照上述说明编译后的内核可能会很大, 笔者编译的 linux6.6 已经有 300+ MB 的 vmlinux 和 12MB 的 bzImage 了。但大部分情况下我们并不需要 kernel 全部的功能, 因此可以在基础之上做一些内核的裁剪</p><blockquote><p>这一步并不是必要的, 视个人情况而定, 很难讲怎么样是最好的</p></blockquote><p>内核配置信息比较复杂, 笔者这里按经验总结了一些 <a href="https://github.com/luzhixing12345/klinux/releases/tag/v0.0.2" target="_blank">linux6.6 内核配置文件</a>, 适用于 linux6.6 版本</p><p>读者可以根据需要直接下载对应的文件, 即跳过前面的 make menuconfig 的部分, 直接使用现成的 .config 配置文件。可以关闭一些诸如 文件系统支持, 设备驱动, 无线网络支持, USB 支持, 图形支持, 声音等。具体见 realease 中的信息</p><p>如果希望给你的内核起一个名字, 可以修改 CONFIG_LOCALVERSION, 该内容会加在内核版本之后</p><pre class="language-txt"><code><span class="Token ID">CONFIG_LOCALVERSION</span><span class="Token ASSIGN">=</span><span class="Token QUOTO">&quot;</span><span class="Token QUOTO">&quot;</span></code></pre><h3 id="h3-5">Ubuntu 替换内核</h3><p>大部分编译的内核由于没有驱动等支持, 所以只能在虚拟机上启动, 没有办法在真机启动 ubuntu. 如果希望在真机(ubuntu)启动可以下载提供 <a href="https://github.com/luzhixing12345/klinux/releases/tag/v0.0.2" target="_blank">linux6.6 内核配置文件</a> 中的 ubuntu.config 并打包为 deb</p><p>打包完成后会在上级目录生成一些文件, 启动 *.deb 文件是我们需要的, 安装 headers 和 image</p><pre class="language-shell"><code><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">dpkg</span><span class="Token SPACE"> </span><span class="Token OPTION">-i</span><span class="Token SPACE"> </span><span class="Token ID">linux-headers-6.6.0+_6.6.0-ga472b7d4a578-12_amd64.deb</span><span class="Token LF">
</span><span class="Token ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">dpkg</span><span class="Token SPACE"> </span><span class="Token OPTION">-i</span><span class="Token SPACE"> </span><span class="Token ID">linux-image-6.6.0+_6.6.0-ga472b7d4a578-12_amd64.deb</span></code></pre><p>此时会将 vmlinuz initrd.img config 等安装到 /boot 下, 可以使用如下 switch_kernel.sh 脚本替换内核, 可以输入需要选择内核, 此脚本将会自动修改 grub 配置并将该内核设为默认启动项</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240916222355.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240916222355.png" alt="20240916222355" class="pic-big"></a></p><pre class="language-shell"><code><span class="Token COMMENT">#!/bin/bash</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Check if the script is run as root</span><span class="Token LF">
</span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$(id -u)&quot;</span><span class="Token SPACE"> </span><span class="Token OPTION">-ne</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;0&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword THEN">then</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;This script must be run as root&quot;</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token AMPERSAND">&amp;</span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">exit</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token Keyword FI">fi</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Define the directory where the kernel images are stored</span><span class="Token LF">
</span><span class="Token ID">KERNEL_DIR</span><span class="Token ASSIGN">=</span><span class="Token String STRING">&quot;/boot&quot;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># List available kernel versions and assign a number to each</span><span class="Token LF">
</span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Available kernel versions:&quot;</span><span class="Token LF">
</span><span class="Token ID">kernels</span><span class="Token ASSIGN">=</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token ID">ls</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-2 LCURLY_BRACE">{</span><span class="Token ID">KERNEL_DIR</span><span class="Token BraceDepth-2 RCURLY_BRACE">}</span><span class="Token DIV">/</span><span class="Token ID">vmlinuz-</span><span class="Token MUL">*</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token ID">count</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Keyword FOR">for</span><span class="Token SPACE"> </span><span class="Token ID">kernel</span><span class="Token SPACE"> </span><span class="Token Keyword IN">in</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${kernels[@]}&quot;</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword DO">do</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">kernel_version</span><span class="Token ASSIGN">=</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token ID">kernel</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">sed</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">s/.</span><span class="Token MUL">*</span><span class="Token BACK_SLASH">\</span><span class="Token DIV">/</span><span class="Token ID">vmlinuz-//</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;[$count]: $kernel_version&quot;</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token ID">count++</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token Keyword DONE">done</span><span class="Token LF">
</span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;&quot;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Prompt the user to select a kernel version by number</span><span class="Token LF">
</span><span class="Token ID">read</span><span class="Token SPACE"> </span><span class="Token OPTION">-p</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Enter the number of the kernel version you want to switch to: &quot;</span><span class="Token SPACE"> </span><span class="Token ID">kernel_number</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Check if the input is a number and within the range</span><span class="Token LF">
</span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$kernel_number&quot;</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token TILDE">~</span><span class="Token SPACE"> </span><span class="Token CARET">^</span><span class="Token BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token NUMBER">0</span><span class="Token MINUS">-</span><span class="Token NUMBER">9</span><span class="Token BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token PLUS">+</span><span class="Token DOLLAR">$</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$kernel_number&quot;</span><span class="Token SPACE"> </span><span class="Token OPTION">-lt</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;0&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$kernel_number&quot;</span><span class="Token SPACE"> </span><span class="Token OPTION">-ge</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$count&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword THEN">then</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Invalid selection&quot;</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">exit</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token Keyword FI">fi</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Get the kernel version based on the number</span><span class="Token LF">
</span><span class="Token ID">kernel_version</span><span class="Token ASSIGN">=</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-1 LCURLY_BRACE">{</span><span class="Token ID">kernels</span><span class="Token BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token DOLLAR">$</span><span class="Token ID">kernel_number</span><span class="Token BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token BraceDepth-1 RCURLY_BRACE">}</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">sed</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">s/.</span><span class="Token MUL">*</span><span class="Token BACK_SLASH">\</span><span class="Token DIV">/</span><span class="Token ID">vmlinuz-//</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Switching to kernel version: $kernel_version&quot;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Check if the selected kernel version exists</span><span class="Token LF">
</span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token OPTION">-e</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$KERNEL_DIR/vmlinuz-$kernel_version&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword THEN">then</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Kernel version $kernel_version does not exist&quot;</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">exit</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token Keyword FI">fi</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Extract the menu entry for the default kernel</span><span class="Token LF">
</span><span class="Token ID">MID</span><span class="Token ASSIGN">=</span><span class="Token BACKTICK">`</span><span class="Token ID">awk</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token DIV">/</span><span class="Token ID">Advanced</span><span class="Token SPACE"> </span><span class="Token ID">options.</span><span class="Token MUL">*</span><span class="Token DIV">/</span><span class="Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Token ID">print</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token ID">NF-1</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">boot/grub/grub.cfg</span><span class="Token BACKTICK">`</span><span class="Token LF">
</span><span class="Token ID">MID</span><span class="Token ASSIGN">=</span><span class="Token String STRING">&quot;${MID//\&#x27;/}&quot;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">KID</span><span class="Token ASSIGN">=</span><span class="Token BACKTICK">`</span><span class="Token ID">awk</span><span class="Token SPACE"> </span><span class="Token OPTION">-v</span><span class="Token SPACE"> </span><span class="Token ID">kern</span><span class="Token ASSIGN">=</span><span class="Token String STRING">&quot;with Linux $kernel_version&quot;</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token TILDE">~</span><span class="Token SPACE"> </span><span class="Token ID">kern</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token DIV">/</span><span class="Token ID">recovery/</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Token SPACE"> </span><span class="Token ID">print</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token ID">NF</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">boot/grub/grub.cfg</span><span class="Token BACKTICK">`</span><span class="Token LF">
</span><span class="Token ID">KID</span><span class="Token ASSIGN">=</span><span class="Token String STRING">&quot;${KID//\&#x27;/}&quot;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Update GRUB configuration</span><span class="Token LF">
</span><span class="Token ID">sed</span><span class="Token SPACE"> </span><span class="Token OPTION">-i</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;s/GRUB_DEFAULT=.*/GRUB_DEFAULT=\&quot;$MID&gt;$KID\&quot;/&quot;</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">etc/default/grub</span><span class="Token LF">
</span><span class="Token ID">update-grub</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token OPTION">-e</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;\e[31mPlease reboot machine\e[0m&quot;</span></code></pre><h2 id="h2-6">深入initramfs</h2><p>前文<a href="../../快速开始/调试内核" target="_self">调试内核</a>中介绍了 initramfs，这是一个内存文件系统，用于内核启动初期加载一些必要的文件系统驱动。当时笔者构建了一个非常简单的 initramfs 镜像，并使用了一个简单的 init 脚本完成了启动，下面我们学习一下现代 linux 发行版（Ubuntu）的 initramfs 构建和启动过程。</p><h3 id="h3-7">initrd和initramfs</h3><p>查看 /boot 目录我们可以发现在 Ubuntu 中并没有 initramfs.img，而是一个 initrd.img 的文件（以及不同版本的initrd.img）</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">lzx@cxl2</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token ID">ls</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">boot/</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">grep</span><span class="Token SPACE"> </span><span class="Token ID">init</span><span class="Token LF">
</span><span class="Token ID">initrd.img</span><span class="Token LF">
</span><span class="Token ID">initrd.img-6.6.0autonuma+</span><span class="Token LF">
</span><span class="Token ID">initrd.img-6.6.0damon+</span><span class="Token LF">
</span><span class="Token ID">initrd.img-6.6.0vtism+</span><span class="Token LF">
</span><span class="Token ID">initrd.img.old</span></code></pre><p>在 grub 的启动项中我们也可以看到 initrd 参数</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">lzx@cxl2</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token ID">grep</span><span class="Token SPACE"> </span><span class="Token ID">initrd</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">boot/grub/grub.cfg</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">initrd</span><span class="Token SPACE">  </span><span class="Token DIV">/</span><span class="Token ID">boot/initrd.img-6.6.0vtism+</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">initrd</span><span class="Token SPACE">  </span><span class="Token DIV">/</span><span class="Token ID">boot/initrd.img-6.6.0vtism+</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">initrd</span><span class="Token SPACE">  </span><span class="Token DIV">/</span><span class="Token ID">boot/initrd.img-6.6.0vtism+</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">initrd</span><span class="Token SPACE">  </span><span class="Token DIV">/</span><span class="Token ID">boot/initrd.img-6.6.0damon+</span></code></pre><p>在 qemu 的启动项中我们也可以看到 -initrd 参数</p><pre class="language-makefile"><code><span class="Token Mission ID">qemu</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">QEMU</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">KERNEL</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-initrd</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Variable ID">INITRAMFS</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">1G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token STRING">&quot;earlyprintk=serial,ttyS0 console=ttyS0&quot;</span></code></pre><p><b>那么initrd和initramfs有什么关系么？</b> 这其实是一个历史遗留问题。要想解释这个问题需要从根源出发。</p><p>首先需要明确的是 initrd 和 initramfs 是两种不同的解决方案</p><ul><li>initrd 是古早时代的方案，initrd.img 是一个 ext2/minix 格式的镜像，<b>需要内核将 ext2 文件系统编译进内核</b>，内核会将其解压到一个 ramdisk 块设备，挂载后再执行 /init</li></ul><ul><li>initramfs 则是更为现代化的方案，通过制作一个 cpio 格式的压缩包镜像，内核直接解压到内存里的 rootfs，没有 ramdisk，没有块设备，速度更快、实现更简单，<b>现代所有发行版都使用 initramfs</b></li></ul><p>initrd 的首先需要内置一个文件系统驱动（通常是ext2），同时由于 initrd.img 是一个块设备，Linux 的设计理念是缓存所有从块设备读取或写入的文件和目录项，<b>因此 Linux 会将数据从块设备复制到内存中</b>，这也浪费了内存缓存。Initrd 上的所有读写操作都被冗余地缓冲到主内存中。</p><p>相比之下 initramfs 的设计更加简洁轻量，解压 cpio 然后通过 ramfs 加载到内存中</p><blockquote style="border-left-color: #0969da; background-color: #e8f3ff;"><div style="color: #0969da;"><img class="icon-note" loading="lazy" src="../../../img/note.svg" alt="[!NOTE]"> NOTE </div><p> 几年前，Linus Torvalds 提出了一个绝妙的想法：如果 Linux 的缓存可以像文件系统一样挂载会怎么样？只需将文件保存在缓存中，直到被删除或系统重启才会释放它们？Linus 为缓存编写了一个名为“ramfs”的轻量级封装，其他内核开发者创建了一个改进版本，名为“tmpfs”（它可以将数据写入交换空间，并限制给定挂载点的大小，使其在耗尽所有可用内存之前被填满）。Initramfs 是 tmpfs 的一个实例。</p><p>这些基于内存的文件系统会根据数据量自动增长或收缩。向内存文件系统 (ramfs) 添加文件（或扩展现有文件）会自动分配更多内存，而删除或截断文件则会释放这些内存。由于没有块设备，因此块设备和缓存之间不存在数据重复。缓存中的副本是数据的唯一副本。最重要的是，这并非新代码，而是对现有 Linux 缓存代码的新应用，这意味着它几乎不增加任何体积，非常简单，并且基于经过充分测试的基础架构。</p></blockquote><p>「所以为什么还会在 Ubuntu 中看到已经被抛弃的 initrd 呢？」这只是一个历史遗留的命名问题。在非常早的 Linux（2.4 时代）中确实使用的是 initrd，当后来的 Linux 切换到 initramfs 机制后，很多发行版（包括 Ubuntu 和 Debian）为了保持命名稳定不改文件名，继续使用 initrd.img 的名称，但内部内容已经不是 initrd，而是 cpio 的 initramfs</p><pre class="language-shell"><code><span class="Token DOLLAR">$</span><span class="Token SPACE"> </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">boot/initrd.img-</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">uname</span><span class="Token SPACE"> </span><span class="Token OPTION">-r</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token DIV">/</span><span class="Token ID">boot/initrd.img-6.6.0vtism+:</span><span class="Token SPACE"> </span><span class="Token ID">ASCII</span><span class="Token SPACE"> </span><span class="Token ID">cpio</span><span class="Token SPACE"> </span><span class="Token ID">archive</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">SVR4</span><span class="Token SPACE"> </span><span class="Token ID">with</span><span class="Token SPACE"> </span><span class="Token ID">no</span><span class="Token SPACE"> </span><span class="Token ID">CRC</span><span class="Token BraceDepth-0 RPAREN">)</span></code></pre><p>简单来说为了兼容老的脚本，配置文件，文档，所以没有改名字，依然叫 initrd，不过其实已经都是 initramfs 的格式了(cpio)。GRUB、update-initramfs、initramfs-tools 的体系从 Debian 系诞生以来就使用，如果改动名字的话所有依赖这个路径的脚本都会被破坏，所以保持旧名称最安全。</p><p>GRUB 自己不会解析 initrd/initramfs 的内部格式，它只是把文件读进内存，然后调用内核参数</p><pre class="language-shell"><code><span class="Token ID">initrd</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">hd0</span><span class="Token COMMA">,</span><span class="Token NUMBER">1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token DIV">/</span><span class="Token ID">boot/initrd.img-</span><span class="Token MUL">*</span></code></pre><blockquote><p>qemu 同样如此，也是通过 initrd 参数传递给内核</p></blockquote><p>内核会根据文件的魔数判断：</p><ul><li>如果文件类型是 ext2 → 把它作为 initrd（旧方式）</li></ul><ul><li>如果文件类型是 cpio → 作为 initramfs 解包到 rootfs</li></ul><p>所以名字无论是什么，都不影响内核的判定。</p><h3 id="h3-8">ubuntu /init</h3><p>initrd 和压缩过的内核 vmlinuz 都会保存在 /boot 目录下，可以使用 unmkinitramfs 对 initrd.img 进行解压操作</p><pre class="language-shell"><code><span class="Token ID">mkdir</span><span class="Token SPACE"> </span><span class="Token ID">initrd_root</span><span class="Token LF">
</span><span class="Token Keyword CD">cd</span><span class="Token SPACE"> </span><span class="Token ID">initrd_root</span><span class="Token LF">
</span><span class="Token ID">unmkinitramfs</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">boot/initrd.img-</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">uname</span><span class="Token SPACE"> </span><span class="Token OPTION">-r</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token ID">.</span></code></pre><p>解压后的看到四部分，early/2/3 和 main</p><pre class="language-tree"><code><span class="Token File ID">lzx@cxl2</span><span class="Token COLON">:</span><span class="Token TILDE">~</span><span class="Token DIV">/</span><span class="Token File ID">klinux/initrd_root</span><span class="Token DOLLAR">$</span><span class="Token SPACE"> </span><span class="Token File ID">tree</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token File ID">L</span><span class="Token SPACE"> </span><span class="Token File ID">2</span><span class="Token LF">
</span><span class="Token Dir ID">.</span><span class="Token LF">
</span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Dir ID">early</span><span class="Token LF">
</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token BACKTICK">`</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token File ID">kernel</span><span class="Token LF">
</span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Dir ID">early2</span><span class="Token LF">
</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token BACKTICK">`</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token File ID">kernel</span><span class="Token LF">
</span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Dir ID">early3</span><span class="Token LF">
</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token BACKTICK">`</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token File ID">usr</span><span class="Token LF">
</span><span class="Token BACKTICK">`</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Dir ID">main</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Link ID">bin</span><span class="Token SPACE"> </span><span class="Token POINT">-&gt;</span><span class="Token SPACE"> </span><span class="Token File ID">usr/bin</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token File ID">conf</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token File ID">etc</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token File ID">init</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Link ID">lib</span><span class="Token SPACE"> </span><span class="Token POINT">-&gt;</span><span class="Token SPACE"> </span><span class="Token File ID">usr/lib</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Link ID">lib.usr-is-merged</span><span class="Token SPACE"> </span><span class="Token POINT">-&gt;</span><span class="Token SPACE"> </span><span class="Token File ID">usr/lib.usr-is-merged</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Link ID">lib32</span><span class="Token SPACE"> </span><span class="Token POINT">-&gt;</span><span class="Token SPACE"> </span><span class="Token File ID">usr/lib32</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Link ID">lib64</span><span class="Token SPACE"> </span><span class="Token POINT">-&gt;</span><span class="Token SPACE"> </span><span class="Token File ID">usr/lib64</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Link ID">libexec</span><span class="Token SPACE"> </span><span class="Token POINT">-&gt;</span><span class="Token SPACE"> </span><span class="Token File ID">usr/libexec</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Link ID">libx32</span><span class="Token SPACE"> </span><span class="Token POINT">-&gt;</span><span class="Token SPACE"> </span><span class="Token File ID">usr/libx32</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token File ID">run</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Link ID">sbin</span><span class="Token SPACE"> </span><span class="Token POINT">-&gt;</span><span class="Token SPACE"> </span><span class="Token File ID">usr/sbin</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token File ID">scripts</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token File ID">usr</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token SPACE"> </span><span class="Token BACKTICK">`</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token File ID">var</span></code></pre><pre class="language-shell"><code><span class="Token COMMENT">#!/bin/sh</span><span class="Token LF">
</span><span class="Token Keyword EXPORT">export</span><span class="Token SPACE"> </span><span class="Token ID">PATH</span><span class="Token ASSIGN">=</span><span class="Token DIV">/</span><span class="Token ID">usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">mkdir</span><span class="Token SPACE"> </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">0755</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">root</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">mkdir</span><span class="Token SPACE"> </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">0700</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">root</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">sys</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">mkdir</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">sys</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">proc</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">mkdir</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">proc</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">tmp</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">mkdir</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">tmp</span><span class="Token LF">
</span><span class="Token ID">mkdir</span><span class="Token SPACE"> </span><span class="Token OPTION">-p</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">var/lock</span><span class="Token LF">
</span><span class="Token ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-t</span><span class="Token SPACE"> </span><span class="Token ID">sysfs</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">nodev</span><span class="Token COMMA">,</span><span class="Token ID">noexec</span><span class="Token COMMA">,</span><span class="Token ID">nosuid</span><span class="Token SPACE"> </span><span class="Token ID">sysfs</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">sys</span><span class="Token LF">
</span><span class="Token ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-t</span><span class="Token SPACE"> </span><span class="Token ID">proc</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">nodev</span><span class="Token COMMA">,</span><span class="Token ID">noexec</span><span class="Token COMMA">,</span><span class="Token ID">nosuid</span><span class="Token SPACE"> </span><span class="Token ID">proc</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">proc</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Note that this only becomes /dev on the real filesystem if udev&#x27;s scripts</span><span class="Token LF">
</span><span class="Token COMMENT"># are used; which they will be, but it&#x27;s worth pointing out</span><span class="Token LF">
</span><span class="Token ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-t</span><span class="Token SPACE"> </span><span class="Token ID">devtmpfs</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">nosuid</span><span class="Token COMMA">,</span><span class="Token ID">mode</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">0755</span><span class="Token SPACE"> </span><span class="Token ID">udev</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Prepare the /dev directory</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/fd</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token ID">ln</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">proc/self/fd</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/fd</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/stdin</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token ID">ln</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">proc/self/fd/0</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/stdin</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/stdout</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token ID">ln</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">proc/self/fd/1</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/stdout</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/stderr</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token ID">ln</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">proc/self/fd/2</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/stderr</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">mkdir</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/pts</span><span class="Token LF">
</span><span class="Token ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-t</span><span class="Token SPACE"> </span><span class="Token ID">devpts</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">noexec</span><span class="Token COMMA">,</span><span class="Token ID">nosuid</span><span class="Token COMMA">,</span><span class="Token ID">gid</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">5</span><span class="Token COMMA">,</span><span class="Token ID">mode</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">0620</span><span class="Token SPACE"> </span><span class="Token ID">devpts</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">dev/pts</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token ID">true</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Export the dpkg architecture</span><span class="Token LF">
</span><span class="Token Keyword EXPORT">export</span><span class="Token SPACE"> </span><span class="Token ID">DPKG_ARCH</span><span class="Token ASSIGN">=</span><span class="Token LF">
</span><span class="Token ID">.</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">conf/arch.conf</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Set modprobe env</span><span class="Token LF">
</span><span class="Token Keyword EXPORT">export</span><span class="Token SPACE"> </span><span class="Token ID">MODPROBE_OPTIONS</span><span class="Token ASSIGN">=</span><span class="Token String STRING">&quot;-qb&quot;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Export relevant variables</span><span class="Token LF">
</span><span class="Token Keyword EXPORT">export</span><span class="Token SPACE"> </span><span class="Token ID">init</span><span class="Token ASSIGN">=</span><span class="Token DIV">/</span><span class="Token ID">sbin/init</span><span class="Token LF">
</span><span class="Token Keyword EXPORT">export</span><span class="Token SPACE"> </span><span class="Token ID">readonly</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token Keyword EXPORT">export</span><span class="Token SPACE"> </span><span class="Token ID">rootmnt</span><span class="Token ASSIGN">=</span><span class="Token DIV">/</span><span class="Token ID">root</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># mdadm needs hostname to be set. This has to be done before the udev rules are called!</span><span class="Token LF">
</span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token OPTION">-f</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;/etc/hostname&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword THEN">then</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token DIV">/</span><span class="Token ID">bin/hostname</span><span class="Token SPACE"> </span><span class="Token OPTION">-F</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">etc/hostname</span><span class="Token SPACE"> </span><span class="Token REDIRECT_TO">&gt;</span><span class="Token DIV">/</span><span class="Token ID">dev/null</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token AMPERSAND">&amp;</span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token Keyword FI">fi</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Parse command line options</span><span class="Token LF">
</span><span class="Token COMMENT"># shellcheck disable=SC2013</span><span class="Token LF">
</span><span class="Token Keyword FOR">for</span><span class="Token SPACE"> </span><span class="Token ID">x</span><span class="Token SPACE"> </span><span class="Token Keyword IN">in</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">cat</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">proc/cmdline</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword DO">do</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">case</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token ID">x</span><span class="Token SPACE"> </span><span class="Token Keyword IN">in</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">init</span><span class="Token ASSIGN">=</span><span class="Token MUL">*</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token ID">init</span><span class="Token ASSIGN">=</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Token ID">x</span><span class="Token COMMENT">#init=}</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token SEMI">;</span><span class="Token SEMI">;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">root</span><span class="Token ASSIGN">=</span><span class="Token MUL">*</span><span class="Token RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token ID">ROOT</span><span class="Token ASSIGN">=</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Token ID">x</span><span class="Token COMMENT">#root=}</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token OPTION">-z</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${BOOT}&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$ROOT&quot;</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;/dev/nfs&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword THEN">then</span><span class="Token LF">
</span><span class="Token SPACE">                        </span><span class="Token ID">BOOT</span><span class="Token ASSIGN">=</span><span class="Token ID">nfs</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token Keyword FI">fi</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token SEMI">;</span><span class="Token SEMI">;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">esac</span><span class="Token LF">
</span><span class="Token Keyword DONE">done</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Default to BOOT=local if no boot script defined.</span><span class="Token LF">
</span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token OPTION">-z</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${BOOT}&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword THEN">then</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">BOOT</span><span class="Token ASSIGN">=</span><span class="Token ID">local</span><span class="Token LF">
</span><span class="Token Keyword FI">fi</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Don&#x27;t do log messages here to avoid confusing graphical boots</span><span class="Token LF">
</span><span class="Token ID">run_scripts</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">scripts/init-top</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">maybe_break</span><span class="Token SPACE"> </span><span class="Token ID">modules</span><span class="Token LF">
</span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$quiet&quot;</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;y&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token ID">log_begin_msg</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Loading essential drivers&quot;</span><span class="Token LF">
</span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token OPTION">-n</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${netconsole}&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">sbin/modprobe</span><span class="Token SPACE"> </span><span class="Token ID">netconsole</span><span class="Token SPACE"> </span><span class="Token ID">netconsole</span><span class="Token ASSIGN">=</span><span class="Token String STRING">&quot;${netconsole}&quot;</span><span class="Token LF">
</span><span class="Token ID">load_modules</span><span class="Token LF">
</span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$quiet&quot;</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;y&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token ID">log_end_msg</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">log_begin_msg</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Mounting root file system&quot;</span><span class="Token LF">
</span><span class="Token COMMENT"># Always load local and nfs (since these might be needed for /etc or</span><span class="Token LF">
</span><span class="Token COMMENT"># /usr, irrespective of the boot script used to mount the rootfs).</span><span class="Token LF">
</span><span class="Token ID">.</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">scripts/local</span><span class="Token LF">
</span><span class="Token ID">.</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">scripts/nfs</span><span class="Token LF">
</span><span class="Token ID">.</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;/scripts/${BOOT}&quot;</span><span class="Token LF">
</span><span class="Token ID">parse_numeric</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${ROOT}&quot;</span><span class="Token LF">
</span><span class="Token ID">maybe_break</span><span class="Token SPACE"> </span><span class="Token ID">mountroot</span><span class="Token LF">
</span><span class="Token ID">mount_top</span><span class="Token LF">
</span><span class="Token ID">mount_premount</span><span class="Token LF">
</span><span class="Token ID">mountroot</span><span class="Token LF">
</span><span class="Token ID">log_end_msg</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Mount cleanup</span><span class="Token LF">
</span><span class="Token ID">mount_bottom</span><span class="Token LF">
</span><span class="Token ID">nfs_bottom</span><span class="Token LF">
</span><span class="Token ID">local_bottom</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">maybe_break</span><span class="Token SPACE"> </span><span class="Token ID">bottom</span><span class="Token LF">
</span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$quiet&quot;</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;y&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token ID">log_begin_msg</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Running /scripts/init-bottom&quot;</span><span class="Token LF">
</span><span class="Token COMMENT"># We expect udev&#x27;s init-bottom script to move /dev to ${rootmnt}/dev</span><span class="Token LF">
</span><span class="Token ID">run_scripts</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">scripts/init-bottom</span><span class="Token LF">
</span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$quiet&quot;</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;y&quot;</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token AND">&amp;&amp;</span><span class="Token SPACE"> </span><span class="Token ID">log_end_msg</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Move /run to the root</span><span class="Token LF">
</span><span class="Token ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-n</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">move</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">run</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-1 LCURLY_BRACE">{</span><span class="Token ID">rootmnt</span><span class="Token BraceDepth-1 RCURLY_BRACE">}</span><span class="Token DIV">/</span><span class="Token ID">run</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">validate_init</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LCURLY_BRACE">{</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">run-init</span><span class="Token SPACE"> </span><span class="Token OPTION">-n</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${rootmnt}&quot;</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${1}&quot;</span><span class="Token LF">
</span><span class="Token BraceDepth-1 RCURLY_BRACE">}</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Check init is really there</span><span class="Token LF">
</span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token ID">validate_init</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$init&quot;</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword THEN">then</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Target filesystem doesn&#x27;t have requested ${init}.&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">init</span><span class="Token ASSIGN">=</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword FOR">for</span><span class="Token SPACE"> </span><span class="Token ID">inittest</span><span class="Token SPACE"> </span><span class="Token Keyword IN">in</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">sbin/init</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">etc/init</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">bin/init</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">bin/sh</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword DO">do</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token ID">validate_init</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${inittest}&quot;</span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword THEN">then</span><span class="Token LF">
</span><span class="Token SPACE">                        </span><span class="Token ID">init</span><span class="Token ASSIGN">=</span><span class="Token String STRING">&quot;$inittest&quot;</span><span class="Token LF">
</span><span class="Token SPACE">                        </span><span class="Token Keyword BREAK">break</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token Keyword FI">fi</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword DONE">done</span><span class="Token LF">
</span><span class="Token Keyword FI">fi</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># No init on rootmount</span><span class="Token LF">
</span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token ID">validate_init</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${init}&quot;</span><span class="Token SPACE"> </span><span class="Token SEMI">;</span><span class="Token SPACE"> </span><span class="Token Keyword THEN">then</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">panic</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;No init found. Try passing init= bootarg.&quot;</span><span class="Token LF">
</span><span class="Token Keyword FI">fi</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">maybe_break</span><span class="Token SPACE"> </span><span class="Token ID">init</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Move virtual filesystems over to the real filesystem</span><span class="Token LF">
</span><span class="Token ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-n</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">move</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">sys</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-1 LCURLY_BRACE">{</span><span class="Token ID">rootmnt</span><span class="Token BraceDepth-1 RCURLY_BRACE">}</span><span class="Token DIV">/</span><span class="Token ID">sys</span><span class="Token LF">
</span><span class="Token ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-n</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">move</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token ID">proc</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-1 LCURLY_BRACE">{</span><span class="Token ID">rootmnt</span><span class="Token BraceDepth-1 RCURLY_BRACE">}</span><span class="Token DIV">/</span><span class="Token ID">proc</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># Chain to real filesystem</span><span class="Token LF">
</span><span class="Token COMMENT"># shellcheck disable=SC2086,SC2094</span><span class="Token LF">
</span><span class="Token ID">exec</span><span class="Token SPACE"> </span><span class="Token ID">run-init</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-1 LCURLY_BRACE">{</span><span class="Token ID">drop_caps</span><span class="Token BraceDepth-1 RCURLY_BRACE">}</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${rootmnt}&quot;</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;${init}&quot;</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;$@&quot;</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token String STRING">&quot;${rootmnt}/dev/console&quot;</span><span class="Token SPACE"> </span><span class="Token REDIRECT_TO">&gt;</span><span class="Token String STRING">&quot;${rootmnt}/dev/console&quot;</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token AMPERSAND">&amp;</span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token ID">echo</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Something went badly wrong in the initramfs.&quot;</span><span class="Token LF">
</span><span class="Token ID">panic</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;Please file a bug on initramfs-tools.&quot;</span></code></pre><pre class="language-shell"><code><span class="Token HOST_NAME">lzx@cxl2</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/klinux/initrd_root/main</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token ID">./usr/bin/run-init</span><span class="Token SPACE"> </span><span class="Token OPTION">--help</span><span class="Token LF">
</span><span class="Token ID">BusyBox</span><span class="Token SPACE"> </span><span class="Token ID">v1.36.1</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">Ubuntu</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token NUMBER">1.36</span><span class="Token ID">.1-6ubuntu3.1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token ID">multi-call</span><span class="Token SPACE"> </span><span class="Token ID">binary.</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">Usage:</span><span class="Token SPACE"> </span><span class="Token ID">run-init</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">CAP</span><span class="Token COMMA">,</span><span class="Token ID">CAP...</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token OPTION">-n</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token OPTION">-c</span><span class="Token SPACE"> </span><span class="Token ID">CONSOLE_DEV</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">NEW_ROOT</span><span class="Token SPACE"> </span><span class="Token ID">NEW_INIT</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">ARGS</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">Free</span><span class="Token SPACE"> </span><span class="Token ID">initramfs</span><span class="Token SPACE"> </span><span class="Token ID">and</span><span class="Token SPACE"> </span><span class="Token ID">switch</span><span class="Token SPACE"> </span><span class="Token ID">to</span><span class="Token SPACE"> </span><span class="Token ID">another</span><span class="Token SPACE"> </span><span class="Token ID">root</span><span class="Token SPACE"> </span><span class="Token ID">fs:</span><span class="Token LF">
</span><span class="Token ID">chroot</span><span class="Token SPACE"> </span><span class="Token ID">to</span><span class="Token SPACE"> </span><span class="Token ID">NEW_ROOT</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">delete</span><span class="Token SPACE"> </span><span class="Token ID">all</span><span class="Token SPACE"> </span><span class="Token Keyword IN">in</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">move</span><span class="Token SPACE"> </span><span class="Token ID">NEW_ROOT</span><span class="Token SPACE"> </span><span class="Token ID">to</span><span class="Token SPACE"> </span><span class="Token DIV">/</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token ID">execute</span><span class="Token SPACE"> </span><span class="Token ID">NEW_INIT.</span><span class="Token SPACE"> </span><span class="Token ID">PID</span><span class="Token SPACE"> </span><span class="Token ID">must</span><span class="Token SPACE"> </span><span class="Token ID">be</span><span class="Token SPACE"> </span><span class="Token NUMBER">1.</span><span class="Token SPACE"> </span><span class="Token ID">NEW_ROOT</span><span class="Token SPACE"> </span><span class="Token ID">must</span><span class="Token SPACE"> </span><span class="Token ID">be</span><span class="Token SPACE"> </span><span class="Token ID">a</span><span class="Token SPACE"> </span><span class="Token ID">mountpoint.</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-c</span><span class="Token SPACE"> </span><span class="Token ID">DEV</span><span class="Token SPACE">  </span><span class="Token ID">Reopen</span><span class="Token SPACE"> </span><span class="Token ID">stdio</span><span class="Token SPACE"> </span><span class="Token ID">to</span><span class="Token SPACE"> </span><span class="Token ID">DEV</span><span class="Token SPACE"> </span><span class="Token ID">after</span><span class="Token SPACE"> </span><span class="Token ID">switch</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">CAPS</span><span class="Token SPACE"> </span><span class="Token ID">Drop</span><span class="Token SPACE"> </span><span class="Token ID">capabilities</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-n</span><span class="Token SPACE">      </span><span class="Token ID">Dry</span><span class="Token SPACE"> </span><span class="Token ID">run</span></code></pre><h2 id="h2-9">替换内核</h2><p>使用 Linux 发行版镜像的主要目的就是借用其已经编译好的软件包环境, 通常内核则使用自己修改后重新编译的 <code>bzImage</code></p><pre class="language-shell"><code><span class="Token ID">qemu-system-x86_64</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token ID">bzImage</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">raw</span><span class="Token COMMA">,</span><span class="Token ID">file</span><span class="Token ASSIGN">=</span><span class="Token ID">disk/ubuntu.raw</span><span class="Token COMMA">,</span><span class="Token Keyword IF">if</span><span class="Token ASSIGN">=</span><span class="Token ID">virtio</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;root=/dev/vda2 console=ttyS0&quot;</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token OPTION">-no-reboot</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">guest_errors</span></code></pre><blockquote><p><code>-d guest_errors</code> 是 QEMU 的一个调试选项,用于记录和报告客户机操作系统中的错误, 这些错误信息会被输出到 QEMU 的日志中,以便开发人员或系统管理员进行调试和问题排查。</p></blockquote><p>如果设置了 kernel 参数那么就会使用新内核而不是当前 ubuntu.raw 中的内核, 相当于不再使用 <code>/dev/vda1</code> 的 /boot 分区, 不会读取其中 <code>/boot/grub/grub.cfg</code> 的配置文件, 因此需要手动指定挂载的根分区所在的位置</p><p>启动的时候可能会出现如下报错: <b>VFS: Unable to mount root fs on unknown wn-block(0,0)</b></p><p>可能有两个原因, 一个是因为现在使用的是 qemu 的虚拟机环境, 所以需要内核也支持虚拟化的设备/网络/PCI模拟, 需要在内核选项中开启如下的配置</p><pre class="language-txt"><code><span class="Token ID">CONFIG_EXT4_FS</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_XFS_FS</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_JBD2</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO_PCI</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO_BALLOON</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO_BLK</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO_NET</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO_RING</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span></code></pre><blockquote><p>正常来说使用 <code>defconfig</code> 的应该都已经开启了, 如果没有可以在 menuconfig 中手动搜索一下开启</p></blockquote><p>不出意外的话就可以正常进入了</p><h2 id="h2-10">参考</h2><ul><li><a href="https://github.com/lingfenghsiang/Nomad/blob/main/src/testing_scripts/setup_system/switch_kernel.sh" target="_blank">Nomad switch_kernel.sh</a></li></ul><ul><li><a href="https://stackoverflow.com/questions/10603104/the-difference-between-initrd-and-initramfs" target="_blank">the difference between initrd and initramfs</a></li></ul><ul><li><a href="https://serverfault.com/questions/601007/initrd-and-initramfs" target="_blank">serverfault initrd-and-initramfs</a></li></ul><ul><li><a href="https://wiki.debian.org/initramfs" target="_blank">debian wiki</a></li></ul><ul><li><a href="https://askubuntu.com/questions/14961/what-is-the-difference-between-initrd-and-initramfs" target="_blank">askubuntu what-is-the-difference-between-initrd-and-initramfs</a></li></ul></div>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var markdownBody = document.querySelector('.markdown-body');
                    var giscusDiv = markdownBody.querySelector('.giscus');
                    var referenceHtml = `<div class="references-tabs-container">
<div class="references-tabs-nav">
<button class="references-tab-btn active" data-tab="references-out">本文引用</button>
<button class="references-tab-btn " data-tab="references-in">本文被引用</button>
</div>
<div class="references-tabs-content">
<div class="references-tab-pane active" id="references-out">
<ul class="reference-list">
<li><a href="../../快速开始/编译内核"><span class="reference-icon" aria-hidden="true"></span><span class="reference-title">编译内核</span></a></li>
<li><a href="../../快速开始/调试内核"><span class="reference-icon" aria-hidden="true"></span><span class="reference-title">调试内核</span></a></li>
</ul>
</div>
<div class="references-tab-pane " id="references-in">
<ul class="reference-list">
<li><a href="../../快速开始/编译内核"><span class="reference-icon" aria-hidden="true"></span><span class="reference-title">编译内核</span></a></li>
<li><a href="../../快速开始/调试内核"><span class="reference-icon" aria-hidden="true"></span><span class="reference-title">调试内核</span></a></li>
</ul>
</div>
</div>
</div>`;
                    
                    if (giscusDiv) {
                        giscusDiv.insertAdjacentHTML('beforebegin', referenceHtml);
                    } else {
                        markdownBody.insertAdjacentHTML('beforeend', referenceHtml);
                    }
                    
                    // 添加选项卡切换功能
                    setTimeout(function() {
                        var tabButtons = document.querySelectorAll('.references-tab-btn');
                        var tabPanes = document.querySelectorAll('.references-tab-pane');
                        
                        tabButtons.forEach(function(button) {
                            button.addEventListener('click', function() {
                                var targetTab = this.getAttribute('data-tab');
                                
                                // 移除所有active类
                                tabButtons.forEach(btn => btn.classList.remove('active'));
                                tabPanes.forEach(pane => pane.classList.remove('active'));
                                
                                // 添加active类到当前选中的选项卡
                                this.classList.add('active');
                                var targetPane = document.getElementById(targetTab);
                                if (targetPane) {
                                    targetPane.classList.add('active');
                                }
                            });
                        });
                    }, 100);
                });
                </script>
                
    <div id="dir-tree-placeholder"></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/dir_tree_toggle.js"></script><script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../快速开始/开发环境搭建","../../快速开始/调试技巧","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/clipboard.svg","../../../img/clipboard-check.svg");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script>
            <script src="https://giscus.app/client.js" data-repo="luzhixing12345/klinux" 
            data-repo-id="R_kgDOJIKiEw" data-category="Q&A" data-category-id="DIC_kwDOJIKiE84CgFwK" data-mapping="pathname" data-strict="0"
            data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom"
            data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
            </script>
            <script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>
<script>
    const ws = new WebSocket("ws://127.0.0.1:8765");
    ws.onmessage = (event) => {
        if (event.data === "reload") location.reload();
    };
</script>

</html>