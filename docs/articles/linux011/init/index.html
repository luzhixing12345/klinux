<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/x86asm.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">init</a><ul><li><a href="#h2-1">编译过程</a></li></ul><ul><li><a href="#h2-2">引导启动程序</a></li></ul><ul><li><a href="#h2-3">init</a><ul><li><a href="#h3-4">系统调用的过程</a></li></ul><ul><li><a href="#h3-5">main函数部分</a></li></ul><ul><li><a href="#h3-6">登录</a></li></ul><ul><li><a href="#h3-7">进程组 会话(session)</a></li></ul></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">init</h1><h2 id="h2-1">编译过程</h2><p>把内核从块设备引导加载到内存, 对系统配置参数进行探测, 完成了进入32位保护模式运行之前的所有工作, 位内核系统执行进一步的初始化工作做准备</p><ul><li>bootsect.s =&gt; 磁盘引导程序</li></ul><ul><li>setup.s =&gt; 获取BIOS参数</li></ul><ul><li>head.s =&gt; 运行启动代码程序</li></ul><p>Makefile中核心编译环节</p><pre class="language-makefile"><code><span class="Mission Token ID">all</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">Image</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># 依赖四个文件 =&gt; boot/bootsect boot/setup tools/system tools/build</span><span class="Token LF">
</span><span class="Token COMMENT"># 是用build 以 $(ROOT_DEV) 为根文件系统设备将其他部分组装成内核映像文件 Image</span><span class="Token LF">
</span><span class="Mission Token ID">Image</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">boot/bootsect</span><span class="Token SPACE"> </span><span class="Token ID">boot/setup</span><span class="Token SPACE"> </span><span class="Token ID">tools/system</span><span class="Token SPACE"> </span><span class="Token ID">tools/build</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">tools/build</span><span class="Token SPACE"> </span><span class="Token ID">boot/bootsect</span><span class="Token SPACE"> </span><span class="Token ID">boot/setup</span><span class="Token SPACE"> </span><span class="Token ID">tools/system</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">ROOT_DEV</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Image</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sync</span><span class="Token LF">
</span><span class="Token COMMENT"># sync : 同步命令, 迫使缓冲块数据立即写盘并更新超级快</span></code></pre><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230317180110.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230317180110.png" alt="20230317180110"></a></p><p>其中Image依赖的四个文件<code>boot/bootsect</code> <code>boot/setup</code> <code>tools/system</code> <code>tools/build</code>分别对应的Makefile规则如下</p><pre class="language-makefile"><code><span class="Mission Token ID">boot/bootsect</span><span class="Token COLON">:</span><span class="Token SPACE">  </span><span class="Token ID">boot/bootsect.s</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">AS86</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">boot/bootsect.o</span><span class="Token SPACE"> </span><span class="Token AUTO_VARIABLE">$^</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">LD86</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token AUTO_VARIABLE">$@</span><span class="Token SPACE"> </span><span class="Token ID">boot/bootsect.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Mission Token ID">boot/setup</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">boot/setup.s</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">AS86</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">boot/setup.o</span><span class="Token SPACE"> </span><span class="Token AUTO_VARIABLE">$^</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">LD86</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token AUTO_VARIABLE">$@</span><span class="Token SPACE"> </span><span class="Token ID">boot/setup.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Mission Token ID">tools/system</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">boot/head.o</span><span class="Token SPACE"> </span><span class="Token ID">init/main.o</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">ARCHIVES</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">DRIVERS</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">MATH</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">LIBS</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">LD</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">LDFLAGS</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token AUTO_VARIABLE">$^</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token AUTO_VARIABLE">$@</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">System.map</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Mission Token ID">tools/build</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">tools/build.c</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">CC</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Variable Token ID">CFLAGS</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token AUTO_VARIABLE">$@</span><span class="Token SPACE"> </span><span class="Token AUTO_VARIABLE">$^</span></code></pre><p>这里的 <code>System.map</code> 用于存放内核符号表信息, 当内核运行出错的时候可以通过 System.map 中的符号表解析查到一个地址对应的变量名, 或反过来通过变量名查到地址</p><h2 id="h2-2">引导启动程序</h2><blockquote><p>引导启动这部分和硬件关系很大, 读不懂理解不了很正常, 跳过此部分直接进入C代码也可以</p></blockquote><p>bootsect.s 和 setup.s 采用近似于 Intel 的汇编语言语法, 需要使用 Intel 8086汇编编译器和链接器as86 ld86</p><p>head.s 使用GNU汇编程序格式, 运行在保护模式下, 需要使用 GNU 的as进行编译, 这是一种 AT&amp;T的汇编语言程序</p><p>笔者这里实在是不想过多讨论汇编相关的内容, 一个原因是确实枯燥乏味, 一个原因是需要很多硬件相关的前置知识, 最主要的原因是这并不是我关心的问题. 操作系统跑起来很重要但是跑的稳更重要, 深究启动细节或许有些意义, 但对我来说意义不大</p><p>下面主要来讨论一下实模式和保护模式</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230321145946.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230321145946.png" alt="20230321145946"></a></p><ul><li>实模式: 如左图, 寻址一个内存地址使用段+偏移值, 也就是ds:si, 段值保存在段寄存器ds当中, 段内偏移地址保存在第一可以寻址的寄存器当中(si), 这两个都是16位寄存器, 对应的大小是64KB, 所以偏移地址的范围就是[0,64KB), 所以段的最大长度是64KB.</li></ul><ul><li>保护模式: 如右图, 寻址一个内存地址仍然是使用段+偏移值, 不过与实模式不同的是, ds并不会直接保存段的地址, 而是保存一个指向全局描述符表(gdt, global descriptor table) 的索引<p>gdt中保存着所有的段的信息, 包括内存段的基地址, 偏移值, 段最大长度</p><p>gdt的基地址在gdtr, ds保存一个索引值, 可以使用类似 gdt[ds]的方式得到所需段的基地址</p><p>这样的方式有一些好处, 首先是段的长度可变, 而不是固定死的64KB, 这样变大变小都可以灵活的调整</p></li></ul><p>在 boot/setup.s 中相关的汇编如下</p><pre class="language-x86asm"><code><span class="Token SECTION">end_move</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">mov</span><span class="Token SPACE"> </span><span class="Token NUMBER">ax</span><span class="Token COMMA">,</span><span class="Token COMMENT">#SETUPSEG    ! right, forgot this at first. didn&#x27;t work :-)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">mov</span><span class="Token SPACE"> </span><span class="Token NUMBER">ds</span><span class="Token COMMA">,</span><span class="Token NUMBER">ax</span><span class="Token SPACE">           </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token NUMBER">ds</span><span class="Token SPACE"> </span><span class="Token ID">指向本程序的setup段</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">lidt</span><span class="Token SPACE">    </span><span class="Token SECTION">idt_48</span><span class="Token SPACE">      </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token ID">load</span><span class="Token SPACE"> </span><span class="Token ID">idt</span><span class="Token SPACE"> </span><span class="Token ID">with</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">lgdt</span><span class="Token SPACE">    </span><span class="Token SECTION">gdt_48</span><span class="Token SPACE">      </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token ID">load</span><span class="Token SPACE"> </span><span class="Token ID">gdt</span><span class="Token SPACE"> </span><span class="Token ID">with</span><span class="Token SPACE"> </span><span class="Token ID">whatever</span><span class="Token SPACE"> </span><span class="Token ID">appropriate</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token SECTION">idt_48</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ASM_KEYWORD">.word</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token SPACE">           </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token ID">idt</span><span class="Token SPACE"> </span><span class="Token ID">limit</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ASM_KEYWORD">.word</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token NUMBER">0</span><span class="Token SPACE">         </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token ID">idt</span><span class="Token SPACE"> </span><span class="Token ID">base</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">0</span><span class="Token NUMBER">L</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token SECTION">gdt_48</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ASM_KEYWORD">.word</span><span class="Token SPACE">   </span><span class="Token NUMBER">0x800</span><span class="Token SPACE">       </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token ID">gdt</span><span class="Token SPACE"> </span><span class="Token ID">limit</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">2048</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">256</span><span class="Token SPACE"> </span><span class="Token ID">GDT</span><span class="Token SPACE"> </span><span class="Token ID">entries</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ASM_KEYWORD">.word</span><span class="Token SPACE">   </span><span class="Token NUMBER">512</span><span class="Token PLUS">+</span><span class="Token ID">gdt</span><span class="Token COMMA">,</span><span class="Token NUMBER">0x9</span><span class="Token SPACE"> </span><span class="Token BANG">!</span><span class="Token SPACE"> </span><span class="Token ID">gdt</span><span class="Token SPACE"> </span><span class="Token ID">base</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token NUMBER">0X9xxxx</span></code></pre><p>引导加载程序 bootsect.s 将 setup.s 代码和 system 模块加载到了内存中, 兵器而分别把自己和 setup.s 代码移动到了物理内存,0x90000 和 0x90200 处后, 就把执行权交给了 setup 程序, 其中 system 模块的首部包含有 head.s 代码</p><p>setup 程序的主要作用是利用 ROM BIOS 的中断程序去获取机器的一些基本参数, 并保存在 0x90000 开始的内存块中, 以供后面程序使用.. 同时把 system 模块向下移动到物理地址 0x00000 开始处, 这样 system 中的head.s 代码就被移动到 0x00000  处了</p><p>然后加载描述符表基地址到描述符表寄存器中, 为进行32为保护模式下的运行做好准备, 接下来对终端控制引荐进行重新设备, 最后通过设计机器控制寄存器 CR0 并跳转到 system 模块的 head.s 代码开始处, 使 CPU 进入32位保护模式下运行</p><p>head.s 代码主要作用是初步初始化中断描述符表中256项门描述符, 检查 A20 地址线是否打开, 测试系统是否含有数学协处理器. 然后初始化内存也目录表, 为内存的分页管理做好准备工作</p><p>最后跳转到system模块中的初始化程序 init.c 中继续执行</p><h2 id="h2-3">init</h2><h3 id="h3-4">系统调用的过程</h3><p>下面这四句用了宏 _syscall0 _syscall1 去展开, 相当于 int fork() {...} 这种定义方式</p><pre class="language-c"><code><span class="FunctionReturnType StorageType Token Keyword STATIC">static</span><span class="FunctionReturnType StorageType Token Keyword SPACE"> </span><span class="FunctionReturnType FunctionType Token Keyword INLINE">inline</span><span class="FunctionReturnType FunctionType Token Keyword SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">_syscall0</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier Token Keyword Typedefine TYPEDEF_ID">fork</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor RPAREN">)</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="FunctionReturnType StorageType Token Keyword STATIC">static</span><span class="FunctionReturnType StorageType Token Keyword SPACE"> </span><span class="FunctionReturnType FunctionType Token Keyword INLINE">inline</span><span class="FunctionReturnType FunctionType Token Keyword SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">_syscall0</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier Token Keyword Typedefine TYPEDEF_ID">pause</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor RPAREN">)</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="FunctionReturnType StorageType Token Keyword STATIC">static</span><span class="FunctionReturnType StorageType Token Keyword SPACE"> </span><span class="FunctionReturnType FunctionType Token Keyword INLINE">inline</span><span class="FunctionReturnType FunctionType Token Keyword SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">_syscall1</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier Token Keyword Typedefine TYPEDEF_ID">setup</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="Pointer Token Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier Token Keyword Typedefine TYPEDEF_ID">BIOS</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor RPAREN">)</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="FunctionReturnType StorageType Token Keyword STATIC">static</span><span class="FunctionReturnType StorageType Token Keyword SPACE"> </span><span class="FunctionReturnType FunctionType Token Keyword INLINE">inline</span><span class="FunctionReturnType FunctionType Token Keyword SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">_syscall0</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier Token Keyword Typedefine TYPEDEF_ID">sync</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor RPAREN">)</span><span class="Declaration Token SEMI">;</span></code></pre><p>其中宏展开可以看到内嵌的汇编代码分别如下</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Preprocess Token Keyword ControlLine DEFINE">define</span><span class="Preprocess Token Keyword ControlLine SPACE"> </span><span class="MarcroFunction ControlLine Token Identifier ID">_syscall0</span><span class="BraceDepth-0 Token ControlLine LPAREN">(</span><span class="Token Identifier ID">type</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">name</span><span class="BraceDepth-0 Token ControlLine RPAREN">)</span><span class="Token ControlLine SPACE">                                           </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">    </span><span class="Token Identifier ID">type</span><span class="Token Identifier SPACE"> </span><span class="Token Identifier ID">name</span><span class="BraceDepth-0 PPtoken Token LPAREN">(</span><span class="Token Keyword VOID">void</span><span class="BraceDepth-0 PPtoken Token RPAREN">)</span><span class="PPtoken Token SPACE"> </span><span class="BraceDepth-0 PPtoken Token LCURLY_BRACE">{</span><span class="PPtoken Token SPACE">                                                   </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">        </span><span class="Token Keyword LONG">long</span><span class="Token Keyword SPACE"> </span><span class="Token Identifier ID">__res</span><span class="PPtoken Token SEMI">;</span><span class="PPtoken Token SPACE">                                                     </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">        </span><span class="Token Keyword _ASM">__asm__</span><span class="Token Keyword SPACE"> </span><span class="Token Keyword VOLATILE">volatile</span><span class="PPtoken Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;int $0x80&quot;</span><span class="Token SPACE"> </span><span class="PPtoken Token COLON">:</span><span class="PPtoken Token SPACE"> </span><span class="Token String STRING">&quot;=a&quot;</span><span class="BraceDepth-2 PPtoken Token LPAREN">(</span><span class="Token Identifier ID">__res</span><span class="BraceDepth-2 PPtoken Token RPAREN">)</span><span class="PPtoken Token SPACE"> </span><span class="PPtoken Token COLON">:</span><span class="PPtoken Token SPACE"> </span><span class="Token String STRING">&quot;0&quot;</span><span class="BraceDepth-2 PPtoken Token LPAREN">(</span><span class="Token Identifier MacroDefine ID">__NR_</span><span class="PPtoken Token DOUBLE_HASH">##</span><span class="Token Identifier ID">name</span><span class="BraceDepth-2 PPtoken Token RPAREN">)</span><span class="PPtoken Token BraceDepth-1 RPAREN">)</span><span class="PPtoken Token SEMI">;</span><span class="PPtoken Token SPACE"> </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">        </span><span class="Token Keyword IF_P">if</span><span class="Token Keyword SPACE"> </span><span class="PPtoken Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">__res</span><span class="Token Identifier SPACE"> </span><span class="PPtoken Token GE">&gt;=</span><span class="PPtoken Token SPACE"> </span><span class="PPtoken Token NUMBER">0</span><span class="PPtoken Token BraceDepth-1 RPAREN">)</span><span class="PPtoken Token SPACE"> </span><span class="Token Keyword RETURN">return</span><span class="Token Keyword SPACE"> </span><span class="PPtoken Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">type</span><span class="PPtoken Token BraceDepth-1 RPAREN">)</span><span class="Token Identifier ID">__res</span><span class="PPtoken Token SEMI">;</span><span class="PPtoken Token SPACE">                             </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">        </span><span class="Token Identifier ID">errno</span><span class="Token Identifier SPACE"> </span><span class="PPtoken Token ASSIGN">=</span><span class="PPtoken Token SPACE"> </span><span class="PPtoken Token MINUS">-</span><span class="Token Identifier ID">__res</span><span class="PPtoken Token SEMI">;</span><span class="PPtoken Token SPACE">                                                 </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">        </span><span class="Token Keyword RETURN">return</span><span class="Token Keyword SPACE"> </span><span class="PPtoken Token MINUS">-</span><span class="PPtoken Token NUMBER">1</span><span class="PPtoken Token SEMI">;</span><span class="PPtoken Token SPACE">                                                      </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">    </span><span class="BraceDepth-0 PPtoken Token RCURLY_BRACE">}</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Preprocess Token Keyword ControlLine DEFINE">define</span><span class="Preprocess Token Keyword ControlLine SPACE"> </span><span class="MarcroFunction ControlLine Token Identifier ID">_syscall1</span><span class="BraceDepth-0 Token ControlLine LPAREN">(</span><span class="Token Identifier ID">type</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">name</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">atype</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">a</span><span class="BraceDepth-0 Token ControlLine RPAREN">)</span><span class="Token ControlLine SPACE">                       </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">    </span><span class="Token Identifier ID">type</span><span class="Token Identifier SPACE"> </span><span class="Token Identifier ID">name</span><span class="BraceDepth-0 PPtoken Token LPAREN">(</span><span class="Token Identifier ID">atype</span><span class="Token Identifier SPACE"> </span><span class="Token Identifier ID">a</span><span class="BraceDepth-0 PPtoken Token RPAREN">)</span><span class="PPtoken Token SPACE"> </span><span class="BraceDepth-0 PPtoken Token LCURLY_BRACE">{</span><span class="PPtoken Token SPACE">                                      </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">        </span><span class="Token Keyword LONG">long</span><span class="Token Keyword SPACE"> </span><span class="Token Identifier ID">__res</span><span class="PPtoken Token SEMI">;</span><span class="PPtoken Token SPACE">                                           </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">        </span><span class="Token Keyword _ASM">__asm__</span><span class="Token Keyword SPACE"> </span><span class="Token Keyword VOLATILE">volatile</span><span class="PPtoken Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;int $0x80&quot;</span><span class="Token SPACE">                          </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">                         </span><span class="PPtoken Token COLON">:</span><span class="PPtoken Token SPACE"> </span><span class="Token String STRING">&quot;=a&quot;</span><span class="BraceDepth-2 PPtoken Token LPAREN">(</span><span class="Token Identifier ID">__res</span><span class="BraceDepth-2 PPtoken Token RPAREN">)</span><span class="PPtoken Token SPACE">                        </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">                         </span><span class="PPtoken Token COLON">:</span><span class="PPtoken Token SPACE"> </span><span class="Token String STRING">&quot;0&quot;</span><span class="BraceDepth-2 PPtoken Token LPAREN">(</span><span class="Token Identifier MacroDefine ID">__NR_</span><span class="PPtoken Token DOUBLE_HASH">##</span><span class="Token Identifier ID">name</span><span class="BraceDepth-2 PPtoken Token RPAREN">)</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="Token String STRING">&quot;b&quot;</span><span class="BraceDepth-2 PPtoken Token LPAREN">(</span><span class="BraceDepth-0 PPtoken Token LPAREN">(</span><span class="Token Keyword LONG">long</span><span class="BraceDepth-0 PPtoken Token RPAREN">)</span><span class="BraceDepth-0 PPtoken Token LPAREN">(</span><span class="Token Identifier ID">a</span><span class="BraceDepth-0 PPtoken Token RPAREN">)</span><span class="BraceDepth-2 PPtoken Token RPAREN">)</span><span class="PPtoken Token BraceDepth-1 RPAREN">)</span><span class="PPtoken Token SEMI">;</span><span class="PPtoken Token SPACE"> </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">        </span><span class="Token Keyword IF_P">if</span><span class="Token Keyword SPACE"> </span><span class="PPtoken Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">__res</span><span class="Token Identifier SPACE"> </span><span class="PPtoken Token GE">&gt;=</span><span class="PPtoken Token SPACE"> </span><span class="PPtoken Token NUMBER">0</span><span class="PPtoken Token BraceDepth-1 RPAREN">)</span><span class="PPtoken Token SPACE"> </span><span class="Token Keyword RETURN">return</span><span class="Token Keyword SPACE"> </span><span class="PPtoken Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">type</span><span class="PPtoken Token BraceDepth-1 RPAREN">)</span><span class="Token Identifier ID">__res</span><span class="PPtoken Token SEMI">;</span><span class="PPtoken Token SPACE">                   </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">        </span><span class="Token Identifier ID">errno</span><span class="Token Identifier SPACE"> </span><span class="PPtoken Token ASSIGN">=</span><span class="PPtoken Token SPACE"> </span><span class="PPtoken Token MINUS">-</span><span class="Token Identifier ID">__res</span><span class="PPtoken Token SEMI">;</span><span class="PPtoken Token SPACE">                                       </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">        </span><span class="Token Keyword RETURN">return</span><span class="Token Keyword SPACE"> </span><span class="PPtoken Token MINUS">-</span><span class="PPtoken Token NUMBER">1</span><span class="PPtoken Token SEMI">;</span><span class="PPtoken Token SPACE">                                            </span><span class="PPtoken Token BACK_SLASH">\</span><span class="PPtoken Token LF">
</span><span class="PPtoken Token SPACE">    </span><span class="BraceDepth-0 PPtoken Token RCURLY_BRACE">}</span></code></pre><p>在 <code>include/sys/unistd.h</code> 中我们可看到如下定义的宏</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230322135932.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230322135932.png" alt="20230322135932"></a></p><p>所以根据对应的映射宏<code>__NR_##name</code>展开, 即扩展得到</p><pre class="language-c"><code><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword INT">int</span><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">fork</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor RPAREN">)</span><span class="Token Declarator DirectDeclaractor SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">__res</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Token Keyword GNU_C_Assembly _ASM">__asm__</span><span class="Token Keyword GNU_C_Assembly SPACE"> </span><span class="Token Keyword GNU_C_Assembly VOLATILE">volatile</span><span class="BraceDepth-1 Token GNU_C_Assembly LPAREN">(</span><span class="Token String STRING">&quot;int $0x80&quot;</span><span class="Token SPACE"> </span><span class="Token GNU_C_Assembly COLON">:</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;=a&quot;</span><span class="BraceDepth-2 Token GNU_C_Assembly LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">__res</span><span class="BraceDepth-2 Token GNU_C_Assembly RPAREN">)</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly COLON">:</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;0&quot;</span><span class="BraceDepth-2 Token GNU_C_Assembly LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">2</span><span class="BraceDepth-2 Token GNU_C_Assembly RPAREN">)</span><span class="BraceDepth-1 Token GNU_C_Assembly RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="SelectionStatement Token BraceDepth-1 LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">__res</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="ConditionalExpression BinaryOp Token GE">&gt;=</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="SelectionStatement Token BraceDepth-1 RPAREN">)</span><span class="SelectionStatement Token SPACE"> </span><span class="JumpStatement Token Keyword RETURN">return</span><span class="JumpStatement Token Keyword SPACE"> </span><span class="ConditionalExpression BraceDepth-1 Token CastExpression LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword INT">int</span><span class="ConditionalExpression BraceDepth-1 Token CastExpression RPAREN">)</span><span class="PrimaryExpression Token Identifier ID">__res</span><span class="SelectionStatement Token JumpStatement SEMI">;</span><span class="SelectionStatement Token JumpStatement LF">
</span><span class="SelectionStatement Token JumpStatement SPACE">    </span><span class="PrimaryExpression Token Identifier ID">errno</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="UnaryOp Token UnaryExpression MINUS">-</span><span class="PrimaryExpression Token Identifier ID">__res</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="JumpStatement Token Keyword RETURN">return</span><span class="JumpStatement Token Keyword SPACE"> </span><span class="UnaryOp Token UnaryExpression MINUS">-</span><span class="PrimaryExpression Token Constant NUMBER">1</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="CompoundStatement BraceDepth-0 Token Function RCURLY_BRACE">}</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function LF">
</span><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword INT">int</span><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">setup</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="Pointer Token Declarator POINTER">*</span><span class="Pointer Token Declarator SPACE"> </span><span class="DirectDeclaractor Token Identifier ID">BIOS</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor RPAREN">)</span><span class="Token Declarator DirectDeclaractor SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">__res</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Token Keyword GNU_C_Assembly _ASM">__asm__</span><span class="Token Keyword GNU_C_Assembly SPACE"> </span><span class="Token Keyword GNU_C_Assembly VOLATILE">volatile</span><span class="BraceDepth-1 Token GNU_C_Assembly LPAREN">(</span><span class="Token String STRING">&quot;int $0x80&quot;</span><span class="Token SPACE"> </span><span class="Token GNU_C_Assembly COLON">:</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;=a&quot;</span><span class="BraceDepth-2 Token GNU_C_Assembly LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">__res</span><span class="BraceDepth-2 Token GNU_C_Assembly RPAREN">)</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly COLON">:</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;0&quot;</span><span class="BraceDepth-2 Token GNU_C_Assembly LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="BraceDepth-2 Token GNU_C_Assembly RPAREN">)</span><span class="Token GNU_C_Assembly COMMA">,</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;b&quot;</span><span class="BraceDepth-2 Token GNU_C_Assembly LPAREN">(</span><span class="ConditionalExpression BraceDepth-0 Token CastExpression LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="ConditionalExpression BraceDepth-0 Token CastExpression RPAREN">)</span><span class="PrimaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Identifier MacroDefine ID">BIOS</span><span class="PrimaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="BraceDepth-2 Token GNU_C_Assembly RPAREN">)</span><span class="BraceDepth-1 Token GNU_C_Assembly RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="SelectionStatement Token BraceDepth-1 LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">__res</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="ConditionalExpression BinaryOp Token GE">&gt;=</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="SelectionStatement Token BraceDepth-1 RPAREN">)</span><span class="SelectionStatement Token SPACE"> </span><span class="JumpStatement Token Keyword RETURN">return</span><span class="JumpStatement Token Keyword SPACE"> </span><span class="ConditionalExpression BraceDepth-1 Token CastExpression LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword INT">int</span><span class="ConditionalExpression BraceDepth-1 Token CastExpression RPAREN">)</span><span class="PrimaryExpression Token Identifier ID">__res</span><span class="SelectionStatement Token JumpStatement SEMI">;</span><span class="SelectionStatement Token JumpStatement LF">
</span><span class="SelectionStatement Token JumpStatement SPACE">    </span><span class="PrimaryExpression Token Identifier ID">errno</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="UnaryOp Token UnaryExpression MINUS">-</span><span class="PrimaryExpression Token Identifier ID">__res</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="JumpStatement Token Keyword RETURN">return</span><span class="JumpStatement Token Keyword SPACE"> </span><span class="UnaryOp Token UnaryExpression MINUS">-</span><span class="PrimaryExpression Token Constant NUMBER">1</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="CompoundStatement BraceDepth-0 Token Function RCURLY_BRACE">}</span></code></pre><p>这两个函数是通过在 Linux 内核中使用中断 (interrupt) 0x80 来调用系统调用 (system call) 的方式实现的.系统调用是操作系统提供给应用程序的一组接口,应用程序可以通过这些接口来请求操作系统执行特定的操作.</p><p>在这两个函数中,<code>asm volatile(&quot;int $0x80&quot;)</code> 的作用是使用内联汇编 (inline assembly) 在代码中嵌入一个汇编指令,将中断 0x80 发送给处理器.这个中断号是 Linux 内核中指向系统调用处理程序的入口点.</p><p>__res 变量是用来保存返回值的,通过 &quot;=a&quot;(__res) 表示将 EAX 寄存器中的值赋给 __res 变量.</p><p>第一个函数中,&quot;0&quot;(2) 表示将函数调用号 2 (在 Linux 中是 fork() 的函数调用号) 赋给 EAX 寄存器.</p><p>第二个函数中,&quot;0&quot;(0) 表示将函数调用号 0 (在 Linux 中是 setup() 的函数调用号) 赋给 EAX 寄存器,&quot;b&quot;((long)(BIOS)) 表示将 BIOS 参数的地址放入 EBX 寄存器中.</p><p>接下来,如果返回值大于等于 0,说明系统调用执行成功,将 __res 强制转换为 int 类型并返回.如果返回值小于 0,将 -__res 赋给 errno 变量,并返回 -1,表示系统调用执行失败.</p><p>这里的 fork 对应的索引值为 2, setup 对应的索引值为 0, 与此同时我们可以看到 <code>include/linux/sys.h</code> 下的所有系统调用sys_call_table</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230322140833.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230322140833.png" alt="20230322140833"></a></p><p>所以简而言之, 当我们使用fork函数的时候</p><ul><li>fork函数借助其内联汇编: <code>__asm__ volatile(&quot;int $0x80&quot; : &quot;=a&quot;(__res) : &quot;0&quot;(2));</code>, 中断 0x80 发送给处理器</li></ul><ul><li>CPU接收到中断信号, 转去调用idt的第2号中断, 也就是 <code>_sys_fork</code></li></ul><ul><li>在 init/main.c 的 main 函数中的 sche_init 初始化的时候设置了相关的中断向量表, 查找到2号中断<pre class="language-c"><code><span class="PrimaryExpression FunctionCall Token Identifier ID">set_tss_desc</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">gdt</span><span class="ConditionalExpression BinaryOp Token PLUS">+</span><span class="PrimaryExpression Token Identifier MacroDefine ID">FIRST_TSS_ENTRY</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="PrimaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">init_task</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">task</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">tss</span><span class="PrimaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="PrimaryExpression FunctionCall Token Identifier ID">set_ldt_desc</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">gdt</span><span class="ConditionalExpression BinaryOp Token PLUS">+</span><span class="PrimaryExpression Token Identifier MacroDefine ID">FIRST_LDT_ENTRY</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="PrimaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">init_task</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">task</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">ldt</span><span class="PrimaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span></code></pre></li></ul><ul><li><code>_sys_fork</code> 的实现在 kernel/system_call.s 的汇编代码中<pre class="language-x86asm"><code><span class="Token SECTION">_sys_fork</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">call</span><span class="Token SPACE"> </span><span class="Token ID">_find_empty_process</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">testl</span><span class="Token SPACE"> </span><span class="Token REGISTER">%eax</span><span class="Token COMMA">,</span><span class="Token REGISTER">%eax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">js</span><span class="Token SPACE"> </span><span class="Token NUMBER">1f</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">push</span><span class="Token SPACE"> </span><span class="Token REGISTER">%gs</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">pushl</span><span class="Token SPACE"> </span><span class="Token REGISTER">%esi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">pushl</span><span class="Token SPACE"> </span><span class="Token REGISTER">%edi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">pushl</span><span class="Token SPACE"> </span><span class="Token REGISTER">%ebp</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">pushl</span><span class="Token SPACE"> </span><span class="Token REGISTER">%eax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">call</span><span class="Token SPACE"> </span><span class="Token ID">_copy_process</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">addl</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">20</span><span class="Token COMMA">,</span><span class="Token REGISTER">%esp</span><span class="Token LF">
</span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE">    </span><span class="Token ID">ret</span></code></pre></li></ul><ul><li>其中汇编中的两个函数 <code>_find_empty_process</code> <code>_copy_process</code> 的去掉前缀下划线的函数实现可以在 <code>kernel/fork.c</code> 中找到<pre class="language-c"><code><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword INT">int</span><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">copy_process</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword INT">int</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nr</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">ebp</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">edi</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">esi</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">gs</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">none</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">               </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">ebx</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">ecx</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">edx</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">fs</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">es</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">ds</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">               </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">eip</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">cs</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">eflags</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">esp</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="TypeSpecifier BaseType Token Keyword LONG">long</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">ss</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor RPAREN">)</span><span class="Token Declarator DirectDeclaractor SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">                  </span><span class="CompoundStatement Token Function COMMENT">// ...</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">               </span><span class="CompoundStatement BraceDepth-0 Token Function RCURLY_BRACE">}</span><span class="CompoundStatement Token Function LF">
</span><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword INT">int</span><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">find_empty_process</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor RPAREN">)</span><span class="Token Declarator DirectDeclaractor SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">  </span><span class="TypeSpecifier BaseType Token Keyword INT">int</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="LabeledStatement GotoLabel Token Identifier ID">repeat</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token LF">
</span><span class="LabeledStatement Token SPACE">    </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="LabeledStatement SelectionStatement Token BraceDepth-1 LPAREN">(</span><span class="PrimaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="UnaryOp Token UnaryExpression INC">++</span><span class="PrimaryExpression Token Identifier ID">last_pid</span><span class="PrimaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="PrimaryExpression Token PostfixExpression SPACE"> </span><span class="ConditionalExpression BinaryOp Token LT">&lt;</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="LabeledStatement SelectionStatement Token BraceDepth-1 RPAREN">)</span><span class="LabeledStatement SelectionStatement Token LF">
</span><span class="LabeledStatement SelectionStatement Token SPACE">        </span><span class="PrimaryExpression Token Identifier ID">last_pid</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">1</span><span class="ExpressionStatement SelectionStatement Token SEMI">;</span><span class="ExpressionStatement SelectionStatement Token LF">
</span><span class="ExpressionStatement SelectionStatement Token SPACE">    </span><span class="IterationStatement Token Keyword FOR">for</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="IterationStatement Token BraceDepth-1 LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">i</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="IterationStatement Token SEMI">;</span><span class="IterationStatement Token SPACE"> </span><span class="PrimaryExpression Token Identifier ID">i</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="ConditionalExpression BinaryOp Token LT">&lt;</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Identifier MacroDefine ID">NR_TASKS</span><span class="IterationStatement Token SEMI">;</span><span class="IterationStatement Token SPACE"> </span><span class="PrimaryExpression Token Identifier ID">i</span><span class="UnaryExpression Token PostfixExpression INC">++</span><span class="IterationStatement Token BraceDepth-1 RPAREN">)</span><span class="IterationStatement Token LF">
</span><span class="IterationStatement Token SPACE">        </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="IterationStatement SelectionStatement Token BraceDepth-1 LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">task</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LSQUAR_PAREN">[</span><span class="PrimaryExpression Token Identifier ID">i</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="ConditionalExpression BinaryOp Token AND">&amp;&amp;</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Identifier ID">task</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LSQUAR_PAREN">[</span><span class="PrimaryExpression Token Identifier ID">i</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">pid</span><span class="Token Identifier SPACE"> </span><span class="BinaryOp Token EQ">==</span><span class="BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Identifier ID">last_pid</span><span class="IterationStatement SelectionStatement Token BraceDepth-1 RPAREN">)</span><span class="IterationStatement SelectionStatement Token LF">
</span><span class="IterationStatement SelectionStatement Token SPACE">            </span><span class="JumpStatement Token Keyword GOTO">goto</span><span class="JumpStatement Token Keyword SPACE"> </span><span class="GotoLabel Token JumpStatement Identifier ID">repeat</span><span class="SelectionStatement Token JumpStatement SEMI">;</span><span class="SelectionStatement Token JumpStatement LF">
</span><span class="SelectionStatement Token JumpStatement SPACE">    </span><span class="IterationStatement Token Keyword FOR">for</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="IterationStatement Token BraceDepth-1 LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">i</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">1</span><span class="IterationStatement Token SEMI">;</span><span class="IterationStatement Token SPACE"> </span><span class="PrimaryExpression Token Identifier ID">i</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="ConditionalExpression BinaryOp Token LT">&lt;</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Identifier MacroDefine ID">NR_TASKS</span><span class="IterationStatement Token SEMI">;</span><span class="IterationStatement Token SPACE"> </span><span class="PrimaryExpression Token Identifier ID">i</span><span class="UnaryExpression Token PostfixExpression INC">++</span><span class="IterationStatement Token BraceDepth-1 RPAREN">)</span><span class="IterationStatement Token LF">
</span><span class="IterationStatement Token SPACE">        </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="IterationStatement SelectionStatement Token BraceDepth-1 LPAREN">(</span><span class="UnaryOp Token UnaryExpression BANG">!</span><span class="PrimaryExpression Token Identifier ID">task</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LSQUAR_PAREN">[</span><span class="PrimaryExpression Token Identifier ID">i</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RSQUAR_PAREN">]</span><span class="IterationStatement SelectionStatement Token BraceDepth-1 RPAREN">)</span><span class="IterationStatement SelectionStatement Token LF">
</span><span class="IterationStatement SelectionStatement Token SPACE">            </span><span class="JumpStatement Token Keyword RETURN">return</span><span class="JumpStatement Token Keyword SPACE"> </span><span class="PrimaryExpression Token Identifier ID">i</span><span class="SelectionStatement Token JumpStatement SEMI">;</span><span class="SelectionStatement Token JumpStatement LF">
</span><span class="SelectionStatement Token JumpStatement SPACE">    </span><span class="JumpStatement Token Keyword RETURN">return</span><span class="JumpStatement Token Keyword SPACE"> </span><span class="UnaryOp Token UnaryExpression MINUS">-</span><span class="PrimaryExpression Token Identifier MacroDefine ID">EAGAIN</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="CompoundStatement BraceDepth-0 Token Function RCURLY_BRACE">}</span></code></pre></li></ul><ul><li>全部完成调用之后返回结果: <code>if (__res &gt;= 0) return (type)__res;</code>, 或返回错误信息</li></ul><h3 id="h3-5">main函数部分</h3><p>main函数的核心部分如下所示, 首先做了一些地址的初始化, 然后初始化各方面的硬件设备. 然后fork一个子进程执行init, 结束之后使用pause等待进程调度</p><pre class="language-c"><code><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword VOID">void</span><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">main</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor RPAREN">)</span><span class="Token Declarator DirectDeclaractor SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="CompoundStatement Token Function COMMENT">// 一些内存地址的初始化</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">mem_init</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">main_memory_start</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier ID">memory_end</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 内存初始化     -&gt; mm/memory.c</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">trap_init</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">     </span><span class="ExpressionStatement Token COMMENT">// 中断向量初始化 -&gt; kernel/traps.c</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">blk_dev_init</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 块设备初始化   -&gt; kernel/blk_drv/ll_rw_blk.c</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">chr_dev_init</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 字符设备初始化 -&gt; kernel/chr_drv/tty_io.c</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">tty_init</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">      </span><span class="ExpressionStatement Token COMMENT">// tty初始化    -&gt; kernel/chr_drv/tty_io.c</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">time_init</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">     </span><span class="ExpressionStatement Token COMMENT">// 开机时间初始化</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">sched_init</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// 调度程序初始化 -&gt; kernel/sched.c</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">buffer_init</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">buffer_memory_end</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 缓冲管理初始化 -&gt; fs/buffer.c</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">hd_init</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">            </span><span class="ExpressionStatement Token COMMENT">// 硬盘初始化     -&gt; kernel/blk_drv/hd.c</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">floppy_init</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">        </span><span class="ExpressionStatement Token COMMENT">// 软驱初始化     -&gt; kernel/blk_drv/floppy.c</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">sti</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">                </span><span class="ExpressionStatement Token COMMENT">// 所有初始化工作结束之后开启中断</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">move_to_user_mode</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 进入用户模式</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="SelectionStatement Token BraceDepth-1 LPAREN">(</span><span class="UnaryOp Token UnaryExpression BANG">!</span><span class="PrimaryExpression FunctionCall Token Identifier ID">fork</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="SelectionStatement Token BraceDepth-1 RPAREN">)</span><span class="SelectionStatement Token SPACE"> </span><span class="CompoundStatement SelectionStatement Token BraceDepth-1 LCURLY_BRACE">{</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">        </span><span class="PrimaryExpression FunctionCall Token Identifier ID">init</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="CompoundStatement SelectionStatement Token BraceDepth-1 RCURLY_BRACE">}</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">    </span><span class="IterationStatement Token Keyword FOR">for</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="IterationStatement Token BraceDepth-1 LPAREN">(</span><span class="IterationStatement Token SEMI">;</span><span class="IterationStatement Token SEMI">;</span><span class="IterationStatement Token BraceDepth-1 RPAREN">)</span><span class="IterationStatement Token SPACE"> </span><span class="PrimaryExpression FunctionCall Token Identifier ID">pause</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement IterationStatement Token SEMI">;</span><span class="ExpressionStatement IterationStatement Token LF">
</span><span class="CompoundStatement BraceDepth-0 Token Function RCURLY_BRACE">}</span></code></pre><p>各部分初始化之后 , 系统已经处理可以运行的状态了, 这时候操作系统进入用户态 <code>move_to_user_mode</code>, 将自己移至任务0(进程0)中, 并且使用 fork 创建进程1 (init进程)</p><hr><p>这里要注意到是, 由于fork创建新进程的过程是通过完全复制父进程代码段和数据段的方式实现的, 因此在首次使用 fork创建新进程并执行 init 时, 为了确保新进程用户态堆栈没有进程 0 的多余信息, 要求进程 0 在创建首个新进程之前不要使用用户态堆栈, <b>即要求任务0不要调用函数</b></p><p>因此在 main.c 主函数移动到任务0执行之后, 任务0 中的代码fork不能以函数的形式进行调用, 所以使用了 gcc 函数内嵌汇编的方式</p><p>任务0 的pause 也是内联汇编, 因为无法确定父进程和子进程的调用顺序, 所以需要保证这里也不会使用用户态堆栈</p><hr><p>init中的任务也并不复杂</p><ul><li>使用 <code>setup((void*)&amp;drive_info)</code> 安装根文件系统设备</li></ul><ul><li>打开设备tty0, 创建终端标准 IO stdin stdout stderr<ul><li>再次fork在子进程中将终端输入定向到 rc</li></ul></li></ul><ul><li>再次fork一个子进程,新建会话开启 /bin/sh. 如果子进程退出则父进程进入死循环继续生成子进程, 等待</li></ul><pre class="language-c"><code><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword VOID">void</span><span class="BaseType TypeSpecifier Token FunctionReturnType Keyword SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">init</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="BraceDepth-0 Token Declarator DirectDeclaractor RPAREN">)</span><span class="Token Declarator DirectDeclaractor SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="TypeSpecifier BaseType Token Keyword INT">int</span><span class="TypeSpecifier BaseType Token Keyword SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pid</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Declaration Token COMMENT">// setup 是一个系统调用</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Declaration Token COMMENT">// 读取硬盘参数包括分区表信息, 加载虚拟盘, 安装根文件系统设备</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">setup</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="ConditionalExpression BraceDepth-2 Token CastExpression LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="AbstractDeclarator Pointer Token POINTER">*</span><span class="ConditionalExpression BraceDepth-2 Token CastExpression RPAREN">)</span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="PrimaryExpression Token Identifier ID">drive_info</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// 以读写访问方式打开 tty0</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ConditionalExpression BraceDepth-1 Token CastExpression LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="ConditionalExpression BraceDepth-1 Token CastExpression RPAREN">)</span><span class="PrimaryExpression FunctionCall Token Identifier ID">open</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;/dev/tty0&quot;</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier MacroDefine ID">O_RDWR</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 0 -&gt; stdin</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ConditionalExpression BraceDepth-1 Token CastExpression LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="ConditionalExpression BraceDepth-1 Token CastExpression RPAREN">)</span><span class="PrimaryExpression FunctionCall Token Identifier ID">dup</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">                        </span><span class="ExpressionStatement Token COMMENT">// 复制句柄1号 -&gt; stdout</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ConditionalExpression BraceDepth-1 Token CastExpression LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="ConditionalExpression BraceDepth-1 Token CastExpression RPAREN">)</span><span class="PrimaryExpression FunctionCall Token Identifier ID">dup</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">                        </span><span class="ExpressionStatement Token COMMENT">// 复制句柄2号 -&gt; stderr</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// 缓冲区块数</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">printf</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Format Token String STRING">%d</span><span class="Token String STRING"> buffers = </span><span class="Format Token String STRING">%d</span><span class="Token String STRING"> bytes buffer space</span><span class="String Token Control STRING">\n</span><span class="Token String STRING">\r&quot;</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier MacroDefine ID">NR_BUFFERS</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression LF">
</span><span class="UnaryExpression Token PostfixExpression SPACE">           </span><span class="PrimaryExpression Token Identifier MacroDefine ID">NR_BUFFERS</span><span class="PrimaryExpression Token Identifier MacroDefine SPACE"> </span><span class="ConditionalExpression BinaryOp Token MUL">*</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Identifier MacroDefine ID">BLOCK_SIZE</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// 内存总字节数</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">printf</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;Free mem: </span><span class="Format Token String STRING">%d</span><span class="Token String STRING"> bytes</span><span class="String Token Control STRING">\n</span><span class="Token String STRING">\r&quot;</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier ID">memory_end</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="ConditionalExpression BinaryOp Token MINUS">-</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Identifier ID">main_memory_start</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// fork 的子进程返回 0</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">//        父进程返回子进程 pid</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// 这里只执行子进程</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="SelectionStatement Token BraceDepth-1 LPAREN">(</span><span class="UnaryOp Token UnaryExpression BANG">!</span><span class="PrimaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">pid</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="PrimaryExpression FunctionCall Token Identifier ID">fork</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="PrimaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="SelectionStatement Token BraceDepth-1 RPAREN">)</span><span class="SelectionStatement Token SPACE"> </span><span class="CompoundStatement SelectionStatement Token BraceDepth-1 LCURLY_BRACE">{</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">        </span><span class="PrimaryExpression FunctionCall Token Identifier ID">close</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">                          </span><span class="ExpressionStatement Token COMMENT">// 关闭 stdin</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">        </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="BraceDepth-2 SelectionStatement Token LPAREN">(</span><span class="PrimaryExpression FunctionCall Token Identifier ID">open</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;/etc/rc&quot;</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier MacroDefine ID">O_RDONLY</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="BraceDepth-2 SelectionStatement Token RPAREN">)</span><span class="SelectionStatement Token SPACE">  </span><span class="SelectionStatement Token COMMENT">// 只读打开 /etc/rc</span><span class="SelectionStatement Token LF">
</span><span class="SelectionStatement Token SPACE">            </span><span class="PrimaryExpression FunctionCall Token Identifier ID">_exit</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">1</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement SelectionStatement Token SEMI">;</span><span class="ExpressionStatement SelectionStatement Token LF">
</span><span class="ExpressionStatement SelectionStatement Token SPACE">        </span><span class="PrimaryExpression FunctionCall Token Identifier ID">execve</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;/bin/sh&quot;</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier ID">argv_rc</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier ID">envp_rc</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 将进程自身替换成 /bin/sh 程序,</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">                                              </span><span class="ExpressionStatement Token COMMENT">// 参数使用的是 argv_rc envp_rc</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">        </span><span class="PrimaryExpression FunctionCall Token Identifier ID">_exit</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">2</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 1: 操作未许可 2: 文件/目录不存在</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="CompoundStatement SelectionStatement Token BraceDepth-1 RCURLY_BRACE">}</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">    </span><span class="CompoundStatement SelectionStatement Token COMMENT">// 父进程等待子进程结束</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">    </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="SelectionStatement Token BraceDepth-1 LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">pid</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="ConditionalExpression BinaryOp Token GT">&gt;</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="SelectionStatement Token BraceDepth-1 RPAREN">)</span><span class="SelectionStatement Token LF">
</span><span class="SelectionStatement Token SPACE">        </span><span class="IterationStatement Token Keyword WHILE">while</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="IterationStatement SelectionStatement Token BraceDepth-1 LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">pid</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="ConditionalExpression BinaryOp Token NE">!=</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression FunctionCall Token Identifier ID">wait</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="PrimaryExpression Token Identifier ID">i</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="IterationStatement SelectionStatement Token BraceDepth-1 RPAREN">)</span><span class="IterationStatement SelectionStatement Token SPACE"> </span><span class="IterationStatement SelectionStatement Token COMMENT">/* nothing */</span><span class="IterationStatement SelectionStatement Token LF">
</span><span class="IterationStatement SelectionStatement Token SPACE">            </span><span class="ExpressionStatement IterationStatement Token SEMI">;</span><span class="ExpressionStatement IterationStatement Token LF">
</span><span class="ExpressionStatement IterationStatement Token SPACE">    </span><span class="IterationStatement Token Keyword WHILE">while</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="IterationStatement Token BraceDepth-1 LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">1</span><span class="IterationStatement Token BraceDepth-1 RPAREN">)</span><span class="IterationStatement Token SPACE"> </span><span class="CompoundStatement IterationStatement Token BraceDepth-1 LCURLY_BRACE">{</span><span class="CompoundStatement IterationStatement Token LF">
</span><span class="CompoundStatement IterationStatement Token SPACE">        </span><span class="CompoundStatement IterationStatement Token COMMENT">// 创建子进程失败</span><span class="CompoundStatement IterationStatement Token LF">
</span><span class="CompoundStatement IterationStatement Token SPACE">        </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="BraceDepth-2 SelectionStatement Token LPAREN">(</span><span class="PrimaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">pid</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="PrimaryExpression FunctionCall Token Identifier ID">fork</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="PrimaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="PrimaryExpression Token PostfixExpression SPACE"> </span><span class="ConditionalExpression BinaryOp Token LT">&lt;</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="BraceDepth-2 SelectionStatement Token RPAREN">)</span><span class="SelectionStatement Token SPACE"> </span><span class="CompoundStatement BraceDepth-2 SelectionStatement Token LCURLY_BRACE">{</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">            </span><span class="PrimaryExpression FunctionCall Token Identifier ID">printf</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;Fork failed in init\r</span><span class="String Token Control STRING">\n</span><span class="Token String STRING">&quot;</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="JumpStatement Token Keyword CONTINUE">continue</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="CompoundStatement BraceDepth-2 SelectionStatement Token RCURLY_BRACE">}</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">        </span><span class="CompoundStatement SelectionStatement Token COMMENT">// 子进程执行</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">        </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="BraceDepth-2 SelectionStatement Token LPAREN">(</span><span class="UnaryOp Token UnaryExpression BANG">!</span><span class="PrimaryExpression Token Identifier ID">pid</span><span class="BraceDepth-2 SelectionStatement Token RPAREN">)</span><span class="SelectionStatement Token SPACE"> </span><span class="CompoundStatement BraceDepth-2 SelectionStatement Token LCURLY_BRACE">{</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">            </span><span class="CompoundStatement SelectionStatement Token COMMENT">// 关闭子进程的 stdin stdout stderr</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">            </span><span class="PrimaryExpression FunctionCall Token Identifier ID">close</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="PrimaryExpression FunctionCall Token Identifier ID">close</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">1</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="PrimaryExpression FunctionCall Token Identifier ID">close</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">2</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="ExpressionStatement Token COMMENT">// 新建会话并设置进程组号</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="PrimaryExpression FunctionCall Token Identifier ID">setsid</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="ConditionalExpression BraceDepth-0 Token CastExpression LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="ConditionalExpression BraceDepth-0 Token CastExpression RPAREN">)</span><span class="PrimaryExpression FunctionCall Token Identifier ID">open</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;/dev/tty0&quot;</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier MacroDefine ID">O_RDWR</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 重新打开 tty0 作为 stdin</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="ConditionalExpression BraceDepth-0 Token CastExpression LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="ConditionalExpression BraceDepth-0 Token CastExpression RPAREN">)</span><span class="PrimaryExpression FunctionCall Token Identifier ID">dup</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">                        </span><span class="ExpressionStatement Token COMMENT">// 复制得到 stdout stderr</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="ConditionalExpression BraceDepth-0 Token CastExpression LPAREN">(</span><span class="TypeSpecifier BaseType Token Keyword VOID">void</span><span class="ConditionalExpression BraceDepth-0 Token CastExpression RPAREN">)</span><span class="PrimaryExpression FunctionCall Token Identifier ID">dup</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="PrimaryExpression FunctionCall Token Identifier ID">_exit</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression FunctionCall Token Identifier ID">execve</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;/bin/sh&quot;</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier ID">argv</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression LF">
</span><span class="UnaryExpression Token PostfixExpression SPACE">                         </span><span class="PrimaryExpression Token Identifier ID">envp</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 再次执行系统解释程序 /bin/sh,</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">                                  </span><span class="ExpressionStatement Token COMMENT">// 这里的参数选择了 argv envp</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">        </span><span class="CompoundStatement BraceDepth-2 SelectionStatement Token RCURLY_BRACE">}</span><span class="CompoundStatement SelectionStatement Token LF">
</span><span class="CompoundStatement SelectionStatement Token SPACE">        </span><span class="IterationStatement Token Keyword WHILE">while</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="IterationStatement BraceDepth-2 Token LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">1</span><span class="IterationStatement BraceDepth-2 Token RPAREN">)</span><span class="IterationStatement Token LF">
</span><span class="IterationStatement Token SPACE">            </span><span class="IterationStatement Token COMMENT">// 父进程等待子进程结束</span><span class="IterationStatement Token LF">
</span><span class="IterationStatement Token SPACE">            </span><span class="SelectionStatement Token Keyword IF">if</span><span class="SelectionStatement Token Keyword SPACE"> </span><span class="IterationStatement SelectionStatement Token BraceDepth-2 LPAREN">(</span><span class="PrimaryExpression Token Identifier ID">pid</span><span class="PrimaryExpression Token Identifier SPACE"> </span><span class="ConditionalExpression BinaryOp Token EQ">==</span><span class="ConditionalExpression BinaryOp Token SPACE"> </span><span class="PrimaryExpression FunctionCall Token Identifier ID">wait</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression LPAREN">(</span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="PrimaryExpression Token Identifier ID">i</span><span class="UnaryExpression BraceDepth-0 Token PostfixExpression RPAREN">)</span><span class="IterationStatement SelectionStatement Token BraceDepth-2 RPAREN">)</span><span class="IterationStatement SelectionStatement Token LF">
</span><span class="IterationStatement SelectionStatement Token SPACE">                </span><span class="JumpStatement Token Keyword BREAK">break</span><span class="SelectionStatement Token JumpStatement SEMI">;</span><span class="SelectionStatement Token JumpStatement LF">
</span><span class="SelectionStatement Token JumpStatement SPACE">        </span><span class="PrimaryExpression FunctionCall Token Identifier ID">printf</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="String Token Control STRING">\n</span><span class="Token String STRING">\rchild </span><span class="Format Token String STRING">%d</span><span class="Token String STRING"> died with code </span><span class="Format Token String STRING">%04x</span><span class="String Token Control STRING">\n</span><span class="Token String STRING">\r&quot;</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier ID">pid</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="PrimaryExpression Token Identifier ID">i</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">        </span><span class="PrimaryExpression FunctionCall Token Identifier ID">sync</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression LPAREN">(</span><span class="UnaryExpression BraceDepth-2 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// 同步操作 刷新缓冲区</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="CompoundStatement IterationStatement Token BraceDepth-1 RCURLY_BRACE">}</span><span class="CompoundStatement IterationStatement Token LF">
</span><span class="CompoundStatement IterationStatement Token SPACE">    </span><span class="PrimaryExpression FunctionCall Token Identifier ID">_exit</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression LPAREN">(</span><span class="PrimaryExpression Token Constant NUMBER">0</span><span class="UnaryExpression BraceDepth-1 Token PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE"> </span><span class="ExpressionStatement Token COMMENT">/* NOTE! _exit, not exit() */</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// _exit 是一个 sys_exit 的系统调用</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// exit 是普通函数库中的一个函数</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement BraceDepth-0 Token Function RCURLY_BRACE">}</span></code></pre><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230322153449.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230322153449.png" alt="20230322153449"></a></p><h3 id="h3-6">登录</h3><p>在0.11版本的代码中init函数直接开始执行了/bin/sh, 在现代实际可用的系统中还需要处理多人同时使用系统, 区分用户等能力. 通常程序会根据系统 /etc 目录中的配置文件的设置信息, 对系统中支持的每个终端设备创建子进程, 并在子进程中运行终端初始化设置程序 getty 以提示用于输入登录提示信息 login, 当用户键入用户名之后 getty 替换去执行 login 程序, 验证用户输入口令的正确性之后调用 shell 程序并且进入 shell 交互工作界面</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230323171144.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230323171144.png" alt="20230323171144"></a></p><h3 id="h3-7">进程组 会话(session)</h3><p>当我们使用如下命令的时候, 此命令包含了三个命令行程序 cat grep more, 并使用管道符 <code>|</code> 连接</p><pre class="language-shell"><code><span class="Token Program ID">cat</span><span class="Token SPACE"> </span><span class="Token PATH">init/main.c</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">grep</span><span class="Token SPACE"> </span><span class="Token Keyword FOR">for</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">more</span></code></pre><pre class="language-shell"><code><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token Program ID">base</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/klinux/init</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">cat</span><span class="Token SPACE"> </span><span class="Token ID">main.c</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">grep</span><span class="Token SPACE"> </span><span class="Token Keyword FOR">for</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">more</span><span class="Token LF">
</span><span class="Token Program PATH">//</span><span class="Token SPACE"> </span><span class="Token ID">下面这四句用了宏</span><span class="Token SPACE"> </span><span class="Token ID">syscall0</span><span class="Token SPACE"> </span><span class="Token ID">syscall1</span><span class="Token SPACE"> </span><span class="Token ID">去展开</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">相当于</span><span class="Token SPACE"> </span><span class="Token ID">int</span><span class="Token SPACE"> </span><span class="Token Function ID">fork</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LCURLY_BRACE">{</span><span class="Token ID">...</span><span class="BraceDepth-0 Token RCURLY_BRACE">}</span><span class="Token LF">
</span><span class="Token Program ID">static</span><span class="Token SPACE"> </span><span class="Token ID">inline</span><span class="Token SPACE"> </span><span class="Token Function ID">_syscall0</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">fork</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SEMI">;</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program PATH">//</span><span class="Token SPACE"> </span><span class="Token ID">fork</span><span class="Token SPACE"> </span><span class="Token ID">一个进程并在子进程中执行</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token BANG">!</span><span class="Token Function ID">fork</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LCURLY_BRACE">{</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Keyword FOR">for</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token SEMI">;</span><span class="Token SEMI">;</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token Program Function ID">pause</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token SEMI">;</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program PATH">//</span><span class="Token SPACE"> </span><span class="Token ID">fork</span><span class="Token SPACE"> </span><span class="Token ID">的子进程返回</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token BANG">!</span><span class="BraceDepth-2 Token LPAREN">(</span><span class="Token Variant ID">pid</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token Function ID">fork</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="BraceDepth-2 Token RPAREN">)</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LCURLY_BRACE">{</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="BraceDepth-2 Token LPAREN">(</span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token Variant ID">pid</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token Function ID">fork</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="BraceDepth-2 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="BraceDepth-2 Token LCURLY_BRACE">{</span></code></pre><p>这里的三个进程属于同一个进程组</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230323170440.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230323170440.png" alt="20230323170440"></a></p><p>进程组是一个或者多个进程的集合, 每一个进程组都有一个唯一的进程组标识号gid, 每一个进程组有一个称为组长的进程, 组长进程的pid等于进程组的gid</p><p>一个进程可以通过setpgid来参加一个现有的进程组或者创建一个新的进程组. 进程组的概念有很多用途, 最常见的是我们在终端上向前台执行程序发出终止信号, 同时终止整个进程组中的所有进程</p><p>会话(session) 是一个或多个进程组的集合, 通常情况下用户登录后所执行的所有程序都属于一个会话期, 登陆的shell时会话期的首进程(session header), 当用户退出登录之后 logout, 所有属于我们的会话期的进程都将要被终止, 这是会话期的主要用途之一</p></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../快速开始/编译内核" >快速开始</a><ul><li><a href="../../快速开始/编译内核" >编译内核</a></li></ul><ul><li><a href="../../快速开始/调试内核" >调试内核</a></li></ul><ul><li><a href="../../快速开始/制作文件系统" >制作文件系统</a></li></ul><ul><li><a href="../../快速开始/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../快速开始/linux目录结构" >linux目录结构</a></li></ul><ul><li><a href="../../快速开始/邮件订阅" >邮件订阅</a></li></ul></li></ul><ul><li><a href="../../linux011/README" >linux011</a><ul><li><a href="../../linux011/README" >README</a></li></ul><ul><li><a href="../../linux011/基础知识概览" >基础知识概览</a></li></ul><ul><li><a href="../../linux011/init" >init</a></li></ul><ul><li><a href="../../linux011/kernel" >kernel</a></li></ul><ul><li><a href="../../linux011/mm" >mm</a></li></ul></li></ul><ul><li><a href="../../内存管理/物理布局探测" >内存管理</a><ul><li><a href="../../内存管理/物理布局探测" >物理布局探测</a></li></ul><ul><li><a href="../../内存管理/NUMA" >NUMA</a></li></ul><ul><li><a href="../../内存管理/buddy" >buddy</a></li></ul><ul><li><a href="../../内存管理/slab分配器" >slab分配器</a></li></ul><ul><li><a href="../../内存管理/memory compaction" >memory compaction</a></li></ul></li></ul><ul><li><a href="../../arch/ACPI" >arch</a><ul><li><a href="../../arch/ACPI" >ACPI</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../linux011/基础知识概览","../../linux011/kernel","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>