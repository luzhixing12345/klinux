<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">init</a><ul><li><a href="#h2-1">idle 进程</a></li></ul><ul><li><a href="#h2-2">init</a></li></ul><ul><li><a href="#h2-3">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">init</h1><p>在 linux 启动过程中的三个特殊进程 <code>idle</code> <code>init</code> 和 <code>kthreadd</code></p><h2 id="h2-1">idle 进程</h2><p><a href="https://github.com/torvalds/linux/blob/v6.6/init/main.c" target="_blank">/init/main.c</a> 文件中的<a href="https://github.com/torvalds/linux/blob/ffc253263a1375a65fa6c9f62a893e9767fbebfa/init/main.c#L870C6-L870C18" target="_blank">start_kernel()</a>函数是一切的起点,在这个函数被调用之前都是系统的初始化工作(汇编语言),所以对内核的启动分析一般都从这个函数开始</p><p>这个函数在执行的过程中初始化、定义了内核中一些十分重要的内容,其执行过程几乎涉及到了内核的所有模块的初始化, 我们这里主要关注<b>进程初始化</b>的部分.</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">__init</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">start_kernel</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">command_line</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">after_dashes</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">/*
     * Need to run as early as possible, to initialize the
     * lockdep hash:
     */</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">lockdep_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">set_task_stack_end_magic</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">init_task</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 一大堆 init</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">rest_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>首先第一行就使用 <a href="https://github.com/torvalds/linux/blob/ffc253263a1375a65fa6c9f62a893e9767fbebfa/init/main.c#L875" target="_blank">set_task_stack_end_magic(&amp;init_task)</a> 去初始化 <code>init_task</code>, 这个函数本身不稀奇, 只是单纯的为 init_task 添加一个栈溢出的标记保护位, 值得注意的是 <code>init_task</code> 变量本身, 它实际上是在 C 中被<a href="https://github.com/torvalds/linux/blob/ffc253263a1375a65fa6c9f62a893e9767fbebfa/init/init_task.c#L64" target="_blank">初始化定义</a> 的</p><blockquote><p>在早期的一些版本(4.4)中也会使用 <a href="https://github.com/torvalds/linux/blob/afd2ff9b7e1b367172f18ba7f693dfb62bdcb2dc/init/init_task.c#L18" target="_blank">INIT_TASK</a> 宏来进行<a href="https://github.com/torvalds/linux/blob/afd2ff9b7e1b367172f18ba7f693dfb62bdcb2dc/include/linux/init_task.h#L190" target="_blank">展开</a>, 效果是完全相同的</p></blockquote><p>init_task 这个变量的 <code>comm</code> 字段的名字是 <a href="https://github.com/torvalds/linux/blob/ffc253263a1375a65fa6c9f62a893e9767fbebfa/include/linux/init_task.h#L38" target="_blank">&quot;swapper&quot;</a>, 这个字段在 <code>task_struct</code> 即进程结构体中的含义是<a href="https://github.com/torvalds/linux/blob/ffc253263a1375a65fa6c9f62a893e9767fbebfa/include/linux/sched.h#L1072-L1078" target="_blank">可执行文件的名字</a></p><blockquote><p>初始(idle)进程的名字 swapper 其实就是从 UNIX 时代延续下来的, 曾经也有人给 linux 提过 <a href="https://www.uwsg.indiana.edu/hypermail/linux/kernel/0604.2/1270.html" target="_blank">patch</a> 想要将名字改为 &quot;idle&quot; 但被拒绝了</p><blockquote><p>Yes, swapper is because of historical reasons. In most text books for Unix, the initial process on boot up is called &quot;swapper&quot;. Probably because those early Unix systems had this process handle the swapping (as kswapd does today).</p><p>By doing this, it will probably make Linux out of sync with all the text books on Unix, so it really is Linus&#x27; call.</p></blockquote><p>回复的意思大致是说 swapper 的名字只是为了和 UNIX 系统保持一致</p></blockquote><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">INIT_TASK_COMM</span><span class="Token PPtoken SPACE"> </span><span class="Token String STRING">&quot;swapper&quot;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">task_struct</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">init_task</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">    </span><span class="Token Initializer InitDeclarator COMMENT">// ...</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">comm</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">INIT_TASK_COMM</span><span class="Token Identifier MacroDefine PrimaryExpression LF">
</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression COMMENT">//</span><span class="Token Identifier MacroDefine PrimaryExpression LF">
</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE">    </span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">prio</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">MAX_PRIO</span><span class="Token BinaryOp ConditionalExpression MINUS">-</span><span class="Token Constant PrimaryExpression NUMBER">20</span><span class="Token Constant PrimaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression COMMENT">// 优先级最低</span><span class="Token Constant PrimaryExpression LF">
</span><span class="Token Initializer InitDeclarator BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p>我们可以在开头打一个断点查看 init_task.comm 的字段, 确实为 &quot;swapper&quot;</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240312122051.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240312122051.png" alt="20240312122051"></a></p><p>或者在 gdb 中调试, 使用 <code>lx_current</code> 来获取当前进程, 可以看到当前 idle 进程的 pid 为 0, 且 comm 为 &quot;swapper&quot;</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">gdb</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token ID">p</span><span class="Token SPACE"> </span><span class="Token VARIANT">$lx_current</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ID">.pid</span><span class="Token LF">
</span><span class="Token VARIANT">$1</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">gdb</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token ID">p</span><span class="Token SPACE"> </span><span class="Token VARIANT">$lx_current</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ID">.comm</span><span class="Token LF">
</span><span class="Token VARIANT">$2</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;swapper\000\000\000\000\000\000\000\000&quot;</span></code></pre><blockquote><p>结构体字段 <code>.pid</code> 并没有直接被赋值, 因为在 .data 段而默认初始化为 0</p></blockquote><p>之后start_kernel()函数继续调用各个系统模块进行各种初始化之类的工作, 比如 <code>trap_init()</code>是中断向量的相关设置, <code>mm_init()</code>是内存管理的设置, <code>sched_init()</code>是调度模块的初始化</p><p>idle 运行在<b>内核态</b>, 在执行了上面的各项工作之后, 在 start_kernel() 函数的最后一行代码调用了另一个非常重要的函数 <a href="https://github.com/torvalds/linux/blob/ffc253263a1375a65fa6c9f62a893e9767fbebfa/init/main.c#L680" target="_blank">rest_init</a>, 创建了两个进程 <code>kernel_init</code> 和 <code>kthreadd</code></p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">rest_init</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// ...</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">kernel_thread</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">kernel_init</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">CLONE_FS</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">pid</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">kernel_thread</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">kthreadd</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">CLONE_FS</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression PIPE">|</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">CLONE_FILES</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// ...</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>6.6 的 kernel 使用的是 <a href="https://github.com/torvalds/linux/blob/ffc253263a1375a65fa6c9f62a893e9767fbebfa/init/main.c#L691" target="_blank">user_mode_thread</a> 来创建用户级进程 &quot;kernel_init&quot;, 它和使用 kernel_thread 创建的没有<a href="https://github.com/torvalds/linux/blob/480e035fc4c714fb5536e64ab9db04fedc89e910/kernel/fork.c#L2845-L2875" target="_blank">区别</a></p><p>另外不是很清楚为什么明明是进程却叫做 thread 而不是 process</p></blockquote><p>kernel_thread 用于 fork 一个新的进程, <b>但此时需要注意的是该进程还并没有被调度执行</b></p><pre class="language-c"><code><span class="Token COMMENT">/*
 * Create a kernel thread.
 */</span><span class="Token LF">
</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">pid_t</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">kernel_thread</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP ID">fn</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">arg</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">flags</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">_do_fork</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">flags</span><span class="Token BinaryOp ConditionalExpression PIPE">|</span><span class="Token Identifier MacroDefine PrimaryExpression ID">CLONE_VM</span><span class="Token BinaryOp ConditionalExpression PIPE">|</span><span class="Token Identifier MacroDefine PrimaryExpression ID">CLONE_UNTRACED</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-2 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token CastExpression ConditionalExpression BraceDepth-2 RPAREN">)</span><span class="Token Identifier FunctionP PrimaryExpression ID">fn</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">        </span><span class="Token CastExpression ConditionalExpression BraceDepth-2 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token CastExpression ConditionalExpression BraceDepth-2 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">arg</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>6.6 实际调用的是 <a href="https://github.com/torvalds/linux/blob/480e035fc4c714fb5536e64ab9db04fedc89e910/kernel/fork.c#L2755" target="_blank">kernel_clone</a>, 原理与 _do_fork 类似</p></blockquote><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240314231716.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240314231716.png" alt="20240314231716"></a></p><p>这里不会深入探讨有关 kernel_thread 实现的细节(我们将在描述调度程序详细展开).现在我们只需要知道我们用 kernel_thread 函数创建了新的内核进程,父进程和子进程将使用有关文件系统的共享信息. 内核进程不同于它在内核模式下运行的用户进程.因此,通过这两个 kernel_thread 调用,我们创建了两个新的内核进程,其中包含 <code>PID = 1</code> 的 init 进程和 <code>PID = 2</code> 的 kthreadd 进程, 进入 shell 之后也可以使用 ps 查看</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240314231941.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240314231941.png" alt="20240314231941"></a></p><p>idle 进程初始化的时候进程的优先级被设置为了 <code>.prio = MAX_PRIO-20</code>(120), 数值越低代表优先级越高, 因此 idle 实际上是优先级最低的一个进程</p><p>idle 进程最后调用 cpu_startup_entry, 调用 cpu_idle_loop, 简化后的执行逻辑如下, 当系统无事可做时,会调度其执行, 此时该内核会变为idle进程,让出CPU,自己进入睡眠, 进入一个无限循环</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">cpu_idle</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">/* endless idle loop with no priority at all */</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">need_resched</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token IterationStatement BraceDepth-2 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">            </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">cpu_is_offline</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">smp_processor_id</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">                </span><span class="Token Identifier PrimaryExpression FunctionCall ID">tick_set_cpu_plugoff_flag</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">                </span><span class="Token Identifier PrimaryExpression FunctionCall ID">cpu_die</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">/* plugoff CPU */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">cpuidle_idle_call</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">                </span><span class="Token Identifier PrimaryExpression FunctionCall ID">pm_idle</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement SPACE"> </span><span class="Token ExpressionStatement SelectionStatement COMMENT">/* 进入低电 */</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">schedule_preempt_disabled</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">/* 调用schedule() */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>早先版本中,idle是参与调度的,所以将其优先级设低点,当没有其他进程可以运行时,才会调度执行 idle.而目前的版本中idle并不在运行队列中参与调度,而是在运行队列结构中含idle指针,指向idle进程,在调度器发现运行队列为空的时候运行,调入运行</p></blockquote><h2 id="h2-2">init</h2><h2 id="h2-3">参考</h2><ul><li><a href="https://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-6.html" target="_blank">gitbooks 0xax</a></li></ul><ul><li><a href="https://www.cnblogs.com/linhaostudy/p/8577504.html" target="_blank">systemd的作用</a></li></ul><ul><li><a href="https://blog.csdn.net/u013686805/article/details/19905941" target="_blank">[linux]进程(三)_idle进程</a></li></ul><ul><li><a href="https://cloud.tencent.com/developer/article/1339566" target="_blank">Linux下0号进程的前世(init_task进程)今生(idle进程)----Linux进程的管理与调度(五)【转】</a></li></ul><ul><li><a href="https://blog.csdn.net/JoggingPig/article/details/110239518" target="_blank">Linux中的特殊进程:idle进程、init进程、kthreadd进程</a></li></ul><ul><li><a href="https://blog.csdn.net/FIELDOFFIER/article/details/44518597" target="_blank">&lt;Linux内核分析&gt;(三)_跟踪分析Linux内核的启动过程</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../快速开始/编译内核" >快速开始</a><ul><li><a href="../../快速开始/编译内核" >编译内核</a></li></ul><ul><li><a href="../../快速开始/调试内核" >调试内核</a></li></ul><ul><li><a href="../../快速开始/制作文件系统" >制作文件系统</a></li></ul><ul><li><a href="../../快速开始/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../快速开始/linux目录结构" >linux目录结构</a></li></ul><ul><li><a href="../../快速开始/邮件订阅" >邮件订阅</a></li></ul></li></ul><ul><li><a href="../../mm/物理布局探测" >mm</a><ul><li><a href="../../mm/物理布局探测" >物理布局探测</a></li></ul><ul><li><a href="../../mm/NUMA" >NUMA</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab分配器" >slab分配器</a></li></ul><ul><li><a href="../../mm/memory compaction" >memory compaction</a></li></ul></li></ul><ul><li><a href="../../runtime/proc" >runtime</a><ul><li><a href="../../runtime/proc" >proc</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul><ul><li><a href="../../runtime/elf_format" >elf_format</a></li></ul><ul><li><a href="../../runtime/elf_loader" >elf_loader</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul><ul><li><a href="../../kernel/interrupt" >interrupt</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cache-coherence" >cache-coherence</a></li></ul><ul><li><a href="../../arch/memory-coherence" >memory-coherence</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/disk" >disk</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul></li></ul><ul><li><a href="../../proc/cpu" >proc</a><ul><li><a href="../../proc/cpu" >cpu</a></li></ul></li></ul><ul><li><a href="../../device/init" >device</a><ul><li><a href="../../device/init" >init</a></li></ul></li></ul><ul><li><a href="../../others/safety" >others</a><ul><li><a href="../../others/safety" >safety</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../runtime/elf_loader","../../kernel/interrupt","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>