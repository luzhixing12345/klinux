<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css /><link rel='stylesheet' href=../../../css/x86asm.css /><link rel='stylesheet' href=../../../css/yaml.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">静态链接</a><ul><li><a href="#h2-1">空间和地址分配</a><ul><li><a href="#h3-2">空间地址分配的含义</a></li></ul><ul><li><a href="#h3-3">手动链接</a></li></ul></li></ul><ul><li><a href="#h2-4">符号解析和重定位</a><ul><li><a href="#h3-5">符号解析</a></li></ul><ul><li><a href="#h3-6">地址重定位</a></li></ul></li></ul><ul><li><a href="#h2-7">静态库链接</a></li></ul><ul><li><a href="#h2-8">最小的 HelloWorld 程序</a></li></ul><ul><li><a href="#h2-9">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">静态链接</h1><p>链接的这个过程主要解决如何将多个目标文件链接起来得到一个可执行文件</p><p>假设分别有如下的两个文件 a.c b.c</p><blockquote><p>注意这里和书上的有点区别在于a.c中添加了 extern swap 的声明</p></blockquote><pre class="language-c"><code><span class="Token Keyword StorageType EXTERN">extern</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">shared</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword StorageType FunctionReturnType EXTERN">extern</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">swap</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">a</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">b</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">a</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">100</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier FunctionName PrimaryExpression ID">swap</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token PPtoken AMPERSAND">&amp;</span><span class="Token Identifier ID">a</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken AMPERSAND">&amp;</span><span class="Token Identifier ID">shared</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">shared</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">swap</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">a</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">b</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token UnaryOp UnaryExpression POINTER">*</span><span class="Token Identifier PrimaryExpression ID">a</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression XOR_ASSIGN">^=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression POINTER">*</span><span class="Token Identifier PrimaryExpression ID">b</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression POINTER">*</span><span class="Token Identifier PrimaryExpression ID">a</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression XOR_ASSIGN">^=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression POINTER">*</span><span class="Token Identifier PrimaryExpression ID">b</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h2 id="h2-1">空间和地址分配</h2><p>我们知道可执行文件中的代码段和数据段都是由输入的目标文件合并起来的, 那么对于多目标文件来说, 链接器是如何将各个段合并到输出文件的呢? 或者说, 输出文件中的空间应该如何分配给输入文件?</p><p>一个简单的方法就是按次序叠加起来, 如下所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230515145541.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230515145541.png" alt="20230515145541"></a></p><p>但是这种方式有很严重的问题, 首先对于多个输入文件的情况会出现很多零散的段, 每一个段都有一定的地址和空间对齐要求, 对于 x86 的硬件来说段的装在地址和空间的对齐单位是 4096 字节, 也就是说即使一个段的长度只有1字节, 他也需要在内存中占据 4096 字节, 因此这并不是一个好的方案</p><p>实际上使用的方式是将各个段合并到一起, 相同性质的段组合为一个大段, 如下所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111151629.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111151629.png" alt="20240111151629"></a></p><h3 id="h3-2">空间地址分配的含义</h3><p>前文提到了 .bss 段实际上并不占用文件的空间, 在装载时占用地址空间. 那么这里我们可以思考一个问题, <b>就是所谓的空间分配到底是什么空间</b>?</p><p>这样讲起来有点抽象, 不如举一个例子. 对于下面的代码, 全局变量中有一个 x[1000], 由于并未初始化所以它应该分配在 bss 段中</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">x</span><span class="Token DirectDeclaractorPostfix BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression NUMBER">1000</span><span class="Token DirectDeclaractorPostfix BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token ID">bss.c</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">bss</span><span class="Token LF">
</span><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">nm</span><span class="Token SPACE"> </span><span class="Token ID">bss</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">grep</span><span class="Token SPACE"> </span><span class="Token ID">x</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">w</span><span class="Token SPACE"> </span><span class="Token ID">__cxa_finalize@GLIBC_2.2.5</span><span class="Token LF">
</span><span class="Token NUMBER">00000000000010e0</span><span class="Token SPACE"> </span><span class="Token Program ID">t</span><span class="Token SPACE"> </span><span class="Token ID">__do_global_dtors_aux</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000003</span><span class="Token Program ID">df8</span><span class="Token SPACE"> </span><span class="Token ID">d</span><span class="Token SPACE"> </span><span class="Token ID">__do_global_dtors_aux_fini_array_entry</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000004040</span><span class="Token SPACE"> </span><span class="Token Program ID">B</span><span class="Token SPACE"> </span><span class="Token ID">x</span></code></pre><blockquote><p>B 对应 .bss, D 对应 .data</p></blockquote><p>可以看到最后一行说明了 x 确实分配在 bss 段中, 通过 du 可以得到这个可执行文件的大小是 16KB</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">du</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">bss</span><span class="Token LF">
</span><span class="Token NUMBER">16K</span><span class="Token SPACE">     </span><span class="Token Program ID">bss</span></code></pre><p>但是如果我们稍微修改一下</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">x</span><span class="Token DirectDeclaractorPostfix BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression NUMBER">1000</span><span class="Token DirectDeclaractorPostfix BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token DirectDeclaractorPostfix SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token Initializer InitDeclarator BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>此时可以看到, x 由于已经被初始化了所以被分配在 data 段中, 并且文件的体积也扩大到了 20KB, 多出来的 4KB 显然就是 x 数组的大小</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">nm</span><span class="Token SPACE"> </span><span class="Token ID">bss</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000004020</span><span class="Token SPACE"> </span><span class="Token Program ID">D</span><span class="Token SPACE"> </span><span class="Token ID">x</span><span class="Token LF">
</span><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">du</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">bss</span><span class="Token LF">
</span><span class="Token NUMBER">20K</span><span class="Token SPACE">     </span><span class="Token Program ID">bss</span></code></pre><p>实际上地址和空间有两部分的含义, <b>一个是指输出在可执行文件中的空间, 第二个是装载后的虚拟地址中的虚拟地址空间</b></p><p>对于有实际数据的段, 比如 .text, .data, 它们在文件中和虚拟地址中都要分配空间, 因为在二者中他们都存在</p><p>但是对于 .bss 这样的段来说<b>不需要在可执行文件中分配地址空间</b>, 只需要在虚拟地址空间中分配空间</p><p>换而言之, 无论使用 <code>int x[1000]</code> 还是 <code>int x[1000] = {1}</code>, 都确实在程序中定义了一个大小为1000的int类型的数组x, 只不过由于前面的x没有初始化, 所以不需要在可执行文件中为其开辟一块 4KB 大小的空间来存放这个数组 x 的所有值, 而是用一个记录说明符号 x, 大小 4000, 这样就可以节约可执行文件的大小了</p><h3 id="h3-3">手动链接</h3><p>链接器一般采用<b>两步链接</b></p><ul><li><b>第一步 空间和地址分配</b>: 扫描所有输入目标文件, 获得它们每一个段的长度, 属性和位置. 将输入目标文件中的符号表中所有的符号定义和符号引用收集起来统一放到一个全局符号表中.<p>在这一步中链接器能够获取所有的输入目标文件的段长度, 并且将它们合并, 计算出输出文件中各个段合并后的长度和位置, 并建立映射关系</p></li></ul><ul><li><b>第二步 符号解析与重定位</b>: 使用上一步收集到的信息, 读取输入文件中的段和数据以及重定位的信息, 进行符号解析与重定位, 调整代码中的地址<p>实际上这一步是链接的核心, 特别是重定位</p></li></ul><p>可以尝试使用 ld 将 a.o 和 b.o 链接起来, 但是这里书上有一点小问题, 首先是需要修改一下程序, 手动添加 exit, 不然程序不知道在哪里终止, 运行起来会出现 segment fault 的问题</p><blockquote><p>参考</p><ul><li><a href="https://zhuanlan.zhihu.com/p/150793679" target="_blank">使用裸ld 链接器手动链接的一些小tips</a></li></ul><ul><li><a href="https://stackoverflow.com/questions/4492799/undefined-reference-to-stack-chk-fail" target="_blank">undefined reference to stack chk fail</a></li></ul></blockquote><pre class="language-c"><code><span class="Token Keyword StorageType EXTERN">extern</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">shared</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword StorageType FunctionReturnType EXTERN">extern</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">swap</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">a</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">b</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">a</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">100</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier FunctionName PrimaryExpression ID">swap</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token PPtoken AMPERSAND">&amp;</span><span class="Token Identifier ID">a</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken AMPERSAND">&amp;</span><span class="Token Identifier ID">shared</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword GNU_C_Assembly ASM">asm</span><span class="Token GNU_C_Assembly BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;movq $66,%rdi </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;movq $60,%rax </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;syscall </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token GNU_C_Assembly BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>其次是在编译的时候使用 <code>-fno-stack-protector</code> 关闭栈检查</p><pre class="language-shell"><code><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token OPTION">-fno-stack-protector</span><span class="Token SPACE"> </span><span class="Token OPTION">-c</span><span class="Token SPACE"> </span><span class="Token ID">a.c</span><span class="Token SPACE"> </span><span class="Token ID">b.c</span><span class="Token LF">
</span><span class="Token Program ID">ld</span><span class="Token SPACE"> </span><span class="Token ID">a.o</span><span class="Token SPACE"> </span><span class="Token ID">b.o</span><span class="Token SPACE"> </span><span class="Token OPTION">-e</span><span class="Token SPACE"> </span><span class="Token ID">main</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">ab</span></code></pre><blockquote><p>-e 表示将 main 函数作为程序的入口, 默认的入口程序是 _start</p></blockquote><p>可以使用 objdump 来查看 a.o b.o ab 的地址分配情况, 如下所示</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">a.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">a.o:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Sections:</span><span class="Token LF">
</span><span class="Token Program ID">Idx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE">      </span><span class="Token ID">VMA</span><span class="Token SPACE">               </span><span class="Token ID">LMA</span><span class="Token SPACE">               </span><span class="Token ID">File</span><span class="Token SPACE"> </span><span class="Token ID">off</span><span class="Token SPACE">  </span><span class="Token ID">Algn</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">.text</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000040</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">RELOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">CODE</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000080</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token Program ID">.bss</span><span class="Token SPACE">          </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000080</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">ALLOC</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token Program ID">.comment</span><span class="Token SPACE">      </span><span class="Token NUMBER">0000002e</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000080</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.GNU-stack</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ae</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">5</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.property</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">b0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">6</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">     </span><span class="Token NUMBER">00000038</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">d0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">RELOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">b.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">b.o:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Sections:</span><span class="Token LF">
</span><span class="Token Program ID">Idx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE">      </span><span class="Token ID">VMA</span><span class="Token SPACE">               </span><span class="Token ID">LMA</span><span class="Token SPACE">               </span><span class="Token ID">File</span><span class="Token SPACE"> </span><span class="Token ID">off</span><span class="Token SPACE">  </span><span class="Token ID">Algn</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">.text</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000047</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">CODE</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000004</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000088</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token Program ID">.bss</span><span class="Token SPACE">          </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000008</span><span class="Token ID">c</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">ALLOC</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token Program ID">.comment</span><span class="Token SPACE">      </span><span class="Token NUMBER">0000002e</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000008</span><span class="Token ID">c</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.GNU-stack</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ba</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">5</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.property</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">c0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">6</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">     </span><span class="Token NUMBER">00000038</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000e0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">RELOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">ab</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">ab:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Sections:</span><span class="Token LF">
</span><span class="Token Program ID">Idx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE">      </span><span class="Token ID">VMA</span><span class="Token SPACE">               </span><span class="Token ID">LMA</span><span class="Token SPACE">               </span><span class="Token ID">File</span><span class="Token SPACE"> </span><span class="Token ID">off</span><span class="Token SPACE">  </span><span class="Token ID">Algn</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.property</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000000004001</span><span class="Token ID">c8</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000000004001</span><span class="Token ID">c8</span><span class="Token SPACE">  </span><span class="Token NUMBER">000001</span><span class="Token ID">c8</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token Program ID">.text</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000087</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000401000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000401000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00001000</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">CODE</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">     </span><span class="Token NUMBER">00000058</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000402000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000402000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00002000</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000004</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000404000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000404000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00003000</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">.comment</span><span class="Token SPACE">      </span><span class="Token NUMBER">0000002</span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00003004</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span></code></pre><p>可以发现 a.o 和 b.o 的 .text 段以及 .data 段大小的和刚好是 ab 中的数值, 也印证了合并的方式</p><blockquote><p>.text: 0x40 + 0x47 = 0x87</p><p>.data: 0x0 + 0x4 = 0x4</p></blockquote><p>VMA(Virtual Memory Address) 代表虚拟地址, LMA(Load Memory Address)加载地址, 正常情况下这两个值应该是一样的. 但是在有的嵌入式系统中这两个值是不同的</p><p>在链接之前目标文件中的所有段的 VMA 都是 0. 而链接后可执行文件中的各个段都被分配到了相应的虚拟地址, 整个程序.text段从 0x401000 开始</p><blockquote><p><a href="https://www.zhihu.com/question/552957041/answer/2738625402" target="_blank">书上说代码地址总是从0x400000开始,但是查看编译好的elf头起始地址是从0开始的,这是为什么?</a></p></blockquote><p>当将多个目标文件合并为一个可执行文件之后, 这时候每一个段的虚拟地址已经确定下来了, 比如 .text 段从 <code>0x401000</code> 开始, .data 段从 <code>0x404000</code> 开始. 对于每一个目标文件中的每一个符号, 它们在对应的目标文件的段中有一个固定的偏移量, 比如 X. 那么当最后得到可执行文件之后只需要对应的从 <code>0x401000 + X</code> 即可得到最终的全局符号地址</p><blockquote><p><code>.text</code> 段从 0x401000 开始而不是 0x400000 是因为开头还有一个 <code>.note.gnu.property</code> 段. 但是程序是从 .text 段开始执行的, 也就是说装入之后 PC 的值会被设置为 0x401000, 这个地址可以使用 <code>readelf -h</code> 来查看 Entry point address 这一项得到</p></blockquote><h2 id="h2-4">符号解析和重定位</h2><p>使用 objdump -d 反汇编 a.o 可以得到如下程序, 其中注意到 0x17 处 48 8d 15 <b>00 00 00 00</b> 和 0x24 处的 e8 <b>00 00 00 00</b>, 分别对应 shared 的地址以及 swap 的地址. 由于在这个阶段编译器并不知道 shared 和 swap 的具体地址, 所以暂时把地址填 0</p><pre class="language-x86asm"><code><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token FUNCTION_CALL">main</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">f3</span><span class="Token SPACE"> </span><span class="Token NUMBER">0f</span><span class="Token SPACE"> </span><span class="Token NUMBER">1e</span><span class="Token SPACE"> </span><span class="Token NUMBER">fa</span><span class="Token SPACE">             </span><span class="Token ID">endbr64</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">4</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">55</span><span class="Token SPACE">                      </span><span class="Token ID">push</span><span class="Token SPACE">   </span><span class="Token REGISTER">%rbp</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">5</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token NUMBER">e5</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token REGISTER">%rsp</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rbp</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">83</span><span class="Token SPACE"> </span><span class="Token NUMBER">ec</span><span class="Token SPACE"> </span><span class="Token NUMBER">10</span><span class="Token SPACE">             </span><span class="Token ID">sub</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0x10</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rsp</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">c</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token NUMBER">fc</span><span class="Token SPACE"> </span><span class="Token NUMBER">64</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">movl</span><span class="Token SPACE">   </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0x64</span><span class="Token COMMA">,</span><span class="Token MINUS">-</span><span class="Token NUMBER">0x4</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">%rbp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">13</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">8d</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token NUMBER">fc</span><span class="Token SPACE">             </span><span class="Token ID">lea</span><span class="Token SPACE">    </span><span class="Token MINUS">-</span><span class="Token NUMBER">0x4</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">%rbp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">17</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">8d</span><span class="Token SPACE"> </span><span class="Token NUMBER">15</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">lea</span><span class="Token SPACE">    </span><span class="Token NUMBER">0x0</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">%rip</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rdx</span><span class="Token SPACE">        </span><span class="Token COMMENT"># 1e &lt;main+0x1e&gt;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1e</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token NUMBER">d6</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token REGISTER">%rdx</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rsi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">21</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token NUMBER">c7</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token REGISTER">%rax</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rdi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">24</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">e8</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">          </span><span class="Token ID">call</span><span class="Token SPACE">   </span><span class="Token NUMBER">29</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token FUNCTION_CALL">main</span><span class="Token PLUS">+</span><span class="Token NUMBER">0x29</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">29</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">42</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0x42</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rdi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">30</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">c0</span><span class="Token SPACE"> </span><span class="Token NUMBER">3c</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0x3c</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">37</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">0f</span><span class="Token SPACE"> </span><span class="Token NUMBER">05</span><span class="Token SPACE">                   </span><span class="Token ID">syscall</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">39</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">b8</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">          </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0x0</span><span class="Token COMMA">,</span><span class="Token REGISTER">%eax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3e</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">c9</span><span class="Token SPACE">                      </span><span class="Token ID">leave</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3f</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">c3</span><span class="Token SPACE">                      </span><span class="Token ID">ret</span></code></pre><p>对于这里的地址重定位的计算交给了链接器, 通过前面的空间和地址分配, 链接器就可以确定所有符号的虚拟地址了, 就对这些位置进行修正. 可以通过 objdump -d ab 来查看最后的可执行文件当中的代码段, 如下所示</p><pre class="language-x86asm"><code><span class="Token NUMBER">0000000000401000</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token FUNCTION_CALL">main</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401000</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">f3</span><span class="Token SPACE"> </span><span class="Token NUMBER">0f</span><span class="Token SPACE"> </span><span class="Token NUMBER">1e</span><span class="Token SPACE"> </span><span class="Token NUMBER">fa</span><span class="Token SPACE">             </span><span class="Token ID">endbr64</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401004</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">55</span><span class="Token SPACE">                      </span><span class="Token ID">push</span><span class="Token SPACE">   </span><span class="Token REGISTER">%rbp</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401005</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token NUMBER">e5</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token REGISTER">%rsp</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rbp</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401008</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">83</span><span class="Token SPACE"> </span><span class="Token NUMBER">ec</span><span class="Token SPACE"> </span><span class="Token NUMBER">10</span><span class="Token SPACE">             </span><span class="Token ID">sub</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0x10</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rsp</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">40100c</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token NUMBER">fc</span><span class="Token SPACE"> </span><span class="Token NUMBER">64</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">movl</span><span class="Token SPACE">   </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0x64</span><span class="Token COMMA">,</span><span class="Token MINUS">-</span><span class="Token NUMBER">0x4</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">%rbp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401013</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">8d</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token NUMBER">fc</span><span class="Token SPACE">             </span><span class="Token ID">lea</span><span class="Token SPACE">    </span><span class="Token MINUS">-</span><span class="Token NUMBER">0x4</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">%rbp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401017</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">8d</span><span class="Token SPACE"> </span><span class="Token NUMBER">15</span><span class="Token SPACE"> </span><span class="Token NUMBER">e2</span><span class="Token SPACE"> </span><span class="Token NUMBER">2f</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">lea</span><span class="Token SPACE">    </span><span class="Token NUMBER">0x2fe2</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">%rip</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rdx</span><span class="Token SPACE">        </span><span class="Token COMMENT"># 404000 &lt;shared&gt;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">40101e</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token NUMBER">d6</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token REGISTER">%rdx</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rsi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401021</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token NUMBER">c7</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token REGISTER">%rax</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rdi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401024</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">e8</span><span class="Token SPACE"> </span><span class="Token NUMBER">17</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">          </span><span class="Token ID">call</span><span class="Token SPACE">   </span><span class="Token NUMBER">401040</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token FUNCTION_CALL">swap</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401029</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">42</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0x42</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rdi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401030</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">c0</span><span class="Token SPACE"> </span><span class="Token NUMBER">3c</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0x3c</span><span class="Token COMMA">,</span><span class="Token REGISTER">%rax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401037</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">0f</span><span class="Token SPACE"> </span><span class="Token NUMBER">05</span><span class="Token SPACE">                   </span><span class="Token ID">syscall</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401039</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">b8</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">          </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token DOLLAR">$</span><span class="Token NUMBER">0x0</span><span class="Token COMMA">,</span><span class="Token REGISTER">%eax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">40103e</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">c9</span><span class="Token SPACE">                      </span><span class="Token ID">leave</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">40103f</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">c3</span><span class="Token SPACE">                      </span><span class="Token ID">ret</span></code></pre><p>可以注意到之前填 0 的地址已经被计算完毕, 那么链接器是如何计算并修正这里的地址的呢?</p><p>在 ELF 文件当中有一个 <b>重定位表(Relocation Table)</b> 的结构专门用于保存这些与重定位相关的信息, 它在 ELF 文件中往往是<b>一个或多个段</b>. 比如 .text 如果有要被重定位的地方那么就有一个相应的叫做 .rela.text 的段(前面加上 <code>.rela</code>). 我们可以使用 <code>readelf -S a.o</code> 查看 a.o 目标文件的段表, 其中 [2] .rela.text 和 [9] .rela.eh_frame 分别是对 [1] 和 [8] 的两个重定位表</p><blockquote><p>重定位段的 TYPE 是 RELA, Link 和 Info 分别指向对应符号表 和 需要重定位的段. 需要重定位的段肯定是代码段(.text)</p></blockquote><pre class="language-shell"><code><span class="Token Program ID">Section</span><span class="Token SPACE"> </span><span class="Token ID">Headers:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Program ID">Nr</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">              </span><span class="Token ID">Type</span><span class="Token SPACE">             </span><span class="Token ID">Address</span><span class="Token SPACE">           </span><span class="Token ID">Offset</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token Program ID">Size</span><span class="Token SPACE">              </span><span class="Token ID">EntSize</span><span class="Token SPACE">          </span><span class="Token ID">Flags</span><span class="Token SPACE">  </span><span class="Token ID">Link</span><span class="Token SPACE">  </span><span class="Token ID">Info</span><span class="Token SPACE">  </span><span class="Token ID">Align</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE">                   </span><span class="Token Program ID">NULL</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000000</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.text</span><span class="Token SPACE">             </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000040</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token Program ID">AX</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.rela.text</span><span class="Token SPACE">        </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000001</span><span class="Token ID">b0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000030</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Token Program ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">10</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">             </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000080</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token Program ID">WA</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">4</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.bss</span><span class="Token SPACE">              </span><span class="Token ID">NOBITS</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000080</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token Program ID">WA</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">5</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.comment</span><span class="Token SPACE">          </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000080</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">000000000000002e</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000001</span><span class="Token SPACE">  </span><span class="Token Program ID">MS</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">6</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.GNU-stack</span><span class="Token SPACE">   </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ae</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">7</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.pr</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">...</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">NOTE</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">b0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">         </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">d0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000038</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">9</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.rela.eh_frame</span><span class="Token SPACE">    </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000001e0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Token Program ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">10</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">10</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.symtab</span><span class="Token SPACE">           </span><span class="Token ID">SYMTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000108</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000090</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">          </span><span class="Token NUMBER">11</span><span class="Token SPACE">     </span><span class="Token NUMBER">3</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">11</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.strtab</span><span class="Token SPACE">           </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000198</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000016</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">12</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.shstrtab</span><span class="Token SPACE">         </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000001</span><span class="Token ID">f8</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">000000000000006</span><span class="Token Program ID">c</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span></code></pre><p>我们可以直接使用 <code>readelf -r</code> 来查看所有重定位表的信息</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">readelf</span><span class="Token SPACE"> </span><span class="Token OPTION">-r</span><span class="Token SPACE"> </span><span class="Token ID">a.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Relocation</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.rela.text</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">at</span><span class="Token SPACE"> </span><span class="Token ID">offset</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x1b0</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Offset</span><span class="Token SPACE">          </span><span class="Token ID">Info</span><span class="Token SPACE">           </span><span class="Token ID">Type</span><span class="Token SPACE">           </span><span class="Token ID">Sym.</span><span class="Token SPACE"> </span><span class="Token ID">Value</span><span class="Token SPACE">    </span><span class="Token ID">Sym.</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token SPACE"> </span><span class="Token ID">Addend</span><span class="Token LF">
</span><span class="Token NUMBER">00000000001</span><span class="Token Program ID">a</span><span class="Token SPACE">  </span><span class="Token NUMBER">000400000002</span><span class="Token SPACE"> </span><span class="Token ID">R_X86_64_PC32</span><span class="Token SPACE">     </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">shared</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token NUMBER">4</span><span class="Token LF">
</span><span class="Token NUMBER">000000000025</span><span class="Token SPACE">  </span><span class="Token NUMBER">000500000004</span><span class="Token SPACE"> </span><span class="Token Program ID">R_X86_64_PLT32</span><span class="Token SPACE">    </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">swap</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token NUMBER">4</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Relocation</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.rela.eh_frame</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">at</span><span class="Token SPACE"> </span><span class="Token ID">offset</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x1e0</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">entry:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Offset</span><span class="Token SPACE">          </span><span class="Token ID">Info</span><span class="Token SPACE">           </span><span class="Token ID">Type</span><span class="Token SPACE">           </span><span class="Token ID">Sym.</span><span class="Token SPACE"> </span><span class="Token ID">Value</span><span class="Token SPACE">    </span><span class="Token ID">Sym.</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token SPACE"> </span><span class="Token ID">Addend</span><span class="Token LF">
</span><span class="Token NUMBER">000000000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">000200000002</span><span class="Token SPACE"> </span><span class="Token Program ID">R_X86_64_PC32</span><span class="Token SPACE">     </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span></code></pre><p>每一个重定位表都是 <code>Elf64_Rela</code> 的数组, 该结构体成员如下所示</p><pre class="language-c"><code><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">   </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Addr</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">r_offset</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE"> </span><span class="Token StructDeclaration COMMENT">// 在对应段(比如 .text)中的偏移量</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">   </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint64_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">r_info</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">   </span><span class="Token StructDeclaration COMMENT">// 低 32 位是符号的重定位类型, 高32位是符号的在符号表中的索引</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">   </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">int64_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">    </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">r_addend</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE"> </span><span class="Token StructDeclaration COMMENT">// 偏移地址长度, 一般是 -4</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">Elf64_Rela</span><span class="Token Declaration SEMI">;</span></code></pre><p>接下来我们具体来看一下链接器是如何根据已有信息完成地址修正的</p><h3 id="h3-5">符号解析</h3><p>在编译程序的过程中, undefined reference 是一个非常常见错误</p><p>对于一个目标文件, 我们可以看到 GLOBAL 中的三个符号中的 shared swap 都是 UND, 即 undefined 未定义类型.</p><p><b>这种未定义的符号说明了文件中有关于他们的重定位项, 如果链接器扫描了所有输入目标文件之后仍然有未定义符号就会报未定义错误</b></p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">readelf</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token ID">a.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Symbol</span><span class="Token SPACE"> </span><span class="Token ID">table</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.symtab</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">6</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">Num:</span><span class="Token SPACE">    </span><span class="Token ID">Value</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">Type</span><span class="Token SPACE">    </span><span class="Token ID">Bind</span><span class="Token SPACE">   </span><span class="Token ID">Vis</span><span class="Token SPACE">      </span><span class="Token ID">Ndx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">FILE</span><span class="Token SPACE">    </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">ABS</span><span class="Token SPACE"> </span><span class="Token ID">a.c</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">3</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">    </span><span class="Token NUMBER">64</span><span class="Token SPACE"> </span><span class="Token Program ID">FUNC</span><span class="Token SPACE">    </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">main</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">shared</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">5</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">swap</span></code></pre><p>接下来详细的讨论一下如何进行指令修正.</p><p>对于每一个需要重定位的符号, 其 offset 对应了其重定位的位置(主要是 .text 段), 同时还有两个重要信息分别是他们的重定位类型 <code>R_X86_64_PC32</code> 和 <code>R_X86_64_PLT32</code> , 以及最后的 Addend 的值. 如下图所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516201225.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516201225.png" alt="20230516201225"></a></p><p>那么如何在链接得到可执行文件的时候确定这个最终应该跳转的地址位置呢? 这主要取决于选址方式, 目前采取的主流重定位方式都是相对地址寻址</p><ul><li><code>R_X86_64_PC32</code>: 用于对<b>全局符号</b>进行重定位,以及在指令中引用数据段中的变量时进行重定位.</li></ul><ul><li><code>R_X86_64_PLT32</code>: 用于对<b>函数调用</b>进行重定位.</li></ul><p>首先观察下图, 前文提到过为了生成可执行文件, 首先需要做的就是取出各个目标文件的 .text, .data , .bss 段并将其分别合并为一个大段, 然后拼接到一起得到一个文件, 也就是第一步. 可以看到最终得到的可执行文件已经确定了各个段的位置, 其中 <code>.text</code> 段的起始地址是 <code>0x401000</code>, <code>.data</code> 段的起始地址是 <code>0x404000</code>, 这两个地址比较重要, 因为我们稍后会需要用到它们, 这两个段的索引分别是 2 和 4</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20231126175403.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20231126175403.png" alt="20231126175403"></a></p><p>在合并所有的目标文件对应的段之后, 实际上<b>每一个符号的位置也就确定了下来</b>, 如下图所示.</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20231126175518.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20231126175518.png" alt="20231126175518"></a></p><p>其中 swap 类型为 FUNC, 地址位于 <code>0x401040</code>, 位于 2 号段(也就是 .text 段). shared 类型为 OBJECT, 地址位于 <code>0x404000</code>(也就是 .data 段的首地址), 位于 4 号段(也就是.data段). 除此之外还可以看到 main 函数, 位于 <code>0x401000</code> 也就是 .text 段的首地址.</p><blockquote><p>不难推测, 对于其他变量和函数, 它们会在 .data 和 .text 段依次往后存放</p></blockquote><p>下图中也可以比较清晰的看到 main 和 swap 函数的地址起点, 就是顺序排列下来</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516211039.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516211039.png" alt="20230516211039"></a></p><h3 id="h3-6">地址重定位</h3><p>那么接下来要做的事就是<b>如何修改这里的四个字节以找到 shared 变量和 swap 函数</b>, 我们先来整理一下已知信息</p><ol start="1"><li>合并之后的可执行文件中, <code>.text</code> 段的起始地址为 0x401000; <code>.data</code> 段的起始地址为 0x404000</li></ol><ol start="2"><li>重定位表有两个表项需要被重定位<ol start="1"><li>shared: 位于 <code>.text</code> 段偏移 0x1a 的位置, 偏移地址长度 -4</li></ol><ol start="2"><li>swap: 位于 <code>.text</code> 段偏移 0x25 的位置, 偏移地址长度 -4</li></ol></li></ol><ol start="3"><li>符号表有两个表项(暂时忽略 eh_frame)<ol start="1"><li>shared: 位于 .data 段, 数据地址为 0x404000</li></ol><ol start="2"><li>swap: 位于 .text 段, 数据地址为 0x401040</li></ol></li></ol><p>当执行这条指令的时候, CPU 的 PC(rip) 的位置实际上是下一条指令的开始位置. 因此为了计算实际地址偏移量, <b>相对偏移量 = 数据地址 - 重定位地址 + 偏移量</b>:</p><pre class="language-txt"><code><span class="Token ID">relative_addr</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token ID">ADDR</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">shared</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">ADDR</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token DOT">.</span><span class="Token ID">text</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token SPACE"> </span><span class="Token ID">OFFSET</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token ID">shared</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token SPACE"> </span><span class="Token ID">ADDEND</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">shared</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">              </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x404000</span><span class="Token SPACE">     </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token NUMBER">0x401000</span><span class="Token SPACE">    </span><span class="Token PLUS">+</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x1a</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE">           </span><span class="Token PLUS">+</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token MINUS">-</span><span class="Token NUMBER">4</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">              </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x404000</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x40101e</span><span class="Token LF">
</span><span class="Token SPACE">              </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x2fe2</span></code></pre><p>所以实际上就是做了一个减法 <code>0x404000 - 0x40101e = 0x2fe2</code></p><ul><li><b>第一个被减数是数据的实际地址</b>,  在链接之后的符号表可以直接找到</li></ul><ul><li><b>第二个减数是需要重定位的地址</b>, 也就是下图箭头所示的位置 <code>0x40101e</code>,</li></ul><p>最后修改这里的值, 使用小端存储也就是 <code>e2 2f 00 00</code></p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516231522.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516231522.png" alt="20230516231522"></a></p><p>那么接下来的过程也是同理, 需要修正 swap 的函数跳转地址: <code>0x401040 - 0x401029 = 0x17</code></p><blockquote><p>这里的 0x401029 也是通过 (.text 段地址 + 偏移量 - addend) = 0x401000 + 0x25 - (-4) 计算得到的</p></blockquote><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230517004015.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230517004015.png" alt="20230517004015"></a></p><h2 id="h2-7">静态库链接</h2><p>我们可以使用如下的命令找到 Linux 下的 libc 库</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">find</span><span class="Token SPACE"> </span><span class="Token PATH">/usr/lib</span><span class="Token MUL">*</span><span class="Token SPACE"> </span><span class="Token OPTION">-name</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;libc.a&quot;</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/lib/x86_64-linux-gnu/libc.a</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/lib32/libc.a</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/libx32/libc.a</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">find</span><span class="Token SPACE"> </span><span class="Token PATH">/usr/lib</span><span class="Token MUL">*</span><span class="Token SPACE"> </span><span class="Token OPTION">-name</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;libc.so&quot;</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/lib/x86_64-linux-gnu/libc.so</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/lib32/libc.so</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/libx32/libc.so</span></code></pre><ul><li><code>/usr/lib/x86_64-linux-gnu/libc.a</code>: 这是针对64位x86架构的Linux系统的库文件.它包含了glibc库的所有符号,并且在链接时可以将所有的代码静态地链接到目标程序中.这个路径是Debian和Ubuntu系统上的默认位置.</li></ul><ul><li><code>/usr/lib32/libc.a</code>: 这是针对32位x86架构的Linux系统的库文件.它包含了glibc库的所有符号,并且在链接时可以将所有的代码静态地链接到目标程序中.这个路径在一些Linux系统上,如Fedora和CentOS上是默认位置.</li></ul><ul><li><code>/usr/libx32/libc.a</code>: 这是针对x32 ABI的64位x86架构的Linux系统的库文件.x32 ABI是一种特殊的ABI,它使用32位指针和64位寄存器,旨在提高64位计算机上32位应用程序的性能.这个路径在一些Linux系统上,如Debian和Ubuntu上是默认位置.</li></ul><p>这些库文件是静态链接库,因此它们可能会增加可执行文件的大小,并且在多个程序使用相同的库时可能会导致重复.因此,通常建议使用动态链接库,例如libglibc.so或libc.so,以减少可执行文件的大小并实现共享.</p><p>一个静态库可以简单的看作<b>一组目标文件的集合</b>, 即很多目标文件压缩打包后形成的一个文件. 在一个C语言的运行库中,包含了很多跟系统功能相关的代码,比如输入输出/文件操作/时间日期/内存管理等. <b>glibc本身是用C语言开发的, 它由成百上千个C语言源代码文件组成</b>,也就是说,编译完成以后有相同数量的目标文件,比如</p><ul><li>输入输出 printf.o. scanf.o</li></ul><ul><li>文件操作 fread.o. fwrite.o</li></ul><ul><li>时间日期 date.o. time.o</li></ul><ul><li>内存管理 malloc.o</li></ul><p>把这些零散的目标文件直接提供给库的使用者,很大程度上会造成文件传输/管理和组织方面的不便,于是通常人们使用&quot;ar&quot;压缩程序将这些目标文件压缩到一起,并且对其进行编号和索引以便于查找和检索, 这样就得到了 libc.a 这个静态库的文件</p><p>可以使用 ar 来压缩/解压/查看一个 .a 静态库的信息, 比如查看 glibc.a, 这个文件有 5.8MB, 是大量目标文件的压缩结果</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">du</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token PATH">/usr/lib/x86_64-linux-gnu/libc.a</span><span class="Token LF">
</span><span class="Token NUMBER">5.8M</span><span class="Token SPACE">    </span><span class="Token Program PATH">/usr/lib/x86_64-linux-gnu/libc.a</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">ar</span><span class="Token SPACE"> </span><span class="Token OPTION">-t</span><span class="Token SPACE"> </span><span class="Token PATH">/usr/lib/x86_64-linux-gnu/libc.a</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">less</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">init-first.o</span><span class="Token LF">
</span><span class="Token Program ID">libc-start.o</span><span class="Token LF">
</span><span class="Token Program ID">sysdep.o</span><span class="Token LF">
</span><span class="Token Program ID">version.o</span><span class="Token LF">
</span><span class="Token Program ID">check_fds.o</span><span class="Token LF">
</span><span class="Token Program ID">libc-tls.o</span><span class="Token LF">
</span><span class="Token Program ID">dso_handle.o</span><span class="Token LF">
</span><span class="Token Program ID">errno.o</span><span class="Token LF">
</span><span class="Token Program ID">errno-loc.o</span><span class="Token LF">
</span><span class="Token Program ID">iconv_open.o</span><span class="Token LF">
</span><span class="Token Program ID">iconv.o</span><span class="Token LF">
</span><span class="Token Program ID">iconv_close.o</span><span class="Token LF">
</span><span class="Token Program ID">gconv_open.o</span><span class="Token LF">
</span><span class="Token Program ID">...</span></code></pre><p>那么我们尝试使用 ld 来手动链接 glibc.a 也很麻烦, 因为除了 C 标准库还需要运行时的一些目标文件和库需要被链接进来. 我们会在 &quot;库与运行库&quot; 这一节单独讲解</p><blockquote><p>Q&amp;A: 为什么静态运行库里面一个目标文件只包含一个函数? 比如 libc.a 里面 printf.o 只有 printf, strlen.o 中只有 strlen</p><p>链接器在链接静态库的时候是以目标文件为单位的.比如我们引用了静态库中的 <code>printf</code> 函数,那么链接器就<b>会把库中包含printf()函数的那个目标文件链接进来</b>,如果很多函数都放在一个目标文件中,很可能很多没用的函数都被一起链接进了输出结果中.由于运行库有成百上千个函数,数量非常庞大,每个函数独立地放在一个目标文件中可以<b>尽量减少空间的浪费,那些没有被用到的目标文件(函数)就不会被链接到最终的输出文件中</b>.</p></blockquote><p>绝大部分情况下,我们使用链接器提供的默认链接规则对目标文件进行链接.这在一般情况下是没有问题的. 但在一些特殊情况下我们希望控制整个链接过程的细节, 比如: 使用哪些目标文件?使用哪些库文件?是否在最终可执行文件中保留调试信息/输出文件格式(可执行文件还是动态链接库)? 还要考虑是否要导出某些符号以供调试器或程序本身或其他程序使用等.</p><p>链接器一般都提供多种控制整个链接过程的方法,以用来产生用户所须要的文件.一般链接器有如下三种方法:</p><ul><li>使用命令行来给链接器指定参数,我们前面所使用的ld的 <code>-o</code> <code>-e</code> 参数就属于这类</li></ul><ul><li>将链接指令存放在目标文件里面,编译器经常会通过这种方法向链接器传递指令.方法也比较常见,只是我们平时很少关注</li></ul><ul><li>使用链接控制脚本,使用链接控制脚本方法就是本节要介绍的,也是最为灵活/最为强大的链接控制方法.</li></ul><p>前面我们在使用ld链接器的时候,没有指定链接脚本,其实 ld 在用户没有指定链接脚本的时候会使用默认链接脚本.我们可以使用下面的命令行来查看ld默认的链接脚本</p><pre class="language-shell"><code><span class="Token Program ID">ld</span><span class="Token SPACE"> </span><span class="Token OPTION">--verbose</span></code></pre><p>默认的链接器脚本位于 <code>/usr/lib/x86_64-linux-gnu/ldscripts</code> 下, 不同的机器平台/输出文件格式都有相应的链接脚本. 可以使用下述命令查看所有链接脚本, 这里使用的是 elf_x86_64.x</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">ls</span><span class="Token SPACE"> </span><span class="Token PATH">/usr/lib/x86_64-linux-gnu/ldscripts</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">vim</span><span class="Token SPACE"> </span><span class="Token PATH">/usr/lib/x86_64-linux-gnu/ldscripts/elf_x86_64.x</span></code></pre><p>当然,为了更加精确地控制链接过程,我们可以自己写一个脚本,然后指定该脚本为链接控制脚本.比如可以使用-T参数:</p><pre class="language-shell"><code><span class="Token Program ID">ld</span><span class="Token SPACE"> </span><span class="Token OPTION">-T</span><span class="Token SPACE"> </span><span class="Token ID">link.script</span></code></pre><h2 id="h2-8">最小的 HelloWorld 程序</h2><p>为了演示链接的具体过程, 我们希望做一个最小的 hello world 程序</p><ol start="1"><li>首先,经典的 helloworld 使用了 <code>printf</code> 函数,该函数是系统C语言库的一部分.为了使用该函数,我们必须在链接时将C语言库与程序的目标文件链接产生最终可执行文件.我们希望&quot;小程序&quot;能够<b>脱离C语言运行库</b>,使得它成为一个独立于任何库的纯正的&quot;程序&quot;.</li></ol><ol start="2"><li>其次,经典的helloworld由于使用了库,所以必须有main函数.我们知道一般程序的入口在库的 <code>_start</code> ,由库负责初始化后调用main 函数来执行程序的主体部分. 因此我们使用 <code>nomain</code> 来作为程序的入口</li></ol><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">str</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token String STRING">&quot;Hello World</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">print</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword GNU_C_Assembly ASM">asm</span><span class="Token GNU_C_Assembly BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;movq $13, %%rdx </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;movq </span><span class="Token Format String STRING">%0</span><span class="Token String STRING">, %%rcx </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;movq $0, %%rbx </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;movq $4, %%rax </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;int $0x80 </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token SPACE"> </span><span class="Token GNU_C_Assembly COLON">:</span><span class="Token GNU_C_Assembly COLON">:</span><span class="Token GNU_C_Assembly STRING">&quot;r&quot;</span><span class="Token GNU_C_Assembly BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">str</span><span class="Token GNU_C_Assembly BraceDepth-2 RPAREN">)</span><span class="Token GNU_C_Assembly LF">
</span><span class="Token GNU_C_Assembly SPACE">        </span><span class="Token GNU_C_Assembly COLON">:</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;rdx&quot;</span><span class="Token GNU_C_Assembly COMMA">,</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;rcx&quot;</span><span class="Token GNU_C_Assembly COMMA">,</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;rbx&quot;</span><span class="Token GNU_C_Assembly BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">exit</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword GNU_C_Assembly ASM">asm</span><span class="Token GNU_C_Assembly BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;movq $42, %rbx </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;movq $1, %rax </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;int $0x80 </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token GNU_C_Assembly BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">nomain</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier FunctionName PrimaryExpression ID">print</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier FunctionName PrimaryExpression ID">exit</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>将上述代码保存为 <code>TinyHelloWorld.c</code>, 然后使用如下的指令编译链接, 程序可以正确执行并输出 &quot;Hello World&quot;, 最后的返回值为 42</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token OPTION">-c</span><span class="Token SPACE"> </span><span class="Token OPTION">-fno-builtin</span><span class="Token SPACE"> </span><span class="Token ID">TinyHelloWorld.c</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">ld</span><span class="Token SPACE"> </span><span class="Token OPTION">-static</span><span class="Token SPACE"> </span><span class="Token OPTION">-e</span><span class="Token SPACE"> </span><span class="Token ID">nomain</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">TinyHelloWorld</span><span class="Token SPACE"> </span><span class="Token ID">TinyHelloWorld.o</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program PATH">./TinyHelloWorld</span><span class="Token LF">
</span><span class="Token Program ID">Hello</span><span class="Token SPACE"> </span><span class="Token ID">World</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">echo</span><span class="Token SPACE"> </span><span class="Token VARIANT">$</span><span class="Token QUESTION">?</span><span class="Token LF">
</span><span class="Token NUMBER">42</span></code></pre><p>从源代码我们可以看到,程序入口为nomain()函数,然后该函数调用print()函数,打印&quot;Hello World&quot;,接着调用exit()函数,结束进程.</p><p>这里的print 函数使用了Linux 的 <code>WRITE</code> 系统调用,exit()函数使用了 <code>EXIT</code> 系统调用, 其中 write 原型如下</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">write</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">fd</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">buf</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">size_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">count</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>我们可以使用 GCC 提供的内联汇编来调用这个 Linux 内核提供的系统调用, 系统调用通过0x80中断实现,其中 eax为调用号,ebx/ecx/edx等通用寄存器用来传递参数</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">print</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword GNU_C_Assembly ASM">asm</span><span class="Token GNU_C_Assembly BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;movq $13, %%rdx </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;movq </span><span class="Token Format String STRING">%0</span><span class="Token String STRING">, %%rcx </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;movq $0, %%rbx </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;movq $4, %%rax </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;int $0x80 </span><span class="Token Control String STRING">\n</span><span class="Token Control String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token SPACE"> </span><span class="Token GNU_C_Assembly COLON">:</span><span class="Token GNU_C_Assembly COLON">:</span><span class="Token GNU_C_Assembly STRING">&quot;r&quot;</span><span class="Token GNU_C_Assembly BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">str</span><span class="Token GNU_C_Assembly BraceDepth-2 RPAREN">)</span><span class="Token GNU_C_Assembly LF">
</span><span class="Token GNU_C_Assembly SPACE">        </span><span class="Token GNU_C_Assembly COLON">:</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;rdx&quot;</span><span class="Token GNU_C_Assembly COMMA">,</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;rcx&quot;</span><span class="Token GNU_C_Assembly COMMA">,</span><span class="Token GNU_C_Assembly SPACE"> </span><span class="Token GNU_C_Assembly STRING">&quot;rbx&quot;</span><span class="Token GNU_C_Assembly BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><ul><li>WRITE 调用的调用号为4,则eax = 0.</li></ul><ul><li>fd 表示被写入的文件句柄,使用ebx寄存器传递,我们这里是要往默认终端(stdout)输出,它的文件句柄为0,即ebx = 0.</li></ul><ul><li>buffer 表示要写入的缓冲区地址,使用ecx寄存器传递,我们这里要输出字符串str,所以ecx = str.</li></ul><ul><li>size 表示要写入的字节数,使用edx寄存器传递,字符串&quot;Hello world!\n&quot;长度为13字节,所以edx = 13.</li></ul><p>除了命令行传参, 我们也可以使用 ld 链接脚本, 将如下代码保存在 link.lds 中</p><pre class="language-txt"><code><span class="Token ID">ENTRY</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">nomain</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token ID">SECTIONS</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DOT">.</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x0401000</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token SPACE"> </span><span class="Token ID">SIZEOF_HEADERS</span><span class="Token SEMI">;</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">tinytext</span><span class="Token SPACE"> </span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LCURLY_BRACE">{</span><span class="Token SPACE"> </span><span class="Token MUL">*</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token DOT">.</span><span class="Token ID">text</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token MUL">*</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token DOT">.</span><span class="Token ID">data</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token MUL">*</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token DOT">.</span><span class="Token ID">rodata</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RCURLY_BRACE">}</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token DIV">/</span><span class="Token ID">DISCARD</span><span class="Token DIV">/</span><span class="Token SPACE"> </span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LCURLY_BRACE">{</span><span class="Token SPACE"> </span><span class="Token MUL">*</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token DOT">.</span><span class="Token ID">comment</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 RCURLY_BRACE">}</span><span class="Token LF">
</span><span class="Token BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>tinytext: { *(.text)&quot;(.data)&quot;(.rodata)}第二条是个段转换规则,它的意思即为所有输入文件中的名字为&quot;.text&quot;/&quot;.data&quot;或&quot;.rodata&quot;的段依次合并到输出文件的&quot;tinytext&quot;.</p><p>/DiISCARD/ : { &quot;(.comment)}第三条规则为:将所有输入文件中的名字为&quot;.comment&quot;的段丢弃,不保存到输出文件中.</p></blockquote><p>使用 -T 参数来指定 ld 链接脚本, 可以看到可执行文件的体积明显变小了</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">ld</span><span class="Token SPACE"> </span><span class="Token OPTION">-static</span><span class="Token SPACE"> </span><span class="Token OPTION">-T</span><span class="Token SPACE"> </span><span class="Token ID">link.lds</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">TinyHelloWorld</span><span class="Token SPACE"> </span><span class="Token ID">TinyHelloWorld.o</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">du</span><span class="Token SPACE"> </span><span class="Token OPTION">-b</span><span class="Token SPACE"> </span><span class="Token ID">TinyHelloWorld</span><span class="Token LF">
</span><span class="Token NUMBER">1352</span><span class="Token SPACE">    </span><span class="Token Program ID">TinyHelloWorld</span></code></pre><p>可以看到最终文件的 <code>.text .data .bss .rodata</code> 段都合并到了 <code>.tinytext</code> 段中, 剩余三个段 <code>.symtab</code> 符号表, <code>.strtab</code> 字符串表, <code>.shstrtab</code> 段表字符串表</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">readelf</span><span class="Token SPACE"> </span><span class="Token OPTION">-S</span><span class="Token SPACE"> </span><span class="Token ID">TinyHelloWorld</span><span class="Token LF">
</span><span class="Token Program ID">There</span><span class="Token SPACE"> </span><span class="Token ID">are</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">headers</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">starting</span><span class="Token SPACE"> </span><span class="Token ID">at</span><span class="Token SPACE"> </span><span class="Token ID">offset</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x348</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Section</span><span class="Token SPACE"> </span><span class="Token ID">Headers:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Program ID">Nr</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">              </span><span class="Token ID">Type</span><span class="Token SPACE">             </span><span class="Token ID">Address</span><span class="Token SPACE">           </span><span class="Token ID">Offset</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token Program ID">Size</span><span class="Token SPACE">              </span><span class="Token ID">EntSize</span><span class="Token SPACE">          </span><span class="Token ID">Flags</span><span class="Token SPACE">  </span><span class="Token ID">Link</span><span class="Token SPACE">  </span><span class="Token ID">Info</span><span class="Token SPACE">  </span><span class="Token ID">Align</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE">                   </span><span class="Token Program ID">NULL</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000000</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.pr</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">...</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">NOTE</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000401120</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000120</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">         </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000401140</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000140</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000078</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">tinytext</span><span class="Token SPACE">          </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000000004011</span><span class="Token ID">b8</span><span class="Token SPACE">  </span><span class="Token NUMBER">000001</span><span class="Token ID">b8</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000078</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">WAX</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">4</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.data.rel.local</span><span class="Token SPACE">   </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000401230</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000230</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000008</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token Program ID">WA</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">5</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.symtab</span><span class="Token SPACE">           </span><span class="Token ID">SYMTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000238</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000090</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">           </span><span class="Token NUMBER">6</span><span class="Token SPACE">     </span><span class="Token NUMBER">2</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">6</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.strtab</span><span class="Token SPACE">           </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000002</span><span class="Token ID">c8</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000028</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">7</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.shstrtab</span><span class="Token SPACE">         </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000002</span><span class="Token ID">f0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000051</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span></code></pre><p>其中 <code>.shstrtab</code> 段表字符串表是必须要保留的, 但是剩下两个也是可以删除的, 可以使用 <code>-s</code> 选项去掉, 如下所示, 可以看到可执行文件被进一步压缩了</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">ld</span><span class="Token SPACE"> </span><span class="Token OPTION">-static</span><span class="Token SPACE"> </span><span class="Token OPTION">-T</span><span class="Token SPACE"> </span><span class="Token ID">link.lds</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">TinyHelloWorld</span><span class="Token SPACE"> </span><span class="Token ID">TinyHelloWorld.o</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">du</span><span class="Token SPACE"> </span><span class="Token OPTION">-b</span><span class="Token SPACE"> </span><span class="Token ID">TinyHelloWorld</span><span class="Token LF">
</span><span class="Token NUMBER">1024</span><span class="Token SPACE">    </span><span class="Token Program ID">TinyHelloWorld</span></code></pre><blockquote><p>ld 链接脚本语法略</p></blockquote><h2 id="h2-9">参考</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/150793679" target="_blank">使用裸ld 链接器手动链接的一些小tips</a></li></ul><ul><li><a href="https://stackoverflow.com/questions/4492799/undefined-reference-to-stack-chk-fail" target="_blank">undefined reference to stack chk fail</a></li></ul><ul><li><a href="https://cjting.me/2020/12/10/tiny-x64-helloworld/" target="_blank">cjting tiny-x64-helloworld</a></li></ul><ul><li><a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/" target="_blank">Linux_System_Call_Table_for_x86_64</a></li></ul><ul><li><a href="https://www.bilibili.com/video/BV1vT4y1B7Fb" target="_blank">汇编第一讲:编写一个最小helloworld</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../快速开始/编译内核" >快速开始</a><ul><li><a href="../../快速开始/编译内核" >编译内核</a></li></ul><ul><li><a href="../../快速开始/调试内核" >调试内核</a></li></ul><ul><li><a href="../../快速开始/开发环境搭建" >开发环境搭建</a></li></ul><ul><li><a href="../../快速开始/调试技巧" >调试技巧</a></li></ul><ul><li><a href="../../快速开始/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../快速开始/邮件订阅" >邮件订阅</a></li></ul><ul><li><a href="../../快速开始/git" >git</a></li></ul></li></ul><ul><li><a href="../../mm/物理内存探测" >mm</a><ul><li><a href="../../mm/物理内存探测" >物理内存探测</a></li></ul><ul><li><a href="../../mm/虚拟地址转换" >虚拟地址转换</a></li></ul><ul><li><a href="../../mm/进程内存布局" >进程内存布局</a></li></ul><ul><li><a href="../../mm/页表" >页表</a></li></ul><ul><li><a href="../../mm/numa" >numa</a></li></ul><ul><li><a href="../../mm/vma" >vma</a></li></ul><ul><li><a href="../../mm/zone" >zone</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab" >slab</a></li></ul><ul><li><a href="../../mm/compaction" >compaction</a></li></ul><ul><li><a href="../../mm/tier-mm" >tier-mm</a></li></ul><ul><li><a href="../../mm/migration" >migration</a></li></ul><ul><li><a href="../../mm/mm_struct" >mm_struct</a></li></ul><ul><li><a href="../../mm/mmio" >mmio</a></li></ul><ul><li><a href="../../mm/LRU" >LRU</a></li></ul><ul><li><a href="../../mm/MGLRU" >MGLRU</a></li></ul><ul><li><a href="../../mm/page" >page</a></li></ul><ul><li><a href="../../mm/folio" >folio</a></li></ul><ul><li><a href="../../mm/autonuma" >autonuma</a></li></ul><ul><li><a href="../../mm/kswapd" >kswapd</a></li></ul><ul><li><a href="../../mm/rmap" >rmap</a></li></ul><ul><li><a href="../../mm/ksm" >ksm</a></li></ul></li></ul><ul><li><a href="../../runtime/ELF文件格式" >runtime</a><ul><li><a href="../../runtime/ELF文件格式" >ELF文件格式</a></li></ul><ul><li><a href="../../runtime/符号表" >符号表</a></li></ul><ul><li><a href="../../runtime/静态链接" >静态链接</a></li></ul><ul><li><a href="../../runtime/装载" >装载</a></li></ul><ul><li><a href="../../runtime/动态链接" >动态链接</a></li></ul><ul><li><a href="../../runtime/库与运行库" >库与运行库</a></li></ul><ul><li><a href="../../runtime/execve" >execve</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul><ul><li><a href="../../kernel/atomic" >atomic</a></li></ul><ul><li><a href="../../kernel/rcu" >rcu</a></li></ul><ul><li><a href="../../kernel/workqueue" >workqueue</a></li></ul><ul><li><a href="../../kernel/lock" >lock</a></li></ul><ul><li><a href="../../kernel/syscall" >syscall</a></li></ul><ul><li><a href="../../kernel/poll" >poll</a></li></ul><ul><li><a href="../../kernel/module" >module</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cache-coherence" >cache-coherence</a></li></ul><ul><li><a href="../../arch/memory-coherence" >memory-coherence</a></li></ul><ul><li><a href="../../arch/io" >io</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/interrupt" >interrupt</a></li></ul></li></ul><ul><li><a href="../../proc/schedule" >proc</a><ul><li><a href="../../proc/schedule" >schedule</a></li></ul><ul><li><a href="../../proc/nice" >nice</a></li></ul><ul><li><a href="../../proc/manage" >manage</a></li></ul><ul><li><a href="../../proc/signal" >signal</a></li></ul><ul><li><a href="../../proc/cgroup" >cgroup</a></li></ul><ul><li><a href="../../proc/task_struct" >task_struct</a></li></ul><ul><li><a href="../../proc/rb-tree" >rb-tree</a></li></ul><ul><li><a href="../../proc/fork" >fork</a></li></ul></li></ul><ul><li><a href="../../net/net-arch" >net</a><ul><li><a href="../../net/net-arch" >net-arch</a></li></ul><ul><li><a href="../../net/ip" >ip</a></li></ul><ul><li><a href="../../net/route" >route</a></li></ul><ul><li><a href="../../net/udp" >udp</a></li></ul><ul><li><a href="../../net/tcp" >tcp</a></li></ul><ul><li><a href="../../net/tools" >tools</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul><ul><li><a href="../../fs/filesystem" >filesystem</a></li></ul><ul><li><a href="../../fs/fd" >fd</a></li></ul><ul><li><a href="../../fs/inode" >inode</a></li></ul><ul><li><a href="../../fs/directory" >directory</a></li></ul><ul><li><a href="../../fs/disk-layout" >disk-layout</a></li></ul><ul><li><a href="../../fs/mount" >mount</a></li></ul><ul><li><a href="../../fs/vfs" >vfs</a></li></ul><ul><li><a href="../../fs/ext4" >ext4</a></li></ul><ul><li><a href="../../fs/fuse" >fuse</a></li></ul><ul><li><a href="../../fs/distribute-fs" >distribute-fs</a></li></ul></li></ul><ul><li><a href="../../device/disk" >device</a><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul><ul><li><a href="../../device/driver" >driver</a></li></ul><ul><li><a href="../../device/io_uring" >io_uring</a></li></ul><ul><li><a href="../../device/pcie" >pcie</a></li></ul></li></ul><ul><li><a href="../../others/safety" >others</a><ul><li><a href="../../others/safety" >safety</a></li></ul><ul><li><a href="../../others/os面试题" >os面试题</a></li></ul><ul><li><a href="../../others/kernel-code" >kernel-code</a></li></ul></li></ul><ul><li><a href="../../cve/dirtycow" >cve</a><ul><li><a href="../../cve/dirtycow" >dirtycow</a></li></ul><ul><li><a href="../../cve/dirtypipe" >dirtypipe</a></li></ul><ul><li><a href="../../cve/sudo" >sudo</a></li></ul><ul><li><a href="../../cve/meltdown" >meltdown</a></li></ul><ul><li><a href="../../cve/smashex" >smashex</a></li></ul></li></ul><ul><li><a href="../../perf/perf" >perf</a><ul><li><a href="../../perf/perf" >perf</a></li></ul></li></ul><ul><li><a href="../../api/mm" >api</a><ul><li><a href="../../api/mm" >mm</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../runtime/符号表","../../runtime/装载","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script>
            <script src="https://giscus.app/client.js" data-repo="luzhixing12345/klinux" 
            data-repo-id="R_kgDOJIKiEw" data-category="Q&A" data-category-id="DIC_kwDOJIKiE84CgFwK" data-mapping="pathname" data-strict="0"
            data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom"
            data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
            </script>
            <script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>