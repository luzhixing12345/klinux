<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">ELF文件格式</a><ul><li><a href="#h2-1">ELF 文件标准历史</a></li></ul><ul><li><a href="#h2-2">ELF 段格式</a></li></ul><ul><li><a href="#h2-3">段分布</a></li></ul><ul><li><a href="#h2-4">段表</a></li></ul><ul><li><a href="#h2-5">ELF Header</a></li></ul><ul><li><a href="#h2-6">段</a><ul><li><a href="#h3-7">代码段(.text)</a></li></ul><ul><li><a href="#h3-8">数据段(.data .bss .rodata)</a></li></ul><ul><li><a href="#h3-9">符号表和重定位表</a></li></ul><ul><li><a href="#h3-10">字符串表(.strtab)和段表字符串表(.shstrtab)</a></li></ul><ul><li><a href="#h3-11">程序头(program header)</a></li></ul><ul><li><a href="#h3-12">其他特殊段</a></li></ul><ul><li><a href="#h3-13">自定义段</a></li></ul></li></ul><ul><li><a href="#h2-14">其他说明</a></li></ul><ul><li><a href="#h2-15">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">ELF文件格式</h1><p>本文来详细介绍一下 ELF 文件格式</p><blockquote><p>笔者在 <a href="https://github.com/luzhixing12345/binutils" target="_blank">binutils</a> 实现了 readelf, 感兴趣的读者可自行阅读源码</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/binutils</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program PATH">./src/readelf</span><span class="Token SPACE"> </span><span class="Token OPTION">--help</span><span class="Token LF">
</span><span class="Token Program ID">Usage:</span><span class="Token SPACE"> </span><span class="Token ID">readelf</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">OPTION</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token ID">...</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">files</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token ID">...</span><span class="Token LF">
</span><span class="Token Program ID">Display</span><span class="Token SPACE"> </span><span class="Token ID">information</span><span class="Token SPACE"> </span><span class="Token ID">about</span><span class="Token SPACE"> </span><span class="Token ID">the</span><span class="Token SPACE"> </span><span class="Token ID">contents</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">ELF</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">files</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token OPTION">-H</span><span class="Token SPACE">   </span><span class="Token OPTION">--help</span><span class="Token SPACE">                </span><span class="Token Program ID">show</span><span class="Token SPACE"> </span><span class="Token ID">help</span><span class="Token SPACE"> </span><span class="Token ID">information</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token OPTION">-v</span><span class="Token SPACE">   </span><span class="Token OPTION">--version</span><span class="Token SPACE">             </span><span class="Token Program ID">show</span><span class="Token SPACE"> </span><span class="Token ID">version</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token OPTION">-h</span><span class="Token SPACE">   </span><span class="Token OPTION">--file-header</span><span class="Token SPACE">         </span><span class="Token Program ID">Display</span><span class="Token SPACE"> </span><span class="Token ID">the</span><span class="Token SPACE"> </span><span class="Token ID">ELF</span><span class="Token SPACE"> </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">header</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token OPTION">-S</span><span class="Token SPACE">   </span><span class="Token OPTION">--section-headers</span><span class="Token SPACE">     </span><span class="Token Program ID">Display</span><span class="Token SPACE"> </span><span class="Token ID">the</span><span class="Token SPACE"> </span><span class="Token ID">sections</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">header</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token OPTION">--sections</span><span class="Token SPACE">            </span><span class="Token Program ID">An</span><span class="Token SPACE"> </span><span class="Token ID">alias</span><span class="Token SPACE"> </span><span class="Token Keyword FOR">for</span><span class="Token SPACE"> </span><span class="Token OPTION">--section-headers</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token OPTION">-s</span><span class="Token SPACE">   </span><span class="Token OPTION">--syms</span><span class="Token SPACE">                </span><span class="Token Program ID">Display</span><span class="Token SPACE"> </span><span class="Token ID">the</span><span class="Token SPACE"> </span><span class="Token ID">symbol</span><span class="Token SPACE"> </span><span class="Token ID">table</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token OPTION">--symbols</span><span class="Token SPACE">             </span><span class="Token Program ID">An</span><span class="Token SPACE"> </span><span class="Token ID">alias</span><span class="Token SPACE"> </span><span class="Token Keyword FOR">for</span><span class="Token SPACE"> </span><span class="Token OPTION">--syms</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token OPTION">-r</span><span class="Token SPACE">   </span><span class="Token OPTION">--relocs</span><span class="Token SPACE">              </span><span class="Token Program ID">Display</span><span class="Token SPACE"> </span><span class="Token ID">the</span><span class="Token SPACE"> </span><span class="Token Function ID">relocations</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Keyword IF">if</span><span class="Token SPACE"> </span><span class="Token ID">present</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token OPTION">-l</span><span class="Token SPACE">   </span><span class="Token OPTION">--program-header</span><span class="Token SPACE">      </span><span class="Token Program ID">Display</span><span class="Token SPACE"> </span><span class="Token ID">the</span><span class="Token SPACE"> </span><span class="Token ID">program</span><span class="Token SPACE"> </span><span class="Token ID">headers</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token OPTION">--segments</span><span class="Token SPACE">            </span><span class="Token Program ID">An</span><span class="Token SPACE"> </span><span class="Token ID">alias</span><span class="Token SPACE"> </span><span class="Token Keyword FOR">for</span><span class="Token SPACE"> </span><span class="Token OPTION">--program-headers</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token OPTION">-T</span><span class="Token SPACE">   </span><span class="Token OPTION">--silent-truncation</span><span class="Token SPACE">   </span><span class="Token Program ID">If</span><span class="Token SPACE"> </span><span class="Token ID">a</span><span class="Token SPACE"> </span><span class="Token ID">symbol</span><span class="Token SPACE"> </span><span class="Token ID">name</span><span class="Token SPACE"> </span><span class="Token ID">is</span><span class="Token SPACE"> </span><span class="Token ID">truncated</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword DO">do</span><span class="Token SPACE"> </span><span class="Token ID">not</span><span class="Token SPACE"> </span><span class="Token ID">add</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">...</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">suffix</span></code></pre></blockquote><h2 id="h2-1">ELF 文件标准历史</h2><p>20世纪90年代, 一些厂商联合成立了一个委员会, 起草并发布了一个 ELF 文件格式标准供公开使用, 并希望所有人都可以遵循这项标准并从中获益. 1993 年委员会发布了 <a href="https://refspecs.linuxfoundation.org/elf/TIS1.1.pdf" target="_blank">ELF 文件标准</a>, 当时参与该委员会的有来自于编译器的厂商, 比如 Watcom(Watcom C/C++ 编译器) 和 Borland(Borland Turbo Pascal 编译器); 来自 CPU 的厂商比如 IBM 和 Intel; 来自操作系统的厂商比如IBM 和 Microsoft. 1995 年委员会发布了 <a href="https://refspecs.linuxfoundation.org/elf/elf.pdf" target="_blank">ELF1.2标准</a>, 自此委员会完成了自己的使命, 不久就解散了, 所以 ELF 文件格式标准的最新版本也是最后一个版本就是 1.2</p><blockquote><p><a href="https://refspecs.linuxfoundation.org" target="_blank">https://refspecs.linuxfoundation.org</a>/</p></blockquote><p>Linux 中的可执行文件(.out), 目标文件(.o), 静态库(.a) 动态库(.so) 等都按照 ELF 文件格式进行存储, 我们可以借助 readelf 和 objudmp 来查看 ELF 文件的相关信息, 也可以利用 <code>elf.h</code> 头文件来对其进行解析和处理</p><p>我们使用如下的一个 C 程序作为示例</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">printf</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">format</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">global_init_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">84</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">global_zero_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">global_uninit_var</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">func1</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier FunctionName PrimaryExpression ID">printf</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Token Format String STRING">%d</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token Identifier ID">i</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">static_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">85</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">static_zero_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">static_var2</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">a</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">b</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier FunctionName PrimaryExpression ID">func1</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">static_var</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken PLUS">+</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">static_var2</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken PLUS">+</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">a</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken PLUS">+</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">b</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>使用 gcc 编译器得到 .o 文件</p><pre class="language-shell"><code><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token OPTION">-c</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.c</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span></code></pre><h2 id="h2-2">ELF 段格式</h2><p>ELF 文件的作用有两个,一是用于程序链接(为了生成程序);二是用于程序执行(为了运行程序).</p><p>ELF 目标文件格式的最前部是 <b>ELF 文件头(ELF Header)</b>, <b>它包含了描述整个文件的基本属性</b>. 接着是 ELF 文件各个段(Section), 在结尾有一个被称为 <b>段表(Section Header Table)</b> 的重要结构, 该表描述了 ELF 包含的所有段的信息, 比如每个段的段名,段长度,文件中的偏移量,读写权限和段的其他属性, 如下图所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111150728.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111150728.png" alt="20240111150728"></a></p><p>链接的其中一个过程就是将多个目标文件中各个段合并到一起, 相同性质的段组合为一个大段, 如下所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111151629.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111151629.png" alt="20240111151629"></a></p><blockquote><p>正常来说 section 应该翻译为节, segment 翻译为段, 由于下文我们讨论单个目标文件的 ELF 格式, section 统称为段</p></blockquote><h2 id="h2-3">段分布</h2><p>ELF 文件中有很多个段组成, 可以使用 <code>readelf -S</code> 可以查看一个 ELF 文件的所有段的信息, 比如查看前文提到的 SimpleSection.o, 它会依次列出所有段的信息, 如下所示</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">readelf</span><span class="Token SPACE"> </span><span class="Token OPTION">-S</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token Program ID">There</span><span class="Token SPACE"> </span><span class="Token ID">are</span><span class="Token SPACE"> </span><span class="Token NUMBER">14</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">headers</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">starting</span><span class="Token SPACE"> </span><span class="Token ID">at</span><span class="Token SPACE"> </span><span class="Token ID">offset</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x410</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Section</span><span class="Token SPACE"> </span><span class="Token ID">Headers:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Program ID">Nr</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">              </span><span class="Token ID">Type</span><span class="Token SPACE">             </span><span class="Token ID">Address</span><span class="Token SPACE">           </span><span class="Token ID">Offset</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token Program ID">Size</span><span class="Token SPACE">              </span><span class="Token ID">EntSize</span><span class="Token SPACE">          </span><span class="Token ID">Flags</span><span class="Token SPACE">  </span><span class="Token ID">Link</span><span class="Token SPACE">  </span><span class="Token ID">Info</span><span class="Token SPACE">  </span><span class="Token ID">Align</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE">                   </span><span class="Token Program ID">NULL</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000000</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.text</span><span class="Token SPACE">             </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000064</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token Program ID">AX</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.rela.text</span><span class="Token SPACE">        </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000002</span><span class="Token ID">f0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000078</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Token Program ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">11</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">             </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">a4</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000008</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token Program ID">WA</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">4</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.bss</span><span class="Token SPACE">              </span><span class="Token ID">NOBITS</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ac</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000008</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token Program ID">WA</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">5</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.rodata</span><span class="Token SPACE">           </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ac</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">6</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.comment</span><span class="Token SPACE">          </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">b0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">000000000000002e</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000001</span><span class="Token SPACE">  </span><span class="Token Program ID">MS</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">7</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.GNU-stack</span><span class="Token SPACE">   </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">de</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.pr</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">...</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">NOTE</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000e0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">9</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">         </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000100</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000058</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">10</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.rela.eh_frame</span><span class="Token SPACE">    </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000368</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000030</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Token Program ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">11</span><span class="Token SPACE">     </span><span class="Token NUMBER">9</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">11</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.symtab</span><span class="Token SPACE">           </span><span class="Token ID">SYMTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000158</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000138</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">          </span><span class="Token NUMBER">12</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">12</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.strtab</span><span class="Token SPACE">           </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000290</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000060</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">13</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.shstrtab</span><span class="Token SPACE">         </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000398</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000074</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token Program ID">Key</span><span class="Token SPACE"> </span><span class="Token ID">to</span><span class="Token SPACE"> </span><span class="Token ID">Flags:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Function Program ID">W</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">write</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">A</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">alloc</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">X</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">execute</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">M</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">merge</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">S</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">strings</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">I</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">info</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Function Program ID">L</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">link</span><span class="Token SPACE"> </span><span class="Token ID">order</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">O</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">extra</span><span class="Token SPACE"> </span><span class="Token ID">OS</span><span class="Token SPACE"> </span><span class="Token ID">processing</span><span class="Token SPACE"> </span><span class="Token ID">required</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">G</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">group</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">T</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">TLS</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Function Program ID">C</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">compressed</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">x</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">unknown</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">o</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">OS</span><span class="Token SPACE"> </span><span class="Token ID">specific</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">E</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">exclude</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Function Program ID">D</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">mbind</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">l</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">large</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Function ID">p</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">processor</span><span class="Token SPACE"> </span><span class="Token ID">specific</span><span class="Token BraceDepth-0 RPAREN">)</span></code></pre><p>根据输出信息可以画出整个 ELF 文件的排布, Offset 对应每一个段的起始位置, Size 对应段的大小</p><p>ELF Header 对应第 0 个无名段, 1-13 section 依次对应右侧的段. 最后一个段 <code>shstrtab</code> 的大小为 0x74, 所以段结尾的地址是 0x398 + 0x74 = 0x40c</p><p>0x000 - 0x40c 之间分别对应各个段, 0x40c - 0x410 地址对齐. 0x410 之后是段表.</p><blockquote><p>段表并不算一个段, 它是独立于段之外的, 用于记录所有段信息的一个数组. ELF Header 是一个需要单独处理的特殊块, 始终位于文件起始位置.</p></blockquote><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111210915.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111210915.png" alt="20240111210915"></a></p><h2 id="h2-4">段表</h2><p>上文我们通过 <code>readelf -S</code> 的输出信息画出了该 ELF 文件的段分布情况, 为了保存所有的诸如 &quot;段的段名,段长度,文件中的偏移量,读写权限和段的其他属性&quot; , ELF 并没有将这些信息分布保存在每一个段中, 而是使用 <b>(Section Header Table)段表</b> 来统一保存所有段的信息.</p><p>段表实际上是一个<b>数组</b>, 数组中每一个元素都是 <code>Elf64_Shdr</code> 结构体, 用于储存每一个段的信息, 可以计算得到该结构体占据 (4x4+8x6) = 64 个字节, 其定义如下所示, 不难看出和前文的输出的对应关系</p><pre class="language-c"><code><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">sh_name</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段名</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">sh_type</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段类型</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint64_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">sh_flags</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">     </span><span class="Token StructDeclaration COMMENT">// 段标志位</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Addr</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">sh_addr</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段虚拟地址</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Off</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">  </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">sh_offset</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">// 段偏移</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint64_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">sh_size</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段长度</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">sh_link</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段链接信息</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">sh_info</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段链接信息</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint64_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">sh_addralign</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE"> </span><span class="Token StructDeclaration COMMENT">// 段地址对齐</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint64_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">sh_entsize</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">   </span><span class="Token StructDeclaration COMMENT">// 段条目的长度</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">Elf64_Shdr</span><span class="Token Declaration SEMI">;</span></code></pre><p>因此段表一共 64 x 14 = 896 (0x380) 字节, 所以总字节数为 0x410 + 0x380 = 0x790 = 1936 字节, 也就是整个ELF文件的大小</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">du</span><span class="Token SPACE"> </span><span class="Token OPTION">-b</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token NUMBER">1936</span><span class="Token SPACE">    </span><span class="Token Program ID">SimpleSection.o</span></code></pre><h2 id="h2-5">ELF Header</h2><p>这里我们可以注意到一个段表位于所有段的最后面, <b>那么如何通过偏移量找到段表的位置呢</b>? 前面我们提到了 ELF Header 为整个 ELF 文件的文件头, <b>段表的起始地址和段表项的数量</b>都记录在 ELF Header 当中</p><p>我们可以使用 <code>readelf -h</code> 参数查看 ELF 文件头信息</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">readelf</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token Program ID">ELF</span><span class="Token SPACE"> </span><span class="Token ID">Header:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Magic:</span><span class="Token SPACE">   </span><span class="Token NUMBER">7</span><span class="Token ID">f</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token NUMBER">4</span><span class="Token ID">c</span><span class="Token SPACE"> </span><span class="Token NUMBER">46</span><span class="Token SPACE"> </span><span class="Token NUMBER">02</span><span class="Token SPACE"> </span><span class="Token NUMBER">01</span><span class="Token SPACE"> </span><span class="Token NUMBER">01</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Class:</span><span class="Token SPACE">                             </span><span class="Token ID">ELF64</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Data:</span><span class="Token SPACE">                              </span><span class="Token NUMBER">2</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">s</span><span class="Token SPACE"> </span><span class="Token ID">complement</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">little</span><span class="Token SPACE"> </span><span class="Token ID">endian</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Version:</span><span class="Token SPACE">                           </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">current</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program PATH">OS/ABI:</span><span class="Token SPACE">                            </span><span class="Token ID">UNIX</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token ID">System</span><span class="Token SPACE"> </span><span class="Token ID">V</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">ABI</span><span class="Token SPACE"> </span><span class="Token ID">Version:</span><span class="Token SPACE">                       </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Type:</span><span class="Token SPACE">                              </span><span class="Token Function ID">REL</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">Relocatable</span><span class="Token SPACE"> </span><span class="Token ID">file</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Machine:</span><span class="Token SPACE">                           </span><span class="Token ID">Advanced</span><span class="Token SPACE"> </span><span class="Token ID">Micro</span><span class="Token SPACE"> </span><span class="Token ID">Devices</span><span class="Token SPACE"> </span><span class="Token ID">X86-64</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Version:</span><span class="Token SPACE">                           </span><span class="Token NUMBER">0x1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Entry</span><span class="Token SPACE"> </span><span class="Token ID">point</span><span class="Token SPACE"> </span><span class="Token ID">address:</span><span class="Token SPACE">               </span><span class="Token NUMBER">0x0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Start</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">program</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">          </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">bytes</span><span class="Token SPACE"> </span><span class="Token ID">into</span><span class="Token SPACE"> </span><span class="Token ID">file</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Start</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">          </span><span class="Token NUMBER">1040</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">bytes</span><span class="Token SPACE"> </span><span class="Token ID">into</span><span class="Token SPACE"> </span><span class="Token ID">file</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Flags:</span><span class="Token SPACE">                             </span><span class="Token NUMBER">0x0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">this</span><span class="Token SPACE"> </span><span class="Token ID">header:</span><span class="Token SPACE">               </span><span class="Token NUMBER">64</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">bytes</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">program</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">bytes</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Number</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">program</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">         </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">           </span><span class="Token NUMBER">64</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">bytes</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Number</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">         </span><span class="Token NUMBER">14</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">Section</span><span class="Token SPACE"> </span><span class="Token ID">header</span><span class="Token SPACE"> </span><span class="Token ID">string</span><span class="Token SPACE"> </span><span class="Token ID">table</span><span class="Token SPACE"> </span><span class="Token ID">index:</span><span class="Token SPACE"> </span><span class="Token NUMBER">13</span></code></pre><p>其中 ELF Header 的结构体如下所示, 相关结构体元素的含义以注释的形式说明. , 其中的 <code>e_shoff</code> 就记录了段表在整个 ELF 文件中的偏移地址, <code>e_shnum</code> 记录了段的个数</p><pre class="language-c"><code><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_ident</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier MacroDefine PrimaryExpression TypeSpecifier ID">EI_NIDENT</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE"> </span><span class="Token StructDeclaration COMMENT">// 一些信息</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint16_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_type</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">             </span><span class="Token StructDeclaration COMMENT">// 文件类型</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint16_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_machine</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">          </span><span class="Token StructDeclaration COMMENT">// CPU类型</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_version</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">          </span><span class="Token StructDeclaration COMMENT">// ELF版本号</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">ElfN_Addr</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">     </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_entry</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 入口地址</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">ElfN_Off</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_phoff</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 程序头入口</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">ElfN_Off</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_shoff</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 段表在文件中的偏移</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_flags</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 标志位</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint16_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_ehsize</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">           </span><span class="Token StructDeclaration COMMENT">// ELF文件头大小</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint16_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_phentsize</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">        </span><span class="Token StructDeclaration COMMENT">// 程序头大小</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint16_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_phnum</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 程序头个数</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint16_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_shentsize</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">        </span><span class="Token StructDeclaration COMMENT">// 段表描述符大小, 等同于 sizeof(ElfN_Ehdr)</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint16_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_shnum</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 段表描述符数量</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">uint16_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">      </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">e_shstrndx</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">         </span><span class="Token StructDeclaration COMMENT">// 段表字符串表的在段表中的索引值</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">ElfN_Ehdr</span><span class="Token Declaration SEMI">;</span></code></pre><blockquote><p>对应 readelf -h 的输出中的 <code>Start of section headers</code> = 1040 以及 <code>Number of section headers</code> = 14</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230820224330.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230820224330.png" alt="20230820224330"></a></p></blockquote><h2 id="h2-6">段</h2><p><b>区分不同段的作用主要是为了将指令和数据的存放区分开, 这样的好处主要有如下三点</b>:</p><ol start="1"><li>易于设置读写权限: 指令区域只读, 代码区域可读写,防止程序指令被有意/无意改写</li></ol><ol start="2"><li>现代CPU的缓存属性: 有益于程序的局部性</li></ol><ol start="3"><li>多副本可共享</li></ol><p>使用 size 查看一个 ELF 文件的代码段/数据段/BSS段的长度</p><blockquote><p>这里的大小不是.o文件的大小, 只是段的大小, 可以使用 <code>du -b SimpleSection.o</code> 查看总大小(1936b)</p></blockquote><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">size</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">text</span><span class="Token SPACE">    </span><span class="Token ID">data</span><span class="Token SPACE">     </span><span class="Token ID">bss</span><span class="Token SPACE">     </span><span class="Token ID">dec</span><span class="Token SPACE">     </span><span class="Token ID">hex</span><span class="Token SPACE"> </span><span class="Token ID">filename</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">224</span><span class="Token SPACE">       </span><span class="Token NUMBER">8</span><span class="Token SPACE">       </span><span class="Token NUMBER">8</span><span class="Token SPACE">     </span><span class="Token NUMBER">240</span><span class="Token SPACE">      </span><span class="Token Program ID">f0</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span></code></pre><p>其中 text 的大小并不是指 .text 段, 而是 <code>.text</code>(0x64) + <code>.rodata</code>(0x4) + <code>.note.GNU-stack</code>(0) + <code>.note.gnu.property</code>(0x20) + <code>.eh_frame</code>(0x58) = 0xe0 = 224</p><p>解析 ELF 文件的方式是先从文件开头开始读取 ELF Header, 从中找到段表的位置, 再根据段表的内容可以找到每一个段</p><p>因此找到每一个段的流程如下:</p><ol start="1"><li>读取 ELF Header, 找到段表在文件中的偏移 <code>e_shoff</code> 和 段表描述符数量 <code>e_shnum</code></li></ol><ol start="2"><li>根据段表偏移量 e_shoff 找到段表起始位置</li></ol><ol start="3"><li>段表是一个大数组, 一共 e_shnum 个项, 每一个项都是 Elf64_Shdr, 根据其中的 sh_offset 找到对应的段</li></ol><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111175430.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111175430.png" alt="20240111175430"></a></p><hr><p>上文我们看到了 ELF 中的有 14 个段, 其中 <code>.comment</code> <code>.note.GNU-stack</code> <code>.note.gnu.property</code> <code>.eh_frame</code>, 它们并不是当前的重点, 我们暂时忽略.</p><ul><li><code>.comment</code>: 注释信息段<p>.comment 段是一种特殊的段,用于保存目标文件的注释信息.具体来说,它包含了编译器和汇编器使用的注释信息,例如编译器版本/编译选项/时间戳和作者等.</p><p>.comment 段的主要作用是为了方便开发者在需要时查看目标文件的注释信息,以便了解目标文件的编译环境和作者等相关信息.该段的大小通常很小,对程序的执行没有影响,因为它只是用于存储元数据.</p><p>在实际开发中,.comment 段的信息可以用于调试/版本控制和审计等方面.例如,如果您在调试时遇到了问题,您可以查看目标文件的注释信息,以确定该文件是由哪个编译器和版本生成的.同样,如果您需要对软件进行审计,您可以查看 .comment 段的信息,以确保该软件是由可信的开发者编写的,并且没有被修改或篡改过.在某些情况下如果希望禁用 .comment 段,以减小目标文件的大小或隐藏一些编译器和版本信息.您可以使用编译器选项 <code>-fno-ident</code></p><blockquote><p>可以看到最终目标文件当中没有 .comment 段了</p></blockquote><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503195503.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503195503.png" alt="20230503195503"></a></p><p>可以使用如下指令查看 .comment 段的内容</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token OPTION">--section</span><span class="Token ASSIGN">=</span><span class="Token ID">.comment</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">SimpleSection.o:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Contents</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">.comment:</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000</span><span class="Token SPACE"> </span><span class="Token NUMBER">00474343</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token Program ID">a202855</span><span class="Token SPACE"> </span><span class="Token NUMBER">62756e74</span><span class="Token SPACE"> </span><span class="Token NUMBER">75203131</span><span class="Token SPACE">  </span><span class="Token Function ID">.GCC:</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">Ubuntu</span><span class="Token SPACE"> </span><span class="Token NUMBER">11</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token NUMBER">0010</span><span class="Token SPACE"> </span><span class="Token NUMBER">2e332</span><span class="Token Program ID">e30</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token ID">d317562</span><span class="Token SPACE"> </span><span class="Token NUMBER">756e7475</span><span class="Token SPACE"> </span><span class="Token NUMBER">317e3232</span><span class="Token SPACE">  </span><span class="Token ID">.3.0-1ubuntu1~22</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token NUMBER">0020</span><span class="Token SPACE"> </span><span class="Token NUMBER">2e30342</span><span class="Token Program ID">e</span><span class="Token SPACE"> </span><span class="Token NUMBER">31292031</span><span class="Token SPACE"> </span><span class="Token NUMBER">312e332</span><span class="Token ID">e</span><span class="Token SPACE"> </span><span class="Token NUMBER">3000</span><span class="Token SPACE">      </span><span class="Token ID">.04.1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token NUMBER">11.3</span><span class="Token ID">.0.</span></code></pre></li></ul><ul><li><code>.note.GNU-stack</code>:<p>用于指定堆栈的执行权限.如果这个段存在,表示堆栈是不可执行的;如果不存在,则堆栈是可执行的.这对于一些安全性和执行优化方面的考虑很重要.例如,栈的可执行性可能被关闭以防止一些攻击.</p></li></ul><ul><li><code>.note.gnu.property</code>:<p>包含了一些特定于GNU的属性,用于在运行时提供额外的信息.这些属性通常与特定的优化或调试选项相关.这个段的内容是一些键值对,描述了与程序执行相关的一些属性,例如是否启用了某些特定的优化.</p></li></ul><ul><li><code>.eh_frame</code>:<p>包含了异常处理框架信息.在程序执行期间,如果发生异常(如C++中的异常),这些信息用于确定如何正确地展开调用栈以查找适当的异常处理程序.这对于调试和程序执行的可靠性都很重要.</p></li></ul><p>14 个段除去 ELF Header 以及上面暂不关心的 4 个段还有 9 个段, 他们分别是 .text, .data, .bss, .rodata, .rela.text, .rela.eh_frame, .symtab, .strtab, .shstrtab, 下面我们依次介绍一下</p><h3 id="h3-7">代码段(.text)</h3><p>程序源码编译后的机器指令保存在代码段中, 这也是唯一一个可以具有<b>可执行权限的段</b>, 程序运行起来后的 IP 就会被设置为代码段的起始地址</p><pre class="language-shell"><code><span class="Token COMMENT"># 使用 objdump 查看反汇编</span><span class="Token LF">
</span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span></code></pre><p>可以看到 .text 段的二进制内容对应右侧的反汇编代码</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111213202.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240111213202.png" alt="20240111213202"></a></p><h3 id="h3-8">数据段(.data .bss .rodata)</h3><p>我们将 .data .bss .rodata 统称为数据段, 但他们三者略有差别.</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">printf</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">format</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">global_init_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">84</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">global_zero_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">global_uninit_var</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">func1</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier FunctionName PrimaryExpression ID">printf</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Token Format String STRING">%d</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token Identifier ID">i</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">static_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">85</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">static_zero_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">static_var2</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">a</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">b</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier FunctionName PrimaryExpression ID">func1</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">static_var</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken PLUS">+</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">static_var2</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken PLUS">+</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">a</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken PLUS">+</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">b</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><ul><li><code>.data</code>: 已初始化的数据段<ul><li><b>初始化不为 0 的全局变量(global_init_var)</b></li></ul><ul><li><b>初始化不为 0 的局部静态变量(static_var)</b></li></ul></li></ul><ul><li><code>.bss</code>: 未初始化的数据段<ul><li><b>没有初始化的全局变量(global_uninit_var)</b></li></ul><ul><li><b>没有初始化的局部静态变量(static_var2)</b></li></ul><ul><li><b>初始化为 0 的全局变量(global_zero_var)</b></li></ul><ul><li><b>初始化为 0 的局部静态变量(static_zero_var)</b></li></ul><blockquote><p>没有初始化的默认值为 0, 和初始化为 0 效果相同</p></blockquote><p>单独分出来 .bss 段是因为 .data 段中需要为一个已经初始化的变量分配空间用于存放初始化的值, 如果初始值是 0 那么其实就没有必要分配. 这些变量在程序运行时确实需要占据内存空间, 但是没有必要在在可执行程序中为它们分配空间. <b>.bss 段只是为初始值0的变量预留一个位置</b></p></li></ul><ul><li><code>.rodata</code>: 只读数据段, 例如程序中的字符串常量 &quot;%d\n&quot;, 其 ASCII 值分别为 <code>0x25 0x64 0x0a 0x00</code></li></ul><p>.data 段中保存的是 <code>int global_init_var = 84(0x54)</code>, <code>static int static_var = 85(0x55)</code>, 四字节小端存储</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503220741.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503220741.png" alt="20230503220741"></a></p><h3 id="h3-9">符号表和重定位表</h3><ul><li>段表为 <code>Elf64_Shdr</code> 数组</li></ul><ul><li>重定位表为 <code>Elf64_Rela</code> 数组</li></ul><ul><li>符号表为 <code>Elf64_Sym</code> 数组</li></ul><p>符号表(.symtab) 和 重定位表(.rela) 对于 ELF 文件来说是很重要的, 涉及到之后链接器 ld 对于地址进行<b>重定位</b>.</p><ul><li>符号表的 sh_type 为 <code>SHT_SYMTAB</code> 或 <code>SHT_DYNSYM</code></li></ul><ul><li>重定位表的 sh_type 是 <code>SHT_RELA</code>.</li></ul><blockquote><p>如果要找到所有的符号表和重定位表, 那么只需要遍历段表的所有项, 判断 sh_type 类型即可</p></blockquote><p>如果段的类型是与链接相关的, 比如重定位表(.rela)和符号表(.symtab), 那么 <code>sh_link</code> 和 <code>sh_info</code> 这两个段就有含义, 否则是无意义的.</p><p>对于重定位表 RELA, <b><code>sh_link</code> 代表该段所对应的符号表(.symbol)的下标, <code>sh_info</code> 表示它作用的重定位的段</b>. 如下所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230821095550.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230821095550.png" alt="20230821095550"></a></p><p>重定位表中的每一个表项都是一个 Elf64_Rela 结构体, 成员含义如下所示</p><pre class="language-c"><code><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Addr</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">r_offset</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">     </span><span class="Token StructDeclaration COMMENT">/* 地址 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Xword</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">r_info</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">/* 重定位类型和符号索引 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Sxword</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">r_addend</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">   </span><span class="Token StructDeclaration COMMENT">/* 偏移量 */</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">Elf64_Rela</span><span class="Token Declaration SEMI">;</span></code></pre><p>符号表的每一个表项都是一个 <code>Elf64_Sym</code> 结构体, <code>sh_link</code> 指向对应的字符串表(通常是 .strtab), st_info 的低4位用于符号类型, 高4位用于符号绑定信息, 成员含义如下所示</p><pre class="language-c"><code><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Word</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">st_name</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">/* 符号名称(字符串表索引) */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">st_info</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">   </span><span class="Token StructDeclaration COMMENT">/* 符号类型和绑定 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">st_other</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">  </span><span class="Token StructDeclaration COMMENT">/* 符号可见性 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Section</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">st_shndx</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">  </span><span class="Token StructDeclaration COMMENT">/* 节索引 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Addr</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">st_value</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">     </span><span class="Token StructDeclaration COMMENT">/* 符号值 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Xword</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">st_size</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">     </span><span class="Token StructDeclaration COMMENT">/* 符号大小 */</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">Elf64_Sym</span><span class="Token Declaration SEMI">;</span></code></pre><p>关于重定位相关的内容我们放在 &quot;静态链接&quot; 中单独进行介绍</p><h3 id="h3-10">字符串表(.strtab)和段表字符串表(.shstrtab)</h3><p>ELF 文件中需要保存许多字符串名, 比如符号的名字, 段的名字. 字符串的长度往往是不确定的, 那么对于一个不定长的字符串, 用固定的结构来表示它比较困难. ELF 的做法是把字符串集中起来保存在段中, <b>符号表的符号名字保存在字符串表中(.strtab)</b>, <b>所有段的名字保存在段表字符串表(.shstrtab)中</b></p><blockquote><p>这一点和ext文件系统的inode对于文件名的管理方式有些类似</p></blockquote><p>我们注意到上文中 Elf64_Shdr 结构体的字段 <code>sh_name</code> 的含义是段名, 但是类型是 uint32_t 而非 char*, 这是因为段本身并不记录其名字, 段的名字在 <code>.shstrtab</code> (段表字符串表)中统一记录, <code>sh_name</code> 只是一个索引值. 采用这种方式就可以固定下来 <code>Elf64_Shdr</code> 结构体的大小</p><blockquote><p>0x410 之后是段表, 0x398 开始是 .shstrtab(段表字符串表), 记录了每一个段的名字</p></blockquote><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230506004340.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230506004340.png" alt="20230506004340"></a></p><p>因此找到每一个段名字的方法如下, 首先找到 shstrtab, 然后利用每一个段 shdr 中的 sh_name 作为偏移量计算地址</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240112095245.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240112095245.png" alt="20240112095245"></a></p><h3 id="h3-11">程序头(program header)</h3><p>ELF可执行文件中有一个专门的数据结构叫做程序头表(Program Header Table)用来保存&quot;Segment&quot;的信息.因为ELF目标文件不需要被装载,所以它没有程序头表,而ELF的可执行文件和共享库文件都有.跟段表结构一样,程序头表也是一个 <code>Elf64_Phdr</code> 结构体数组,它的结构体如下:</p><pre class="language-c"><code><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Word</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">    </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">p_type</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">          </span><span class="Token StructDeclaration COMMENT">/* 段类型 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Word</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">    </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">p_flags</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">         </span><span class="Token StructDeclaration COMMENT">/* 段标志 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Off</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">     </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">p_offset</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">        </span><span class="Token StructDeclaration COMMENT">/* 段在文件中的偏移量 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Addr</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">    </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">p_vaddr</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">         </span><span class="Token StructDeclaration COMMENT">/* 段的虚拟地址 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Addr</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">    </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">p_paddr</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">         </span><span class="Token StructDeclaration COMMENT">/* 段的物理地址 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Xword</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">p_filesz</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">        </span><span class="Token StructDeclaration COMMENT">/* 段在文件中的大小 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Xword</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">p_memsz</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">         </span><span class="Token StructDeclaration COMMENT">/* 段在内存中的大小 */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">Elf64_Xword</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">   </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">p_align</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">         </span><span class="Token StructDeclaration COMMENT">/* 段对齐方式 */</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">Elf64_Phdr</span><span class="Token Declaration SEMI">;</span></code></pre><blockquote><p>program header 在可重定位文件中不存在, 仅存在于已经完成链接的可执行文件, 可以使用 <code>-l</code> 选项查看, 其中还多出来了 .init .plt .plt.got 等等一些段, 这些是与运行时和动态链接相关的段, 我们暂不做介绍</p></blockquote><h3 id="h3-12">其他特殊段</h3><p>还可以使用 <code>objcopy</code> 将一张图片添加到 .o 文件中</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objcopy</span><span class="Token SPACE"> </span><span class="Token OPTION">-I</span><span class="Token SPACE"> </span><span class="Token ID">binary</span><span class="Token SPACE"> </span><span class="Token OPTION">-O</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token SPACE"> </span><span class="Token ID">a.jpg</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-ht</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">SimpleSection.o:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Sections:</span><span class="Token LF">
</span><span class="Token Program ID">Idx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE">      </span><span class="Token ID">VMA</span><span class="Token SPACE">               </span><span class="Token ID">LMA</span><span class="Token SPACE">               </span><span class="Token ID">File</span><span class="Token SPACE"> </span><span class="Token ID">off</span><span class="Token SPACE">  </span><span class="Token ID">Algn</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">         </span><span class="Token NUMBER">00009261</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token Program ID">SYMBOL</span><span class="Token SPACE"> </span><span class="Token ID">TABLE:</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">       </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">_binary_a_jpg_start</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000009261</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">       </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">_binary_a_jpg_end</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000009261</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">       </span><span class="Token MUL">*</span><span class="Token ID">ABS</span><span class="Token MUL">*</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">_binary_a_jpg_size</span></code></pre><p>其中 <code>_binary_a_jpg_start</code> <code>_binary_a_jpg_end</code> <code>_binary_a_jpg_size</code> 分别表示起始地址, 结束地址, 大小, <b>我们可以在程序中直接声明并使用它们</b>, 例如打印出图像数据的前10个字节:</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">stdio.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword StorageType EXTERN">extern</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">_binary_a_jpg_start</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword StorageType EXTERN">extern</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">_binary_a_jpg_end</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword StorageType EXTERN">extern</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">_binary_a_jpg_size</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration IterationStatement SEMI">;</span><span class="Token Declaration IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">10</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Token Format String STRING">%02x</span><span class="Token String STRING"> &quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">_binary_a_jpg_start</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>这种将图片直接打入目标文件是一种方式,不过会导致文件变大</p></blockquote><h3 id="h3-13">自定义段</h3><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">printf</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">format</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">global_init_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">84</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">global_uninit_var</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token GNU_C_Assembly Declaration _ATTRIBUTE">__attribute__</span><span class="Token GNU_C_Assembly Declaration BraceDepth-0 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">section</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;FOO&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token GNU_C_Assembly Declaration BraceDepth-0 RPAREN">)</span><span class="Token GNU_C_Assembly Declaration SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">global_foo_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">42</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token GNU_C_Assembly Declaration _ATTRIBUTE">__attribute__</span><span class="Token GNU_C_Assembly Declaration BraceDepth-0 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">section</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;BAR&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token GNU_C_Assembly Declaration BraceDepth-0 RPAREN">)</span><span class="Token GNU_C_Assembly Declaration SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">foo</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">func1</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier FunctionName PrimaryExpression ID">printf</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Token Format String STRING">%d</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token Identifier ID">i</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">static_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">85</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">static_var2</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">a</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">b</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier FunctionName PrimaryExpression ID">func1</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">static_var</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken PLUS">+</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">static_var2</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken PLUS">+</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">a</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken PLUS">+</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">b</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>可以看到新增了两个段</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230504002317.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230504002317.png" alt="20230504002317"></a></p><blockquote><p><code>__attribute__((section(&quot;name&quot;)))</code> 是GCC和Clang编译器的扩展,它不是C标准的一部分,因此不是所有的编译器都支持它.</p><p>在MSVC编译器中,可以使用 <code>#pragma section</code> 指令来将变量或函数放置在自定义段中 (#pragma section指令是MSVC编译器的扩展) .例如:</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine PRAGMA">pragma</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">section</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;FOO&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">read</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">write</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">global_foo_var</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">42</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine PRAGMA">pragma</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">section</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;BAR&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">execute</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">foo</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// ...</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre></blockquote><h2 id="h2-14">其他说明</h2><p>当然 GCC 编译器提供了关于 ELF 的众多选项</p><p><code>-fdata-sections</code> 和 <code>-ffunction-sections</code> 是GCC编译器的选项,用于将数据和函数放置在单独的段中.</p><p>当使用这些选项时,<b>GCC会将每个全局变量和函数放置在单独的段中,而不是将它们放置在默认的.data和.text段中</b>.这样做的好处是可以将不同的数据和函数放置在不同的段中,从而使得目标文件更加灵活.例如,您可以将只读数据放置在只读段中,将可写数据放置在可写段中,将可执行代码放置在可执行段中.</p><pre class="language-shell"><code><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token OPTION">-c</span><span class="Token SPACE"> </span><span class="Token OPTION">-fdata-sections</span><span class="Token SPACE"> </span><span class="Token OPTION">-ffunction-sections</span><span class="Token SPACE"> </span><span class="Token ID">file.c</span></code></pre><p>在将目标文件链接到可执行文件时,您需要使用 <code>-Wl</code> , <code>--gc-sections</code> 选项来删除未使用的段.这将从目标文件中删除未使用的段,从而减少可执行文件的大小.例如:</p><pre class="language-shell"><code><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token OPTION">-Wl</span><span class="Token COMMA">,</span><span class="Token OPTION">--gc-sections</span><span class="Token SPACE"> </span><span class="Token ID">file.o</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">program</span></code></pre><p>请注意,使用 <code>-fdata-sections</code> 和 <code>-ffunction-sections</code> 选项可能会增加目标文件的大小,并在链接时增加一些开销.然而,通过将数据和函数放置在单独的段中,可以使得目标文件更加灵活,并且可以优化可执行文件的大小和性能.</p><p>不难发现 ELF 中 .text .data 已经分开了</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230504003246.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230504003246.png" alt="20230504003246"></a></p><h2 id="h2-15">参考</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/380908650" target="_blank">ELF 文件解析 1-前述+文件头分析</a></li></ul><ul><li><a href="https://refspecs.linuxfoundation.org/" target="_blank">linuxfoundation refspecs</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../快速开始/编译内核" >快速开始</a><ul><li><a href="../../快速开始/编译内核" >编译内核</a></li></ul><ul><li><a href="../../快速开始/调试内核" >调试内核</a></li></ul><ul><li><a href="../../快速开始/制作文件系统" >制作文件系统</a></li></ul><ul><li><a href="../../快速开始/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../快速开始/linux目录结构" >linux目录结构</a></li></ul><ul><li><a href="../../快速开始/邮件订阅" >邮件订阅</a></li></ul></li></ul><ul><li><a href="../../mm/物理布局探测" >mm</a><ul><li><a href="../../mm/物理布局探测" >物理布局探测</a></li></ul><ul><li><a href="../../mm/NUMA" >NUMA</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab分配器" >slab分配器</a></li></ul><ul><li><a href="../../mm/memory compaction" >memory compaction</a></li></ul><ul><li><a href="../../mm/va-translate" >va-translate</a></li></ul><ul><li><a href="../../mm/tlb" >tlb</a></li></ul></li></ul><ul><li><a href="../../vm/intro" >vm</a><ul><li><a href="../../vm/intro" >intro</a></li></ul></li></ul><ul><li><a href="../../runtime/proc" >runtime</a><ul><li><a href="../../runtime/proc" >proc</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul><ul><li><a href="../../runtime/elf_format" >elf_format</a></li></ul><ul><li><a href="../../runtime/elf_loader" >elf_loader</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cache-coherence" >cache-coherence</a></li></ul><ul><li><a href="../../arch/memory-coherence" >memory-coherence</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/interrupt" >interrupt</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul></li></ul><ul><li><a href="../../proc/cpu" >proc</a><ul><li><a href="../../proc/cpu" >cpu</a></li></ul><ul><li><a href="../../proc/nice" >nice</a></li></ul></li></ul><ul><li><a href="../../device/io" >device</a><ul><li><a href="../../device/io" >io</a></li></ul><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul></li></ul><ul><li><a href="../../others/safety" >others</a><ul><li><a href="../../others/safety" >safety</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../runtime/vsdo","../../runtime/elf_loader","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>