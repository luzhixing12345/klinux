<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css /><link rel='stylesheet' href=../../../css/x86asm.css /><link rel='stylesheet' href=../../../css/yaml.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">execve</a><ul><li><a href="#h2-1">加载过程</a></li></ul><ul><li><a href="#h2-2">search_binary_handler</a></li></ul><ul><li><a href="#h2-3">load_elf_binary</a><ul><li><a href="#h3-4">检查ELF头部</a></li></ul><ul><li><a href="#h3-5">加载程序头表</a></li></ul><ul><li><a href="#h3-6">寻找解释器</a></li></ul><ul><li><a href="#h3-7">检查并读取解释器的程序表头</a></li></ul><ul><li><a href="#h3-8">装入目标程序的段</a></li></ul><ul><li><a href="#h3-9">设置入口点</a></li></ul><ul><li><a href="#h3-10">参数与环境变量</a></li></ul><ul><li><a href="#h3-11">进入新的程序入口</a></li></ul></li></ul><ul><li><a href="#h2-12">符号的动态解析</a></li></ul><ul><li><a href="#h2-13">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">execve</h1><p>shell 中最常见的操作就是执行程序, 此时 shell 会 fork 出一个子进程然后通过调用 <code>execve()</code> 来执行对应的任务.</p><pre class="language-c"><code><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-0 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pid</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">fork</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 子进程执行任务</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">execve</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token Identifier PrimaryExpression ID">environ</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Token Format String STRING">%s</span><span class="Token String STRING">: Command not found</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">exit</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 父进程</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">wait</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>关于 shell 的实现参见 <a href="https://luzhixing12345.github.io/csapplab/articles/md-docs/09-ShellLab/" target="_blank">09-ShellLab</a></p></blockquote><p>exec() 是一个函数族, 有诸如 execl/execlp/execle 等功能相似但实际上都是调用execve的库函数, 最核心的 execve 函数加载并运行可执行目标文件filename,并且带参数列表argv和环境变量列表envp,与fork返回两次不同.execve调用一次并且不返回,只有出现错误,比如找到不到filename才会返回到调用程序, 成功执行后原先子进程的栈.数据以及堆段会直接被新程序所替换</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">unistd.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">execve</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">filename</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">argv</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">envp</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20221226211353.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20221226211353.png" alt="image"></a></p><p>其中参数列表的数据结构如上图所示</p><ul><li><code>argv</code> 变量指向一个null结尾的指针数组,每个指针指向一个参数字符串,通常来说argv[0]是可执行目标文件的名字</li></ul><ul><li><code>envp</code> 变量指向一个null结尾的指针数据,每个指针指向一个字符串,每个串都是类似&quot;name=value&quot;的键值对</li></ul><p>一个进程一旦调用 exec函数,它本身就&quot;死亡&quot;了,系统把代码段替换成新程序的代码,放弃原有的数据段和堆栈段,并为新程序分配新的数据段与堆栈段,唯一保留的就是进程的 PID.也就是说,对系统而言,还是同一个进程,不过执行的已经是另外一个程序了.</p><h2 id="h2-1">加载过程</h2><p>当用户进程调用 <code>execve</code> 时,系统会从用户态切换到内核态,并进入内核的相应处理函数.这个处理过程大致可以分为以下几步:</p><ol start="1"><li><b>用户态调用</b>: 用户进程调用 <code>execve</code> 函数.</li></ol><ol start="2"><li><b>系统调用入口</b>: 系统调用通过中断或快速系统调用路径进入内核, 根据 <a href="https://github.com/luzhixing12345/klinux/blob/87d51ff1ac50fd0e21e1b8bbd17988476b4f19b1/arch/x86/entry/syscalls/syscall_64.tbl#L70" target="_blank">execve syscall number</a> 定位到 <code>sys_execve</code> 函数.<pre class="language-c"><code><span class="Token COMMENT">// fs/exec.c</span><span class="Token LF">
</span><span class="Token Identifier MacroDefine PrimaryExpression ID">SYSCALL_DEFINE3</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">execve</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken LF">
</span><span class="Token PPtoken SPACE">                </span><span class="Token Keyword CONST">const</span><span class="Token Keyword SPACE"> </span><span class="Token Keyword CHAR">char</span><span class="Token Keyword SPACE"> </span><span class="Token MacroDefine PPtoken TYPEDEF_ID">__user</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken MUL">*</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">filename</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken LF">
</span><span class="Token PPtoken SPACE">                </span><span class="Token Keyword CONST">const</span><span class="Token Keyword SPACE"> </span><span class="Token Keyword CHAR">char</span><span class="Token Keyword SPACE"> </span><span class="Token MacroDefine MacroDefine PPtoken TYPEDEF_ID">__user</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken MUL">*</span><span class="Token Keyword CONST">const</span><span class="Token Keyword SPACE"> </span><span class="Token MacroDefine MacroDefine PPtoken TYPEDEF_ID">__user</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken MUL">*</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">argv</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken LF">
</span><span class="Token PPtoken SPACE">                </span><span class="Token Keyword CONST">const</span><span class="Token Keyword SPACE"> </span><span class="Token Keyword CHAR">char</span><span class="Token Keyword SPACE"> </span><span class="Token MacroDefine MacroDefine PPtoken TYPEDEF_ID">__user</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken MUL">*</span><span class="Token Keyword CONST">const</span><span class="Token Keyword SPACE"> </span><span class="Token MacroDefine MacroDefine PPtoken TYPEDEF_ID">__user</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken MUL">*</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">envp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token CompoundStatement PostfixExpression BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement PostfixExpression LF">
</span><span class="Token CompoundStatement PostfixExpression SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">do_execve</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">getname</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">filename</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">envp</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement PostfixExpression BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>详见 <a href="../../kernel/syscall" target="_self">syscall</a></p></blockquote></li></ol><p><code>do_execve</code> 是核心函数,它主要负责处理用户传入的参数、进行安全检查以及最终的进程替换. 指向程序参数argv和环境变量envp两个数组的指针以及数组中所有的指针都位于虚拟地址空间的用户空间部分.因此内核在当问用户空间内存时, 需要将其复制到内核空间.</p><blockquote><p><code>__user</code> 宏定义为空, 该宏的作用只是用来标记信息以便自动化工具检测</p></blockquote><p>将指针封装为 user_arg_ptr 后进入 <code>do_execveat_common</code>, 该函数主要执行三部分内容:</p><ol start="1"><li>创建 <code>linux_binprm</code> 结构体并初始化<p>该结构体用来保存要要执行的文件相关的信息, 包括可执行程序的路径, 参数和环境变量的信息. 这个结构体内容比较多, 关键字段如下</p><pre class="language-c"><code><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">executable</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">/* Executable to pass to the interpreter */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">interpreter</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration HighlightLine SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier HighlightLine STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier HighlightLine ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Pointer Declarator HighlightLine POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier HighlightLine ID">file</span><span class="Token StructDeclaration HighlightLine SEMI">;</span><span class="Token StructDeclaration HighlightLine SPACE">          </span><span class="Token StructDeclaration HighlightLine COMMENT">/*  要执行的文件  */</span><span class="Token StructDeclaration HighlightLine LF">
</span><span class="Token StructDeclaration HighlightLine SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier HighlightLine INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier HighlightLine ID">argc</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier HighlightLine ID">envc</span><span class="Token StructDeclaration HighlightLine SEMI">;</span><span class="Token StructDeclaration HighlightLine SPACE">             </span><span class="Token StructDeclaration HighlightLine COMMENT">/*  命令行参数和环境变量数目  */</span><span class="Token StructDeclaration HighlightLine LF">
</span><span class="Token StructDeclaration HighlightLine SPACE">    </span><span class="Token Keyword QualifyType TypeSpecifier HighlightLine CONST">const</span><span class="Token Keyword QualifyType TypeSpecifier HighlightLine SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier HighlightLine CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Pointer Declarator HighlightLine POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier HighlightLine ID">filename</span><span class="Token StructDeclaration HighlightLine SEMI">;</span><span class="Token StructDeclaration HighlightLine SPACE">        </span><span class="Token StructDeclaration HighlightLine COMMENT">/* 要执行的文件的名称 */</span><span class="Token StructDeclaration HighlightLine LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">buf</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier MacroDefine PrimaryExpression TypeSpecifier ID">BINPRM_BUF_SIZE</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">  </span><span class="Token StructDeclaration COMMENT">/* 保存可执行文件的头128字节 */</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">__randomize_layout</span><span class="Token Declaration SEMI">;</span></code></pre></li></ol><ol start="2"><li>将用户空间的参数拷贝到内核空间<ul><li>调用copy_strings_kernel()从内核空间获取二进制文件的路径名称</li></ul><ul><li>调用copy_string()从用户空间拷贝环境变量和命令行参数</li></ul></li></ol><ol start="3"><li>bprm_execve 执行程序</li></ol><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">do_execveat_common</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">fd</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">filename</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">filename</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">user_arg_ptr</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">argv</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">user_arg_ptr</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">envp</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">flags</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">retval</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">alloc_bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">fd</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">filename</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine SPACE"> </span><span class="Token ExpressionStatement HighlightLine COMMENT">// 创建二进制参数结构体,包含了关于可执行文件的信息</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 将用户提供的 argv 和 envp 复制到内核空间</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">retval</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">copy_string_kernel</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">filename</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">retval</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine LT">&lt;</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">        </span><span class="Token Keyword JumpStatement HighlightLine GOTO">goto</span><span class="Token Keyword JumpStatement HighlightLine SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel HighlightLine ID">out_free</span><span class="Token JumpStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token JumpStatement SelectionStatement HighlightLine LF">
</span><span class="Token JumpStatement SelectionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">exec</span><span class="Token Identifier HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">p</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">retval</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">copy_strings</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">envc</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">envp</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">retval</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine LT">&lt;</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">        </span><span class="Token Keyword JumpStatement HighlightLine GOTO">goto</span><span class="Token Keyword JumpStatement HighlightLine SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel HighlightLine ID">out_free</span><span class="Token JumpStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token JumpStatement SelectionStatement HighlightLine LF">
</span><span class="Token JumpStatement SelectionStatement HighlightLine LF">
</span><span class="Token JumpStatement SelectionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">retval</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">copy_strings</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">argc</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">argv</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">retval</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine LT">&lt;</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">        </span><span class="Token Keyword JumpStatement HighlightLine GOTO">goto</span><span class="Token Keyword JumpStatement HighlightLine SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel HighlightLine ID">out_free</span><span class="Token JumpStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token JumpStatement SelectionStatement HighlightLine LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">/*
     * When argv is empty, add an empty string (&quot;&quot;) as argv[0] to
     * ensure confused userspace programs that start processing
     * from argv[1] won&#x27;t end up walking envp. See also
     * bprm_stack_limits().
     */</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">argc</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">copy_string_kernel</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">out_free</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">argc</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// // 加载可执行文件</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">retval</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">bprm_execve</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">fd</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">filename</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">flags</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token Identifier LabeledStatement GotoLabel ID">out_free</span><span class="Token LabeledStatement COLON">:</span><span class="Token LabeledStatement LF">
</span><span class="Token LabeledStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">free_bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement LabeledStatement SEMI">;</span><span class="Token ExpressionStatement LabeledStatement LF">
</span><span class="Token ExpressionStatement LabeledStatement LF">
</span><span class="Token Identifier LabeledStatement GotoLabel ID">out_ret</span><span class="Token LabeledStatement COLON">:</span><span class="Token LabeledStatement LF">
</span><span class="Token LabeledStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">putname</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">filename</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement LabeledStatement SEMI">;</span><span class="Token ExpressionStatement LabeledStatement LF">
</span><span class="Token ExpressionStatement LabeledStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>bprm_execve 中也分为三部分</p><ol start="1"><li>调用 do_open_execat() 以可执行的模式打开文件<p>在打开文件时 do_open_execat() 的 open_flag 中包含 <code>__FMODE_EXEC</code>, 如果文件并没有可执行权限, 那么此时将会通过返回错误终止.</p><blockquote><p>关于读写执行权限的判断会有 vfs 交由下层的文件系统处理, 详见 <a href="../../fs/vfs" target="_self">vfs</a></p></blockquote><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier FunctionReturnType STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier FunctionReturnType ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">do_open_execat</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">fd</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">filename</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">name</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">flags</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">     </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">file</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">     </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">err</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">     </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">open_flags</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">open_exec_flags</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-1 LCURLY_BRACE">{</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator HighlightLine SPACE">         </span><span class="Token Designator HighlightLine DOT">.</span><span class="Token Identifier Designator HighlightLine ID">open_flag</span><span class="Token Identifier Designator HighlightLine SPACE"> </span><span class="Token Designation DesignationInitializer HighlightLine ASSIGN">=</span><span class="Token Designation DesignationInitializer HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">O_LARGEFILE</span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine PIPE">|</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">O_RDONLY</span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine PIPE">|</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">__FMODE_EXEC</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine LF">
</span><span class="Token SPACE">         </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">acc_mode</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">MAY_EXEC</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">         </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">intent</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">LOOKUP_OPEN</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">         </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">lookup_flags</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">LOOKUP_FOLLOW</span><span class="Token Initializer InitDeclarator COMMA">,</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">     </span><span class="Token Initializer InitDeclarator BraceDepth-1 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">     </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">flags</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression TILDE">~</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">AT_SYMLINK_NOFOLLOW</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression PIPE">|</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">AT_EMPTY_PATH</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression NE">!=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">         </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ERR_PTR</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token PPtoken MINUS">-</span><span class="Token Identifier MacroDefine ID">EINVAL</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">     </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">flags</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">AT_SYMLINK_NOFOLLOW</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">         </span><span class="Token Identifier PrimaryExpression ID">open_exec_flags</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">lookup_flags</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression AND_ASSIGN">&amp;=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression TILDE">~</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">LOOKUP_FOLLOW</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">     </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">flags</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">AT_EMPTY_PATH</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">         </span><span class="Token Identifier PrimaryExpression ID">open_exec_flags</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">lookup_flags</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression OR_ASSIGN">|=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">LOOKUP_EMPTY</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">     </span><span class="Token Identifier PrimaryExpression ID">file</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">do_filp_open</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fd</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">name</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">open_exec_flags</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">     </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">IS_ERR</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">file</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">         </span><span class="Token Keyword JumpStatement HighlightLine GOTO">goto</span><span class="Token Keyword JumpStatement HighlightLine SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel HighlightLine ID">out</span><span class="Token JumpStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token JumpStatement SelectionStatement HighlightLine LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 HighlightLine RCURLY_BRACE">}</span></code></pre></li></ol><ol start="2"><li>调用 sched_exec() 找到最小负载的CPU,用来执行该二进制文件</li></ol><ol start="3"><li>exec_binprm 执行</li></ol><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">bprm_execve</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">               </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">fd</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">filename</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">filename</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">flags</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">file</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">retval</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">file</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">do_open_execat</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">fd</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">filename</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">flags</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTR_ERR</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">file</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">IS_ERR</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">file</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">out_unmark</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">sched_exec</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">file</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">file</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">retval</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">exec_binprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">out</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>exec_binprm 的核心函数 search_binary_handler 用于查找和设置可执行文件格式的处理器.这个函数会<b>搜索已注册的可执行文件格式(binfmt)并尝试找到可以处理给定二进制文件的格式</b>.这种机制允许内核支持多种不同的可执行文件格式,例如 ELF、script 等.</p><p>注意到代码片段中使用了循环和 depth 变量是用来限制内核在查找合适的可执行文件格式处理器时可以进行的重写(rewrite)或重试的次数.这里的注释说明了内核在放弃之前允许的最大重写级别是 4 级. 这是因为<b>某些特殊的可执行文件可能需要特定的格式处理器来加载</b>.例如,一个可执行文件可能是一个脚本,它本身又调用了另一个程序.内核需要递归地查找合适的处理器来处理这些情况.</p><blockquote><p>例如执行 <code>.sh</code> 文件实际上就会转化为调用 bash 执行 <code>.sh</code></p></blockquote><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">exec_binprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">/* This allows 4 levels of binfmt rewrites before failing hard. */</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">depth</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">depth</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">exec</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">depth</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression GT">&gt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">5</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">ELOOP</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">ret</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">search_binary_handler</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">ret</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">ret</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">interpreter</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">exec</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">file</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">file</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">interpreter</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">interpreter</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h2 id="h2-2">search_binary_handler</h2><p>search_binary_handler 是进程装载的核心函数,它负责找到合适的二进制处理程序(比如 ELF 加载器)并调用它来装载可执行文件.</p><p>前文我们提到了 Linux 下标准的可执行文件格式是 <a href="../../runtime/ELF文件格式" target="_self">ELF</a>, 但严格来说其实只要一个文件拥有<b>可执行权限</b>, 并且可以被内核中的某一种解释器正确加载, 那么他就可以运行.</p><p>除了标准 ELF 格式 linux 也支持其他不同的可执行程序格式, 例如以 <code>#!/bin/bash</code> 开头的脚本文件, 或者以 <code>#!/bin/python3</code> 开头的 python 文件. 各个可执行程序的执行方式不尽相同, 因此linux内核每种被注册的可执行程序格式都用 linux_bin_fmt 来存储, 其中记录了可执行程序的加载和执行函数</p><pre class="language-c"><code><span class="Token COMMENT">// include/linux/binfmts.h</span><span class="Token LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binfmt</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">lh</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">module</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">module</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration HighlightLine SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier HighlightLine INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Pointer Declarator HighlightLine POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier HighlightLine ID">load_binary</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier HighlightLine STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier HighlightLine ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Pointer Declarator HighlightLine POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token StructDeclaration HighlightLine SEMI">;</span><span class="Token StructDeclaration HighlightLine LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">load_shlib</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess IfGroup IFDEF">ifdef</span><span class="Token Keyword Preprocess IfGroup SPACE"> </span><span class="Token Identifier MacroDefine IfGroup MacroDefine ID">CONFIG_COREDUMP</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">core_dump</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">coredump_params</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">cprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">min_coredump</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE"> </span><span class="Token StructDeclaration COMMENT">/* minimal dump size */</span><span class="Token StructDeclaration LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess EndifLine ENDIF">endif</span><span class="Token LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">__randomize_layout</span><span class="Token Declaration SEMI">;</span></code></pre><p>其提供了3种方法来加载和执行可执行程序</p><ul><li><b>load_binary: 通过读存放在可执行文件中的信息为当前进程建立一个新的执行环境</b></li></ul><ul><li>load_shlib: 用于动态的把一个共享库捆绑到一个已经在运行的进程, 这是由uselib()系统调用激活的</li></ul><ul><li>core_dump: 在名为core的文件中, 存放当前进程的执行上下文. 这个文件通常是在进程接收到一个缺省操作为&quot;dump&quot;的信号时被创建的, 其格式取决于被执行程序的可执行类型</li></ul><p>所有支持的格式都需要通过 <code>register_binfmt</code> 函数注册到内核当中, 该函数的作用就是将一个结构体头插到 <code>format</code> 全局变量的链表中</p><pre class="language-c"><code><span class="Token COMMENT">/* Registration of default binfmt handlers */</span><span class="Token LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword FunctionType FunctionReturnType INLINE">inline</span><span class="Token Keyword FunctionType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">register_binfmt</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binfmt</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fmt</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">__register_binfmt</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fmt</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">__register_binfmt</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binfmt</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Pointer Declarator SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">fmt</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">insert</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">write_lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">binfmt_lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">insert</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token ConditionalExpression AssignmentExpression HighlightLine QUESTION">?</span><span class="Token ConditionalExpression AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">list_add</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">fmt</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">lh</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">formats</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token ConditionalExpression AssignmentExpression HighlightLine COLON">:</span><span class="Token ConditionalExpression AssignmentExpression HighlightLine LF">
</span><span class="Token ConditionalExpression AssignmentExpression HighlightLine SPACE">         </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">list_add_tail</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">fmt</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">lh</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">formats</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">write_unlock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">binfmt_lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>当实现了一个新的可执行格式的模块正被装载时, 也执行这个函数, 当模块被卸载时, 执行 unregister_binfmt()函数. 可以动态的加载卸载新可执行文件的模块</p></blockquote><p>在代码库中全局搜索该函数, 可以看到内核支持的所有可执行文件格式</p><pre class="language-shell"><code><span class="Token Program ID">grep</span><span class="Token SPACE"> </span><span class="Token OPTION">-rnw</span><span class="Token SPACE"> </span><span class="Token ID">.</span><span class="Token SPACE"> </span><span class="Token OPTION">-e</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">register_binfmt</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token OPTION">--include</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token MUL">*</span><span class="Token ID">.c</span><span class="Token SPACE"> </span><span class="Token OPTION">--include</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token MUL">*</span><span class="Token ID">.h</span></code></pre><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240621154352.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240621154352.png" alt="20240621154352"></a></p><blockquote><p>6.6 相比于 4.4.6 删除了对于 em86/a.out 格式的支持</p><p>对应的注册位置见 <a href="https://github.com/luzhixing12345/klinux/blob/98b724b922a1949f03d5b53f710a97753d76a338/fs/binfmt_elf.c#L2163-L2167" target="_blank">binfmt_elf.c</a> <a href="https://github.com/luzhixing12345/klinux/blob/98b724b922a1949f03d5b53f710a97753d76a338/fs/binfmt_flat.c#L937-L941" target="_blank">binfmt_flat.c</a> <a href="https://github.com/luzhixing12345/klinux/blob/98b724b922a1949f03d5b53f710a97753d76a338/fs/binfmt_script.c#L145-L149" target="_blank">binfmt_script.c</a></p></blockquote><p>当我们执行一个可执行程序的时候, 内核会 <code>list_for_each_entry</code> 遍历所有注册的linux_binfmt对象, 对其调用 <code>load_binrary</code> 方法来尝试加载, 直到加载成功为止.</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">search_binary_handler</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier BOOL">bool</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">need_retry</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">IS_ENABLED</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier MacroDefine ID">CONFIG_MODULES</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binfmt</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fmt</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">retval</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">prepare_binprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 读取该文件前 256 字节保存在 buf 中</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">list_for_each_entry</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fmt</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">formats</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">lh</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token CompoundStatement PostfixExpression BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement PostfixExpression LF">
</span><span class="Token CompoundStatement PostfixExpression SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">try_module_get</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fmt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">module</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement CONTINUE">continue</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">read_unlock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">binfmt_lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">retval</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">fmt</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier FunctionCall HighlightLine ID">load_binary</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">read_lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">binfmt_lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">put_binfmt</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fmt</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">point_of_no_return</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression NE">!=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">ENOEXEC</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">read_unlock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">binfmt_lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement PostfixExpression BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement PostfixExpression LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>load_binary 为各个加载解释器的实现的方法, 例如对于最常见的 shell 脚本, 通常其开头都有 <code>#!/bin/bash</code>. 此时会读取其内容判断是否是以 &quot;#!&quot; 开头, 然后解析取出解释器的路径 /bin/bash 保存到 <code>i_name</code> 中, 打开该文件重新执行(前文提到的多次查找解释器)</p><blockquote><p><code>#!/bin/python3</code> 处理 python 文件也是同理</p></blockquote><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">load_script</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">i_name</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">i_sep</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">i_arg</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">i_end</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">buf_end</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">file</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">retval</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">/* Not ours to exec if we don&#x27;t start with &quot;#!&quot;. */</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">buf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression NE">!=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Char PrimaryExpression CHARACTER">&#x27;#&#x27;</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">buf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression NE">!=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Char PrimaryExpression CHARACTER">&#x27;!&#x27;</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">ENOEXEC</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">// ...</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">// i_name 被解析为 /bin/bash</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">bprm_change_interp</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">i_name</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">/*
     * OK, now restart the process with the interpreter&#x27;s dentry.
     */</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">file</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">open_exec</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">i_name</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">IS_ERR</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">file</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTR_ERR</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">file</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">interpreter</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">file</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>对于其他格式的文件我们不深入研究, 下文重点介绍一下 ELF 文件的加载和执行. 对于 ELF 文件格式, list_for_each_entry(fmt, &amp;formats, lh) 循环查找最终会匹配到 ELF 的函数调用 load_elf_binary, 从 execve 系统调用进入到 elf 文件加载执行的函数调用栈如下所示</p><pre class="language-txt"><code><span class="Token ID">do_execveat_common</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">exec</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">bprm_execve</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">exec</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">exec_binprm</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">exec</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">      </span><span class="Token ID">search_binary_handler</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">exec</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">load_elf_binary</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">binfmt_elf</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span></code></pre><h2 id="h2-3">load_elf_binary</h2><p>load_elf_binary 是装载处理 ELF 文件的核心逻辑, 这个函数很长我们分几段来看.</p><ol start="1"><li>检查目标程序ELF头部</li></ol><ol start="2"><li>load_elf_phdrs 加载目标程序的程序头表</li></ol><ol start="3"><li>如果需要动态链接, 则寻找和处理解释器段</li></ol><ol start="4"><li>检查并读取解释器的程序表头</li></ol><ol start="5"><li>装入目标程序的段segment</li></ol><ol start="6"><li>填写程序的入口地址</li></ol><ol start="7"><li>create_elf_tables填写目标文件的参数环境变量等必要信息</li></ol><ol start="8"><li>START_THREAD 宏准备进入新的程序入口</li></ol><h3 id="h3-4">检查ELF头部</h3><p>在进入 load_elf_binary 之前, search_binary_handler 中会调用 prepare_binprm() 读取映像文件的前 256 个字节对 bprm-&gt;buf 进行填充, 读取头部数据目的是<b>判断文件的格式</b>,每种可执行文件的格式的开头几个字节都是很特殊的,特别是开头4个字节,常常被称做<b>魔数</b>(Magic Number)</p><p>通过对魔数的判断可以确定文件的格式和类型.比如</p><ul><li>ELF的可执行文件格式的头4个字节为0x7F/&#x27;e&#x27;/&quot;1&#x27;/&quot;f&#x27;;</li></ul><ul><li>Java 的可执行文件格式的头4个字节为&#x27;c&#x27;/&#x27;a&#x27;/&quot;f&quot;/&#x27;e&#x27;;</li></ul><ul><li>Shell 脚本或perl/python 等这种解释型语言的脚本,那么它的第一行往往是&quot;#!/bin/sh&quot;或&quot;#!/usr/bin/perl&quot;或&quot;#!/usr/bin/python&quot;,这时候前两个字节&quot;#和&quot;!就构成了魔数</li></ul><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230506004437.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230506004437.png" alt="20230506004437"></a></p><p>魔数用来确定文件的类型, 操作系统在加载可执行文件的时候会确认魔数是否正确, 如果不正确会拒绝加载</p><p>此处的逻辑为判断文件开头是否为 ELF 魔数, 并检查 ELF 类型以及处理器架构.</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">prepare_binprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">loff_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pos</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">memset</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">buf</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">BINPRM_BUF_SIZE</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">kernel_read</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">file</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">buf</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">BINPRM_BUF_SIZE</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">pos</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">load_elf_binary</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">elfhdr</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">elf_ex</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">elfhdr</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">buf</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">ENOEXEC</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 判断开头四个字节为 &quot;\177ELF&quot;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">memcmp</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">elf_ex</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">e_ident</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ELFMAG</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">SELFMAG</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression NE">!=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">out</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">// 判断是可执行文件或者动态链接库</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">elf_ex</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">e_type</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp BinaryOp NE">!=</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ET_EXEC</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_ex</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">e_type</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp NE">!=</span><span class="Token BinaryOp SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ET_DYN</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">out</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">// 判断可执行文件和内核的处理器架构相同</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">elf_check_arch</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">elf_ex</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">out</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h3 id="h3-5">加载程序头表</h3><p>从编译/链接和运行的角度看,应用程序和库程序的链接有两种方式.</p><ul><li>一种是固定的、静态的链接,就是把需要用到的库函数的目标代码(二进制)代码从程序库中抽取出来,链接进应用软件的目标映像中;</li></ul><ul><li>另一种是动态链接,是指库函数的代码并不进入应用软件的目标映像,应用软件在编译/链接阶段并不完成跟库函数的链接,而是把函数库的映像也交给用户,到<b>启动应用软件目标映像运行时才把程序库的映像也装入用户空间</b>(并加以定位),再完成应用软件与库函数的链接.</li></ul><p>Linux内核既支持静态链接的ELF映像,也支持动态链接的ELF映像,而且装入/启动ELF映像必需由内核完成,而动态链接的实现则既可以在内核中完成,也可在用户空间完成.</p><p>因此,GNU把对于动态链接ELF映像的支持作了分工:</p><p><b>把ELF映像的装入/启动入在Linux内核中;而把动态链接的实现放在用户空间(glibc),并为此提供一个称为&quot;解释器&quot;(ld-linux.so.2)的工具软件,而解释器的装入/启动也由内核负责</b>,这在后面我们分析ELF文件的加载时就可以看到</p><p>前文我们介绍了关于 <a href="../../runtime/ELF文件格式" target="_self">ELF文件格式</a> 和 <a href="../../runtime/动态链接" target="_self">动态链接</a> 的相关知识, 虽然 ELF 分为很多段且每个段有不同的作用, 但是在最终执行时<b>操作系统内核只关心需要装载的段</b>, program header(程序头表)中保存了这部分的信息</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240827141550.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240827141550.png" alt="20240827141550"></a></p><p>上图中 LOAD 的部分就是需要装载的段, 可以看到分为三种类型</p><ul><li><b>R</b>(只读): 对应只读数据段</li></ul><ul><li><b>RE</b>(可读可执行): 对应代码段</li></ul><ul><li><b>RW</b>(可读可写): 对应数据段</li></ul><p>采用动态链接的文件还会有动态链接的解释器的段, 下文介绍</p><blockquote><p>由于动态链接的种种优势, 绝大部分 ELF 包括编译器的默认编译选项都会生成动态链接的可执行文件</p></blockquote><h3 id="h3-6">寻找解释器</h3><p>如果需要动态链接, 则寻找和处理解释器段. 使用 load_elf_phdrs 加载程序头之后查找解释器段. &quot;解释器&quot;段的类型为 <code>PT_INTERP</code>, 如果找到就根据其位置的 p_offset 和大小 p_filesz 把整个&quot;解释器&quot;段的内容读入缓冲区. 该段实际上只是一个字符串, 即解释器的文件名, 64位机器上对应的叫做 <code>/lib64/ld-linux-x86-64.so.2</code></p><blockquote><p>这是一个指向 <code>/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</code> 的软链接</p></blockquote><p>有了解释器的文件名以后,就通过 open_exec() 打开这个文件, 并读取解释器头部 256 字节数据</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">load_elf_binary</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// ...</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression ID">elf_phdata</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">load_elf_phdrs</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">elf_ex</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">file</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_phdata</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_ex</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">e_phnum</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token Expression COMMA">,</span><span class="Token Expression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">elf_interpreter</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">p_type</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PT_GNU_PROPERTY</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">elf_property_phdata</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement CONTINUE">continue</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">        </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">elf_ppnt</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">p_type</span><span class="Token Identifier HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine NE">!=</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">PT_INTERP</span><span class="Token SelectionStatement BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">            </span><span class="Token Keyword JumpStatement HighlightLine CONTINUE">continue</span><span class="Token JumpStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token JumpStatement SelectionStatement HighlightLine LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">elf_interpreter</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">kmalloc</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">p_filesz</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">GFP_KERNEL</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">elf_read</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">file</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_interpreter</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">p_filesz</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                  </span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">p_offset</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">interpreter</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">open_exec</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">elf_interpreter</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">interp_elf_ex</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">kmalloc</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Keyword UnaryExpression HighlightLine SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-0 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine POINTER">*</span><span class="Token Identifier PrimaryExpression HighlightLine ID">interp_elf_ex</span><span class="Token UnaryExpression CastExpression BraceDepth-0 HighlightLine RPAREN">)</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression HighlightLine ID">GFP_KERNEL</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">interp_elf_ex</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">ENOMEM</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">out_free_file</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">/* Get the exec headers */</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">elf_read</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">interpreter</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">interp_elf_ex</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                  </span><span class="Token Keyword UnaryExpression SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-0 LPAREN">(</span><span class="Token UnaryOp UnaryExpression POINTER">*</span><span class="Token Identifier PrimaryExpression ID">interp_elf_ex</span><span class="Token UnaryExpression CastExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h3 id="h3-7">检查并读取解释器的程序表头</h3><p>如果需要加载解释器, 前面经过一趟for循环已经找到了需要的解释器信息 <code>elf_interpreter</code>, 它也是当作一个ELF文件, 因此跟目标可执行程序一样, 我们需要load_elf_phdrs加载解释器的程序头表program header table</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">load_elf_binary</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// ...</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">/* Some simple consistency checks for the interpreter */</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">interpreter</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">retval</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">ELIBBAD</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token ExpressionStatement COMMENT">/* Not an ELF interpreter */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">memcmp</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">interp_elf_ex</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">e_ident</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ELFMAG</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">SELFMAG</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression NE">!=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">out_free_dentry</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token JumpStatement SelectionStatement COMMENT">/* Verify the interpreter has a valid arch */</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">elf_check_arch</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">interp_elf_ex</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">elf_check_fdpic</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">interp_elf_ex</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">out_free_dentry</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token JumpStatement SelectionStatement COMMENT">/* Load the interpreter program headers */</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">interp_elf_phdata</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">load_elf_phdrs</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">interp_elf_ex</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">interpreter</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>至此我们已经把目标执行程序和其所需要的解释器都加载初始化, 并且完成检查工作, 也加载了程序头表program header table, 下面开始加载程序的段信息</p><h3 id="h3-8">装入目标程序的段</h3><p>这段代码从目标映像的程序头中搜索类型为 <code>PT_LOAD</code> 的段.在二进制映像中,只有类型为 <code>PT_LOAD</code> 的段才是需要装入的.当然在装入之前,需要确定装入的地址,只要考虑的就是页面对齐,还有该段的p_vaddr域的值(上面省略这部分内容).确定了装入地址后,就通过elf_map()建立用户空间虚拟地址空间与目标映像文件中某个连续区间之间的映射, 其返回值为实际映射的起始地址</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">load_elf_binary</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// ...</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Expression COMMA">,</span><span class="Token Expression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_phdata</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_ex</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">e_phnum</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token Expression COMMA">,</span><span class="Token Expression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement COMMENT">// ...</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">p_type</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression NE">!=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PT_LOAD</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement CONTINUE">continue</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token JumpStatement SelectionStatement COMMENT">// ...</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">error</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">elf_map</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">file</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">load_bias</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">vaddr</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_ppnt</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                </span><span class="Token Identifier PrimaryExpression ID">elf_prot</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">elf_flags</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">total_size</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h3 id="h3-9">设置入口点</h3><p>完成了目标程序和解释器的加载, 同时目标程序的各个段也已经加载到内存了, 我们的目标程序已经准备好了要执行了, 但是还缺少一样东西, 就是我们程序的入口地址, 没有入口地址, 操作系统就不知道从哪里开始执行内存中加载好的可执行映像</p><p>这段程序的逻辑非常简单:</p><ul><li>如果需要装入解释器,就通过 load_elf_interp 装入其映像, 并把将来进入用户空间的入口地址设置成解释器映像的入口地址</li></ul><ul><li>若不装入解释器,那么这个入口地址就是目标映像本身的入口地址.</li></ul><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">load_elf_binary</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// ...</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">interpreter</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">elf_entry</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">load_elf_interp</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">interp_elf_ex</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                        </span><span class="Token Identifier PrimaryExpression ID">interpreter</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                        </span><span class="Token Identifier PrimaryExpression ID">load_bias</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">interp_elf_phdata</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                        </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">arch_state</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token ExpressionStatement COMMENT">// ...</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">elf_entry</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e_entry</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token ExpressionStatement COMMENT">// ...</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h3 id="h3-10">参数与环境变量</h3><p>在完成装入,启动用户空间的映像运行之前,还需要为目标映像和解释器准备好一些有关的信息,这些信息包括常规的argc、envc等等,还有一些&quot;辅助向量(Auxiliary Vector)&quot;.这些信息需要复制到用户空间,使它们在CPU进入解释器或目标映像的程序入口时出现在用户空间堆栈上.这里的 create_elf_tables() 就起着这个作用</p><blockquote><p>详见 <a href="../../runtime/装载" target="_self">装载</a> 进程栈初始化</p></blockquote><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType LF">
</span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">create_elf_tables</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">elfhdr</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">exec</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">interp_load_addr</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">e_entry</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">phdr_addr</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">mm_struct</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">mm</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">current</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">mm</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">p</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">p</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">argc</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">argc</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">envc</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">bprm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">envc</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">// ...</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">put_user</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">argc</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">sp</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">EFAULT</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">/* Populate list of argv pointers back to argv strings. */</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">mm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">arg_end</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">mm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">arg_start</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">argc</span><span class="Token PostfixExpression UnaryExpression DEC">--</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression GT">&gt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">size_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">len</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">put_user</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">elf_addr_t</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">p</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">sp</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">EFAULT</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">strnlen_user</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token CastExpression ConditionalExpression BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine MacroInvocation ID">__user</span><span class="Token Identifier MacroDefine MacroInvocation SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-0 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">p</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">MAX_ARG_STRLEN</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp GT">&gt;</span><span class="Token BinaryOp SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">MAX_ARG_STRLEN</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">EINVAL</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">put_user</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">sp</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">EFAULT</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">mm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">arg_end</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">/* Populate list of envp pointers back to envp strings. */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">mm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">env_end</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">mm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">env_start</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">envc</span><span class="Token PostfixExpression UnaryExpression DEC">--</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression GT">&gt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">size_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">len</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">put_user</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">elf_addr_t</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">p</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">sp</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">EFAULT</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">strnlen_user</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token CastExpression ConditionalExpression BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token MacroDefine MacroDefine Identifier MacroDefine MacroInvocation ID">__user</span><span class="Token Identifier MacroDefine MacroInvocation SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-0 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">p</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">MAX_ARG_STRLEN</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp GT">&gt;</span><span class="Token BinaryOp SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">MAX_ARG_STRLEN</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">EINVAL</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">put_user</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">sp</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">EFAULT</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">mm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">env_end</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">/* Put the elf_info on the stack in the right place.  */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">copy_to_user</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">sp</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">mm</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">saved_auxv</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">ei_index</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression MUL">*</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Keyword UnaryExpression SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">elf_addr_t</span><span class="Token UnaryExpression CastExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">EFAULT</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h3 id="h3-11">进入新的程序入口</h3><p>STEART_THREAD() 宏操作会将eip和esp改成新的地址,就使得CPU在返回用户空间时就进入新的程序入口. 这里新的地址入口就是前文计算的 elf_entry, 如果存在解释器映像,那么这就是解释器映像的程序入口,否则就是目标映像的程序入口</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">load_elf_binary</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">linux_binprm</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">bprm</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// ...</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression ID">START_THREAD</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">elf_ex</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">regs</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">elf_entry</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">bprm</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">p</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>该宏展开之后的功能就是重新设置寄存器的值, 将 IP 指向新的地址</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType LF">
</span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">start_thread_common</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">pt_regs</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">regs</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">new_ip</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">new_sp</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">_cs</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">_ss</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">_ds</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">regs</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">ip</span><span class="Token Identifier HighlightLine SPACE">        </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">new_ip</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">regs</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">sp</span><span class="Token Identifier SPACE">        </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">new_sp</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">regs</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">cs</span><span class="Token Identifier SPACE">        </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">_cs</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">regs</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">ss</span><span class="Token Identifier SPACE">        </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">_ss</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">regs</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">flags</span><span class="Token Identifier SPACE">     </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">X86_EFLAGS_IF</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h2 id="h2-12">符号的动态解析</h2><p>前面我们提到了内核空间中ELF文件的加载工作</p><p>内核的工作</p><ul><li>内核首先读取ELF文件头部,再读如各种数据结构,从这些数据结构中可知各段或节的地址及标识,然后调用mmap()把找到的可加载段的内容加载到内存中.同时读取段标记,以标识该段在内存中是否可读、可写、可执行.其中,文本段是程序代码,只读且可执行,而数据段是可读且可写.</li></ul><ul><li>从PT_INTERP的段中找到所对应的动态链接器名称,并加载动态链接器.通常是/lib/ld-linux.so.2.</li></ul><ul><li>内核把新进程的堆栈中设置一些标记对,以指示动态链接器的相关操作.</li></ul><ul><li>内核把控制权传递给动态链接器.</li></ul><p>动态链接器的工作并不是在内核空间完成的, 而是在用户空间完成的, 比如C语言程序则交给C运行时库来完成, 这个并不是我们今天内核学习的重点, 而是由glic完成的,但是其一般过程如下</p><p>动态链接器的工作</p><ul><li>动态链接器检查程序对共享库的依赖性,并在需要时对其进行加载.</li></ul><ul><li>动态链接器对程序的外部引用进行重定位,并告诉程序其引用的外部变量/函数的地址,此地址位于共享库被加载在内存的区间内.动态链接还有一个<b>延迟定位</b>的特性,即只有在&quot;真正&quot;需要引用符号时才重定位,这对提高程序运行效率有极大帮助.</li></ul><ul><li>动态链接器执行在ELF文件中标记为.init的节的代码,进行程序运行的初始化.</li></ul><ul><li>程序开始执行</li></ul><blockquote><p>动态链接相关详见 <a href="../../runtime/动态链接" target="_self">动态链接</a></p></blockquote><h2 id="h2-13">参考</h2><ul><li><a href="https://www.cnblogs.com/tjyuanxi/p/9313253.html" target="_blank">进程装载过程分析(execve系统调用分析)</a></li></ul><ul><li><a href="https://www.xiaolincoding.com/os/3_memory/linux_mem.html#_5-3-%E5%86%85%E6%A0%B8%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F" target="_blank">深入理解 Linux 虚拟内存管理</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/690824245" target="_blank">ld-linux.so 加载流程</a></li></ul><ul><li><a href="https://www.cnblogs.com/linhaostudy/p/9650228.html" target="_blank">Linux进程启动过程分析do_execve(可执行程序的加载和运行)---Linux进程的管理与调度(十一)</a></li></ul><ul><li><a href="https://blog.csdn.net/gatieme/article/details/51628257" target="_blank">ELF文件的加载过程(load_elf_binary函数详解)--Linux进程的管理与调度(十三)</a></li></ul></div>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var markdownBody = document.querySelector('.markdown-body');
                    var giscusDiv = markdownBody.querySelector('.giscus');
                    var referenceHtml = `<div class="references-tabs-container">
<div class="references-tabs-nav">
<button class="references-tab-btn active" data-tab="references-out">本文引用</button>
</div>
<div class="references-tabs-content">
<div class="references-tab-pane active" id="references-out">
<ul class="reference-list">
<li><a href="../../kernel/syscall">📄 syscall</a></li>
<li><a href="../../fs/vfs">📄 vfs</a></li>
<li><a href="../../runtime/ELF文件格式">📄 ELF文件格式</a></li>
<li><a href="../../runtime/动态链接">📄 动态链接</a></li>
<li><a href="../../runtime/装载">📄 装载</a></li>
</ul>
</div>
</div>
</div>`;
                    
                    if (giscusDiv) {
                        giscusDiv.insertAdjacentHTML('beforebegin', referenceHtml);
                    } else {
                        markdownBody.insertAdjacentHTML('beforeend', referenceHtml);
                    }
                    
                    // 添加选项卡切换功能
                    setTimeout(function() {
                        var tabButtons = document.querySelectorAll('.references-tab-btn');
                        var tabPanes = document.querySelectorAll('.references-tab-pane');
                        
                        tabButtons.forEach(function(button) {
                            button.addEventListener('click', function() {
                                var targetTab = this.getAttribute('data-tab');
                                
                                // 移除所有active类
                                tabButtons.forEach(btn => btn.classList.remove('active'));
                                tabPanes.forEach(pane => pane.classList.remove('active'));
                                
                                // 添加active类到当前选中的选项卡
                                this.classList.add('active');
                                var targetPane = document.getElementById(targetTab);
                                if (targetPane) {
                                    targetPane.classList.add('active');
                                }
                            });
                        });
                    }, 100);
                });
                </script>
                
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../tutorial/编译内核" >tutorial</a><ul><li><a href="../../tutorial/编译内核" >编译内核</a></li></ul><ul><li><a href="../../tutorial/调试内核" >调试内核</a></li></ul><ul><li><a href="../../tutorial/开发环境搭建" >开发环境搭建</a></li></ul><ul><li><a href="../../tutorial/调试技巧" >调试技巧</a></li></ul><ul><li><a href="../../tutorial/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../tutorial/邮件订阅" >邮件订阅</a></li></ul><ul><li><a href="../../tutorial/git" >git</a></li></ul><ul><li><a href="../../tutorial/打包发布库" >打包发布库</a></li></ul></li></ul><ul><li><a href="../../mm/物理内存探测" >mm</a><ul><li><a href="../../mm/物理内存探测" >物理内存探测</a></li></ul><ul><li><a href="../../mm/虚拟地址转换" >虚拟地址转换</a></li></ul><ul><li><a href="../../mm/进程内存布局" >进程内存布局</a></li></ul><ul><li><a href="../../mm/页表" >页表</a></li></ul><ul><li><a href="../../mm/numa" >numa</a></li></ul><ul><li><a href="../../mm/vma" >vma</a></li></ul><ul><li><a href="../../mm/zone" >zone</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab" >slab</a></li></ul><ul><li><a href="../../mm/compaction" >compaction</a></li></ul><ul><li><a href="../../mm/tier-mm" >tier-mm</a></li></ul><ul><li><a href="../../mm/migration" >migration</a></li></ul><ul><li><a href="../../mm/mm_struct" >mm_struct</a></li></ul><ul><li><a href="../../mm/mmio" >mmio</a></li></ul><ul><li><a href="../../mm/LRU" >LRU</a></li></ul><ul><li><a href="../../mm/MGLRU" >MGLRU</a></li></ul><ul><li><a href="../../mm/page" >page</a></li></ul><ul><li><a href="../../mm/folio" >folio</a></li></ul><ul><li><a href="../../mm/autonuma" >autonuma</a></li></ul><ul><li><a href="../../mm/kswapd" >kswapd</a></li></ul><ul><li><a href="../../mm/rmap" >rmap</a></li></ul><ul><li><a href="../../mm/ksm" >ksm</a></li></ul></li></ul><ul><li><a href="../../runtime/ELF文件格式" >runtime</a><ul><li><a href="../../runtime/ELF文件格式" >ELF文件格式</a></li></ul><ul><li><a href="../../runtime/符号表" >符号表</a></li></ul><ul><li><a href="../../runtime/静态链接" >静态链接</a></li></ul><ul><li><a href="../../runtime/装载" >装载</a></li></ul><ul><li><a href="../../runtime/动态链接" >动态链接</a></li></ul><ul><li><a href="../../runtime/库与运行库" >库与运行库</a></li></ul><ul><li><a href="../../runtime/execve" >execve</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul><ul><li><a href="../../kernel/schedule" >schedule</a></li></ul><ul><li><a href="../../kernel/atomic" >atomic</a></li></ul><ul><li><a href="../../kernel/nice" >nice</a></li></ul><ul><li><a href="../../kernel/rcu" >rcu</a></li></ul><ul><li><a href="../../kernel/manage" >manage</a></li></ul><ul><li><a href="../../kernel/workqueue" >workqueue</a></li></ul><ul><li><a href="../../kernel/signal" >signal</a></li></ul><ul><li><a href="../../kernel/lock" >lock</a></li></ul><ul><li><a href="../../kernel/cgroup" >cgroup</a></li></ul><ul><li><a href="../../kernel/syscall" >syscall</a></li></ul><ul><li><a href="../../kernel/task_struct" >task_struct</a></li></ul><ul><li><a href="../../kernel/sync_io" >sync_io</a></li></ul><ul><li><a href="../../kernel/rb-tree" >rb-tree</a></li></ul><ul><li><a href="../../kernel/async_io" >async_io</a></li></ul><ul><li><a href="../../kernel/fork" >fork</a></li></ul><ul><li><a href="../../kernel/module" >module</a></li></ul><ul><li><a href="../../kernel/lock_stat" >lock_stat</a></li></ul><ul><li><a href="../../kernel/kallsyms" >kallsyms</a></li></ul><ul><li><a href="../../kernel/list" >list</a></li></ul><ul><li><a href="../../kernel/epoll" >epoll</a></li></ul><ul><li><a href="../../kernel/per-cpu" >per-cpu</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cache-coherence" >cache-coherence</a></li></ul><ul><li><a href="../../arch/memory-coherence" >memory-coherence</a></li></ul><ul><li><a href="../../arch/io" >io</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/interrupt" >interrupt</a></li></ul><ul><li><a href="../../arch/dram" >dram</a></li></ul><ul><li><a href="../../arch/nvm" >nvm</a></li></ul><ul><li><a href="../../arch/iommu" >iommu</a></li></ul></li></ul><ul><li><a href="../../net/net-arch" >net</a><ul><li><a href="../../net/net-arch" >net-arch</a></li></ul><ul><li><a href="../../net/ip" >ip</a></li></ul><ul><li><a href="../../net/route" >route</a></li></ul><ul><li><a href="../../net/udp" >udp</a></li></ul><ul><li><a href="../../net/tcp" >tcp</a></li></ul><ul><li><a href="../../net/tools" >tools</a></li></ul><ul><li><a href="../../net/quic" >quic</a></li></ul><ul><li><a href="../../net/rdma" >rdma</a></li></ul><ul><li><a href="../../net/socket" >socket</a></li></ul><ul><li><a href="../../net/epoll" >epoll</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul><ul><li><a href="../../fs/filesystem" >filesystem</a></li></ul><ul><li><a href="../../fs/fd" >fd</a></li></ul><ul><li><a href="../../fs/inode" >inode</a></li></ul><ul><li><a href="../../fs/directory" >directory</a></li></ul><ul><li><a href="../../fs/disk-layout" >disk-layout</a></li></ul><ul><li><a href="../../fs/mount" >mount</a></li></ul><ul><li><a href="../../fs/vfs" >vfs</a></li></ul><ul><li><a href="../../fs/ext4" >ext4</a></li></ul><ul><li><a href="../../fs/fuse" >fuse</a></li></ul><ul><li><a href="../../fs/distribute-fs" >distribute-fs</a></li></ul></li></ul><ul><li><a href="../../device/disk" >device</a><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul><ul><li><a href="../../device/driver" >driver</a></li></ul><ul><li><a href="../../device/pcie" >pcie</a></li></ul></li></ul><ul><li><a href="../../cve/dirtycow" >cve</a><ul><li><a href="../../cve/dirtycow" >dirtycow</a></li></ul><ul><li><a href="../../cve/dirtypipe" >dirtypipe</a></li></ul><ul><li><a href="../../cve/sudo" >sudo</a></li></ul><ul><li><a href="../../cve/meltdown" >meltdown</a></li></ul><ul><li><a href="../../cve/smashex" >smashex</a></li></ul></li></ul><ul><li><a href="../../tools/perf" >tools</a><ul><li><a href="../../tools/perf" >perf</a></li></ul><ul><li><a href="../../tools/fault-injection" >fault-injection</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../runtime/库与运行库","../../runtime/vsdo","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/clipboard.svg","../../../img/clipboard-check.svg");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script>
            <script src="https://giscus.app/client.js" data-repo="luzhixing12345/klinux" 
            data-repo-id="R_kgDOJIKiEw" data-category="Q&A" data-category-id="DIC_kwDOJIKiE84CgFwK" data-mapping="pathname" data-strict="0"
            data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom"
            data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
            </script>
            <script type="text/javascript" src="../../../js/dir_tree_toggle.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>