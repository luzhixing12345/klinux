<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">buddy</a><ul><li><a href="#h2-1">buddy system 概述</a></li></ul><ul><li><a href="#h2-2">zone</a></li></ul><ul><li><a href="#h2-3">思考的问题</a></li></ul><ul><li><a href="#h2-4">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">buddy</h1><h2 id="h2-1">buddy system 概述</h2><p>Linux的Buddy内存分配算法是一种用于管理物理内存的分配算法,旨在解决内存分配和释放的碎片问题, 该算法被广泛应用于Linux操作系统中. 内存中有一些是被内核代码占用,还有一些是被特殊用途所保留,那么剩余的空闲内存都会交给内核内存管理系统来进行统一管理和分配</p><p>linux早期版本(比如0.11)管理的方式比较简单粗暴,直接用bitmap的思路标记物理页是否被使用,这样做带来最直接的问题:内存碎片化, 而且bitmap也不能直观的快速寻址连续空闲的内存,每次都要从头开始遍历查找</p><p>在内核分配内存时,必须记录页帧的已分配或空闲状态,以免两个进程使用同样的内存区域.由于内存分配和释放非常频繁,内核还必须保证相关操作尽快完成.<b>内核可以只分配完整的页帧.将内存划分为更小的部分的工作,则委托给用户空间中的标准库.标准库将来源于内核的页帧拆分为小的区域,并为进程分配内存</b>.</p><p>内核中很多时候要求分配连续页.为快速检测内存中的连续区域,内核采用了一种古老而历经检验的技术: 伙伴系统(Buddy system)</p><p>系统中的空闲内存块总是<b>两两分组,每组中的两个内存块称作伙伴</b>.伙伴的分配可以是彼此独立的.但如果两个伙伴都是空闲的,内核会将其合并为一个更大的内存块,作为下一层次上某个内存块的伙伴. 众所周知进程的内存分配是以虚拟页 4KB 为最小单位分配的(即使会出现内部碎片)</p><p>如下图所示, 大小相等且相邻的两个分组是彼此的Buddy, 当 n=1 时,组的页面数量是2, 此时 Group 1 与 Group 2 互为Buddy, 但Group 1 与 Group 3 由于隔开了,就不是Buddy. 如果 Group1 与 Group 2 都被释放回来后,系统就将会对两个Buddy进行合并,形成一个数量更大的组Group 5, 这也是两个Buddy必须相邻的原因</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230822122037.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230822122037.png" alt="20230822122037"></a></p><p>下图展示一个 4 级的 buddy, 的分配和释放过程. 其中最小的 buddy 块为 4KB</p><ul><li>最初的情况.</li></ul><ul><li>程序 A 请求内存 3 KB ,阶数 0.<ul><li>没有可用的 0 阶块,因此分割 4 阶块,创建两个 3 阶块.</li></ul><ul><li>仍然没有可用的 0 阶块,因此第一个 3 阶块被分割,创建两个 2 阶块.</li></ul><ul><li>仍然没有可用的 0 阶块,因此第一个 2 阶块被分割,创建两个 1 阶块.</li></ul><ul><li>仍然没有可用的 0 阶块,因此第一个 1 阶块被分割,创建两个 0 阶块.</li></ul><ul><li>现在有一个 0 阶区块可用,因此它被分配给 A.</li></ul></li></ul><ul><li>程序 B 请求内存 6 K,顺序 1.顺序 1 块可用,因此将其分配给 B.</li></ul><ul><li>程序 C 请求内存 3 K,阶数 0.阶数 0 块可用,因此将其分配给 C.</li></ul><ul><li>程序 D 请求内存 6 K,顺序 1.<ul><li>没有可用的 1 阶块,因此分割 2 阶块,创建两个 1 阶块.</li></ul><ul><li>现在有一个 1 阶块可用,因此它被分配给 D.</li></ul></li></ul><ul><li>程序 B 释放其内存,释放一阶 1 块.</li></ul><ul><li>程序D释放其内存.<ul><li>释放一订单 1 块.</li></ul><ul><li>由于新释放的块的伙伴块也空闲,因此两者被合并为一个2阶块.</li></ul></li></ul><ul><li>程序 A 释放其内存,释放一个 0 阶块.</li></ul><ul><li>程序C释放其内存.</li></ul><ul><li>释放 1 个 0 阶块.<ul><li>由于新释放的块的伙伴块也空闲,因此两者被合并为一个1阶块.</li></ul><ul><li>由于新形成的 1 阶区块的伙伴区块也空闲,因此两者合并为一个 2 阶区块.</li></ul><ul><li>由于新形成的2阶区块的伙伴区块也是空闲的,因此两者被合并为一个3阶区块.</li></ul><ul><li>由于新形成的 3 阶区块的伙伴区块也空闲,因此两者合并为一个 4 阶区块.</li></ul></li></ul><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230816164048.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230816164048.png" alt="20230816164048"></a></p><p>在应用程序释放内存时,内核可以直接检查地址,来判断是否能够创建一组伙伴,并合并为一个更大的内存块放回到伙伴列表中,这刚好是内存块分裂的逆过程.这提高了较大内存块可用的可能性</p><h2 id="h2-2">zone</h2><p>在Linux的物理内存模型中,一个内存node按照属性被划分为了多个zones,比如ZONE_DMA和ZONE_NORMAL. 虽然内存访问的最小单位是byte或者word,但MMU是以page为单位来查找页表的,page也就成了Linux中内存管理的重要单位.包括换出(swap out)、回收(relcaim)、映射等操作,都是以page为粒度的. 由于虚拟内存和页表转换的设计, 使得在虚拟内存中需要连续的页面在物理内存中不必连续, 但是我们仍然希望可以快速的找到一组连续的可用页面以实现快速的分配和回收</p><p>linux 中 buddy 的最大数量为定义在 include/linux/mmzone.h 中的 <code>MAX_ORDER</code> 决定, 默认值为 11, 也就是把所有的空闲页框分组为11个块链表,每个块链表分别包含大小为1,2,4,8,16,32,64,128,256,512和1024个连续页框的页框块.最大可以申请1024个连续页框,对应4MB大小的连续内存,每个页框块的第一个页框的物理地址是该块大小的整数倍, 如下图所示.</p><blockquote><p>数组 free_area 每个索引 i 存放的就是大小为 2^i 页面数量的分组,这样可以提升Buddy System分配内存时查找分组的效率.</p></blockquote><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230822212729.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230822212729.png" alt="20230822212729"></a></p><blockquote><p>以上图为例, 假设现在要分配一个 9KB 的页面, 首先计算满足条件的 2^i, 所以至少分配一个 16KB 的空间, 也就是 i=2, free_area[2] 没有对应的链表节点, 所以从 i=3 的链表取第一个节点分为两部分, 一部分分配, 一部分存于 i=2 处的链表</p></blockquote><blockquote><p>值得注意的是上图中 2^3 画成一个大块只是为了说明, 实际上 buddy system 对于物理内存的管理是以 page(4KB) 为单位的, 所以一个大块中存了 8 个 page</p></blockquote><p>zone 和 free_area 的结构体定义核心部分如下所示. 但需要注意的是每个&quot;free_area&quot;包含不只一个free list,而是一个free list数组(形成二维数组),包含了多种&quot;migrate type&quot;,以便将具有相同「迁移类型」的page frame尽可能地分组(同一类型的所有order的free list构成一组&quot;pageblocks&quot;)</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">MAX_ORDER</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken NUMBER">11</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">zone</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Structure COMMENT">/* free areas of different sizes */</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">free_area</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">free_area</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression TypeSpecifier ID">MAX_ORDER</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration VARARGS">...</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure LF">
</span><span class="Token Structure LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">free_area</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">free_list</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier MacroDefine PrimaryExpression TypeSpecifier ID">MIGRATE_TYPES</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">nr_free</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration COMMENT">// 这是一个双向链表, 图中没有画出来</span><span class="Token Declaration LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">next</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">prev</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p>free_area 中的空闲分组按照 MIGRATE_TYPES 进行了分组,每种类型都保存在一个双向链表中. MIGRATE_TYPES (默认为4) 用于记录当前内存块的属性, 是否可移动,</p><blockquote><p>这样的设计是为了使包括 <a href="https://zhuanlan.zhihu.com/p/81983973" target="_blank">memory compaction</a> 在内的一些操作更加高效</p></blockquote><pre class="language-c"><code><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier ID">migratetype</span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token EnumSpecifier BraceDepth-0 LCURLY_BRACE">{</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">MIGRATE_UNMOVABLE</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE">   </span><span class="Token EnumSpecifier COMMENT">// page frame不可移动</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">MIGRATE_MOVABLE</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE">     </span><span class="Token EnumSpecifier COMMENT">// page frame可移动</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">MIGRATE_RECLAIMABLE</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE"> </span><span class="Token EnumSpecifier COMMENT">// page frame可回收迁移</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">MIGRATE_PCPTYPES</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE">   </span><span class="Token EnumSpecifier COMMENT">/* the number of types on the pcp lists */</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">MIGRATE_HIGHATOMIC</span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier SPACE"> </span><span class="Token Enumerator ASSIGN">=</span><span class="Token Enumerator SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression TypeSpecifier ID">MIGRATE_PCPTYPES</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess IfGroup IFDEF">ifdef</span><span class="Token Keyword Preprocess IfGroup SPACE"> </span><span class="Token Identifier MacroDefine IfGroup MacroDefine ID">CONFIG_CMA</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token COMMENT">/*
     * MIGRATE_CMA migration type is designed to mimic the way
     * ZONE_MOVABLE works.  Only movable pages can be allocated
     * from MIGRATE_CMA pageblocks and page allocator never
     * implicitly change migration type of MIGRATE_CMA pageblock.
     *
     * The way to use it is to change migratetype of a range of
     * pageblocks to MIGRATE_CMA which can be done by
     * __free_pageblock_cma() function.
     */</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">MIGRATE_CMA</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess EndifLine ENDIF">endif</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess IfGroup IFDEF">ifdef</span><span class="Token Keyword Preprocess IfGroup SPACE"> </span><span class="Token Identifier MacroDefine IfGroup MacroDefine ID">CONFIG_MEMORY_ISOLATION</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">MIGRATE_ISOLATE</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token EnumSpecifier COMMENT">/* can&#x27;t allocate from here */</span><span class="Token EnumSpecifier LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess EndifLine ENDIF">endif</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">MIGRATE_TYPES</span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier LF">
</span><span class="Token EnumSpecifier BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p>所以实际情况上图 free_area 画的并不准确, 准确来说如下图所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230823002618.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230823002618.png" alt="20230823002618"></a></p><p>分配内存时还需要很多标记类参数,例如指定目标 zone (是从 DMA 请求内存还是 NORMAL)、分配到的内存是否要全部置零、如果内存不足,是否可以触发内存回收机制等等,这些标记都定义在 include/linux/gfp.h 中</p><pre class="language-c"><code><span class="Token COMMENT">// include/linux/gfp.h</span><span class="Token LF">
</span><span class="Token COMMENT">// include/linux/gfp_types.h</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">___GFP_DMA</span><span class="Token PPtoken SPACE">      </span><span class="Token PPtoken NUMBER">0x01u</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">___GFP_HIGHMEM</span><span class="Token PPtoken SPACE">      </span><span class="Token PPtoken NUMBER">0x02u</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">___GFP_DMA32</span><span class="Token PPtoken SPACE">        </span><span class="Token PPtoken NUMBER">0x04u</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">___GFP_MOVABLE</span><span class="Token PPtoken SPACE">      </span><span class="Token PPtoken NUMBER">0x08u</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">___GFP_RECLAIMABLE</span><span class="Token PPtoken SPACE">  </span><span class="Token PPtoken NUMBER">0x10u</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">___GFP_HIGH</span><span class="Token PPtoken SPACE">     </span><span class="Token PPtoken NUMBER">0x20u</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">___GFP_IO</span><span class="Token PPtoken SPACE">       </span><span class="Token PPtoken NUMBER">0x40u</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">___GFP_FS</span><span class="Token PPtoken SPACE">       </span><span class="Token PPtoken NUMBER">0x80u</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">___GFP_ZERO</span><span class="Token PPtoken SPACE">     </span><span class="Token PPtoken NUMBER">0x100u</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">___GFP_ATOMIC</span><span class="Token PPtoken SPACE">       </span><span class="Token PPtoken NUMBER">0x200u</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT">/* 通过位运算将不同的标记组合起来 */</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">GFP_ATOMIC</span><span class="Token PPtoken SPACE">  </span><span class="Token PPtoken BraceDepth-0 LPAREN">(</span><span class="Token MacroDefine Identifier MacroDefine ID">__GFP_HIGH</span><span class="Token PPtoken PIPE">|</span><span class="Token MacroDefine Identifier MacroDefine ID">__GFP_ATOMIC</span><span class="Token PPtoken PIPE">|</span><span class="Token MacroDefine Identifier MacroDefine ID">__GFP_KSWAPD_RECLAIM</span><span class="Token PPtoken BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">GFP_KERNEL</span><span class="Token PPtoken SPACE">  </span><span class="Token PPtoken BraceDepth-0 LPAREN">(</span><span class="Token MacroDefine Identifier MacroDefine ID">__GFP_RECLAIM</span><span class="Token Identifier MacroDefine SPACE"> </span><span class="Token PPtoken PIPE">|</span><span class="Token PPtoken SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine ID">__GFP_IO</span><span class="Token Identifier MacroDefine SPACE"> </span><span class="Token PPtoken PIPE">|</span><span class="Token PPtoken SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine ID">__GFP_FS</span><span class="Token PPtoken BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">GFP_KERNEL_ACCOUNT</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken BraceDepth-0 LPAREN">(</span><span class="Token MacroDefine Identifier MacroDefine ID">GFP_KERNEL</span><span class="Token Identifier MacroDefine SPACE"> </span><span class="Token PPtoken PIPE">|</span><span class="Token PPtoken SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine ID">__GFP_ACCOUNT</span><span class="Token PPtoken BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">GFP_NOWAIT</span><span class="Token PPtoken SPACE">  </span><span class="Token PPtoken BraceDepth-0 LPAREN">(</span><span class="Token MacroDefine MacroDefine Identifier MacroDefine ID">__GFP_KSWAPD_RECLAIM</span><span class="Token PPtoken BraceDepth-0 RPAREN">)</span></code></pre><blockquote><p>&quot;MIGRATE_MOVABLE&quot;表示page frame可移动,&quot;MIGRATE_UNMOVABLE&quot;与之相反,而&quot;MIGRATE_CMA&quot;则是专用于CMA区域, 分配的时候会首先按照请求的migrate type从对应的pageblocks中寻找,如果不成功,其他migrate type的pageblocks中也会考虑(类似于<a href="https://zhuanlan.zhihu.com/p/81961211" target="_blank">Linux内存调节之lowmem reserve</a>中zone之间的fallback),在一定条件下,甚至有可能改变pageblock的migrate type.</p></blockquote><p>本质上讲,buddy算法相对于原始的bitmap,优势在于:</p><ol start="1"><li>按照不同页框个数2^n重新组织了内存,便于快速查找用户所需大小的内存块(free_area数组的寻址时间复杂度是O(1))</li></ol><ol start="2"><li>不停的分配、重组页框,在一定程度上减少了页框碎片</li></ol><p>可以查看 <code>/proc/buddyinfo</code> 来获取当前系统中的 buddy 信息</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/klinux</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">cat</span><span class="Token SPACE"> </span><span class="Token PATH">/proc/buddyinfo</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">      </span><span class="Token ID">DMA</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">    </span><span class="Token ID">DMA32</span><span class="Token SPACE">      </span><span class="Token NUMBER">3</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">      </span><span class="Token NUMBER">4</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">3</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">    </span><span class="Token NUMBER">959</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">   </span><span class="Token ID">Normal</span><span class="Token SPACE">    </span><span class="Token NUMBER">832</span><span class="Token SPACE">    </span><span class="Token NUMBER">677</span><span class="Token SPACE">    </span><span class="Token NUMBER">293</span><span class="Token SPACE">    </span><span class="Token NUMBER">101</span><span class="Token SPACE">     </span><span class="Token NUMBER">66</span><span class="Token SPACE">     </span><span class="Token NUMBER">85</span><span class="Token SPACE">     </span><span class="Token NUMBER">37</span><span class="Token SPACE">     </span><span class="Token NUMBER">11</span><span class="Token SPACE">     </span><span class="Token NUMBER">10</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">    </span><span class="Token NUMBER">656</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT">## 另一个机器上</span><span class="Token LF">
</span><span class="Token HOST_NAME">root@kamilu</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">#</span><span class="Token SPACE"> </span><span class="Token Program ID">cat</span><span class="Token SPACE"> </span><span class="Token PATH">/proc/buddyinfo</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">      </span><span class="Token ID">DMA</span><span class="Token SPACE">     </span><span class="Token NUMBER">54</span><span class="Token SPACE">     </span><span class="Token NUMBER">21</span><span class="Token SPACE">      </span><span class="Token NUMBER">5</span><span class="Token SPACE">      </span><span class="Token NUMBER">4</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">3</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">    </span><span class="Token ID">DMA32</span><span class="Token SPACE">   </span><span class="Token NUMBER">1386</span><span class="Token SPACE">    </span><span class="Token NUMBER">559</span><span class="Token SPACE">    </span><span class="Token NUMBER">475</span><span class="Token SPACE">     </span><span class="Token NUMBER">83</span><span class="Token SPACE">     </span><span class="Token NUMBER">52</span><span class="Token SPACE">     </span><span class="Token NUMBER">30</span><span class="Token SPACE">     </span><span class="Token NUMBER">13</span><span class="Token SPACE">      </span><span class="Token NUMBER">7</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">      </span><span class="Token NUMBER">8</span><span class="Token SPACE">      </span><span class="Token NUMBER">4</span></code></pre><p>上图信息说明:</p><ol start="1"><li>当前计算机只有一个 node, 所以都是 Node 0</li></ol><ol start="2"><li>当前系统中 X86-64 分为三个区, 分区名分别是 DMA DMA32 Normal (可配置)</li></ol><ol start="3"><li>后面每一行有 11 个数字, 每一列依次对应的 buddy 数组中每一个链表头指向的链表的节点内存块个数<blockquote><p>从左至右分别为 1 2 4 ... 1024. 即第一行的 3 对应 (3 * PG_SIZE * 1024)KB 大小的 buddy 块</p></blockquote></li></ol><p>除此之外还可以查看 pagetypeinfo 获取一个更详细的, 每一个 list_head 的 MIGRATE_TYPES 信息</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/klinux</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">cat</span><span class="Token SPACE"> </span><span class="Token PATH">/proc/pagetypeinfo</span><span class="Token LF">
</span><span class="Token Program ID">Page</span><span class="Token SPACE"> </span><span class="Token ID">block</span><span class="Token SPACE"> </span><span class="Token ID">order:</span><span class="Token SPACE"> </span><span class="Token NUMBER">9</span><span class="Token LF">
</span><span class="Token Program ID">Pages</span><span class="Token SPACE"> </span><span class="Token ID">per</span><span class="Token SPACE"> </span><span class="Token ID">block:</span><span class="Token SPACE">  </span><span class="Token NUMBER">512</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Free</span><span class="Token SPACE"> </span><span class="Token ID">pages</span><span class="Token SPACE"> </span><span class="Token ID">count</span><span class="Token SPACE"> </span><span class="Token ID">per</span><span class="Token SPACE"> </span><span class="Token ID">migrate</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE"> </span><span class="Token ID">at</span><span class="Token SPACE"> </span><span class="Token ID">order</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">      </span><span class="Token NUMBER">3</span><span class="Token SPACE">      </span><span class="Token NUMBER">4</span><span class="Token SPACE">      </span><span class="Token NUMBER">5</span><span class="Token SPACE">      </span><span class="Token NUMBER">6</span><span class="Token SPACE">      </span><span class="Token NUMBER">7</span><span class="Token SPACE">      </span><span class="Token NUMBER">8</span><span class="Token SPACE">      </span><span class="Token NUMBER">9</span><span class="Token SPACE">     </span><span class="Token NUMBER">10</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">      </span><span class="Token ID">DMA</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">    </span><span class="Token ID">Unmovable</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">      </span><span class="Token ID">DMA</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">      </span><span class="Token ID">Movable</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">      </span><span class="Token ID">DMA</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">  </span><span class="Token ID">Reclaimable</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">      </span><span class="Token ID">DMA</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">   </span><span class="Token ID">HighAtomic</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">      </span><span class="Token ID">DMA</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">      </span><span class="Token ID">Isolate</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">    </span><span class="Token ID">DMA32</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">    </span><span class="Token ID">Unmovable</span><span class="Token SPACE">     </span><span class="Token NUMBER">45</span><span class="Token SPACE">     </span><span class="Token NUMBER">52</span><span class="Token SPACE">    </span><span class="Token NUMBER">117</span><span class="Token SPACE">    </span><span class="Token NUMBER">111</span><span class="Token SPACE">     </span><span class="Token NUMBER">98</span><span class="Token SPACE">     </span><span class="Token NUMBER">65</span><span class="Token SPACE">     </span><span class="Token NUMBER">38</span><span class="Token SPACE">     </span><span class="Token NUMBER">23</span><span class="Token SPACE">      </span><span class="Token NUMBER">6</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">    </span><span class="Token ID">DMA32</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">      </span><span class="Token ID">Movable</span><span class="Token SPACE">    </span><span class="Token NUMBER">516</span><span class="Token SPACE">    </span><span class="Token NUMBER">201</span><span class="Token SPACE">    </span><span class="Token NUMBER">219</span><span class="Token SPACE">    </span><span class="Token NUMBER">127</span><span class="Token SPACE">     </span><span class="Token NUMBER">66</span><span class="Token SPACE">     </span><span class="Token NUMBER">23</span><span class="Token SPACE">     </span><span class="Token NUMBER">13</span><span class="Token SPACE">     </span><span class="Token NUMBER">10</span><span class="Token SPACE">      </span><span class="Token NUMBER">6</span><span class="Token SPACE">     </span><span class="Token NUMBER">24</span><span class="Token SPACE">    </span><span class="Token NUMBER">740</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">    </span><span class="Token ID">DMA32</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">  </span><span class="Token ID">Reclaimable</span><span class="Token SPACE">     </span><span class="Token NUMBER">41</span><span class="Token SPACE">     </span><span class="Token NUMBER">16</span><span class="Token SPACE">     </span><span class="Token NUMBER">29</span><span class="Token SPACE">     </span><span class="Token NUMBER">26</span><span class="Token SPACE">     </span><span class="Token NUMBER">21</span><span class="Token SPACE">      </span><span class="Token NUMBER">2</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">    </span><span class="Token ID">DMA32</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">   </span><span class="Token ID">HighAtomic</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">    </span><span class="Token ID">DMA32</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">      </span><span class="Token ID">Isolate</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">   </span><span class="Token ID">Normal</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">    </span><span class="Token ID">Unmovable</span><span class="Token SPACE">    </span><span class="Token NUMBER">678</span><span class="Token SPACE">    </span><span class="Token NUMBER">299</span><span class="Token SPACE">    </span><span class="Token NUMBER">508</span><span class="Token SPACE">    </span><span class="Token NUMBER">226</span><span class="Token SPACE">     </span><span class="Token NUMBER">85</span><span class="Token SPACE">     </span><span class="Token NUMBER">37</span><span class="Token SPACE">     </span><span class="Token NUMBER">20</span><span class="Token SPACE">     </span><span class="Token NUMBER">19</span><span class="Token SPACE">     </span><span class="Token NUMBER">11</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">   </span><span class="Token ID">Normal</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">      </span><span class="Token ID">Movable</span><span class="Token SPACE">   </span><span class="Token NUMBER">1662</span><span class="Token SPACE">    </span><span class="Token NUMBER">126</span><span class="Token SPACE">    </span><span class="Token NUMBER">151</span><span class="Token SPACE">     </span><span class="Token NUMBER">96</span><span class="Token SPACE">     </span><span class="Token NUMBER">55</span><span class="Token SPACE">     </span><span class="Token NUMBER">33</span><span class="Token SPACE">     </span><span class="Token NUMBER">23</span><span class="Token SPACE">     </span><span class="Token NUMBER">20</span><span class="Token SPACE">      </span><span class="Token NUMBER">9</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">   </span><span class="Token ID">Normal</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">  </span><span class="Token ID">Reclaimable</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">7</span><span class="Token SPACE">      </span><span class="Token NUMBER">3</span><span class="Token SPACE">     </span><span class="Token NUMBER">20</span><span class="Token SPACE">     </span><span class="Token NUMBER">10</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">1</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">   </span><span class="Token ID">Normal</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">   </span><span class="Token ID">HighAtomic</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">   </span><span class="Token ID">Normal</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">      </span><span class="Token ID">Isolate</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token SPACE">      </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Number</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">blocks</span><span class="Token SPACE"> </span><span class="Token ID">type</span><span class="Token SPACE">     </span><span class="Token ID">Unmovable</span><span class="Token SPACE">      </span><span class="Token ID">Movable</span><span class="Token SPACE">  </span><span class="Token ID">Reclaimable</span><span class="Token SPACE">   </span><span class="Token ID">HighAtomic</span><span class="Token SPACE">      </span><span class="Token ID">Isolate</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">      </span><span class="Token ID">DMA</span><span class="Token SPACE">            </span><span class="Token NUMBER">1</span><span class="Token SPACE">            </span><span class="Token NUMBER">7</span><span class="Token SPACE">            </span><span class="Token NUMBER">0</span><span class="Token SPACE">            </span><span class="Token NUMBER">0</span><span class="Token SPACE">            </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">    </span><span class="Token ID">DMA32</span><span class="Token SPACE">           </span><span class="Token NUMBER">25</span><span class="Token SPACE">         </span><span class="Token NUMBER">1941</span><span class="Token SPACE">           </span><span class="Token NUMBER">10</span><span class="Token SPACE">            </span><span class="Token NUMBER">0</span><span class="Token SPACE">            </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token Program ID">Node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">zone</span><span class="Token SPACE">   </span><span class="Token ID">Normal</span><span class="Token SPACE">          </span><span class="Token NUMBER">291</span><span class="Token SPACE">         </span><span class="Token NUMBER">1648</span><span class="Token SPACE">          </span><span class="Token NUMBER">108</span><span class="Token SPACE">            </span><span class="Token NUMBER">0</span><span class="Token SPACE">            </span><span class="Token NUMBER">0</span></code></pre><h2 id="h2-3">思考的问题</h2><ol start="1"><li>516KB?<p>选择1: 1024KB; 选择2: 512KB + 4KB</p></li></ol><ol start="2"><li>大于 4MB怎么办?</li></ol><h2 id="h2-4">参考</h2><ul><li><a href="https://blog.csdn.net/rikeyone/article/details/85054231" target="_blank">深入浅出内存管理-- 伙伴系统(buddy system)</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/73562347" target="_blank">内存分配[二] - Buddy系统的原理</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/105589621" target="_blank">内存分配[三] - Linux中Buddy系统的实现</a></li></ul><ul><li><a href="https://awesome-programming-books.github.io/linux/%E6%B7%B1%E5%85%A5Linux%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84.pdf" target="_blank">深入Linux内核架构.pdf</a></li></ul><ul><li><a href="https://s3.shizhz.me/linux-mm/3.2-wu-li-nei-cun/3.2.4-buddy-system-huo-ban-xi-tong" target="_blank">Buddy System(伙伴系统)</a></li></ul><ul><li><a href="https://www.cnblogs.com/theseventhson/p/15703182.html" target="_blank">linux源码解读(九):内存管理_buddy和slab</a></li></ul><ul><li><a href="https://en.wikipedia.org/wiki/Buddy_memory_allocation" target="_blank">Buddy memory allocation</a></li></ul><ul><li><a href="https://blog.csdn.net/lickylin/article/details/50726847" target="_blank">Linux /proc/buddyinfo理解</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/81983973" target="_blank">Linux中的Memory Compaction [一]</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../快速开始/编译内核" >快速开始</a><ul><li><a href="../../快速开始/编译内核" >编译内核</a></li></ul><ul><li><a href="../../快速开始/调试内核" >调试内核</a></li></ul><ul><li><a href="../../快速开始/开发环境搭建" >开发环境搭建</a></li></ul><ul><li><a href="../../快速开始/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../快速开始/邮件订阅" >邮件订阅</a></li></ul><ul><li><a href="../../快速开始/patch" >patch</a></li></ul></li></ul><ul><li><a href="../../mm/detect" >mm</a><ul><li><a href="../../mm/detect" >detect</a></li></ul><ul><li><a href="../../mm/va_trans" >va_trans</a></li></ul><ul><li><a href="../../mm/numa" >numa</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab" >slab</a></li></ul><ul><li><a href="../../mm/compaction" >compaction</a></li></ul><ul><li><a href="../../mm/tier" >tier</a></li></ul><ul><li><a href="../../mm/migration" >migration</a></li></ul><ul><li><a href="../../mm/mm_struct" >mm_struct</a></li></ul><ul><li><a href="../../mm/mmio" >mmio</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul><ul><li><a href="../../fs/filesystem" >filesystem</a></li></ul><ul><li><a href="../../fs/fd" >fd</a></li></ul><ul><li><a href="../../fs/inode" >inode</a></li></ul><ul><li><a href="../../fs/directory" >directory</a></li></ul><ul><li><a href="../../fs/disk-layout" >disk-layout</a></li></ul><ul><li><a href="../../fs/mount" >mount</a></li></ul><ul><li><a href="../../fs/vfs" >vfs</a></li></ul><ul><li><a href="../../fs/ext4" >ext4</a></li></ul><ul><li><a href="../../fs/fuse" >fuse</a></li></ul><ul><li><a href="../../fs/distribute-fs" >distribute-fs</a></li></ul></li></ul><ul><li><a href="../../runtime/proc" >runtime</a><ul><li><a href="../../runtime/proc" >proc</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul><ul><li><a href="../../runtime/elf_format" >elf_format</a></li></ul><ul><li><a href="../../runtime/elf_loader" >elf_loader</a></li></ul><ul><li><a href="../../runtime/ld" >ld</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul><ul><li><a href="../../kernel/atomic" >atomic</a></li></ul><ul><li><a href="../../kernel/rcu" >rcu</a></li></ul><ul><li><a href="../../kernel/workqueue" >workqueue</a></li></ul><ul><li><a href="../../kernel/lock" >lock</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cache-co" >cache-co</a></li></ul><ul><li><a href="../../arch/memory-co" >memory-co</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/interrupt" >interrupt</a></li></ul></li></ul><ul><li><a href="../../proc/schedule" >proc</a><ul><li><a href="../../proc/schedule" >schedule</a></li></ul><ul><li><a href="../../proc/nice" >nice</a></li></ul><ul><li><a href="../../proc/manage" >manage</a></li></ul><ul><li><a href="../../proc/signal" >signal</a></li></ul><ul><li><a href="../../proc/cgroup" >cgroup</a></li></ul><ul><li><a href="../../proc/task_struct" >task_struct</a></li></ul><ul><li><a href="../../proc/rb-tree" >rb-tree</a></li></ul></li></ul><ul><li><a href="../../net/net-arch" >net</a><ul><li><a href="../../net/net-arch" >net-arch</a></li></ul><ul><li><a href="../../net/ip" >ip</a></li></ul><ul><li><a href="../../net/route" >route</a></li></ul><ul><li><a href="../../net/udp" >udp</a></li></ul><ul><li><a href="../../net/tcp" >tcp</a></li></ul><ul><li><a href="../../net/tools" >tools</a></li></ul></li></ul><ul><li><a href="../../device/io" >device</a><ul><li><a href="../../device/io" >io</a></li></ul><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul><ul><li><a href="../../device/driver" >driver</a></li></ul><ul><li><a href="../../device/io_uring" >io_uring</a></li></ul></li></ul><ul><li><a href="../../others/safety" >others</a><ul><li><a href="../../others/safety" >safety</a></li></ul><ul><li><a href="../../others/Q&A" >Q&A</a></li></ul></li></ul><ul><li><a href="../../driver/intro" >driver</a><ul><li><a href="../../driver/intro" >intro</a></li></ul><ul><li><a href="../../driver/usb" >usb</a></li></ul><ul><li><a href="../../driver/pcie" >pcie</a></li></ul></li></ul><ul><li><a href="../../cve/dirtycow" >cve</a><ul><li><a href="../../cve/dirtycow" >dirtycow</a></li></ul><ul><li><a href="../../cve/dirtypipe" >dirtypipe</a></li></ul><ul><li><a href="../../cve/sudo" >sudo</a></li></ul><ul><li><a href="../../cve/meltdown" >meltdown</a></li></ul><ul><li><a href="../../cve/smashex" >smashex</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../mm/numa","../../mm/slab","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script>
            <script src="https://giscus.app/client.js" data-repo="luzhixing12345/klinux" 
            data-repo-id="R_kgDOJIKiEw" data-category="Q&A" data-category-id="DIC_kwDOJIKiE84CgFwK" data-mapping="pathname" data-strict="0"
            data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom"
            data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
            </script>
            <script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>