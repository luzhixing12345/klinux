<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css /><link rel='stylesheet' href=../../../css/x86asm.css /><link rel='stylesheet' href=../../../css/yaml.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">LRU</a><ul><li><a href="#h2-1">基本思路</a></li></ul><ul><li><a href="#h2-2">内核实现</a><ul><li><a href="#h3-3">加入 lru</a></li></ul><ul><li><a href="#h3-4">页面访问</a></li></ul></li></ul><ul><li><a href="#h2-5">一些细节</a></li></ul><ul><li><a href="#h2-6">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">LRU</h1><p>当内存变得紧张时, 内核必须找到一种方法来释放一些内存页.在某种程度上,内核可以通过清理自己的内部数据结构来释放内存,例如,通过减少 inode 和 dentry 缓存的大小. 但是在大多数系统中,<b>用户态内存页占用了所消耗的内存量的大头</b>,毕竟,系统存在的第一要旨就是为应用服务.因此,为了满足当前应用对用户态内存页的分配需求,内核必须找到并释放一些已分配的内存页.</p><p>同时系统必须维持文件页和匿名页之间数量上的适当平衡,否则系统将无法正常运行.无论是通过牺牲哪一种内存页为代价而让另一种内存页在数量上占优势,都会导致一种称之为 &quot;thrashing&quot; 的现象.</p><blockquote style="border-left-color: #0969da; background-color: #e8f3ff;"><p><div style="color: #0969da;"><img class="icon-note" loading="lazy" src="../../../img/note.svg" alt="[!NOTE]"> NOTE </div> 指当系统内存不足时,页框回收算法(Page Frame Reclaiming Algrithom,简称 PFRA),会全力把页框上的内容写入磁盘以便回收这些本属于进程的页框;而同时由于这些进程要继续执行,也会努力申请页框存放(譬如缓存)其内容.因此内核把 PFRA 刚释放的页框又分配给这些进程,并从磁盘读回其内容.其结果就是<b>数据被无休止地写入磁盘并且再从磁盘读回.大部分的时间耗费在访问磁盘上,而进程则无法实质性地运行下去</b>.</p></blockquote><p>那如何合理地挑选要回收的 page frames 呢?通常,应该选择那些最近不使用(不活跃)的页面,依据是最近不使用的页面在较短的时间内也不会被频繁使用,这就是 LRU(Least Recently Used) 算法的基本思想.</p><h2 id="h2-1">基本思路</h2><p>为了找到那些最近不活跃的 page ,我们需要有 timestamp 来标识一个 page 最近被访问的时间,然而像 x86 这样的架构并没有从硬件上提供这种机制.</p><p>在 x86 中,当一个 page 被访问后,硬件会将 page 对应的 PTE 中的 Access 位置 1,如果完全按照 LRU的思想来设计,那么此时软件需要为这个 page 关联一个定时器,然后将 PTE 中的 Access 位清 0.在定时器 timeout 之前,如果该 page 没有再被访问到,那么就将这个 page 回收.然而,page frames 数量庞大,维护那么多的内核定时器显然是不切实际的.</p><p>那如何实现才能保证相对公平又高效呢? Linux 采用的方法是维护 2 个双向链表,一个是包含了最近使用页面的 active list,另一个是包含了最近不使用页面的 inactive list(struct page 中的 lru 域含有指向所在链表中前后页面的指针),并且在 struct page 的 page flags 中使用了 <code>PG_referenced</code> 和 <code>PG_active</code> 两个标志位来标识页面的活跃程度.</p><pre class="language-c"><code><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier ID">pageflags</span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token EnumSpecifier BraceDepth-0 LCURLY_BRACE">{</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_locked</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE">      </span><span class="Token EnumSpecifier COMMENT">/* Page is locked. Don&#x27;t touch. */</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_writeback</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE">       </span><span class="Token EnumSpecifier COMMENT">/* Page is under writeback */</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier HighlightToken ID">PG_referenced</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_uptodate</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_dirty</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_lru</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_head</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE">        </span><span class="Token EnumSpecifier COMMENT">/* Must be in bit 6 */</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_waiters</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE">     </span><span class="Token EnumSpecifier COMMENT">/* Page has waiters, check its waitqueue. Must be bit #7 and in the same byte as &quot;PG_locked&quot; */</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier HighlightToken ID">PG_active</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_workingset</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_reserved</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_reclaim</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE">     </span><span class="Token EnumSpecifier COMMENT">/* To be reclaimed asap */</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_swapbacked</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE">      </span><span class="Token EnumSpecifier COMMENT">/* Page is backed by RAM/swap */</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier ID">PG_unevictable</span><span class="Token Identifier Enumerator Enumerator TypeSpecifier SPACE">      </span><span class="Token Identifier Enumerator Enumerator TypeSpecifier COMMENT">/* Page is &quot;unevictable&quot;  */</span><span class="Token Identifier Enumerator Enumerator TypeSpecifier LF">
</span><span class="Token Identifier Enumerator Enumerator TypeSpecifier SPACE">    </span><span class="Token EnumSpecifier VARARGS">...</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><ul><li><code>PG_referenced</code> 标志位表明 page 最近是否被使用过.</li></ul><ul><li><code>PG_active</code> 标志位决定 page 在哪个链表,也就是说 active list 中的 pages 的 PG_active 都为 1,而 inactive list 中的 pages 的 <code>PG_active</code> 都为 0.</li></ul><p>因此每个 page 都会有四个状态 [active/inactive + referenced/unreferenced]. 不管是 active list 还是 inactive list,都是采用 FIFO(First In First Out) 的形式,新的元素从链表头部加入,中间的元素逐渐向尾端移动.在需要进行内存回收时,内核总是选择 inactive list 尾端的页面进行回收.</p><p>对于一个新加入的页其初始状态为 inactive+unreferenced, 每次访问后该页面状态的变化如下图所示</p><ul><li>inactive,unreferenced  -&gt;    inactive,referenced | 第一次access</li></ul><ul><li>inactive,referenced    -&gt;    active,unreferenced | 第二次access</li></ul><ul><li>active,unreferenced    -&gt;    active,referenced   | 第三次access</li></ul><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241223232112.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241223232112.png" alt="20241223232112"></a></p><ul><li>如果 inactive list 上 PG_referenced 为 1 的 page 在回收之前被再次访问到,也就是说它在 inactive list 中时被访问了 2 次,那么就会通过 <code>activate_page()</code> 被调整到 active list 的头部,同时将其 PG_active 位置1,PG_referenced 位清 0,这个过程叫做 <b>promotion</b>(页面提升), 此时页面从 inactive list 被移动到 active list</li></ul><ul><li>当 active list 中的一个 page 在到达链表尾端时,如果其 PG_referenced 位为 1,则被放回链表头部,但同时其PG_referenced 会被清 0.如果其 PG_referenced 位为 0,那么就会被放入 inactive list 的头部,这个过程叫做 <b>demotion</b>(页面降级), 此时页面由 active list 被移动到 inactive list</li></ul><ul><li>如果 inactive list 中的 page 在达到链表尾端的时候 PG_referenced 为 0(在 inactive list 期间没有被访问到),那还有什么可说的,不回收你回收谁, 此时页面直接被 reclaim (回收)</li></ul><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241223234246.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241223234246.png" alt="20241223234246"></a></p><h2 id="h2-2">内核实现</h2><p>现代内核中 LRU 并不只有 active/inactive 两种, 而是有五种, 分别对应匿名/文件的活跃/不活跃, 以及不可回收的页面</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">LRU_BASE</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken NUMBER">0</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">LRU_ACTIVE</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken NUMBER">1</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">LRU_FILE</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken NUMBER">2</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier ID">lru_list</span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token EnumSpecifier BraceDepth-0 LCURLY_BRACE">{</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">LRU_INACTIVE_ANON</span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier SPACE"> </span><span class="Token Enumerator ASSIGN">=</span><span class="Token Enumerator SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression TypeSpecifier ID">LRU_BASE</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">LRU_ACTIVE_ANON</span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier SPACE"> </span><span class="Token Enumerator ASSIGN">=</span><span class="Token Enumerator SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression TypeSpecifier ID">LRU_BASE</span><span class="Token Identifier MacroDefine PrimaryExpression TypeSpecifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression TypeSpecifier ID">LRU_ACTIVE</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">LRU_INACTIVE_FILE</span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier SPACE"> </span><span class="Token Enumerator ASSIGN">=</span><span class="Token Enumerator SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression TypeSpecifier ID">LRU_BASE</span><span class="Token Identifier MacroDefine PrimaryExpression TypeSpecifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression TypeSpecifier ID">LRU_FILE</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">LRU_ACTIVE_FILE</span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier SPACE"> </span><span class="Token Enumerator ASSIGN">=</span><span class="Token Enumerator SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression TypeSpecifier ID">LRU_BASE</span><span class="Token Identifier MacroDefine PrimaryExpression TypeSpecifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression TypeSpecifier ID">LRU_FILE</span><span class="Token Identifier MacroDefine PrimaryExpression TypeSpecifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression TypeSpecifier ID">LRU_ACTIVE</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">LRU_UNEVICTABLE</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier LF">
</span><span class="Token EnumSpecifier SPACE">    </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">NR_LRU_LISTS</span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier LF">
</span><span class="Token EnumSpecifier BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p>每一个 numa node 对应的结构体 pglist_data 中都有一个 <code>struct lruvec</code> 保存该节点上的 LRU 链表信息</p><pre class="language-c"><code><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">pglist_data</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token StructDeclaration VARARGS">...</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">lruvec</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE">        </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">__lruvec</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">pg_data_t</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">lruvec</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure HighlightLine SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier HighlightLine STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier HighlightLine ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier HighlightLine SPACE">        </span><span class="Token Identifier DirectDeclaractor TypeSpecifier HighlightLine ID">lists</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 HighlightLine LSQUAR_PAREN">[</span><span class="Token Identifier MacroDefine PrimaryExpression TypeSpecifier HighlightLine ID">NR_LRU_LISTS</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 HighlightLine RSQUAR_PAREN">]</span><span class="Token StructDeclaration HighlightLine SEMI">;</span><span class="Token StructDeclaration HighlightLine LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">/* per lruvec lru_lock for memcg */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">spinlock_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">          </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">lru_lock</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">/*
     * These track the cost of reclaiming one LRU - file or anon -
     * over the other. As the observed cost of reclaiming one LRU
     * increases, the reclaim scan balance tips toward the other.
     */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE">           </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">anon_cost</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE">           </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">file_cost</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">/* Non-resident age, driven by LRU movement */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">atomic_long_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">           </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">nonresident_age</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">/* Refaults at the time of last reclaim cycle */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE">           </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">refaults</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier MacroDefine PrimaryExpression TypeSpecifier ID">ANON_AND_FILE</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">/* Various lruvec state flags (enum lruvec_flags) */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE">           </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">flags</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess IfGroup IFDEF">ifdef</span><span class="Token Keyword Preprocess IfGroup SPACE"> </span><span class="Token Identifier MacroDefine IfGroup MacroDefine ID">CONFIG_LRU_GEN</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token COMMENT">/* evictable pages divided into generations */</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">lru_gen_folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE">        </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">lrugen</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">/* to concurrently iterate lru_gen_mm_list */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">lru_gen_mm_state</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE">     </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">mm_state</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess EndifLine ENDIF">endif</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess IfGroup IFDEF">ifdef</span><span class="Token Keyword Preprocess IfGroup SPACE"> </span><span class="Token Identifier MacroDefine IfGroup MacroDefine ID">CONFIG_MEMCG</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">pglist_data</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">pgdat</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess EndifLine ENDIF">endif</span><span class="Token LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><h3 id="h3-3">加入 lru</h3><p>自然我们很关注的一个问题是 page 是什么时候加入到lru链表中的呢? lru链表是页面回收用的,所以只有分配了的页面才有可能存在于lru链中.那很有可能在分配页面的时候把它加进去.事实的确如此</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">vm_fault_t</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">do_anonymous_page</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">vm_fault</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">vmf</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token VARARGS">...</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_add_lru_vma</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">vma</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token VARARGS">...</span><span class="Token LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>还有很多地方也会使用 folio_add_lru 将新增页面加入 lru, 这里只是举一个例子</p><p>有关 folio 的介绍详见 <a href="../../mm/folio" target="_self">folio</a></p></blockquote><p>前文我们提到每个 node 保存一个 lruvec, 意味着该lru链是该节点全局的,加入lru链需要持有相关的锁,可想而知当分配或回收密集的时候<b>锁的争用非常严重</b>. 此外 inactive list 中尾端的页面不断被回收,相当于一个消费者,active list 则不断地将尾端 PG_referenced 为 0 的页面放入 inactive list,相当于一个生产者.不难想象,<b>这 2 个链表的锁(lru_lock)应该是高度竞争的</b>,如果从active list 向 inactive list 的页面转移是一个一个进行的,那对锁的争抢将会十分严重.</p><p>于是内核使用 per-cpu 的 lru cache (struct pagevec)去做优化. 对于要加入lru链的页,可以先加入该 CPU 的 lru cache,直到 lru cache 中已经积累了 PAGEVEC_SIZE(15)个页面,再获取lru_lock,将这些页面批量放入 inactive list 中,这样可以大大减少对lru链的引用.</p><p>我们来看一下对应的函数实现. 如下所示, 该函数会获取per cpu lru cache结构并且将该 folio 加入到 fbatch 当中</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">folio_add_lru</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fbatch</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">/* see the comment in lru_gen_add_folio() */</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">lru_gen_enabled</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_unevictable</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">lru_gen_in_fault</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">current</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">flags</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PF_MEMALLOC</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token SelectionStatement COMMENT">//设置页的active标志</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_set_active</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token ExpressionStatement SelectionStatement COMMENT">//增加页refcount计数</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_get</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">local_lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">cpu_fbatches</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">//获取per cpu lru cache结构</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">fbatch</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">this_cpu_ptr</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">cpu_fbatches</span><span class="Token PostfixExpression UnaryExpression HighlightLine DOT">.</span><span class="Token Identifier HighlightLine ID">lru_add</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token ExpressionStatement HighlightLine COMMENT">//将页面加入per cpu lru cache或者lru_active_anon链</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">folio_batch_add_and_move</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">fbatch</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">lru_add_fn</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">local_unlock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">cpu_fbatches</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>每个 CPU 都会分配一个对应的结构体, 其中 lru_add 对应的 folio_batch 的最大长度为 <code>PAGEVEC_SIZE</code>(15)</p><pre class="language-c"><code><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">cpu_fbatches</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">local_lock_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">lock</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration HighlightLine SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier HighlightLine STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier HighlightLine ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier HighlightLine ID">lru_add</span><span class="Token StructDeclaration HighlightLine SEMI">;</span><span class="Token StructDeclaration HighlightLine LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">lru_deactivate_file</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">lru_deactivate</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">lru_lazyfree</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess IfGroup IFDEF">ifdef</span><span class="Token Keyword Preprocess IfGroup SPACE"> </span><span class="Token Identifier MacroDefine IfGroup MacroDefine ID">CONFIG_SMP</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">activate</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess EndifLine ENDIF">endif</span><span class="Token LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">DEFINE_PER_CPU</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">cpu_fbatches</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">cpu_fbatches</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">lock</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">INIT_LOCAL_LOCK</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">lock</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token Initializer InitDeclarator COMMA">,</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">PAGEVEC_SIZE</span><span class="Token PPtoken SPACE">    </span><span class="Token PPtoken NUMBER">15</span><span class="Token LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">nr</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier BOOL">bool</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">percpu_pvec_drained</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration HighlightLine SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier HighlightLine STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier HighlightLine ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier HighlightLine SPACE"> </span><span class="Token Pointer Declarator HighlightLine POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier HighlightLine ID">folios</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 HighlightLine LSQUAR_PAREN">[</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression TypeSpecifier HighlightLine ID">PAGEVEC_SIZE</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 HighlightLine RSQUAR_PAREN">]</span><span class="Token StructDeclaration HighlightLine SEMI">;</span><span class="Token StructDeclaration HighlightLine LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p>可以看到页会先加入fbatch如果没问题就直接返回,否则就要把整个fbatch都加入lru链.</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">folio_batch_add_and_move</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fbatch</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">move_fn_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">move_fn</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// fbatch 还有剩余空间, 直接加入</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_batch_add</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_large</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">        </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">lru_cache_disabled</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">// 满了则将整个 fbetch 加入到 node lru</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_batch_move_lru</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">move_fn</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>folio_batch_add 非常简单, 就是直接加入数组下一个元素, 直到满(PAGEVEC_SIZE)了返回 0</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword FunctionType FunctionReturnType INLINE">inline</span><span class="Token Keyword FunctionType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">folio_batch_add</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fbatch</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">folios</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_batch_space</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword FunctionType FunctionReturnType INLINE">inline</span><span class="Token Keyword FunctionType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">folio_batch_space</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fbatch</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PAGEVEC_SIZE</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression MINUS">-</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>如果该 CPU 对应的 fbatch 满了, 此时调用 folio_batch_move_lru 获取 node 的 lruvec 并将 fbatch 中的所有元素逐个加入</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">folio_batch_move_lru</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fbatch</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">move_fn_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">move_fn</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">lruvec</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">lruvec</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">flags</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_batch_count</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">folios</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Declaration COMMENT">/* block memcg migration while the folio moves between lru */</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">move_fn</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp NE">!=</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier PrimaryExpression ID">lru_add_fn</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_clear_lru</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement CONTINUE">continue</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">lruvec</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">folio_lruvec_relock_irqsave</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">lruvec</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">flags</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">move_fn</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">lruvec</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">folio_set_lru</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">lruvec</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">unlock_page_lruvec_irqrestore</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">lruvec</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">flags</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folios_put</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">folios</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_batch_count</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_batch_reinit</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>folio_lruvec_relock_irqsave 层层往下调用最终获取到的 lruvec 实际上就是 node lruvec</p><blockquote><p>这里面还有 mem cgroup 的参与, 代码阅读起来有点绕, 简单来说就是如果 disable memcgroup 那么返回的就是 pgdat 中的 __lruvec 链表</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword FunctionType FunctionReturnType INLINE">inline</span><span class="Token Keyword FunctionType FunctionReturnType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier FunctionReturnType STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier FunctionReturnType ID">lruvec</span><span class="Token Identifier Structure StructureClass TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">mem_cgroup_lruvec</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">mem_cgroup</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">memcg</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">                         </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">pglist_data</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">pgdat</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">  </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">mem_cgroup_per_node</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">mz</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">  </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">lruvec</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">lruvec</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">  </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">mem_cgroup_disabled</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">      </span><span class="Token Identifier PrimaryExpression HighlightLine ID">lruvec</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">pgdat</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">__lruvec</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">      </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">out</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">  </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">  </span><span class="Token Identifier PrimaryExpression ID">mz</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">memcg</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nodeinfo</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">pgdat</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">node_id</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">  </span><span class="Token Identifier PrimaryExpression ID">lruvec</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">mz</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">lruvec</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">  </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">lruvec</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre></blockquote><p>move_fn 则负责将一个 folio 加入到 lru 中, 通过往前回溯可以发现该函数指针在 folio_add_lru 中调用时的传参为 lru_add_fn. 该函数前面是对于 evictable/active 标志位的检查和清空, 关键在于最后的 lruvec_add_folio</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">lru_add_fn</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">lruvec</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">lruvec</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">was_unevictable</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_clear_unevictable</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nr_pages</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_nr_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_evictable</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">was_unevictable</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">__count_vm_events</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">UNEVICTABLE_PGRESCUED</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nr_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_clear_active</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_set_unevictable</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">mlock_count</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">was_unevictable</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">__count_vm_events</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">UNEVICTABLE_PGCULLED</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nr_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">lruvec_add_folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">lruvec</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">trace_mm_lru_insertion</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>lruvec_add_folio 首先判断一下该 folio 属于哪种 list, 然后调用 list_add 最终将其加入到 lruvec 对应的 lists[lru] 中</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">__always_inline</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">lruvec_add_folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">lruvec</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">lruvec</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// 判断该 folio 属于哪个 list, file/anon</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier ID">lru_list</span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">lru</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_lru_list</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">lru_gen_add_folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">lruvec</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression FALSE">false</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">update_lru_size</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">lruvec</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">lru</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_zonenum</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_nr_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">lru</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression NE">!=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">LRU_UNEVICTABLE</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">list_add</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">lru</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">lruvec</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">lists</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression HighlightLine ID">lru</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement SelectionStatement HighlightLine LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote style="border-left-color: #1a7f37; background-color: #e5f6ea;"><p><div style="color: #1a7f37;"><img class="icon-tip" loading="lazy" src="../../../img/tip.svg" alt="[!TIP]"> TIP </div> folio-&gt;lru 和 lruvec-&gt;lists[lru] 都是 list_head 类型, 它们本身并不保存任何相关页面信息, 只是作为指针地址将二者关联起来</p><p>即可以通过 folio-&gt;lru 找到 lruvec-&gt;list[lru] 也可以通过遍历 lruvec-&gt;list[lru] 找到 folio</p><p>只是通过指针建立了双向链表的地址引用, 如果希望删掉 folio 直接 list_del 即可</p></blockquote><p>folio_lru_list 的注释也写的很清晰, 先判断 file/anon, 然后再判断是否 active</p><pre class="language-c"><code><span class="Token COMMENT">/**
 * folio_lru_list - Which LRU list should a folio be on?
 * @folio: The folio to test.
 *
 * Return: The LRU list a folio should be on, as an index
 * into the array of LRU lists.
 */</span><span class="Token LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">__always_inline</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Keyword EnumSpecifier TypeSpecifier FunctionReturnType ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier FunctionReturnType ID">lru_list</span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">folio_lru_list</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumID EnumSpecifier EnumID TypeSpecifier ID">lru_list</span><span class="Token Identifier EnumID EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">lru</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression ID">VM_BUG_ON_FOLIO</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">folio_test_active</span><span class="Token PPtoken BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">folio</span><span class="Token PPtoken BraceDepth-2 RPAREN">)</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken AND">&amp;&amp;</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">folio_test_unevictable</span><span class="Token PPtoken BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">folio</span><span class="Token PPtoken BraceDepth-2 RPAREN">)</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">folio</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_unevictable</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">LRU_UNEVICTABLE</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">lru</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_is_file_lru</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token ConditionalExpression AssignmentExpression QUESTION">?</span><span class="Token ConditionalExpression AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">LRU_INACTIVE_FILE</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression AssignmentExpression COLON">:</span><span class="Token ConditionalExpression AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">LRU_INACTIVE_ANON</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_active</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">lru</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">LRU_ACTIVE</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">lru</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote style="border-left-color: #0969da; background-color: #e8f3ff;"><p><div style="color: #0969da;"><img class="icon-note" loading="lazy" src="../../../img/note.svg" alt="[!NOTE]"> NOTE </div> lru += LRU_ACTIVE 这个操作和前文 enum lru_list 的定义相关, 算是一种枚举值的巧用, 不然判断估计要写好几个 if else</p></blockquote><p>如果没有显示的设置active那就会将page放到inactive链表中, 这也是默认情况. 一般新创建的内存页都会先加入 inactive list 中.</p><hr><p>至此我们梳理一下整个过程, 关键函数调用如下</p><pre class="language-txt"><code><span class="Token ID">do_anonymous_page</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token ID">分配匿名页面</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">folio_add_lru</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token ID">加入到</span><span class="Token SPACE"> </span><span class="Token ID">lru</span><span class="Token SPACE"> </span><span class="Token ID">list</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">folio_batch_add_and_move</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token ID">批量加入到</span><span class="Token SPACE"> </span><span class="Token ID">cpu</span><span class="Token SPACE"> </span><span class="Token ID">fbatch</span><span class="Token SPACE"> </span><span class="Token ID">中</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token ID">folio_batch_add</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token ID">优先加入到</span><span class="Token SPACE"> </span><span class="Token ID">per</span><span class="Token MINUS">-</span><span class="Token ID">cpu</span><span class="Token SPACE"> </span><span class="Token ID">lru</span><span class="Token SPACE"> </span><span class="Token ID">cache</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token ID">folio_batch_move_lru</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token ID">满了则将</span><span class="Token SPACE"> </span><span class="Token ID">fbatch</span><span class="Token SPACE"> </span><span class="Token ID">加入</span><span class="Token SPACE"> </span><span class="Token ID">node</span><span class="Token SPACE"> </span><span class="Token ID">lruvec</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">设置</span><span class="Token SPACE"> </span><span class="Token ID">PG_lru</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token ID">folio_lruvec_relock_irqsave</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token ID">获取</span><span class="Token SPACE"> </span><span class="Token ID">node</span><span class="Token SPACE"> </span><span class="Token ID">lruvec</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token ID">lru_add_fn</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">lruvec</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">folio</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SEMI">;</span><span class="Token LF">
</span><span class="Token SPACE">                    </span><span class="Token ID">lruvec_add_folio</span><span class="Token LF">
</span><span class="Token SPACE">                        </span><span class="Token ID">folio_lru_list</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token ID">判断folio类型</span><span class="Token LF">
</span><span class="Token SPACE">                        </span><span class="Token ID">list_add</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token MINUS">-</span><span class="Token ID">加入lruvec</span></code></pre><blockquote style="border-left-color: #8250df; background-color: #eee4ff;"><p><div style="color: #8250df;"><img class="icon-important" loading="lazy" src="../../../img/important.svg" alt="[!IMPORTANT]"> IMPORTANT </div> 需要注意的是, 为 folio 添加 PG_lru 标志位发生在 folio_batch_move_lru 中, 表示确认将其加入到 lru list 中了.</p><p>folio_batch_add 并不会对 folio 设置此标记位, 因此尚在 per-cpu lru cache 的 folio 并不算在 lru list 中</p></blockquote><h3 id="h3-4">页面访问</h3><p>在分配匿名页的时候会将分配的页放在该folio所在node的lruvec的对应链表里,从代码中看到第一次加入lru链表是在inactive链表中</p><p>如果页面一直呆在inactive链表中是很&quot;危险&quot;的, 因为随着后续页面的不断加入, 该页面会不断地从 list 的头部被推向尾部, 到达 inactive list 尾部时就会被回收.如果不想被回收那该怎么做呢?这就是页面在lru链表上如何移动的问题.与此相关的页的flag有PG_referenced和PG_active.</p><p>假设初始状态两个标志都是0,他们的状态变化如下</p><ul><li>inactive,unreferenced  -&gt;    inactive,referenced | 第一次access</li></ul><ul><li>inactive,referenced    -&gt;    active,unreferenced | 第二次access</li></ul><ul><li>active,unreferenced    -&gt;    active,referenced   | 第三次access</li></ul><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241223232112.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241223232112.png" alt="20241223232112"></a></p><p>对于 mmap 的页面,需要在回收扫描时,通过 rmap 检查 PTE 的 Access 位来判断,而对于通过页面在文件的 offset 来作为索引的(比如 read/write),则可以在 page 被访问后标记该信息. 例如 filemap_read 函数中, 实现此方向状态转移的函数是 folio_mark_accessed</p><pre class="language-c"><code><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">ssize_t</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">filemap_read</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">kiocb</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">iocb</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">iov_iter</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">iter</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">ssize_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">already_read</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_mark_accessed</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>folio_mark_accessed 用于标记一个 folio 最近被访问过了, 这里的几个 if else if 很巧妙;</p><ul><li>如果 unreferenced, 设置 referenced = 1</li></ul><ul><li>否则此时一定 referenced = 1, 如果 inactive<ul><li>如果已经在 lru list 中, 标记为 active</li></ul><ul><li>不在 lru 中, 还在 lru cache 中, 找到并标记 active</li></ul></li></ul><ul><li>referenced &amp;&amp; active 的不需要处理</li></ul><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">folio_mark_accessed</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">lru_gen_enabled</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_inc_refs</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 如果 referenced = 0, 设置 referenced = 1</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_referenced</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_set_referenced</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_unevictable</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 不可回收页面不需要处理</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_active</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 此时 referenced 一定为 1, 清除 referenced 并设置 active</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">        </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">folio_test_lru</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 HighlightLine RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">folio_activate</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement SelectionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SelectionStatement HighlightLine SPACE">        </span><span class="Token Keyword SelectionStatement HighlightLine ELSE">else</span><span class="Token Keyword SelectionStatement HighlightLine LF">
</span><span class="Token Keyword SelectionStatement HighlightLine SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">__lru_cache_activate_folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement SelectionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_clear_referenced</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">workingset_activation</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// referened 且 active 的不需要处理</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_idle</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_clear_idle</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>如果 folio 已经在 lru 中, 则调用 folio_activate. 该函数与前文提到的 folio_add_lru 基本类似, 也是使用 folio_batch_add_and_move. 不同点在于函数指针为 folio_activate_fn</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">folio_activate</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_lru</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_active</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">        </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_unevictable</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fbatch</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_get</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">local_lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">cpu_fbatches</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">this_cpu_ptr</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">cpu_fbatches</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">activate</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_batch_add_and_move</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">folio_activate_fn</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">local_unlock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">cpu_fbatches</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>和前文处理逻辑类似, 在 folio_batch_add_and_move 中如果 fbatch 已满, 则将其批量移入 node lru, 并调用 move_fn. 此时需要执行的操作即</p><ol start="1"><li>从 lru 中删除当前 folio</li></ol><ol start="2"><li>将 folio 设置为 active</li></ol><ol start="3"><li>把 folio 重新添加回 lru 中, 使其位于 active list 头部</li></ol><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">folio_activate_fn</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">lruvec</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">lruvec</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_active</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_unevictable</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nr_pages</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_nr_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">lruvec_del_folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">lruvec</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">folio_set_active</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">lruvec_add_folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">lruvec</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">trace_mm_lru_activate</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">__count_vm_events</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGACTIVATE</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nr_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">__count_memcg_events</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">lruvec_memcg</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">lruvec</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">PGACTIVATE</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                     </span><span class="Token Identifier PrimaryExpression ID">nr_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>而对于另一种情况, 即 folio 不在 lru 中, 那么就去 cpu lru cache 中查找到对应的 folio 并将其设置为 active</p><blockquote><p>这里的一个小细节是遍历时从最后一个开始查找, 与向 folio_batch 添加 folio 时刚好相反</p></blockquote><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">__lru_cache_activate_folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio_batch</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fbatch</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">local_lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">cpu_fbatches</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">this_cpu_ptr</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">cpu_fbatches</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">lru_add</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_batch_count</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression MINUS">-</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression GE">&gt;=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression DEC">--</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">batch_folio</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">fbatch</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">folios</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">batch_folio</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_set_active</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">local_unlock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">cpu_fbatches</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">lock</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h2 id="h2-5">一些细节</h2><p>TODO list 长度?</p><p>内核提供了一个名为 swappiness 的控制项(<code>/proc/sys/vm/swappiness</code>, 默认60),可以调节这种平衡.如果系统管理员设置的 swappiness 值较高,则意味着内核允许在内存中保留较多的 cache page.将 swappiness 调低则是告诉内核回收更多的 cache page,保留较多的 anonymous page.</p><h2 id="h2-6">参考</h2><ul><li><a href="https://www.cnblogs.com/tolimit/p/5447448.html" target="_blank">linux内存源码分析 - 内存回收(lru链表)</a></li></ul><ul><li><a href="https://blog.csdn.net/qq_37517281/article/details/134533485" target="_blank">linux 内存回收lru算法代码注释1</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/70964195" target="_blank">Linux中的内存回收 [一]</a></li></ul><ul><li><a href="https://www.cnblogs.com/banshanjushi/p/18003021" target="_blank">linux内存管理(九)- 页面回收</a></li></ul><ul><li><a href="https://blog.csdn.net/u012489236/category_9614673.html" target="_blank">内存管理</a></li></ul></div>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var markdownBody = document.querySelector('.markdown-body');
                    var giscusDiv = markdownBody.querySelector('.giscus');
                    var referenceHtml = `<div class="references-tabs-container">
<div class="references-tabs-nav">
<button class="references-tab-btn active" data-tab="references-out">本文引用</button>
<button class="references-tab-btn " data-tab="references-in">本文被引用</button>
</div>
<div class="references-tabs-content">
<div class="references-tab-pane active" id="references-out">
<ul class="reference-list">
<li><a href="../../mm/folio">📄 folio</a></li>
</ul>
</div>
<div class="references-tab-pane " id="references-in">
<ul class="reference-list">
<li><a href="../../mm/numa">📄 numa</a></li>
</ul>
</div>
</div>
</div>`;
                    
                    if (giscusDiv) {
                        giscusDiv.insertAdjacentHTML('beforebegin', referenceHtml);
                    } else {
                        markdownBody.insertAdjacentHTML('beforeend', referenceHtml);
                    }
                    
                    // 添加选项卡切换功能
                    setTimeout(function() {
                        var tabButtons = document.querySelectorAll('.references-tab-btn');
                        var tabPanes = document.querySelectorAll('.references-tab-pane');
                        
                        tabButtons.forEach(function(button) {
                            button.addEventListener('click', function() {
                                var targetTab = this.getAttribute('data-tab');
                                
                                // 移除所有active类
                                tabButtons.forEach(btn => btn.classList.remove('active'));
                                tabPanes.forEach(pane => pane.classList.remove('active'));
                                
                                // 添加active类到当前选中的选项卡
                                this.classList.add('active');
                                var targetPane = document.getElementById(targetTab);
                                if (targetPane) {
                                    targetPane.classList.add('active');
                                }
                            });
                        });
                    }, 100);
                });
                </script>
                
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../tutorial/编译内核" >tutorial</a><ul><li><a href="../../tutorial/编译内核" >编译内核</a></li></ul><ul><li><a href="../../tutorial/调试内核" >调试内核</a></li></ul><ul><li><a href="../../tutorial/开发环境搭建" >开发环境搭建</a></li></ul><ul><li><a href="../../tutorial/调试技巧" >调试技巧</a></li></ul><ul><li><a href="../../tutorial/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../tutorial/邮件订阅" >邮件订阅</a></li></ul><ul><li><a href="../../tutorial/git" >git</a></li></ul></li></ul><ul><li><a href="../../mm/物理内存探测" >mm</a><ul><li><a href="../../mm/物理内存探测" >物理内存探测</a></li></ul><ul><li><a href="../../mm/虚拟地址转换" >虚拟地址转换</a></li></ul><ul><li><a href="../../mm/进程内存布局" >进程内存布局</a></li></ul><ul><li><a href="../../mm/页表" >页表</a></li></ul><ul><li><a href="../../mm/numa" >numa</a></li></ul><ul><li><a href="../../mm/vma" >vma</a></li></ul><ul><li><a href="../../mm/zone" >zone</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab" >slab</a></li></ul><ul><li><a href="../../mm/compaction" >compaction</a></li></ul><ul><li><a href="../../mm/tier-mm" >tier-mm</a></li></ul><ul><li><a href="../../mm/migration" >migration</a></li></ul><ul><li><a href="../../mm/mm_struct" >mm_struct</a></li></ul><ul><li><a href="../../mm/mmio" >mmio</a></li></ul><ul><li><a href="../../mm/LRU" >LRU</a></li></ul><ul><li><a href="../../mm/MGLRU" >MGLRU</a></li></ul><ul><li><a href="../../mm/page" >page</a></li></ul><ul><li><a href="../../mm/folio" >folio</a></li></ul><ul><li><a href="../../mm/autonuma" >autonuma</a></li></ul><ul><li><a href="../../mm/kswapd" >kswapd</a></li></ul><ul><li><a href="../../mm/rmap" >rmap</a></li></ul><ul><li><a href="../../mm/ksm" >ksm</a></li></ul></li></ul><ul><li><a href="../../runtime/ELF文件格式" >runtime</a><ul><li><a href="../../runtime/ELF文件格式" >ELF文件格式</a></li></ul><ul><li><a href="../../runtime/符号表" >符号表</a></li></ul><ul><li><a href="../../runtime/静态链接" >静态链接</a></li></ul><ul><li><a href="../../runtime/装载" >装载</a></li></ul><ul><li><a href="../../runtime/动态链接" >动态链接</a></li></ul><ul><li><a href="../../runtime/库与运行库" >库与运行库</a></li></ul><ul><li><a href="../../runtime/execve" >execve</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul><ul><li><a href="../../kernel/schedule" >schedule</a></li></ul><ul><li><a href="../../kernel/atomic" >atomic</a></li></ul><ul><li><a href="../../kernel/nice" >nice</a></li></ul><ul><li><a href="../../kernel/rcu" >rcu</a></li></ul><ul><li><a href="../../kernel/manage" >manage</a></li></ul><ul><li><a href="../../kernel/workqueue" >workqueue</a></li></ul><ul><li><a href="../../kernel/signal" >signal</a></li></ul><ul><li><a href="../../kernel/lock" >lock</a></li></ul><ul><li><a href="../../kernel/cgroup" >cgroup</a></li></ul><ul><li><a href="../../kernel/syscall" >syscall</a></li></ul><ul><li><a href="../../kernel/task_struct" >task_struct</a></li></ul><ul><li><a href="../../kernel/sync_io" >sync_io</a></li></ul><ul><li><a href="../../kernel/rb-tree" >rb-tree</a></li></ul><ul><li><a href="../../kernel/async_io" >async_io</a></li></ul><ul><li><a href="../../kernel/fork" >fork</a></li></ul><ul><li><a href="../../kernel/module" >module</a></li></ul><ul><li><a href="../../kernel/lock_stat" >lock_stat</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cache-coherence" >cache-coherence</a></li></ul><ul><li><a href="../../arch/memory-coherence" >memory-coherence</a></li></ul><ul><li><a href="../../arch/io" >io</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/interrupt" >interrupt</a></li></ul><ul><li><a href="../../arch/dram" >dram</a></li></ul><ul><li><a href="../../arch/nvm" >nvm</a></li></ul></li></ul><ul><li><a href="../../net/net-arch" >net</a><ul><li><a href="../../net/net-arch" >net-arch</a></li></ul><ul><li><a href="../../net/ip" >ip</a></li></ul><ul><li><a href="../../net/route" >route</a></li></ul><ul><li><a href="../../net/udp" >udp</a></li></ul><ul><li><a href="../../net/tcp" >tcp</a></li></ul><ul><li><a href="../../net/tools" >tools</a></li></ul><ul><li><a href="../../net/quic" >quic</a></li></ul><ul><li><a href="../../net/rdma" >rdma</a></li></ul><ul><li><a href="../../net/socket" >socket</a></li></ul><ul><li><a href="../../net/epoll" >epoll</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul><ul><li><a href="../../fs/filesystem" >filesystem</a></li></ul><ul><li><a href="../../fs/fd" >fd</a></li></ul><ul><li><a href="../../fs/inode" >inode</a></li></ul><ul><li><a href="../../fs/directory" >directory</a></li></ul><ul><li><a href="../../fs/disk-layout" >disk-layout</a></li></ul><ul><li><a href="../../fs/mount" >mount</a></li></ul><ul><li><a href="../../fs/vfs" >vfs</a></li></ul><ul><li><a href="../../fs/ext4" >ext4</a></li></ul><ul><li><a href="../../fs/fuse" >fuse</a></li></ul><ul><li><a href="../../fs/distribute-fs" >distribute-fs</a></li></ul></li></ul><ul><li><a href="../../device/disk" >device</a><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul><ul><li><a href="../../device/driver" >driver</a></li></ul><ul><li><a href="../../device/pcie" >pcie</a></li></ul></li></ul><ul><li><a href="../../cve/dirtycow" >cve</a><ul><li><a href="../../cve/dirtycow" >dirtycow</a></li></ul><ul><li><a href="../../cve/dirtypipe" >dirtypipe</a></li></ul><ul><li><a href="../../cve/sudo" >sudo</a></li></ul><ul><li><a href="../../cve/meltdown" >meltdown</a></li></ul><ul><li><a href="../../cve/smashex" >smashex</a></li></ul></li></ul><ul><li><a href="../../tools/perf" >tools</a><ul><li><a href="../../tools/perf" >perf</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../mm/mmio","../../mm/MGLRU","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/clipboard.svg","../../../img/clipboard-check.svg");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script>
            <script src="https://giscus.app/client.js" data-repo="luzhixing12345/klinux" 
            data-repo-id="R_kgDOJIKiEw" data-category="Q&A" data-category-id="DIC_kwDOJIKiE84CgFwK" data-mapping="pathname" data-strict="0"
            data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom"
            data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
            </script>
            <script type="text/javascript" src="../../../js/dir_tree_toggle.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>