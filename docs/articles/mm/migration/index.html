<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css /><link rel='stylesheet' href=../../../css/x86asm.css /><link rel='stylesheet' href=../../../css/yaml.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">migration</a><ul><li><a href="#h2-1">函数执行流程</a><ul><li><a href="#h3-2">同步迁移</a></li></ul><ul><li><a href="#h3-3">异步迁移</a></li></ul></li></ul><ul><li><a href="#h2-4">页面降级(demotion)</a></li></ul><ul><li><a href="#h2-5">tracing</a></li></ul><ul><li><a href="#h2-6">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">migration</h1><p>页面迁移允许在进程运行时在 NUMA 系统中的节点之间移动页面的物理位置.这意味着进程看到的虚拟地址不会改变.但是,系统会重新排列这些页面的物理位置.页面迁移的主要目的是通过将页面移动到访问内存的进程正在运行的处理器附近来减少内存访问的延迟.后来内存规整和内存热插拔等场景都使用了此功能.</p><p>内存迁移相关的有两个系统调用函数 migrate_pages 和 move_pages, migrate_pages 表示将一个进程的所有内存迁移到另一组节点. 而 move_pages 更细粒度一些, 表示将一个进程的一些页面迁移到其他节点</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">numaif.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType LONG">long</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">migrate_pages</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pid</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">maxnode</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">                   </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">old_nodes</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">                   </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">new_nodes</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType LONG">long</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">move_pages</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pid</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">count</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">pages</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">                       </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">nodes</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">status</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">flags</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration COMMENT">// Link with -lnuma.</span></code></pre><p>两个系统调用在功能上有相似之处, 事实上他们在内核中都会调用内核函数 migrate_pages 完成页面的迁移, 下面我们来详细介绍一下这个函数. migrate_pages 经过一次参数的变化, 添加了 ret_succeeded 表示成功迁移的页面个数, 也就是说并不是所有页面都一定迁移成功, 有可能因为一些原因迁移失败</p><pre class="language-c"><code><span class="Token COMMENT">// v5.x</span><span class="Token LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">migrate_pages</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">from</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">new_page_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">get_new_page</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">free_page_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">put_new_page</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">private</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier ID">migrate_mode</span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">mode</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">reason</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration COMMENT">// v5.18</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier FunctionName DirectDeclaractor FunctionName ID">migrate_pages</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">from</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">new_folio_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">get_new_folio</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">free_folio_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">put_new_folio</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">private</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumID EnumSpecifier EnumID TypeSpecifier ID">migrate_mode</span><span class="Token Identifier EnumID EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">mode</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">reason</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">ret_succeeded</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><ul><li>from: 迁移页面的链表.</li></ul><ul><li>get_new_page:申请新内存的页面的函数指针</li></ul><ul><li>put_new_page: 迁移失败时释放目标页面的函数指针</li></ul><ul><li>private: 传递给get_new_page的参数.</li></ul><ul><li>mode: 迁移模式</li></ul><ul><li>reason: 迁移因素</li></ul><p>其中 mode 和 reason 有很多种</p><table><tr><th><b>迁移类型</b></th><th><b>描述</b></th></tr><tr><td style="text-align:left">                <b>MIGRATE_ASYNC</b></td><td style="text-align:left">                异步迁移,过程中不会发生阻塞.</td></tr><tr><td style="text-align:left">                MIGRATE_SYNC_LIGHT</td><td style="text-align:left">                轻度同步迁移,允许大部分的阻塞操作,但不允许脏页的回写操作.</td></tr><tr><td style="text-align:left">                <b>MIGRATE_SYNC</b></td><td style="text-align:left">                同步迁移,迁移过程会发生阻塞.如果某个页正在 writeback 或被锁定,会等待完成后再迁移.</td></tr><tr><td style="text-align:left">                MIGRATE_SYNC_NO_COPY</td><td style="text-align:left">                同步迁移,但不等待页面的拷贝过程.页面拷贝通过回调 <code>migratepage()</code>,过程可能涉及 DMA.</td></tr></table><table><tr><th><b>迁移原因</b></th><th><b>描述</b></th></tr><tr><td style="text-align:left">                MR_COMPACTION</td><td style="text-align:left">                内存规整导致的迁移.</td></tr><tr><td style="text-align:left">                MR_MEMORY_FAILURE</td><td style="text-align:left">                内存出现硬件问题(如 ECC 校验失败)时触发的页面迁移(<code>memory–failure.c</code>).</td></tr><tr><td style="text-align:left">                MR_MEMORY_HOTPLUG</td><td style="text-align:left">                内存热插拔导致的迁移.</td></tr><tr><td style="text-align:left">                MR_SYSCALL</td><td style="text-align:left">                应用层主动调用 <code>migrate_pages()</code> 或 <code>move_pages()</code> 触发的迁移.</td></tr><tr><td style="text-align:left">                MR_MEMPOLICY_MBIND</td><td style="text-align:left">                调用 <code>mbind</code> 系统调用设置 memory policy 时触发的迁移.</td></tr><tr><td style="text-align:left">                <b>MR_NUMA_MISPLACED</b></td><td style="text-align:left">                NUMA balance 触发的页面迁移.</td></tr><tr><td style="text-align:left">                MR_CONTIG_RANGE</td><td style="text-align:left">                调用 <code>alloc_contig_range()</code> 为 CMA 或 HugeTLB 分配连续内存时触发的迁移(与内存规整相关).</td></tr></table><blockquote><p>系统中绝大部分导致迁移的情况是因为 numa balance 产生的 MR_NUMA_MISPLACED 页面迁移, 在后文会详细讨论</p></blockquote><h2 id="h2-1">函数执行流程</h2><p>在正式介绍 migrate_pages 的函数执行流程之前我们先来做一个小实验测试一下 migrate_pages 内部各个函数的执行时间占比, 对应的代码如下</p><blockquote><p>这段代码内容比较简单, 创建 NUM_PAGES 个页面, 使用系统调用将它们迁移到其他 node 节点上, 循环 count 次</p></blockquote><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">_GNU_SOURCE</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">errno.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">numa.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">numaif.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">stdio.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">stdlib.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">sys/syscall.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">unistd.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">NUM_PAGES</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">5000</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">PAGE_SIZE</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">4096</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">pages</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier MacroDefine PrimaryExpression ID">NUM_PAGES</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">status</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">NUM_PAGES</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nodes</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">NUM_PAGES</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pid</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">getpid</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE">  </span><span class="Token Declaration COMMENT">// Current process ID</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">// Allocate memory for pages</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">node_number</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">numa_max_node</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;node_number: </span><span class="Token Format String STRING">%d</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">node_number</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">count</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1000</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">count</span><span class="Token PostfixExpression UnaryExpression DEC">--</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement COMMENT">// printf(&quot;count: %d\n&quot;, count);</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-2 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration IterationStatement SEMI">;</span><span class="Token Declaration IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">NUM_PAGES</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-2 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">malloc</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">PAGE_SIZE</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-0 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token SelectionStatement BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">                </span><span class="Token Identifier PrimaryExpression FunctionCall ID">perror</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;malloc&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">                </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">EXIT_FAILURE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement COMMENT">// Initialize memory</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token UnaryOp UnaryExpression POINTER">*</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token CastExpression ConditionalExpression BraceDepth-0 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">nodes</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression MOD">%</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">node_number</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE">  </span><span class="Token ExpressionStatement COMMENT">// Move pages to NUMA node</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement COMMENT">// Use move_pages system call to move pages</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">syscall</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">SYS_move_pages</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">pid</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">NUM_PAGES</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">pages</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nodes</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">status</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">perror</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;move_pages&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">EXIT_FAILURE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// Check the status of each page</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-2 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration IterationStatement SEMI">;</span><span class="Token Declaration IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">NUM_PAGES</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-2 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">            </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">status</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token SelectionStatement BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">                </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;Page </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">: Failed to move (errno: </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">)</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">errno</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">                </span><span class="Token CompoundStatement SelectionStatement COMMENT">// printf(&quot;Page %d: Successfully moved to node %d\n&quot;, i, status[i]);</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement COMMENT">// Free allocated memory</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-2 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration IterationStatement SEMI">;</span><span class="Token Declaration IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">NUM_PAGES</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-2 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">free</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">EXIT_SUCCESS</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>性能分析的结果如下所示, 其中可以看到占用时间最长的六个函数(不代表执行顺序, 仅为占比大小顺序排列)</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20241113100106.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20241113100106.png" alt="20241113100106"></a></p><p>migrate_pages 分为如下几个步骤, 分别对应</p><ol start="1"><li>分配 new_pages: <code>alloc_migration_target</code></li></ol><ol start="2"><li>获取 old page 的页面锁 PG_locked: <code>folio_trylock(src)</code></li></ol><ol start="3"><li>若是正在writeback的页面,则根据迁移模式判断是否等待页面wirteback(MIGRATE_SYNC_LIGHT和MIGRATE_ASYNC不等待) <code>folio_test_writeback(src)</code></li></ol><ol start="4"><li>获取 new page 的页面锁 PG_locked: <code>folio_trylock(dst)</code></li></ol><ol start="5"><li>取消页面映射: <code>try_to_migrate</code></li></ol><p>move_pages 最终会调用到 do_move_pages_to_node, 进一步调用 migrate_pages, 参数使用了 MIGRATE_SYNC 和 MR_SYSCALL 表示通过系统调用进行同步迁移.</p><p>migrate_pages 的形参 get_new_page 对应 alloc_migration_target 函数, 其作用是在目标节点上分配新页面</p><pre class="language-c"><code><span class="Token Keyword StructureType Structure TypeSpecifier FunctionReturnType STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier FunctionReturnType ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">alloc_migration_target</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">src</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">private</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">migration_target_control</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">mtc</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression ID">mtc</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">migration_target_control</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">private</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">gfp_mask</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">mtc</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">gfp_mask</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">__folio_alloc</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">gfp_mask</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">order</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nid</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">mtc</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nmask</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">do_move_pages_to_node</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">mm_struct</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">mm</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">pagelist</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">node</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">err</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">migration_target_control</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">mtc</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-1 LCURLY_BRACE">{</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">        </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">nid</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">node</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">gfp_mask</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">GFP_HIGHUSER_MOVABLE</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression PIPE">|</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">__GFP_THISNODE</span><span class="Token Initializer InitDeclarator COMMA">,</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">    </span><span class="Token Initializer InitDeclarator BraceDepth-1 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">err</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">migrate_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">pagelist</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression HighlightLine ID">alloc_migration_target</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">NULL</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine LF">
</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE">        </span><span class="Token CastExpression ConditionalExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier HighlightLine UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier HighlightLine SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier HighlightLine LONG">long</span><span class="Token CastExpression ConditionalExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">mtc</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">MIGRATE_SYNC</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">MR_SYSCALL</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression HighlightLine ID">NULL</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">err</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">putback_movable_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pagelist</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">err</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><hr><p>migrate_pages 中首先计算一共需要迁移的页面数量(nr_pages), 如果小于 <code>NR_MAX_BATCHED_MIGRATION</code>(512) 在将其从 from 转移到 folios 中; 根据 mode 的类型, 如果是异步(ASYNC)则使用 migrate_pages_batch, 否则使用 migrate_pages_sync 进行同步迁移. 如果迁移后 from 仍不为空则重新尝试迁移</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">migrate_pages</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">from</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">new_folio_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">get_new_folio</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">free_folio_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">put_new_folio</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">private</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier ID">migrate_mode</span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">mode</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">reason</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">ret_succeeded</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">folio</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">folio2</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression ID">LIST_HEAD</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">folios</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token Identifier LabeledStatement GotoLabel ID">again</span><span class="Token LabeledStatement COLON">:</span><span class="Token LabeledStatement LF">
</span><span class="Token LabeledStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">nr_pages</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token ExpressionStatement LabeledStatement SEMI">;</span><span class="Token ExpressionStatement LabeledStatement LF">
</span><span class="Token ExpressionStatement LabeledStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">list_for_each_entry_safe</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">folio2</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">from</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">lru</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token CompoundStatement PostfixExpression BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement PostfixExpression LF">
</span><span class="Token CompoundStatement PostfixExpression SPACE">        </span><span class="Token CompoundStatement PostfixExpression COMMENT">/* Retried hugetlb folios will be kept in list  */</span><span class="Token CompoundStatement PostfixExpression LF">
</span><span class="Token CompoundStatement PostfixExpression SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_test_hugetlb</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">list_move_tail</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">lru</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">ret_folios</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement CONTINUE">continue</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">nr_pages</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">folio_nr_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">folio</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">nr_pages</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression GE">&gt;=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NR_MAX_BATCHED_MIGRATION</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement PostfixExpression BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement PostfixExpression LF">
</span><span class="Token CompoundStatement PostfixExpression SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">nr_pages</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression GE">&gt;=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">NR_MAX_BATCHED_MIGRATION</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">list_cut_before</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">folios</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">from</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">folio2</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">lru</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement LF">
</span><span class="Token Keyword SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">list_splice_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">from</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">folios</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement HighlightLine SPACE">    </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">mode</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine EQ">==</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">MIGRATE_ASYNC</span><span class="Token SelectionStatement BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">rc</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">migrate_pages_batch</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">get_new_folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">put_new_folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine LF">
</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE">                </span><span class="Token Identifier PrimaryExpression HighlightLine ID">private</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">mode</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">reason</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">ret_folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine LF">
</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE">                </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">split_folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">stats</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine LF">
</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE">                </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">NR_MAX_MIGRATE_PAGES_RETRY</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement SelectionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SelectionStatement HighlightLine SPACE">    </span><span class="Token Keyword SelectionStatement HighlightLine ELSE">else</span><span class="Token Keyword SelectionStatement HighlightLine LF">
</span><span class="Token Keyword SelectionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">rc</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">migrate_pages_sync</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">get_new_folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">put_new_folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine LF">
</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE">                </span><span class="Token Identifier PrimaryExpression HighlightLine ID">private</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">mode</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">reason</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">ret_folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine LF">
</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE">                </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">split_folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">stats</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement SelectionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">rc_gather</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">rc</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">list_empty</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">from</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier GotoLabel JumpStatement GotoLabel ID">again</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote style="border-left-color: #0969da; background-color: #e8f3ff;"><p><div style="color: #0969da;"><img class="icon-note" loading="lazy" src="../../../img/note.svg" alt="[!NOTE]"> NOTE </div> 在 <code>migrate_pages</code> 函数中,<code>split_folios</code> 和 <code>ret_folios</code> 是两个链表(list_head)类型的变量,它们用于管理folio(页框)的迁移过程.</p><ul><li><code>split_folios</code> 用于存储那些需要被拆分(split)的folio.这些folio通常是大页(large page)或者巨页(huge page),它们需要被拆分成小页(small page)才能迁移到新的位置.</li></ul><ul><li><code>ret_folios</code> 用于存储那些已经迁移到新位置的folio.这些folio可能是原来的大页、巨页或者小页,它们已经被成功迁移到新的位置.</li></ul><p>当 <code>migrate_pages</code> 函数成功迁移一个folio时,它会将该folio添加到 <code>ret_folios</code> 链表中.这个链表用于存储所有已经迁移的folio,以便函数可以返回给调用者.</p></blockquote><h3 id="h3-2">同步迁移</h3><p>因为同步迁移的代码比较简单所以先来看同步迁移. migrate_pages_sync 用于同步地将一组folios(页帧)从一个位置迁移到另一个位置</p><ol start="1"><li>首先,它尝试使用<code>MIGRATE_ASYNC</code>模式批量迁移folios</li></ol><ol start="2"><li>如果批量迁移失败,则退回到逐个同步迁移每个folio</li></ol><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">migrate_pages_sync</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">from</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">new_folio_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">get_new_folio</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">free_folio_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">put_new_folio</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">private</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier ID">migrate_mode</span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">mode</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">reason</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">ret_folios</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">split_folios</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">migrate_pages_stats</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">stats</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">rc</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nr_failed</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression ID">LIST_HEAD</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">folios</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">migrate_pages_stats</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">astats</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">memset</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">astats</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Keyword UnaryExpression SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">astats</span><span class="Token UnaryExpression CastExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">/* Try to migrate in batch with MIGRATE_ASYNC mode firstly */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">rc</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">migrate_pages_batch</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">from</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">get_new_folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">put_new_folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">private</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">MIGRATE_ASYNC</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine LF">
</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE">                 </span><span class="Token Identifier PrimaryExpression HighlightLine ID">reason</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">split_folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">astats</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine LF">
</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE">                 </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">NR_MAX_MIGRATE_ASYNC_RETRY</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_succeeded</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">astats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_succeeded</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_thp_succeeded</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">astats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_thp_succeeded</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_thp_split</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">astats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_thp_split</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">rc</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_failed_pages</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">astats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_failed_pages</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_thp_failed</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">astats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_thp_failed</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">list_splice_tail</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">folios</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">ret_folios</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">rc</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_thp_failed</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">astats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_thp_split</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">nr_failed</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">astats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_thp_split</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">/*
     * Fall back to migrate all failed folios one by one synchronously. All
     * failed folios except split THPs will be retried, so their failure
     * isn&#x27;t counted
     */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">list_splice_tail_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">from</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Keyword IterationStatement HighlightLine WHILE">while</span><span class="Token Keyword IterationStatement HighlightLine SPACE"> </span><span class="Token IterationStatement BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">list_empty</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">from</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token IterationStatement BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token IterationStatement HighlightLine SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 HighlightLine LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement HighlightLine LF">
</span><span class="Token CompoundStatement IterationStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">list_move</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">from</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">next</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folios</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">rc</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">migrate_pages_batch</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">get_new_folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">put_new_folio</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine LF">
</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE">                     </span><span class="Token Identifier PrimaryExpression HighlightLine ID">private</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">mode</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">reason</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">ret_folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine LF">
</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE">                     </span><span class="Token Identifier PrimaryExpression HighlightLine ID">split_folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">stats</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">NR_MAX_MIGRATE_SYNC_RETRY</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">list_splice_tail_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">folios</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">ret_folios</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">rc</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine LT">&lt;</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">            </span><span class="Token Keyword JumpStatement HighlightLine RETURN">return</span><span class="Token Keyword JumpStatement HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">rc</span><span class="Token JumpStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token JumpStatement SelectionStatement HighlightLine LF">
</span><span class="Token JumpStatement SelectionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">nr_failed</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">rc</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 HighlightLine RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement HighlightLine LF">
</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nr_failed</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>我们详细的看一下同步迁移的部分, 这里涉及到了几个链表(list_head 相关的宏)</p><ul><li><code>list_splice_tail_init(&amp;folios, from)</code> 将 <code>folios</code> 链表中的所有元素追加到 <code>from</code> 链表的尾部,并清空 <code>folios</code> 链表.</li></ul><ul><li>此时 <code>from</code> 链表中保存着所有需要迁移的页面, <code>folios</code> 为空</li></ul><ul><li>如果 <code>from</code> 链表不空<ul><li><code>list_move(from-&gt;next, &amp;folios)</code> 将 <code>from</code> 链表中的下一个元素移动到 <code>folios</code> 链表中.</li></ul><ul><li><code>rc = migrate_pages_batch(&amp;folios, ...)</code> 尝试批量迁移 <code>folios</code> 链表中的元素.</li></ul><ul><li><code>list_splice_tail_init(&amp;folios, ret_folios)</code> 将 <code>folios</code> 链表中的所有元素追加到 <code>ret_folios</code> 链表的尾部,并清空 <code>folios</code> 链表.</li></ul></li></ul><p>其中每一步的 list_move 只会将 from 的第一个元素移动到 folios 中, 所以<b>每次循环也只会移动一个 page, 因此称为同步</b></p><h3 id="h3-3">异步迁移</h3><p>在同步迁移中我们注意到它其实也是先尝试进行异步迁移, 这说明<b>异步迁移的性能是要好于同步迁移的</b>. 这部分代码比较多我们分几部分介绍.</p><p>首先异步迁移可能会失败, 如果失败将重试最多 <code>NR_MAX_MIGRATE_PAGES_RETRY</code>(10) 次. 在开头判断如果迁移类型不是 <code>ASYNC</code> 并且 from 链表不空且不唯一(即有很多个页面, 但不是异步) 则会报错</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MacroDefine ID">NR_MAX_MIGRATE_PAGES_RETRY</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken NUMBER">10</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">migrate_pages_batch</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">from</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">new_folio_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">get_new_folio</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">free_folio_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">put_new_folio</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">private</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier ID">migrate_mode</span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">mode</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">reason</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">ret_folios</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">split_folios</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">migrate_pages_stats</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">stats</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nr_pass</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression ID">VM_WARN_ON_ONCE</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">mode</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken NE">!=</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier MacroDefine ID">MIGRATE_ASYNC</span><span class="Token Identifier MacroDefine SPACE"> </span><span class="Token PPtoken AND">&amp;&amp;</span><span class="Token PPtoken LF">
</span><span class="Token PPtoken SPACE">            </span><span class="Token PPtoken BANG">!</span><span class="Token Identifier ID">list_empty</span><span class="Token PPtoken BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">from</span><span class="Token PPtoken BraceDepth-2 RPAREN">)</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken AND">&amp;&amp;</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken BANG">!</span><span class="Token Identifier ID">list_is_singular</span><span class="Token PPtoken BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">from</span><span class="Token PPtoken BraceDepth-2 RPAREN">)</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pass</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">pass</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp LT">&lt;</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nr_pass</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">retry</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">pass</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement COMMENT">// ...</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">rc</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><ul><li>migrate_pages_batch<ul><li>migrate_folio_unmap<ul><li>dst = get_new_folio(src, private) 分配新页面 <code>alloc_migration_target</code></li></ul><ul><li>folio_trylock(src) 获取 src 锁</li></ul><ul><li>folio_test_writeback(src) 等待脏页面写回</li></ul><ul><li>folio_trylock(dst) 获取 dst 锁</li></ul><ul><li>try_to_migrate</li></ul></li></ul><ul><li>migrate_folio_move<ul><li>move_to_new_folio 拷贝old page的内容和struct page元数据到new page</li></ul><ul><li>folio_add_lru 新页面加到 lru 中</li></ul><ul><li>remove_migration_ptes 迁移页表,通过反向映射机制RMAP来建立new page的映射关系</li></ul><ul><li>migrate_folio_done 清空 src folio</li></ul></li></ul></li></ul><h2 id="h2-4">页面降级(demotion)</h2><p>系统接口中的 demotion_enabled 变量可以控制是否降级页面, 可以将其设置为 true/false 来选择开启/关闭页面降级功能</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">ls</span><span class="Token SPACE"> </span><span class="Token PATH">/sys/kernel/mm/numa/</span><span class="Token LF">
</span><span class="Token Program ID">demotion_enabled</span><span class="Token LF">
</span><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">cat</span><span class="Token SPACE"> </span><span class="Token PATH">/sys/kernel/mm/numa/demotion_enabled</span><span class="Token LF">
</span><span class="Token Program ID">false</span></code></pre><p>其对应内核中的 numa_demotion_enabled 变量, 改变量的唯一影响在 mm/vmscan.c 的 <code>can_demotion</code> 函数</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType BOOL">bool</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">can_demote</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nid</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">scan_control</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">sc</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">numa_demotion_enabled</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression FALSE">false</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">sc</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">sc</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">no_demotion</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression FALSE">false</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">next_demotion_node</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">nid</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NUMA_NO_NODE</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression FALSE">false</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression TRUE">true</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h2 id="h2-5">tracing</h2><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">migrate_pages</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">list_head</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">from</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">new_folio_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">get_new_folio</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">free_folio_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">put_new_folio</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">private</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier ID">migrate_mode</span><span class="Token Identifier EnumSpecifier EnumID TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">mode</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">reason</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">ret_succeeded</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">trace_mm_migrate_pages_start</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">reason</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// ...</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">trace_mm_migrate_pages</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_succeeded</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_failed_pages</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                   </span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_thp_succeeded</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_thp_failed</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                   </span><span class="Token Identifier PrimaryExpression ID">stats</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nr_thp_split</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">reason</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">cat</span><span class="Token SPACE"> </span><span class="Token PATH">/sys/kernel/tracing/available_events</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">grep</span><span class="Token SPACE"> </span><span class="Token ID">migrate</span><span class="Token LF">
</span><span class="Token Program ID">sched:sched_migrate_task</span><span class="Token LF">
</span><span class="Token Program ID">compaction:mm_compaction_migratepages</span><span class="Token LF">
</span><span class="Token Program ID">compaction:mm_compaction_isolate_migratepages</span><span class="Token LF">
</span><span class="Token Program ID">migrate:remove_migration_pte</span><span class="Token LF">
</span><span class="Token Program ID">migrate:set_migration_pte</span><span class="Token LF">
</span><span class="Token Program ID">migrate:mm_migrate_pages_start</span><span class="Token LF">
</span><span class="Token Program ID">migrate:mm_migrate_pages</span><span class="Token LF">
</span><span class="Token Program ID">syscalls:sys_exit_migrate_pages</span><span class="Token LF">
</span><span class="Token Program ID">syscalls:sys_enter_migrate_pages</span></code></pre><pre class="language-shell"><code><span class="Token Program ID">echo</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">tee</span><span class="Token SPACE"> </span><span class="Token PATH">/sys/kernel/tracing/events/mm/migrate_pages_start/enable</span><span class="Token LF">
</span><span class="Token Program ID">echo</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">tee</span><span class="Token SPACE"> </span><span class="Token PATH">/sys/kernel/tracing/tracing_on</span><span class="Token LF">
</span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">cat</span><span class="Token SPACE"> </span><span class="Token PATH">/sys/kernel/tracing/trace</span></code></pre><pre class="language-shell"><code><span class="Token COMMENT"># 停止跟踪</span><span class="Token LF">
</span><span class="Token Program ID">echo</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">tee</span><span class="Token SPACE"> </span><span class="Token PATH">/sys/kernel/tracing/tracing_on</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># 查看或保存跟踪数据</span><span class="Token LF">
</span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">cat</span><span class="Token SPACE"> </span><span class="Token PATH">/sys/kernel/tracing/trace</span><span class="Token SPACE"> </span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token PATH">/path/to/save/trace_output.txt</span></code></pre><h2 id="h2-6">参考</h2><ul><li><a href="https://blog.csdn.net/yhb1047818384/article/details/119920971" target="_blank">Linux内存管理(十): 页面迁移</a></li></ul><ul><li><a href="https://www.cnblogs.com/linhaostudy/p/17647370.html" target="_blank">linux那些事之页迁移(page migratiom)</a></li></ul><ul><li><a href="https://docs.kernel.org/mm/page_migration.html" target="_blank">page_migration</a></li></ul><ul><li><a href="https://docs.kernel.org/mm/hmm.html" target="_blank">Heterogeneous Memory Management (HMM)</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../tutorial/编译内核" >tutorial</a><ul><li><a href="../../tutorial/编译内核" >编译内核</a></li></ul><ul><li><a href="../../tutorial/调试内核" >调试内核</a></li></ul><ul><li><a href="../../tutorial/开发环境搭建" >开发环境搭建</a></li></ul><ul><li><a href="../../tutorial/调试技巧" >调试技巧</a></li></ul><ul><li><a href="../../tutorial/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../tutorial/邮件订阅" >邮件订阅</a></li></ul><ul><li><a href="../../tutorial/git" >git</a></li></ul><ul><li><a href="../../tutorial/打包发布库" >打包发布库</a></li></ul></li></ul><ul><li><a href="../../mm/物理内存探测" >mm</a><ul><li><a href="../../mm/物理内存探测" >物理内存探测</a></li></ul><ul><li><a href="../../mm/虚拟地址转换" >虚拟地址转换</a></li></ul><ul><li><a href="../../mm/进程内存布局" >进程内存布局</a></li></ul><ul><li><a href="../../mm/页表" >页表</a></li></ul><ul><li><a href="../../mm/numa" >numa</a></li></ul><ul><li><a href="../../mm/vma" >vma</a></li></ul><ul><li><a href="../../mm/zone" >zone</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab" >slab</a></li></ul><ul><li><a href="../../mm/compaction" >compaction</a></li></ul><ul><li><a href="../../mm/tier-mm" >tier-mm</a></li></ul><ul><li><a href="../../mm/migration" >migration</a></li></ul><ul><li><a href="../../mm/mm_struct" >mm_struct</a></li></ul><ul><li><a href="../../mm/mmio" >mmio</a></li></ul><ul><li><a href="../../mm/LRU" >LRU</a></li></ul><ul><li><a href="../../mm/MGLRU" >MGLRU</a></li></ul><ul><li><a href="../../mm/page" >page</a></li></ul><ul><li><a href="../../mm/folio" >folio</a></li></ul><ul><li><a href="../../mm/autonuma" >autonuma</a></li></ul><ul><li><a href="../../mm/kswapd" >kswapd</a></li></ul><ul><li><a href="../../mm/rmap" >rmap</a></li></ul><ul><li><a href="../../mm/ksm" >ksm</a></li></ul></li></ul><ul><li><a href="../../runtime/ELF文件格式" >runtime</a><ul><li><a href="../../runtime/ELF文件格式" >ELF文件格式</a></li></ul><ul><li><a href="../../runtime/符号表" >符号表</a></li></ul><ul><li><a href="../../runtime/静态链接" >静态链接</a></li></ul><ul><li><a href="../../runtime/装载" >装载</a></li></ul><ul><li><a href="../../runtime/动态链接" >动态链接</a></li></ul><ul><li><a href="../../runtime/库与运行库" >库与运行库</a></li></ul><ul><li><a href="../../runtime/execve" >execve</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul><ul><li><a href="../../kernel/schedule" >schedule</a></li></ul><ul><li><a href="../../kernel/atomic" >atomic</a></li></ul><ul><li><a href="../../kernel/nice" >nice</a></li></ul><ul><li><a href="../../kernel/rcu" >rcu</a></li></ul><ul><li><a href="../../kernel/manage" >manage</a></li></ul><ul><li><a href="../../kernel/workqueue" >workqueue</a></li></ul><ul><li><a href="../../kernel/signal" >signal</a></li></ul><ul><li><a href="../../kernel/lock" >lock</a></li></ul><ul><li><a href="../../kernel/cgroup" >cgroup</a></li></ul><ul><li><a href="../../kernel/syscall" >syscall</a></li></ul><ul><li><a href="../../kernel/task_struct" >task_struct</a></li></ul><ul><li><a href="../../kernel/sync_io" >sync_io</a></li></ul><ul><li><a href="../../kernel/rb-tree" >rb-tree</a></li></ul><ul><li><a href="../../kernel/async_io" >async_io</a></li></ul><ul><li><a href="../../kernel/fork" >fork</a></li></ul><ul><li><a href="../../kernel/module" >module</a></li></ul><ul><li><a href="../../kernel/lock_stat" >lock_stat</a></li></ul><ul><li><a href="../../kernel/kallsyms" >kallsyms</a></li></ul><ul><li><a href="../../kernel/list" >list</a></li></ul><ul><li><a href="../../kernel/epoll" >epoll</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cache-coherence" >cache-coherence</a></li></ul><ul><li><a href="../../arch/memory-coherence" >memory-coherence</a></li></ul><ul><li><a href="../../arch/io" >io</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/interrupt" >interrupt</a></li></ul><ul><li><a href="../../arch/dram" >dram</a></li></ul><ul><li><a href="../../arch/nvm" >nvm</a></li></ul></li></ul><ul><li><a href="../../net/net-arch" >net</a><ul><li><a href="../../net/net-arch" >net-arch</a></li></ul><ul><li><a href="../../net/ip" >ip</a></li></ul><ul><li><a href="../../net/route" >route</a></li></ul><ul><li><a href="../../net/udp" >udp</a></li></ul><ul><li><a href="../../net/tcp" >tcp</a></li></ul><ul><li><a href="../../net/tools" >tools</a></li></ul><ul><li><a href="../../net/quic" >quic</a></li></ul><ul><li><a href="../../net/rdma" >rdma</a></li></ul><ul><li><a href="../../net/socket" >socket</a></li></ul><ul><li><a href="../../net/epoll" >epoll</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul><ul><li><a href="../../fs/filesystem" >filesystem</a></li></ul><ul><li><a href="../../fs/fd" >fd</a></li></ul><ul><li><a href="../../fs/inode" >inode</a></li></ul><ul><li><a href="../../fs/directory" >directory</a></li></ul><ul><li><a href="../../fs/disk-layout" >disk-layout</a></li></ul><ul><li><a href="../../fs/mount" >mount</a></li></ul><ul><li><a href="../../fs/vfs" >vfs</a></li></ul><ul><li><a href="../../fs/ext4" >ext4</a></li></ul><ul><li><a href="../../fs/fuse" >fuse</a></li></ul><ul><li><a href="../../fs/distribute-fs" >distribute-fs</a></li></ul></li></ul><ul><li><a href="../../device/disk" >device</a><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul><ul><li><a href="../../device/driver" >driver</a></li></ul><ul><li><a href="../../device/pcie" >pcie</a></li></ul></li></ul><ul><li><a href="../../cve/dirtycow" >cve</a><ul><li><a href="../../cve/dirtycow" >dirtycow</a></li></ul><ul><li><a href="../../cve/dirtypipe" >dirtypipe</a></li></ul><ul><li><a href="../../cve/sudo" >sudo</a></li></ul><ul><li><a href="../../cve/meltdown" >meltdown</a></li></ul><ul><li><a href="../../cve/smashex" >smashex</a></li></ul></li></ul><ul><li><a href="../../tools/perf" >tools</a><ul><li><a href="../../tools/perf" >perf</a></li></ul><ul><li><a href="../../tools/fault-injection" >fault-injection</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../mm/tier-mm","../../mm/mm_struct","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/clipboard.svg","../../../img/clipboard-check.svg");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script>
            <script src="https://giscus.app/client.js" data-repo="luzhixing12345/klinux" 
            data-repo-id="R_kgDOJIKiEw" data-category="Q&A" data-category-id="DIC_kwDOJIKiE84CgFwK" data-mapping="pathname" data-strict="0"
            data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom"
            data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
            </script>
            <script type="text/javascript" src="../../../js/dir_tree_toggle.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>