<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">NUMA</a><ul><li><a href="#h2-1">CPU 术语</a></li></ul><ul><li><a href="#h2-2">NUMA系统</a><ul><li><a href="#h3-3">NUMA互联</a></li></ul><ul><li><a href="#h3-4">NUMA亲和性</a></li></ul><ul><li><a href="#h3-5">Firmware接口</a></li></ul></li></ul><ul><li><a href="#h2-6">node 初始化</a></li></ul><ul><li><a href="#h2-7">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">NUMA</h1><blockquote><p>阅读本文需要掌握 <a href="../../arch/multicore" target="_self">多处理器</a>的相关知识</p></blockquote><h2 id="h2-1">CPU 术语</h2><p>大多数CPU都是在二维平面上构建的.CPU还必须添加集成内存控制器.对于每个CPU核心,有四个内存总线(上,下,左,右)的简单解决方案允许完全可用的带宽,但仅此而已.CPU在很长一段时间内都停滞在4核状态.当芯片变成3D时,在上面和下面添加痕迹允许直接总线穿过对角线相反的CPU.在卡上放置一个四核CPU,然后连接到总线,这是合乎逻辑的下一步.</p><p>如今每个处理器都包含许多核心,这些核心都有一个共享的片上缓存和片外内存,并且在服务器内不同内存部分的内存访问成本是可变的. 提高数据访问效率是当前CPU设计的主要目标之一, 因此每个CPU核都被赋予了一个较小的一级缓存(32 KB)和一个较大的二级缓存(256 KB).各个核心随后共享几个MB的3级缓存,其大小随着时间的推移而大幅增长.</p><blockquote><p>为了避免缓存丢失(请求不在缓存中的数据),需要花费大量的研究时间来寻找合适的CPU缓存数量,缓存结构和相应的算法. 详见 <a href="./cc.md" target="_blank">缓存一致性</a></p></blockquote><p>一个 CPU 有如下的一些术语: <code>socket</code> <code>core</code> <code>ucore</code> <code>threads</code></p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240510153146.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240510153146.png" alt="20240510153146"></a></p><ul><li>Socket: <b>一个Socket对应一个物理CPU</b>. 这个词大概是从CPU在主板上的物理连接方式上来的,可以理解为 Socket 就是主板上的 CPU 插槽.处理器通过主板的Socket来插到主板上. 尤其是有了多核(Multi-core)系统以后,Multi-socket系统被用来指明系统到底存在多少个物理CPU.</li></ul><ul><li>Core: <b>CPU的运算核心</b>. x86的核包含了CPU运算的基本部件,如逻辑运算单元(ALU), 浮点运算单元(FPU), L1和L2缓存. 一个Socket里可以有多个Core.如今的多核时代,即使是单个socket的系统, 由于每个socket也有多个core, 所以逻辑上也是SMP系统.<blockquote><p>但是,一个物理CPU的系统不存在非本地内存,因此相当于UMA系统.</p></blockquote></li></ul><ul><li>Uncore: Intel x86物理CPU里没有放在Core里的部件都被叫做Uncore.Uncore里集成了过去x86 UMA架构时代北桥芯片的基本功能. 在Nehalem时代,内存控制器被集成到CPU里,叫做iMC(Integrated Memory Controller). 而PCIe Root Complex还做为独立部件在IO Hub芯片里.到了SandyBridge时代,PCIe Root Complex也被集成到了CPU里. 现今的Uncore部分,除了iMC,PCIe Root Complex,还有QPI(QuickPath Interconnect)控制器, L3缓存,CBox(负责缓存一致性),及其它外设控制器.</li></ul><ul><li>Threads: 这里特指CPU的多线程技术.在Intel x86架构下,CPU的多线程技术被称作超线程(Hyper-Threading)技术. Intel的超线程技术在一个处理器Core内部引入了额外的硬件设计模拟了两个逻辑处理器(Logical Processor), 每个逻辑处理器都有独立的处理器状态,但共享Core内部的计算资源,如ALU,FPU,L1,L2缓存. 这样在最小的硬件投入下提高了CPU在多线程软件工作负载下的性能,提高了硬件使用效率. x86的超线程技术出现早于NUMA架构.</li></ul><p>因此, 一个CPU Socket里可以由多个CPU Core和一个Uncore部分组成.每个CPU Core内部又可以由两个CPU Thread组成. 每个CPU thread都是一个操作系统可见的逻辑CPU.对大多数操作系统来说,一个八核HT(Hyper-Threading)打开的CPU会被识别为16个CPU</p><p>如下图所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240510165348.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240510165348.png" alt="20240510165348"></a></p><blockquote><p>QPI(QuickPath Interconnect)是英特尔(Intel)处理器架构中使用的一种高速互联技术.它用于处理器与其他组件(如内存,I/O设备和其他处理器)之间的通信.</p><p>LLC(Last-Level Cache):LLC 是处理器架构中的最后一级缓存.在多级缓存结构中,处理器通常具有多个级别的缓存,而最后一级缓存(通常是共享的)被称为 LLC.LLC 位于处理器核心和主存之间,用于存储频繁访问的数据,以加快处理器对数据的访问速度.</p></blockquote><h2 id="h2-2">NUMA系统</h2><p>NUMA体系结构中多了Node的概念,这个概念其实是用来解决core的分组的问题.<b>每个node有自己的内部CPU,总线和内存</b>,同时还可以访问其他node内的内存,NUMA的最大的优势就是可以方便的增加CPU的数量.NUMA系统中,<b>内存的划分是根据物理内存模块和内存控制器的布局来确定的</b></p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240224114939.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240224114939.png" alt="image"></a></p><p>在Intel x86平台上:</p><ul><li>本地内存指 CPU 可以经过Uncore部件里的iMC访问到的内存.</li></ul><ul><li>远程内存(Remote Memory),则需要经过QPI的链路到该内存所在的CPU的iMC来访问.</li></ul><p>与本地内存一样,所谓本地IO资源,就是CPU可以经过Uncore部件里的PCIe Root Complex直接访问到的IO资源. 如果是非本地IO资源,则需要经过QPI链路到该IO资源所属的CPU,再通过该CPU PCIe Root Complex访问. 如果同一个NUMA Node内的CPU和内存和另外一个NUMA Node的IO资源发生互操作,因为要跨越QPI链路, 会存在额外的访问延迟问题</p><blockquote><p>曾经在Intel IvyBridge的NUMA平台上做的内存访问性能测试显示,远程内存访问的延时时本地内存的一倍.</p></blockquote><p>一个NUMA Node内部是由一个物理CPU和它所有的本地内存, 本地IO资源组成的. 通常一个 Socket 有一个 Node,也有可能一个 Socket 有多个 Node.</p><pre class="language-shell"><code><span class="Token HOST_NAME">root@kamilu</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">numactl</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token HOST_NAME">root@kamilu</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">numactl</span><span class="Token SPACE"> </span><span class="Token OPTION">-H</span><span class="Token LF">
</span><span class="Token Program ID">available:</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token Function ID">nodes</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token NUMBER">0</span><span class="Token MINUS">-</span><span class="Token NUMBER">2</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">cpus:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token NUMBER">5</span><span class="Token SPACE"> </span><span class="Token NUMBER">6</span><span class="Token SPACE"> </span><span class="Token NUMBER">7</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token SPACE"> </span><span class="Token NUMBER">9</span><span class="Token SPACE"> </span><span class="Token NUMBER">10</span><span class="Token SPACE"> </span><span class="Token NUMBER">11</span><span class="Token SPACE"> </span><span class="Token NUMBER">24</span><span class="Token SPACE"> </span><span class="Token NUMBER">25</span><span class="Token SPACE"> </span><span class="Token NUMBER">26</span><span class="Token SPACE"> </span><span class="Token NUMBER">27</span><span class="Token SPACE"> </span><span class="Token NUMBER">28</span><span class="Token SPACE"> </span><span class="Token NUMBER">29</span><span class="Token SPACE"> </span><span class="Token NUMBER">30</span><span class="Token SPACE"> </span><span class="Token NUMBER">31</span><span class="Token SPACE"> </span><span class="Token NUMBER">32</span><span class="Token SPACE"> </span><span class="Token NUMBER">33</span><span class="Token SPACE"> </span><span class="Token NUMBER">34</span><span class="Token SPACE"> </span><span class="Token NUMBER">35</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">size:</span><span class="Token SPACE"> </span><span class="Token NUMBER">31819</span><span class="Token SPACE"> </span><span class="Token ID">MB</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">free:</span><span class="Token SPACE"> </span><span class="Token NUMBER">10283</span><span class="Token SPACE"> </span><span class="Token ID">MB</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">cpus:</span><span class="Token SPACE"> </span><span class="Token NUMBER">12</span><span class="Token SPACE"> </span><span class="Token NUMBER">13</span><span class="Token SPACE"> </span><span class="Token NUMBER">14</span><span class="Token SPACE"> </span><span class="Token NUMBER">15</span><span class="Token SPACE"> </span><span class="Token NUMBER">16</span><span class="Token SPACE"> </span><span class="Token NUMBER">17</span><span class="Token SPACE"> </span><span class="Token NUMBER">18</span><span class="Token SPACE"> </span><span class="Token NUMBER">19</span><span class="Token SPACE"> </span><span class="Token NUMBER">20</span><span class="Token SPACE"> </span><span class="Token NUMBER">21</span><span class="Token SPACE"> </span><span class="Token NUMBER">22</span><span class="Token SPACE"> </span><span class="Token NUMBER">23</span><span class="Token SPACE"> </span><span class="Token NUMBER">36</span><span class="Token SPACE"> </span><span class="Token NUMBER">37</span><span class="Token SPACE"> </span><span class="Token NUMBER">38</span><span class="Token SPACE"> </span><span class="Token NUMBER">39</span><span class="Token SPACE"> </span><span class="Token NUMBER">40</span><span class="Token SPACE"> </span><span class="Token NUMBER">41</span><span class="Token SPACE"> </span><span class="Token NUMBER">42</span><span class="Token SPACE"> </span><span class="Token NUMBER">43</span><span class="Token SPACE"> </span><span class="Token NUMBER">44</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token NUMBER">46</span><span class="Token SPACE"> </span><span class="Token NUMBER">47</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">size:</span><span class="Token SPACE"> </span><span class="Token NUMBER">32193</span><span class="Token SPACE"> </span><span class="Token ID">MB</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">free:</span><span class="Token SPACE"> </span><span class="Token NUMBER">26965</span><span class="Token SPACE"> </span><span class="Token ID">MB</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token ID">cpus:</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token ID">size:</span><span class="Token SPACE"> </span><span class="Token NUMBER">16384</span><span class="Token SPACE"> </span><span class="Token ID">MB</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token ID">free:</span><span class="Token SPACE"> </span><span class="Token NUMBER">16375</span><span class="Token SPACE"> </span><span class="Token ID">MB</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE"> </span><span class="Token ID">distances:</span><span class="Token LF">
</span><span class="Token Program ID">node</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token SPACE">   </span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE">  </span><span class="Token NUMBER">10</span><span class="Token SPACE">  </span><span class="Token NUMBER">21</span><span class="Token SPACE">  </span><span class="Token NUMBER">24</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE">  </span><span class="Token NUMBER">21</span><span class="Token SPACE">  </span><span class="Token NUMBER">10</span><span class="Token SPACE">  </span><span class="Token NUMBER">14</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE">  </span><span class="Token NUMBER">24</span><span class="Token SPACE">  </span><span class="Token NUMBER">14</span><span class="Token SPACE">  </span><span class="Token NUMBER">10</span></code></pre><h3 id="h3-3">NUMA互联</h3><p>在Intel x86上,NUMA Node之间的互联是通过 QPI(QuickPath Interconnect) Link的. CPU的Uncore部分有QPI的控制器来控制CPU到QPI的数据访问, 下图就是一个利用 QPI Switch 互联的 8 NUMA Node 的 x86 系统</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/numa-imc-iio-qpi-switch-3.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/numa-imc-iio-qpi-switch-3.png" alt="numa-imc-iio-qpi-switch-3"></a></p><h3 id="h3-4">NUMA亲和性</h3><p>NUMA Affinity(亲和性)是和NUMA Hierarchy(层级结构)直接相关的.对系统软件来说, 以下两个概念至关重要</p><ul><li>CPU NUMA Affinity<p>CPU NUMA的亲和性是指从CPU角度看,哪些内存访问更快,有更低的延迟.如前所述, 和该CPU直接相连的本地内存是更快的.操作系统如果可以根据任务所在CPU去分配本地内存, 就是基于CPU NUMA亲和性的考虑.因此,CPU NUMA亲和性就是要<b>尽量让任务运行在本地的NUMA Node里.</b></p></li></ul><ul><li>Device NUMA Affinity<p>设备NUMA亲和性是指从PCIe外设的角度看,如果和CPU和内存相关的IO活动都发生在外设所属的NUMA Node, 将会有更低延迟.这里有两种设备NUMA亲和性的问题</p><ol start="1"><li>DMA Buffer NUMA Affinity<p>大部分PCIe设备支持DMA功能的.也就是说,设备可以直接把数据写入到位于内存中的DMA缓冲区. 显然,如果DMA缓冲区在PCIe外设所属的NUMA Node里分配,那么将会有最低的延迟. 否则,外设的DMA操作要跨越QPI链接去读写另外一个NUMA Node里的DMA缓冲区. 因此,<b>操作系统如果可以根据PCIe设备所属的NUMA node分配DMA缓冲区</b>, 将会有最好的DMA操作的性能.</p></li></ol><ol start="2"><li>Interrupt NUMA Affinity<p>当设备完成DMA操作后,它会发送一个中断信号给CPU,通知CPU需要处理相关的中断处理例程(ISR),这个例程负责读写DMA缓冲区的数据. ISR在某些情况下会触发下半部机制(SoftIRQ),以便进入与协议栈(如网络,存储)相关的代码路径,以传输数据. 对大部分操作系统来说,硬件中断(HardIRQ)和下半部机制的代码在同一个CPU上发生. 因此,<b>如果操作系统能够将设备的硬件中断绑定到与操作系统自身所属的NUMA节点相对应的处理器上</b>,那么中断处理函数和协议栈代码对DMA缓冲区的读写操作将会具有更低的延迟.这样做可以减少处理器间的通信延迟,提高系统性能.</p></li></ol></li></ul><blockquote><p>中断处理例程(Interrupt Service Routine, ISR)用于响应硬件中断事件,尽快地处理中断并进行必要的操作. 当一个设备或外部事件触发了一个硬件中断,CPU会中断当前执行的任务,并跳转到相应的ISR来处理中断</p><p>半部机制(SoftIRQ)是一种延迟处理机制,用于处理与中断相关的一些非关键,耗时较长的任务. SoftIRQ不是由硬件中断触发,而是在上下文切换,网络数据包处理,定时器等事件发生时,由内核调度执行的</p></blockquote><h3 id="h3-5">Firmware接口</h3><p>由于NUMA的亲和性对应用的性能非常重要,那么硬件平台就需要给操作系统提供接口机制来感知硬件的NUMA层级结构. 在x86平台,ACPI规范提供了以下接口来让操作系统来检测系统的NUMA层级结构.</p><blockquote><p>ACPI(Advanced Configuration and Power Interface)是一种开放标准,旨在为操作系统和硬件之间提供统一的接口,以实现高级配置和电源管理功能, 包括ACPI表, 系统电源管理, 系统配置和资源管理, 事件处理, 系统配置表和命名空间. ACPI规范的广泛应用使得不同的操作系统和硬件厂商能够以一致的方式进行交互,提高了系统的兼容性和可移植性</p><p>ACPI 5.0a规范的第17章是有关NUMA的章节.ACPI规范里,NUMA Node被第9章定义的Module Device所描述. <b>ACPI规范里用Proximity Domain(接近性域)对NUMA Node做了抽象,两者的概念大多时候等同.</b></p></blockquote><ul><li>SRAT(System Resource Affinity Table) 系统资源关联表, 用于优化资源分配和调度<p>主要描述了系统boot时的CPU和内存都属于哪个Proximity Domain(NUMA Node). 这个表格里的信息时静态的,</p><blockquote><p>如果是启动后热插拔,需要用OSPM的_PXM方法去获得相关信息.</p></blockquote></li></ul><ul><li>SLIT(System Locality Information Table) 系统局部性信息表, 用于优化任务调度和资源分配<p><b>提供CPU和内存之间的位置远近信息</b>.在SRAT表格里,只能告诉给定的CPU和内存是否在一个NUMA Node. 对某个CPU来说,不在本NUMA Node里的内存,即远程内存们是否都是一样的访问延迟取决于NUMA的拓扑有多复杂(QPI的跳数). 总之,<b>对于不能简单用远近来描述的NUMA系统</b>(QPI存在0,1,2等不同跳数), 需要SLIT表格给出进一步的说明.</p><blockquote><p>也是静态表格,热插拔需要使用OSPM的_SLI方法.</p></blockquote></li></ul><ul><li>DSDT(Differentiated System Description Table) 不同化系统描述表, 用于正确识别和管理硬件和设备<p>从 Device NUMA角度看,这个表格给出了系统boot时的外设都属于哪个Proximity Domain(NUMA Node).</p></li></ul><blockquote><p>关于 ACPI 的一些介绍见本系列的 arch/ACPI</p></blockquote><h2 id="h2-6">node 初始化</h2><p>node的初始化,从几条启动日志开始说起</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230705155010.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230705155010.png" alt="20230705155010"></a></p><p>通过第一条日志顺藤摸瓜可以找到如下的函数</p><pre class="language-c"><code><span class="Token COMMENT">/**
 * dummy_numa_init - Fallback dummy NUMA init
 *
 * Used if there&#x27;s no underlying NUMA architecture, NUMA initialization
 * fails, or NUMA is disabled on the command line.
 *
 * Must online at least one node and add memory blocks that cover all
 * allowed memory.  This function must not fail.
 */</span><span class="Token LF">
</span><span class="Token COMMENT">// arch/x86/mm/numa.c</span><span class="Token LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">__init</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">dummy_numa_init</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printk</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">KERN_INFO</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token String STRING">&quot;</span><span class="Token Format String STRING">%s</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">           </span><span class="Token Identifier PrimaryExpression ID">numa_off</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression AssignmentExpression QUESTION">?</span><span class="Token ConditionalExpression AssignmentExpression SPACE"> </span><span class="Token String STRING">&quot;NUMA turned off&quot;</span><span class="Token SPACE"> </span><span class="Token ConditionalExpression AssignmentExpression COLON">:</span><span class="Token ConditionalExpression AssignmentExpression SPACE"> </span><span class="Token String STRING">&quot;No NUMA configuration found&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">/* max_pfn是e820探测到的最大物理内存页,其初始化是max_pfn = e820__end_of_ram_pfn() */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printk</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">KERN_INFO</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token String STRING">&quot;Faking a node at [mem </span><span class="Token Format String STRING">%#018Lx</span><span class="Token String STRING">-</span><span class="Token Format String STRING">%#018Lx</span><span class="Token String STRING">]</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">           </span><span class="Token Constant PrimaryExpression NUMBER">0LLU</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PFN_PHYS</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">max_pfn</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BinaryOp ConditionalExpression MINUS">-</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">/* 一个nodemask_t是 位图, 最多支持MAX_NUMNODES个node
     * 这里将node 0置位
     */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">node_set</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">numa_nodes_parsed</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">/* 将node 0的起始和结束地址记录起来 */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">numa_add_memblk</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PFN_PHYS</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">max_pfn</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">__init</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">numa_add_memblk</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nid</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">u64</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">start</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">u64</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">end</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">numa_add_memblk_to</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">nid</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">start</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">end</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">numa_meminfo</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function COMMENT">// arch/x86/mm/numa_internal.h</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">numa_meminfo</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE">         </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">nr_blks</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">numa_memblk</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE">  </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">blk</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier MacroDefine PrimaryExpression TypeSpecifier ID">NR_NODE_MEMBLKS</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">numa_memblk</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">u64</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">         </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">start</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">u64</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE">         </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">end</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE">         </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">nid</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p>代码和注释写的很清晰, 当没有 NUMA 架构或者 NUMA 架构被禁止的时候, Linux为了适配两者,将UMA&quot;假装&quot;(fake)成一种NUMA架构,也就只有一个node 0节点,该节点包括所有物理内存. numa_nodes_parsed 为 NUMA 节点的位图, 每一个bit代表一个node,node_set是将一个node设置为&quot;在线&quot;.</p><p>numa_add_memblk 就是将一个 node 加入到 numa_meminfo, 并设置内存地址的范围. numa_meminfo, numa_memblk 的结构体也比较清晰</p><blockquote><p>PFN_PHYS(max_pfn) 宏用于获取探测到的最大物理内存页的范围</p></blockquote><p>numa_add_memblk_to 逻辑也比较简单, 就是先做一些配置上的判断, 然后结构体对应元素赋值</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">__init</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">numa_add_memblk_to</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nid</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">u64</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">start</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">u64</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">end</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">                     </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">numa_meminfo</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">mi</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">/* ignore zero length blks */</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">start</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">end</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token JumpStatement SelectionStatement COMMENT">/* whine about and ignore invalid blks */</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">start</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp GT">&gt;</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier PrimaryExpression ID">end</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nid</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp LT">&lt;</span><span class="Token BinaryOp SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Constant PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nid</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp GE">&gt;=</span><span class="Token BinaryOp SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">MAX_NUMNODES</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">pr_warn</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;Warning: invalid memblk node </span><span class="Token Format String STRING">%d</span><span class="Token String STRING"> [mem </span><span class="Token Format String STRING">%#010Lx</span><span class="Token String STRING">-</span><span class="Token Format String STRING">%#010Lx</span><span class="Token String STRING">]</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">            </span><span class="Token Identifier PrimaryExpression ID">nid</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">start</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">end</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression MINUS">-</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mi</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_blks</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression GE">&gt;=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NR_NODE_MEMBLKS</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">pr_err</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;too many memblk ranges</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">EINVAL</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">mi</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">blk</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">mi</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_blks</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">start</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">start</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">mi</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">blk</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">mi</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_blks</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">end</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">end</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">mi</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">blk</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">mi</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_blks</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">nid</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nid</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">mi</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">nr_blks</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>整个系统的函数调用栈如下, numa_init 中也可以看出, 无论是否有 NUMA, 区别只是对所传递的函数指针的调用的差别而已</p><pre class="language-c"><code><span class="Token COMMENT">// arch/x86/kernel/setup.c | setup_arch</span><span class="Token LF">
</span><span class="Token COMMENT">// arch/x86/mm/numa_64.c   | initmem_init</span><span class="Token LF">
</span><span class="Token COMMENT">// arch/x86/mm/numa.c      | x86_numa_init</span><span class="Token LF">
</span><span class="Token COMMENT">// arch/x86/mm/numa.c      | numa_init</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">__init</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">x86_numa_init</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">numa_off</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess IfGroup IFDEF">ifdef</span><span class="Token Keyword Preprocess IfGroup SPACE"> </span><span class="Token Identifier MacroDefine IfGroup MacroDefine ID">CONFIG_ACPI_NUMA</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">numa_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">x86_acpi_numa_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess EndifLine ENDIF">endif</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess IfGroup IFDEF">ifdef</span><span class="Token Keyword Preprocess IfGroup SPACE"> </span><span class="Token Identifier MacroDefine IfGroup MacroDefine ID">CONFIG_AMD_NUMA</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">numa_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">amd_numa_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess EndifLine ENDIF">endif</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">numa_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">dummy_numa_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h2 id="h2-7">参考</h2><ul><li><a href="https://www.zhihu.com/column/c_1444822980567805952" target="_blank">深入理解Linux内存管理 专栏</a></li></ul><ul><li><a href="https://www.zhihu.com/column/c_1543333099974721536" target="_blank">Linux内存管理 专栏</a></li></ul><ul><li><a href="https://zhou-yuxin.github.io/" target="_blank">zhou-yuxin&#x27;s blog</a></li></ul><ul><li><a href="https://www.cnblogs.com/linhaostudy/p/12679441.html" target="_blank">内存管理相关数据结构之pg_data_t</a></li></ul><ul><li><a href="https://zhou-yuxin.github.io/articles/2018/Linux%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E2%80%94%E2%80%94%E8%8E%B7%E5%8F%96%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E3%80%81%E5%88%92%E5%88%86%E5%86%85%E5%AD%98%E5%8C%BA%E4%B8%8E%E5%88%9B%E5%BB%BANUMA%E8%8A%82%E7%82%B9/index.html" target="_blank">articles</a></li></ul><ul><li><a href="https://zhou-yuxin.github.io/articles/2018/Linux物理内存管理_获取物理内存布局,划分内存区与创建NUMA节点/index.html" target="_blank">Linux物理内存管理_获取物理内存布局,划分内存区与创建NUMA节点</a></li></ul><ul><li><a href="https://citeseerx.ist.psu.edu/viewdoc/download;jsessionid=09667FE3B088F3927E29EF7518DDA56F?doi=10.1.1.414.3607&rep=rep1&type=pdf" target="_blank">Performance Analysis of UMA and NUMA Models</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/534989692" target="_blank">理解 NUMA 架构</a></li></ul><ul><li><a href="https://linuxhint.com/understanding_numa_architecture/" target="_blank">linuxhint understanding_numa_architecture</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/62795773" target="_blank">Linux 内核 101:NUMA架构</a></li></ul><ul><li><a href="https://plantegg.github.io/2021/05/14/十年后数据库还是不敢拥抱NUMA/" target="_blank">十年后数据库还是不敢拥抱NUMA</a>: 好文</li></ul><ul><li><a href="https://houmin.cc/posts/b893097a/" target="_blank">[计算机体系结构]NUMA架构详解</a>: 好文</li></ul><ul><li><a href="https://frankdenneman.nl/2016/07/07/numa-deep-dive-part-1-uma-numa/" target="_blank">NUMA背后的设计思想</a></li></ul><ul><li><a href="https://en.wikipedia.org/wiki/Bus_snooping" target="_blank">Bus snooping</a></li></ul><ul><li><a href="https://www.geeksforgeeks.org/cache-coherence-protocols-in-multiprocessor-system/" target="_blank">cache-coherence-protocols-in-multiprocessor-system</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/26078552" target="_blank">NUMA与UEFI</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../快速开始/编译内核" >快速开始</a><ul><li><a href="../../快速开始/编译内核" >编译内核</a></li></ul><ul><li><a href="../../快速开始/调试内核" >调试内核</a></li></ul><ul><li><a href="../../快速开始/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../快速开始/邮件订阅" >邮件订阅</a></li></ul></li></ul><ul><li><a href="../../mm/detect" >mm</a><ul><li><a href="../../mm/detect" >detect</a></li></ul><ul><li><a href="../../mm/numa" >numa</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab" >slab</a></li></ul><ul><li><a href="../../mm/compaction" >compaction</a></li></ul><ul><li><a href="../../mm/va-translate" >va-translate</a></li></ul><ul><li><a href="../../mm/tlb" >tlb</a></li></ul><ul><li><a href="../../mm/tier" >tier</a></li></ul><ul><li><a href="../../mm/migration" >migration</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul><ul><li><a href="../../fs/filesystem" >filesystem</a></li></ul><ul><li><a href="../../fs/fd" >fd</a></li></ul><ul><li><a href="../../fs/inode" >inode</a></li></ul><ul><li><a href="../../fs/directory" >directory</a></li></ul><ul><li><a href="../../fs/disk-layout" >disk-layout</a></li></ul><ul><li><a href="../../fs/mount" >mount</a></li></ul><ul><li><a href="../../fs/vfs" >vfs</a></li></ul><ul><li><a href="../../fs/fhs" >fhs</a></li></ul><ul><li><a href="../../fs/ext4" >ext4</a></li></ul><ul><li><a href="../../fs/distribute-fs" >distribute-fs</a></li></ul></li></ul><ul><li><a href="../../runtime/proc" >runtime</a><ul><li><a href="../../runtime/proc" >proc</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul><ul><li><a href="../../runtime/elf_format" >elf_format</a></li></ul><ul><li><a href="../../runtime/elf_loader" >elf_loader</a></li></ul><ul><li><a href="../../runtime/ld" >ld</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul><ul><li><a href="../../kernel/rcu" >rcu</a></li></ul><ul><li><a href="../../kernel/workqueue" >workqueue</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cc" >cc</a></li></ul><ul><li><a href="../../arch/mc" >mc</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/interrupt" >interrupt</a></li></ul></li></ul><ul><li><a href="../../proc/schedule" >proc</a><ul><li><a href="../../proc/schedule" >schedule</a></li></ul><ul><li><a href="../../proc/nice" >nice</a></li></ul><ul><li><a href="../../proc/manage" >manage</a></li></ul><ul><li><a href="../../proc/signal" >signal</a></li></ul><ul><li><a href="../../proc/cgroup" >cgroup</a></li></ul><ul><li><a href="../../proc/task_struct" >task_struct</a></li></ul></li></ul><ul><li><a href="../../device/io" >device</a><ul><li><a href="../../device/io" >io</a></li></ul><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul><ul><li><a href="../../device/driver" >driver</a></li></ul><ul><li><a href="../../device/io_uring" >io_uring</a></li></ul></li></ul><ul><li><a href="../../others/safety" >others</a><ul><li><a href="../../others/safety" >safety</a></li></ul><ul><li><a href="../../others/Q&A" >Q&A</a></li></ul></li></ul><ul><li><a href="../../driver/intro" >driver</a><ul><li><a href="../../driver/intro" >intro</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../mm/detect","../../mm/buddy","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>