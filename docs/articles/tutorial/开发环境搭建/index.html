<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css /><link rel='stylesheet' href=../../../css/x86asm.css /><link rel='stylesheet' href=../../../css/yaml.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">开发环境搭建</a><ul><li><a href="#h2-1">Ubuntu 镜像</a></li></ul><ul><li><a href="#h2-2">替换内核</a></li></ul><ul><li><a href="#h2-3">网络配置</a><ul><li><a href="#h3-4">网卡驱动</a></li></ul><ul><li><a href="#h3-5">User 模式</a></li></ul><ul><li><a href="#h3-6">tap 模式</a></li></ul></li></ul><ul><li><a href="#h2-7">添加文件</a></li></ul><ul><li><a href="#h2-8">磁盘扩容</a></li></ul><ul><li><a href="#h2-9">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">开发环境搭建</h1><p>在<a href="../../tutorial/调试内核" target="_self">调试内核</a>我们使用 initramfs + kernel 构建了一个基础的 linux kernel 调试环境, 但是目前的所有操作都只会保存在 initramfs 中, 目前可用的软件很少, 没有编译器, 没有联网, 没有 apt 包管理工具, 不能持久化存储</p><p>本文介绍如何使用 qemu 模拟更加复杂的环境, 以及如何利用现有的 Linux 发行版根文件系统(比如说 Ubuntu 的基础软件包)来搭建一个可用的 linux 开发环境, 替换自己编译的内核</p><h2 id="h2-1">Ubuntu 镜像</h2><p>手动构建软件包环境是十分繁琐的, 可以直接利用现有的 Linux 发行版提供的系统映像安装, 这里以 Ubuntu 为例</p><p>可以在 <a href="https://ubuntu.com/download/server#manual-install" target="_blank">ubuntu server</a> 查找到 Ubuntu 的 server 镜像 iso 文件 也有一些其他存档镜像:</p><ul><li><a href="https://cloud-images.ubuntu.com/minimal/releases/jammy/release-20220901/" target="_blank">Ubuntu Minimal 22.04 LTS</a></li></ul><ul><li><a href="https://askubuntu.com/a/1233750" target="_blank">archive ubuntu</a></li></ul><ul><li><a href="https://releases.ubuntu.com/jammy/" target="_blank">ubuntu releases</a> <a href="https://releases.ubuntu.com/jammy/ubuntu-22.04.4-live-server-amd64.iso" target="_blank">ubuntu server iso</a></li></ul><p>下载的 iso 是光盘 CD/DVD 映像, 需要先创建一个存储介质用于安装系统</p><pre class="language-shell"><code><span class="Token Program ID">qemu-img</span><span class="Token SPACE"> </span><span class="Token ID">create</span><span class="Token SPACE"> </span><span class="Token ID">ubuntu.raw</span><span class="Token SPACE"> </span><span class="Token OPTION">-f</span><span class="Token SPACE"> </span><span class="Token ID">raw</span><span class="Token SPACE"> </span><span class="Token NUMBER">20G</span></code></pre><p>安装系统, 其中 <code>-drive</code> <code>-cdrom</code> 的路径自行调整</p><pre class="language-shell"><code><span class="Token Program ID">qemu-system-x86_64</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token Variant ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">raw</span><span class="Token COMMA">,</span><span class="Token Variant ID">file</span><span class="Token ASSIGN">=</span><span class="Token PATH">disk/ubuntu.raw</span><span class="Token COMMA">,</span><span class="Token Keyword IF">if</span><span class="Token ASSIGN">=</span><span class="Token ID">virtio</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token OPTION">-cdrom</span><span class="Token SPACE"> </span><span class="Token PATH">iso/ubuntu-24.04-live-server-amd64.iso</span></code></pre><p>具体的安装过程略过, <b>注意不要开启 LVM, 启用 OpenSSH</b></p><p>安装完成之后就不再需要 <code>-cdrom</code> 了, 可以直接通过磁盘启动</p><pre class="language-shell"><code><span class="Token Program ID">qemu-system-x86_64</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token Variant ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">raw</span><span class="Token COMMA">,</span><span class="Token Variant ID">file</span><span class="Token ASSIGN">=</span><span class="Token PATH">disk/ubuntu.raw</span><span class="Token COMMA">,</span><span class="Token Keyword IF">if</span><span class="Token ASSIGN">=</span><span class="Token ID">virtio</span></code></pre><blockquote><p>启动会有点慢, 耐心一些</p></blockquote><p>启动之后可以使用 lsblk 看一下当前的所有磁盘, 启动 sr0 代表第一个光盘驱动器(CD-ROM Drive), vda 代表第一个 Virtio 磁盘设备</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@kamilu</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">lsblk</span><span class="Token LF">
</span><span class="Token Program ID">NAME</span><span class="Token SPACE">   </span><span class="Token ID">MAJ:MIN</span><span class="Token SPACE"> </span><span class="Token ID">RM</span><span class="Token SPACE">  </span><span class="Token ID">SIZE</span><span class="Token SPACE"> </span><span class="Token ID">RO</span><span class="Token SPACE"> </span><span class="Token ID">TYPE</span><span class="Token SPACE"> </span><span class="Token ID">MOUNTPOINTS</span><span class="Token LF">
</span><span class="Token Program ID">sr0</span><span class="Token SPACE">     </span><span class="Token NUMBER">11</span><span class="Token COLON">:</span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token NUMBER">1024M</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">rom</span><span class="Token LF">
</span><span class="Token Program ID">vda</span><span class="Token SPACE">    </span><span class="Token NUMBER">253</span><span class="Token COLON">:</span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">20G</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">disk</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token Program ID">vda1</span><span class="Token SPACE"> </span><span class="Token NUMBER">253</span><span class="Token COLON">:</span><span class="Token NUMBER">1</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">1M</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">part</span><span class="Token LF">
</span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token Program ID">vda2</span><span class="Token SPACE"> </span><span class="Token NUMBER">253</span><span class="Token COLON">:</span><span class="Token NUMBER">2</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">20G</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">part</span><span class="Token SPACE"> </span><span class="Token PATH">/</span></code></pre><blockquote><p>由于命令行中设置参数中 if(interface) 指定为 <code>if=virtio</code> 所以这里显示的是 vda, 如果设置为 <code>if=sd</code> 则这里应该是 sda, 这里设置为 virtio 可以让设备通过允许客体系统直接与主机通信而绕过仿真层, 以实现高效的磁盘I</p><p>qemu 全部支持的设备模拟见下文 qemu 参数</p></blockquote><p>可以看到 <code>/dev/vda1</code> 是用于启动的 /boot 分区, <code>/dev/vda2</code> 是挂载的根分区, <b>也是后面启动时需要手动指定的分区</b></p><h2 id="h2-2">替换内核</h2><p>使用 Linux 发行版镜像的主要目的就是借用其已经编译好的软件包环境, 通常内核则使用自己修改后重新编译的 <code>bzImage</code></p><pre class="language-shell"><code><span class="Token Program ID">qemu-system-x86_64</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token ID">bzImage</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token Variant ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">raw</span><span class="Token COMMA">,</span><span class="Token Variant ID">file</span><span class="Token ASSIGN">=</span><span class="Token PATH">disk/ubuntu.raw</span><span class="Token COMMA">,</span><span class="Token Keyword IF">if</span><span class="Token ASSIGN">=</span><span class="Token ID">virtio</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;root=/dev/vda2 console=ttyS0&quot;</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token OPTION">-no-reboot</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">guest_errors</span></code></pre><blockquote><p><code>-d guest_errors</code> 是 QEMU 的一个调试选项,用于记录和报告客户机操作系统中的错误, 这些错误信息会被输出到 QEMU 的日志中,以便开发人员或系统管理员进行调试和问题排查.</p></blockquote><p>如果设置了 kernel 参数那么就会使用新内核而不是当前 ubuntu.raw 中的内核, 相当于不再使用 <code>/dev/vda1</code> 的 /boot 分区, 不会读取其中 <code>/boot/grub/grub.cfg</code> 的配置文件, 因此需要手动指定挂载的根分区所在的位置</p><p>启动的时候可能会出现如下报错: <b>VFS: Unable to mount root fs on unknown wn-block(0,0)</b></p><p>可能有两个原因, 一个是因为现在使用的是 qemu 的虚拟机环境, 所以需要内核也支持虚拟化的设备/网络/PCI模拟, 需要在内核选项中开启如下的配置</p><pre class="language-txt"><code><span class="Token ID">CONFIG_EXT4_FS</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_XFS_FS</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_JBD2</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO_PCI</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO_BALLOON</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO_BLK</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO_NET</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token LF">
</span><span class="Token ID">CONFIG_VIRTIO_RING</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span></code></pre><blockquote><p>正常来说使用 <code>defconfig</code> 的应该都已经开启了, 如果没有可以在 menuconfig 中手动搜索一下开启</p></blockquote><p>不出意外的话就可以正常进入了</p><p>进去之后发现没有彩色输出, 修改 .bashrc, 在开头加上</p><pre class="language-shell"><code><span class="Token Keyword EXPORT">export</span><span class="Token SPACE"> </span><span class="Token Variant ID">TERM</span><span class="Token ASSIGN">=</span><span class="Token ID">xterm-256color</span></code></pre><h2 id="h2-3">网络配置</h2><p>qemu 的网络配置比较复杂, 可以做很多模式的连接, 这里简单介绍一下最基础的联网配置, 至少可以用 apt 下载软件包了</p><h3 id="h3-4">网卡驱动</h3><p>大部分情况我们需要使用自己编译的内核, 在编译内核的时候选择 E1000 网卡驱动</p><pre class="language-txt"><code><span class="Token MINUS">-</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Device</span><span class="Token SPACE"> </span><span class="Token ID">Drivers</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token MINUS">-</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Network</span><span class="Token SPACE"> </span><span class="Token ID">device</span><span class="Token SPACE"> </span><span class="Token ID">support</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">NETDEVICES</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">      </span><span class="Token MINUS">-</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Ethernet</span><span class="Token SPACE"> </span><span class="Token ID">driver</span><span class="Token SPACE"> </span><span class="Token ID">support</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">ETHERNET</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">         </span><span class="Token MINUS">-</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Intel</span><span class="Token SPACE"> </span><span class="Token ID">devices</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">NET_VENDOR_INTEL</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token MINUS">-</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">Intel</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">R</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token ID">PRO</span><span class="Token DIV">/</span><span class="Token NUMBER">1000</span><span class="Token SPACE"> </span><span class="Token ID">Gigabit</span><span class="Token SPACE"> </span><span class="Token ID">Ethernet</span><span class="Token SPACE"> </span><span class="Token ID">support</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">E1000</span><span class="Token SPACE"> </span><span class="Token BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token ASSIGN">=</span><span class="Token ID">y</span><span class="Token BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 RPAREN">)</span></code></pre><p>也可以作为模块编译, 不过建议编译进内核比较省事</p><h3 id="h3-5">User 模式</h3><p>启动 qemu 时添加如下参数</p><pre class="language-shell"><code><span class="Token Program ID">qemu-system-x86_64</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token PATH">/home/kamilu/klinux/arch/x86/boot/bzImage</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token Variant ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">raw</span><span class="Token COMMA">,</span><span class="Token Variant ID">file</span><span class="Token ASSIGN">=</span><span class="Token PATH">disk/ubuntu.raw</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;root=/dev/sda2 console=ttyS0&quot;</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token OPTION">-no-reboot</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">guest_errors</span><span class="Token SPACE"> </span><span class="Token OPTION">-serial</span><span class="Token SPACE"> </span><span class="Token ID">mon:stdio</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token HighlightLine SPACE">        </span><span class="Token HighlightLine OPTION">-netdev</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">user</span><span class="Token HighlightLine COMMA">,</span><span class="Token Variant HighlightLine ID">id</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">net0</span><span class="Token HighlightLine COMMA">,</span><span class="Token Variant HighlightLine ID">hostfwd</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">tcp:127.0.0.1:2222-:22</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine OPTION">-device</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">e1000</span><span class="Token HighlightLine COMMA">,</span><span class="Token Variant HighlightLine ID">netdev</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">net0</span></code></pre><p>查看网络配置, 不出意外的话网卡名应该是 enp0s3, 如果不是的话下面对应的名字也替换一下</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">a</span><span class="Token LF">
</span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token Program ID">lo:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">LOOPBACK</span><span class="Token COMMA">,</span><span class="Token ID">UP</span><span class="Token COMMA">,</span><span class="Token ID">LOWER_UP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">65536</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">noqueue</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">UNKNOWN</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program ID">...</span><span class="Token LF">
</span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token Program ID">enp0s3:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">BROADCAST</span><span class="Token COMMA">,</span><span class="Token ID">MULTICAST</span><span class="Token COMMA">,</span><span class="Token ID">UP</span><span class="Token COMMA">,</span><span class="Token ID">LOWER_UP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">1500</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">pfifo_fast</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">UP</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">...</span><span class="Token LF">
</span><span class="Token NUMBER">3</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token Program ID">sit0@NONE:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">NOARP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">1480</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">noop</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">DOWN</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program PATH">link/sit</span><span class="Token SPACE"> </span><span class="Token NUMBER">0.0</span><span class="Token ID">.0.0</span><span class="Token SPACE"> </span><span class="Token ID">brd</span><span class="Token SPACE"> </span><span class="Token NUMBER">0.0</span><span class="Token ID">.0.0</span></code></pre><p>其中 enp0s3 网卡还并未配置, 创建一个网卡配置文件</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">vim</span><span class="Token SPACE"> </span><span class="Token PATH">/etc/netplan/01-netcfg.yaml</span></code></pre><p>写入如下内容, 需要注意的是 YAML 对缩进非常敏感, 直接复制进去可能会有缩进问题, 建议手打</p><pre class="language-yaml"><code><span class="Token Key ID">network</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Key ID">version</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Key ID">ethernets</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Key ID">enp0s3</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">      </span><span class="Token Key ID">addresses</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token NUMBER">10.0</span><span class="Token NUMBER">.2</span><span class="Token NUMBER">.15</span><span class="Token ID">/24</span><span class="Token LF">
</span><span class="Token SPACE">      </span><span class="Token Key ID">routes</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token Key ID">to</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token Key ID">via</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">10.0</span><span class="Token NUMBER">.2</span><span class="Token NUMBER">.2</span><span class="Token LF">
</span><span class="Token SPACE">      </span><span class="Token Key ID">nameservers</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Key ID">addresses</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token NUMBER">8.8</span><span class="Token NUMBER">.8</span><span class="Token TIME NUMBER">.8</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token NUMBER">8.8</span><span class="Token NUMBER">.4</span><span class="Token NUMBER">.4</span></code></pre><p>修改文件权限</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">chmod</span><span class="Token SPACE"> </span><span class="Token NUMBER">600</span><span class="Token SPACE"> </span><span class="Token PATH">/etc/netplan/01-netcfg.yaml</span></code></pre><p>应用 Netplan 配置</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">netplan</span><span class="Token SPACE"> </span><span class="Token ID">apply</span></code></pre><p>此时网络就已经完成了配置, 再次查看网络配置</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">a</span><span class="Token LF">
</span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token Program ID">lo:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">LOOPBACK</span><span class="Token COMMA">,</span><span class="Token ID">UP</span><span class="Token COMMA">,</span><span class="Token ID">LOWER_UP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">65536</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">noqueue</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">UNKNOWN</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program PATH">link/loopback</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token ID">brd</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program ID">inet</span><span class="Token SPACE"> </span><span class="Token NUMBER">127.0</span><span class="Token PATH">.0.1/8</span><span class="Token SPACE"> </span><span class="Token ID">scope</span><span class="Token SPACE"> </span><span class="Token ID">host</span><span class="Token SPACE"> </span><span class="Token ID">lo</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token Program ID">valid_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token SPACE"> </span><span class="Token ID">preferred_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program ID">inet6</span><span class="Token SPACE"> </span><span class="Token COLON">:</span><span class="Token COLON">:</span><span class="Token NUMBER">1</span><span class="Token PATH">/128</span><span class="Token SPACE"> </span><span class="Token ID">scope</span><span class="Token SPACE"> </span><span class="Token ID">host</span><span class="Token SPACE"> </span><span class="Token ID">noprefixroute</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token Program ID">valid_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token SPACE"> </span><span class="Token ID">preferred_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token LF">
</span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token Program ID">enp0s3:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">BROADCAST</span><span class="Token COMMA">,</span><span class="Token ID">MULTICAST</span><span class="Token COMMA">,</span><span class="Token ID">UP</span><span class="Token COMMA">,</span><span class="Token ID">LOWER_UP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">1500</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">pfifo_fast</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">UP</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program PATH">link/ether</span><span class="Token SPACE"> </span><span class="Token NUMBER">52</span><span class="Token COLON">:</span><span class="Token NUMBER">54</span><span class="Token COLON">:</span><span class="Token NUMBER">00</span><span class="Token COLON">:</span><span class="Token NUMBER">12</span><span class="Token COLON">:</span><span class="Token NUMBER">34</span><span class="Token COLON">:</span><span class="Token NUMBER">56</span><span class="Token SPACE"> </span><span class="Token ID">brd</span><span class="Token SPACE"> </span><span class="Token ID">ff:ff:ff:ff:ff:ff</span><span class="Token LF">
</span><span class="Token HighlightLine SPACE">    </span><span class="Token Program HighlightLine ID">inet</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine NUMBER">10.0</span><span class="Token HighlightLine PATH">.2.15/24</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">brd</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine NUMBER">10.0</span><span class="Token HighlightLine ID">.2.255</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">scope</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">global</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">enp0s3</span><span class="Token HighlightLine LF">
</span><span class="Token SPACE">       </span><span class="Token Program ID">valid_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token SPACE"> </span><span class="Token ID">preferred_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program ID">inet6</span><span class="Token SPACE"> </span><span class="Token ID">fec0::5054:ff:fe12:3456/64</span><span class="Token SPACE"> </span><span class="Token ID">scope</span><span class="Token SPACE"> </span><span class="Token ID">site</span><span class="Token SPACE"> </span><span class="Token ID">dynamic</span><span class="Token SPACE"> </span><span class="Token ID">mngtmpaddr</span><span class="Token SPACE"> </span><span class="Token ID">noprefixroute</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token Program ID">valid_lft</span><span class="Token SPACE"> </span><span class="Token NUMBER">86274s</span><span class="Token ID">ec</span><span class="Token SPACE"> </span><span class="Token ID">preferred_lft</span><span class="Token SPACE"> </span><span class="Token NUMBER">14274s</span><span class="Token ID">ec</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program ID">inet6</span><span class="Token SPACE"> </span><span class="Token ID">fe80::5054:ff:fe12:3456/64</span><span class="Token SPACE"> </span><span class="Token ID">scope</span><span class="Token SPACE"> </span><span class="Token ID">link</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token Program ID">valid_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token SPACE"> </span><span class="Token ID">preferred_lft</span><span class="Token SPACE"> </span><span class="Token ID">forever</span><span class="Token LF">
</span><span class="Token NUMBER">3</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token Program ID">sit0@NONE:</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">NOARP</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token ID">mtu</span><span class="Token SPACE"> </span><span class="Token NUMBER">1480</span><span class="Token SPACE"> </span><span class="Token ID">qdisc</span><span class="Token SPACE"> </span><span class="Token ID">noop</span><span class="Token SPACE"> </span><span class="Token ID">state</span><span class="Token SPACE"> </span><span class="Token ID">DOWN</span><span class="Token SPACE"> </span><span class="Token ID">group</span><span class="Token SPACE"> </span><span class="Token ID">default</span><span class="Token SPACE"> </span><span class="Token ID">qlen</span><span class="Token SPACE"> </span><span class="Token NUMBER">1000</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Program PATH">link/sit</span><span class="Token SPACE"> </span><span class="Token NUMBER">0.0</span><span class="Token ID">.0.0</span><span class="Token SPACE"> </span><span class="Token ID">brd</span><span class="Token SPACE"> </span><span class="Token NUMBER">0.0</span><span class="Token ID">.0.0</span></code></pre><p>然后就可以正常联网使用了, 再次启动也会自动联网</p><h3 id="h3-6">tap 模式</h3><blockquote style="border-left-color: #9a6700; background-color: #fff4dd;"><p><div style="color: #9a6700;"><img class="icon-warning" loading="lazy" src="../../../img/warning.svg" alt="[!WARNING]"> WARNING </div> 存疑, 还有问题! 不要用!</p></blockquote><blockquote><p>一般的网络配置建议直接使用 user</p></blockquote><p>-netdev user 模式适用于简单的网络需求,但如果你需要更复杂的网络配置或完整的桥接网络连接,可以考虑使用桥接模式.</p><p>首先在你的主机上创建 tap0 接口,并将其添加到一个网桥中</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">tuntap</span><span class="Token SPACE"> </span><span class="Token ID">add</span><span class="Token SPACE"> </span><span class="Token ID">tap0</span><span class="Token SPACE"> </span><span class="Token ID">mode</span><span class="Token SPACE"> </span><span class="Token ID">tap</span><span class="Token SPACE"> </span><span class="Token ID">user</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">whoami</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">link</span><span class="Token SPACE"> </span><span class="Token ID">set</span><span class="Token SPACE"> </span><span class="Token ID">tap0</span><span class="Token SPACE"> </span><span class="Token ID">up</span><span class="Token LF">
</span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">brctl</span><span class="Token SPACE"> </span><span class="Token ID">addbr</span><span class="Token SPACE"> </span><span class="Token ID">br0</span><span class="Token LF">
</span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">brctl</span><span class="Token SPACE"> </span><span class="Token ID">addif</span><span class="Token SPACE"> </span><span class="Token ID">br0</span><span class="Token SPACE"> </span><span class="Token ID">tap0</span><span class="Token LF">
</span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">dhclient</span><span class="Token SPACE"> </span><span class="Token ID">br0</span></code></pre><p>其中最后一步可能会卡住, 通常是因为网桥 <code>br0</code> 没有正确配置或没有有效的网络接口连接, 可以尝试为网桥 <code>br0</code> 手动分配静态 IP 地址,避免依赖 DHCP:</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">addr</span><span class="Token SPACE"> </span><span class="Token ID">add</span><span class="Token SPACE"> </span><span class="Token NUMBER">192.168</span><span class="Token PATH">.1.100/24</span><span class="Token SPACE"> </span><span class="Token ID">dev</span><span class="Token SPACE"> </span><span class="Token ID">br0</span><span class="Token SPACE">  </span><span class="Token COMMENT"># 替换为你网络的 IP 地址段</span><span class="Token LF">
</span><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">ip</span><span class="Token SPACE"> </span><span class="Token ID">link</span><span class="Token SPACE"> </span><span class="Token ID">set</span><span class="Token SPACE"> </span><span class="Token ID">br0</span><span class="Token SPACE"> </span><span class="Token ID">up</span></code></pre><p>要配置桥接网络,修改启动参数</p><pre class="language-shell"><code><span class="Token Program ID">qemu-system-x86_64</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-m</span><span class="Token SPACE"> </span><span class="Token NUMBER">4G</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-kernel</span><span class="Token SPACE"> </span><span class="Token PATH">/home/kamilu/klinux/arch/x86/boot/bzImage</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-drive</span><span class="Token SPACE"> </span><span class="Token Variant ID">format</span><span class="Token ASSIGN">=</span><span class="Token ID">raw</span><span class="Token COMMA">,</span><span class="Token Variant ID">file</span><span class="Token ASSIGN">=</span><span class="Token PATH">disk/ubuntu.raw</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-append</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;root=/dev/sda2 console=ttyS0&quot;</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token OPTION">-nographic</span><span class="Token SPACE"> </span><span class="Token OPTION">-no-reboot</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">guest_errors</span><span class="Token SPACE"> </span><span class="Token OPTION">-serial</span><span class="Token SPACE"> </span><span class="Token ID">mon:stdio</span><span class="Token SPACE"> </span><span class="Token BACK_SLASH">\</span><span class="Token LF">
</span><span class="Token HighlightLine SPACE">        </span><span class="Token HighlightLine OPTION">-netdev</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">tap</span><span class="Token HighlightLine COMMA">,</span><span class="Token Variant HighlightLine ID">id</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">net0</span><span class="Token HighlightLine COMMA">,</span><span class="Token Variant HighlightLine ID">ifname</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">tap0</span><span class="Token HighlightLine COMMA">,</span><span class="Token Variant HighlightLine ID">script</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">no</span><span class="Token HighlightLine COMMA">,</span><span class="Token Variant HighlightLine ID">downscript</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">no</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine OPTION">-device</span><span class="Token HighlightLine SPACE"> </span><span class="Token HighlightLine ID">e1000</span><span class="Token HighlightLine COMMA">,</span><span class="Token Variant HighlightLine ID">netdev</span><span class="Token HighlightLine ASSIGN">=</span><span class="Token HighlightLine ID">net0</span></code></pre><h2 id="h2-7">添加文件</h2><p>有时候我们希望添加一些在磁盘镜像中添加一些内容,</p><p>如果只有一个分区直接 mount 就可以了, 如果磁盘分为了多个分区, 比如说前面的分区作为 /boot 分区, 这时候没办法直接 mount</p><p>可以先查看一下该磁盘的分区</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">fdisk</span><span class="Token SPACE"> </span><span class="Token OPTION">-l</span><span class="Token SPACE"> </span><span class="Token ID">ubuntu.raw</span></code></pre><p>此时发现该磁盘有两个分区, 第二个分区为根分区, 所以应该跳过第一个分区, 找到对应的偏移量开始挂载</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240613182359.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240613182359.png" alt="20240613182359"></a></p><p>偏移量计算为 (4095 + 1) * 512 = 2097152</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">mount</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">loop</span><span class="Token COMMA">,</span><span class="Token Variant ID">offset</span><span class="Token ASSIGN">=</span><span class="Token NUMBER">2097152</span><span class="Token SPACE"> </span><span class="Token ID">ubuntu.raw</span><span class="Token SPACE"> </span><span class="Token ID">tmp</span></code></pre><p>内核中有一些组件并不是直接编译进内核的, 还有一些内核模块作为可选项, 有的时候需要加载和卸载</p><p>我们可以编译所有模块, 并保存到 modules/ 目录下</p><pre class="language-shell"><code><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">modules_install</span><span class="Token SPACE"> </span><span class="Token Variant ID">INSTALL_MOD_PATH</span><span class="Token ASSIGN">=</span><span class="Token PATH">modules/</span></code></pre><p>将 modules 目录下的格式如下, 其中 lib/modules/ 下包含你的内核版本+名字</p><pre class="language-shell"><code><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">lib</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">modules</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token NUMBER">6.6</span><span class="Token Program ID">.0+</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">build</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token SPACE"> </span><span class="Token PATH">/home/kamilu/klinux</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">kernel</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">drivers</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">net</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">ethernet</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE">     </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">intel</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE">         </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">e1000</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">thermal</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE">     </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">intel</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">fs</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">efivarfs</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">net</span><span class="Token LF">
</span><span class="Token SPACE">                    </span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">ipv4</span><span class="Token LF">
</span><span class="Token SPACE">                    </span><span class="Token TEXT">│</span><span class="Token TEXT"> </span><span class="Token TEXT"> </span><span class="Token SPACE"> </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">netfilter</span><span class="Token LF">
</span><span class="Token SPACE">                    </span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token TEXT">─</span><span class="Token SPACE"> </span><span class="Token Program ID">netfilter</span></code></pre><p>将该目录 copy 到磁盘镜像的 /lib/modules 下即可</p><h2 id="h2-8">磁盘扩容</h2><p>如果初始创建的磁盘镜像随着使用发现空间不足, 可以比较方便的扩容</p><p>第一步将磁盘镜像文件的大小从 20GB 扩展到 50GB</p><pre class="language-shell"><code><span class="Token Program ID">qemu-img</span><span class="Token SPACE"> </span><span class="Token ID">resize</span><span class="Token SPACE"> </span><span class="Token ID">ubuntu.raw</span><span class="Token SPACE"> </span><span class="Token NUMBER">50G</span></code></pre><p>扩展磁盘后,还需要在虚拟机内部调整分区和文件系统以使用新增的空间, 使用 cfdisk 调整分区 /dev/sda</p><blockquote><p>如果是用的 if=virtio 那么是 /dev/vda</p></blockquote><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">cfdisk</span><span class="Token SPACE"> </span><span class="Token PATH">/dev/sda</span></code></pre><p>选择 /dev/sda2 分区将其扩容至 50GB</p><p>使用 df -h 查看磁盘剩余容量, 发现还是 20G</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404-VM</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">df</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token LF">
</span><span class="Token Program ID">Filesystem</span><span class="Token SPACE">      </span><span class="Token ID">Size</span><span class="Token SPACE">  </span><span class="Token ID">Used</span><span class="Token SPACE"> </span><span class="Token ID">Avail</span><span class="Token SPACE"> </span><span class="Token ID">Use</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token ID">Mounted</span><span class="Token SPACE"> </span><span class="Token ID">on</span><span class="Token LF">
</span><span class="Token Program PATH">/dev/root</span><span class="Token SPACE">        </span><span class="Token NUMBER">20G</span><span class="Token SPACE">  </span><span class="Token NUMBER">8.2G</span><span class="Token SPACE">   </span><span class="Token NUMBER">11G</span><span class="Token SPACE">  </span><span class="Token NUMBER">45</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">95G</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">95G</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/dev/shm</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">38G</span><span class="Token SPACE">  </span><span class="Token NUMBER">892K</span><span class="Token SPACE">   </span><span class="Token NUMBER">38G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/run</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">           </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">  </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/run/lock</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">12K</span><span class="Token SPACE">   </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/run/user/1000</span></code></pre><p>但是 lsblk 可以看到分区信息已经更新</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404-VM</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">lsblk</span><span class="Token LF">
</span><span class="Token Program ID">NAME</span><span class="Token SPACE">   </span><span class="Token ID">MAJ:MIN</span><span class="Token SPACE"> </span><span class="Token ID">RM</span><span class="Token SPACE">  </span><span class="Token ID">SIZE</span><span class="Token SPACE"> </span><span class="Token ID">RO</span><span class="Token SPACE"> </span><span class="Token ID">TYPE</span><span class="Token SPACE"> </span><span class="Token ID">MOUNTPOINTS</span><span class="Token LF">
</span><span class="Token Program ID">sda</span><span class="Token SPACE">      </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">50G</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">disk</span><span class="Token LF">
</span><span class="Token TEXT">├</span><span class="Token TEXT">─</span><span class="Token Program ID">sda1</span><span class="Token SPACE">   </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token NUMBER">1</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">1M</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">part</span><span class="Token LF">
</span><span class="Token TEXT">└</span><span class="Token TEXT">─</span><span class="Token Program ID">sda2</span><span class="Token SPACE">   </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token NUMBER">2</span><span class="Token SPACE">    </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">50G</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">part</span><span class="Token SPACE"> </span><span class="Token PATH">/</span><span class="Token LF">
</span><span class="Token Program ID">sr0</span><span class="Token SPACE">     </span><span class="Token NUMBER">11</span><span class="Token COLON">:</span><span class="Token NUMBER">0</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token NUMBER">1024M</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token ID">rom</span></code></pre><p>这是因为文件系统的信息还没有更新, 查看根目录的文件系统类型(默认是ext4)</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404-VM</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">df</span><span class="Token SPACE"> </span><span class="Token OPTION">-Th</span><span class="Token LF">
</span><span class="Token Program ID">Filesystem</span><span class="Token SPACE">     </span><span class="Token ID">Type</span><span class="Token SPACE">   </span><span class="Token ID">Size</span><span class="Token SPACE">  </span><span class="Token ID">Used</span><span class="Token SPACE"> </span><span class="Token ID">Avail</span><span class="Token SPACE"> </span><span class="Token ID">Use</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token ID">Mounted</span><span class="Token SPACE"> </span><span class="Token ID">on</span><span class="Token LF">
</span><span class="Token Program PATH">/dev/root</span><span class="Token SPACE">      </span><span class="Token ID">ext4</span><span class="Token SPACE">    </span><span class="Token NUMBER">20G</span><span class="Token SPACE">  </span><span class="Token NUMBER">8.2G</span><span class="Token SPACE">   </span><span class="Token NUMBER">11G</span><span class="Token SPACE">  </span><span class="Token NUMBER">45</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">          </span><span class="Token ID">tmpfs</span><span class="Token SPACE">   </span><span class="Token NUMBER">95G</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">95G</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/dev/shm</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">          </span><span class="Token ID">tmpfs</span><span class="Token SPACE">   </span><span class="Token NUMBER">38G</span><span class="Token SPACE">  </span><span class="Token NUMBER">892K</span><span class="Token SPACE">   </span><span class="Token NUMBER">38G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/run</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">          </span><span class="Token ID">tmpfs</span><span class="Token SPACE">  </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">  </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/run/lock</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">          </span><span class="Token ID">tmpfs</span><span class="Token SPACE">   </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">12K</span><span class="Token SPACE">   </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/run/user/1000</span></code></pre><p>重新更新文件系统信息</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">resize2fs</span><span class="Token SPACE"> </span><span class="Token PATH">/dev/sda2</span></code></pre><p>ext4 更新块信息后再次查看发现磁盘大小正常</p><pre class="language-shell"><code><span class="Token HOST_NAME">kamilu@ubuntu2404-VM</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">df</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token LF">
</span><span class="Token Program ID">Filesystem</span><span class="Token SPACE">      </span><span class="Token ID">Size</span><span class="Token SPACE">  </span><span class="Token ID">Used</span><span class="Token SPACE"> </span><span class="Token ID">Avail</span><span class="Token SPACE"> </span><span class="Token ID">Use</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token ID">Mounted</span><span class="Token SPACE"> </span><span class="Token ID">on</span><span class="Token LF">
</span><span class="Token Program PATH">/dev/root</span><span class="Token SPACE">        </span><span class="Token NUMBER">50G</span><span class="Token SPACE">  </span><span class="Token NUMBER">8.2G</span><span class="Token SPACE">   </span><span class="Token NUMBER">39G</span><span class="Token SPACE">  </span><span class="Token NUMBER">18</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">95G</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">   </span><span class="Token NUMBER">95G</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/dev/shm</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">38G</span><span class="Token SPACE">  </span><span class="Token NUMBER">892K</span><span class="Token SPACE">   </span><span class="Token NUMBER">38G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/run</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">           </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">  </span><span class="Token NUMBER">5.0M</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/run/lock</span><span class="Token LF">
</span><span class="Token Program ID">tmpfs</span><span class="Token SPACE">            </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">12K</span><span class="Token SPACE">   </span><span class="Token NUMBER">19G</span><span class="Token SPACE">   </span><span class="Token NUMBER">1</span><span class="Token MOD">%</span><span class="Token SPACE"> </span><span class="Token PATH">/run/user/1000</span></code></pre><h2 id="h2-9">参考</h2><ul><li><a href="https://ubuntu.com/server/docs/virtualisation-with-qemu" target="_blank">ubuntu virtualisation-with-qemu</a></li></ul><ul><li><a href="https://linux-tips.com/t/booting-from-an-iso-image-using-qemu/136" target="_blank">Booting from an ISO image using qemu</a></li></ul><ul><li><a href="https://stackoverflow.com/questions/17242403/linux-running-self-compiled-kernel-in-qemu-vfs-unable-to-mount-root-fs-on-unk" target="_blank">linux running self compiled kernel in qemu vfs unable to mount root fs on unk</a></li></ul><ul><li><a href="https://serverfault.com/questions/471719/how-to-start-qemu-directly-in-the-console-not-in-curses-or-sdl" target="_blank">serverfault how-to-start-qemu-directly-in-the-console-not-in-curses-or-sdl</a></li></ul><ul><li><a href="https://web.archive.org/web/20180104171638/http://nairobi-embedded.org/qemu_monitor_console.html" target="_blank">QEMU Human Monitor Interface</a></li></ul><ul><li><a href="https://tech.joellemena.com/ubuntu/ubuntu-22-04-mini-iso/" target="_blank">Ubuntu 22.04 Mini Iso</a></li></ul><ul><li><a href="https://askubuntu.com/questions/1233746/download-ubuntu-minimal-iso-20-04lts" target="_blank">askubuntu download-ubuntu-minimal-iso-20-04lts</a></li></ul><ul><li><a href="https://www.bilibili.com/video/BV1Yz421S7vK/" target="_blank">18-Linux 操作系统 (initramfs; 最小 Linux 世界) [南京大学2024操作系统]</a></li></ul><ul><li><a href="https://zhou-yuxin.github.io/articles/2018/%E5%AE%89%E8%A3%85qemu-kvm%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C/index.html" target="_blank">安装qemu-kvm以及配置桥接网络</a></li></ul><ul><li><a href="https://vaaandark.top/en/posts/linux-startup/" target="_blank">vaaandark linux-startup</a></li></ul></div>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var markdownBody = document.querySelector('.markdown-body');
                    var giscusDiv = markdownBody.querySelector('.giscus');
                    var referenceHtml = `<div class="references-tabs-container">
<div class="references-tabs-nav">
<button class="references-tab-btn active" data-tab="references-out">本文引用</button>
</div>
<div class="references-tabs-content">
<div class="references-tab-pane active" id="references-out">
<ul class="reference-list">
<li><a href="../../tutorial/调试内核">📄 调试内核</a></li>
</ul>
</div>
</div>
</div>`;
                    
                    if (giscusDiv) {
                        giscusDiv.insertAdjacentHTML('beforebegin', referenceHtml);
                    } else {
                        markdownBody.insertAdjacentHTML('beforeend', referenceHtml);
                    }
                    
                    // 添加选项卡切换功能
                    setTimeout(function() {
                        var tabButtons = document.querySelectorAll('.references-tab-btn');
                        var tabPanes = document.querySelectorAll('.references-tab-pane');
                        
                        tabButtons.forEach(function(button) {
                            button.addEventListener('click', function() {
                                var targetTab = this.getAttribute('data-tab');
                                
                                // 移除所有active类
                                tabButtons.forEach(btn => btn.classList.remove('active'));
                                tabPanes.forEach(pane => pane.classList.remove('active'));
                                
                                // 添加active类到当前选中的选项卡
                                this.classList.add('active');
                                var targetPane = document.getElementById(targetTab);
                                if (targetPane) {
                                    targetPane.classList.add('active');
                                }
                            });
                        });
                    }, 100);
                });
                </script>
                
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../tutorial/编译内核" >tutorial</a><ul><li><a href="../../tutorial/编译内核" >编译内核</a></li></ul><ul><li><a href="../../tutorial/调试内核" >调试内核</a></li></ul><ul><li><a href="../../tutorial/开发环境搭建" >开发环境搭建</a></li></ul><ul><li><a href="../../tutorial/调试技巧" >调试技巧</a></li></ul><ul><li><a href="../../tutorial/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../tutorial/邮件订阅" >邮件订阅</a></li></ul><ul><li><a href="../../tutorial/git" >git</a></li></ul><ul><li><a href="../../tutorial/打包发布库" >打包发布库</a></li></ul></li></ul><ul><li><a href="../../mm/物理内存探测" >mm</a><ul><li><a href="../../mm/物理内存探测" >物理内存探测</a></li></ul><ul><li><a href="../../mm/虚拟地址转换" >虚拟地址转换</a></li></ul><ul><li><a href="../../mm/进程内存布局" >进程内存布局</a></li></ul><ul><li><a href="../../mm/页表" >页表</a></li></ul><ul><li><a href="../../mm/numa" >numa</a></li></ul><ul><li><a href="../../mm/vma" >vma</a></li></ul><ul><li><a href="../../mm/zone" >zone</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab" >slab</a></li></ul><ul><li><a href="../../mm/compaction" >compaction</a></li></ul><ul><li><a href="../../mm/tier-mm" >tier-mm</a></li></ul><ul><li><a href="../../mm/migration" >migration</a></li></ul><ul><li><a href="../../mm/mm_struct" >mm_struct</a></li></ul><ul><li><a href="../../mm/mmio" >mmio</a></li></ul><ul><li><a href="../../mm/LRU" >LRU</a></li></ul><ul><li><a href="../../mm/MGLRU" >MGLRU</a></li></ul><ul><li><a href="../../mm/page" >page</a></li></ul><ul><li><a href="../../mm/folio" >folio</a></li></ul><ul><li><a href="../../mm/autonuma" >autonuma</a></li></ul><ul><li><a href="../../mm/kswapd" >kswapd</a></li></ul><ul><li><a href="../../mm/rmap" >rmap</a></li></ul><ul><li><a href="../../mm/ksm" >ksm</a></li></ul><ul><li><a href="../../mm/shared-memory" >shared-memory</a></li></ul></li></ul><ul><li><a href="../../runtime/ELF文件格式" >runtime</a><ul><li><a href="../../runtime/ELF文件格式" >ELF文件格式</a></li></ul><ul><li><a href="../../runtime/符号表" >符号表</a></li></ul><ul><li><a href="../../runtime/静态链接" >静态链接</a></li></ul><ul><li><a href="../../runtime/装载" >装载</a></li></ul><ul><li><a href="../../runtime/动态链接" >动态链接</a></li></ul><ul><li><a href="../../runtime/库与运行库" >库与运行库</a></li></ul><ul><li><a href="../../runtime/execve" >execve</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul><ul><li><a href="../../runtime/ipc" >ipc</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul><ul><li><a href="../../kernel/schedule" >schedule</a></li></ul><ul><li><a href="../../kernel/atomic" >atomic</a></li></ul><ul><li><a href="../../kernel/nice" >nice</a></li></ul><ul><li><a href="../../kernel/rcu" >rcu</a></li></ul><ul><li><a href="../../kernel/manage" >manage</a></li></ul><ul><li><a href="../../kernel/workqueue" >workqueue</a></li></ul><ul><li><a href="../../kernel/signal" >signal</a></li></ul><ul><li><a href="../../kernel/lock" >lock</a></li></ul><ul><li><a href="../../kernel/cgroup" >cgroup</a></li></ul><ul><li><a href="../../kernel/syscall" >syscall</a></li></ul><ul><li><a href="../../kernel/task_struct" >task_struct</a></li></ul><ul><li><a href="../../kernel/sync_io" >sync_io</a></li></ul><ul><li><a href="../../kernel/rb-tree" >rb-tree</a></li></ul><ul><li><a href="../../kernel/async_io" >async_io</a></li></ul><ul><li><a href="../../kernel/fork" >fork</a></li></ul><ul><li><a href="../../kernel/module" >module</a></li></ul><ul><li><a href="../../kernel/lock_stat" >lock_stat</a></li></ul><ul><li><a href="../../kernel/kallsyms" >kallsyms</a></li></ul><ul><li><a href="../../kernel/list" >list</a></li></ul><ul><li><a href="../../kernel/per-cpu" >per-cpu</a></li></ul><ul><li><a href="../../kernel/pipe" >pipe</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cache-coherence" >cache-coherence</a></li></ul><ul><li><a href="../../arch/memory-coherence" >memory-coherence</a></li></ul><ul><li><a href="../../arch/io" >io</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/interrupt" >interrupt</a></li></ul><ul><li><a href="../../arch/dram" >dram</a></li></ul><ul><li><a href="../../arch/nvm" >nvm</a></li></ul><ul><li><a href="../../arch/iommu" >iommu</a></li></ul></li></ul><ul><li><a href="../../net/net-arch" >net</a><ul><li><a href="../../net/net-arch" >net-arch</a></li></ul><ul><li><a href="../../net/ip" >ip</a></li></ul><ul><li><a href="../../net/route" >route</a></li></ul><ul><li><a href="../../net/udp" >udp</a></li></ul><ul><li><a href="../../net/tcp" >tcp</a></li></ul><ul><li><a href="../../net/tools" >tools</a></li></ul><ul><li><a href="../../net/quic" >quic</a></li></ul><ul><li><a href="../../net/rdma" >rdma</a></li></ul><ul><li><a href="../../net/socket" >socket</a></li></ul><ul><li><a href="../../net/epoll" >epoll</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul><ul><li><a href="../../fs/filesystem" >filesystem</a></li></ul><ul><li><a href="../../fs/fd" >fd</a></li></ul><ul><li><a href="../../fs/inode" >inode</a></li></ul><ul><li><a href="../../fs/directory" >directory</a></li></ul><ul><li><a href="../../fs/disk-layout" >disk-layout</a></li></ul><ul><li><a href="../../fs/mount" >mount</a></li></ul><ul><li><a href="../../fs/vfs" >vfs</a></li></ul><ul><li><a href="../../fs/ext4" >ext4</a></li></ul><ul><li><a href="../../fs/fuse" >fuse</a></li></ul><ul><li><a href="../../fs/distribute-fs" >distribute-fs</a></li></ul></li></ul><ul><li><a href="../../device/disk" >device</a><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul><ul><li><a href="../../device/driver" >driver</a></li></ul><ul><li><a href="../../device/pcie" >pcie</a></li></ul></li></ul><ul><li><a href="../../cve/dirtycow" >cve</a><ul><li><a href="../../cve/dirtycow" >dirtycow</a></li></ul><ul><li><a href="../../cve/dirtypipe" >dirtypipe</a></li></ul><ul><li><a href="../../cve/sudo" >sudo</a></li></ul><ul><li><a href="../../cve/meltdown" >meltdown</a></li></ul><ul><li><a href="../../cve/smashex" >smashex</a></li></ul></li></ul><ul><li><a href="../../tools/perf" >tools</a><ul><li><a href="../../tools/perf" >perf</a></li></ul><ul><li><a href="../../tools/fault-injection" >fault-injection</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../tutorial/调试内核","../../tutorial/调试技巧","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/clipboard.svg","../../../img/clipboard-check.svg");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script>
            <script src="https://giscus.app/client.js" data-repo="luzhixing12345/klinux" 
            data-repo-id="R_kgDOJIKiEw" data-category="Q&A" data-category-id="DIC_kwDOJIKiE84CgFwK" data-mapping="pathname" data-strict="0"
            data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom"
            data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
            </script>
            <script type="text/javascript" src="../../../js/dir_tree_toggle.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>