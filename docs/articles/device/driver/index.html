<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css /><link rel='stylesheet' href=../../../css/x86asm.css /><link rel='stylesheet' href=../../../css/yaml.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/klinux.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">驱动程序</a><ul><li><a href="#h2-1">驱动层设计</a></li></ul><ul><li><a href="#h2-2">设备驱动程序</a></li></ul><ul><li><a href="#h2-3">一切皆文件的问题</a></li></ul><ul><li><a href="#h2-4">Linux 设备驱动</a></li></ul><ul><li><a href="#h2-5">内核模块(LKM)</a><ul><li><a href="#h3-6">简单的模块</a></li></ul></li></ul><ul><li><a href="#h2-7">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">驱动程序</h1><p>输入输出(I/O)设备模型本质上是由许多寄存器构成的.同样地,我们可以将内存,如DDR,视为由大量寄存器组成的.当我们执行物理内存的读写操作,比如访问0x123456这个地址时,实际上是从内存管理器(MMU)的寄存器中读取或写入数据, 这个过程可以简化为从寄存器中获取数据并发送给中央处理器(CPU),或者将数据从CPU写入寄存器.</p><p>因此,I/O设备在操作方式上与内存非常相似.自然而然地,我们会将I/O设备抽象为具有控制寄存器(包括命令寄存器command和数据寄存器data)的计算器.一旦这些设备被<b>映射到与CPU相同的地址空间</b>,CPU就可以使用load和store指令直接访问这些设备.例如,CPU可以查询设备是否准备就绪,如果设备ready,就可以将字节写入设备.</p><p>设备驱动程序是一种特殊的软件,它充当操作系统和硬件设备之间的桥梁.它的主要功能是将操作系统发出的通用指令翻译成特定硬件设备能够理解和执行的命令.这样,操作系统就能够控制和管理各种硬件设备,而不需要为每一种硬件都编写特定的控制代码.</p><h2 id="h2-1">驱动层设计</h2><p>为了使软件能够访问I/O设备,我们可以考虑将控制寄存器直接暴露给应用程序.理论上,操作系统可以提供一个系统调用,比如说 <code>dev_write</code>, 它可以允许应用程序直接发送命令给设备.</p><pre class="language-c"><code><span class="Token Identifier PrimaryExpression FunctionCall ID">dev_write</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">reg</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">data</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span></code></pre><p>然而这种直接的控制方式并不是最佳实践,尤其是在操作系统需要有效管理资源并确保应用程序顺畅使用这些资源的情况下.</p><p>操作系统的目标之一是<b>确保应用程序在使用资源时不会相互干扰</b>.例如,应用程序在使用CPU时,应该感觉不到自己被中断或抢占.它们应该感觉自己独占CPU,持续不断地执行指令.同样地,内存的虚拟化技术让每个进程都拥有自己的地址空间,其中包含了可读、可写、可执行的区域,而无需关心物理内存的具体布局.</p><p>因此,操作系统在管理I/O设备时,<b>不应该简单地将底层设备寄存器暴露给程序, 更好的方法是将设备抽象成操作系统中的对象</b>.例如,字符终端可以被视为操作系统的一个对象,磁盘也是如此.这样,应用程序在访问设备时,可以使用统一的接口,而无需关心底层的具体实现.</p><p>对于I/O设备,其核心功能通常可以归结为输入(input)和输出(output).例如,打印机接收打印任务并输出打印内容,字符终端允许用户输入数据并输出显示信息,而磁盘则作为一个巨大的字节数组,支持数据的读取和写入.因此,操作系统为I/O设备定义的基本操作也主要围绕这两个功能展开.在Linux等操作系统中,最基本的I/O操作是read和write.这两个操作允许应用程序从设备读取数据(read)或向设备写入数据(write).这些操作通常可以指定一个偏移量,以便在设备上的正确位置进行数据的读取或写入.</p><pre class="language-c"><code><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">ssize_t</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">read</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">fd</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">buf</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">size_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">count</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">ssize_t</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">write</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">fd</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">buf</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">size_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">count</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>我们可以得到两类 IO 设备的抽象: <b>字节流</b>(byte stream)类型的, 例如终端, 网络套接字; <b>字节数组</b>(byte array), 例如磁盘</p><p>除了基本的读写操作,I/O设备还可能需要一些控制功能.例如,我们可能需要查询设备的状态、配置设备的工作模式或获取设备的特定信息.为了实现这些控制功能,操作系统提供了I/O控制(I/O control)操作.通过I/O控制操作,应用程序可以发送特定的控制命令给设备,或者查询设备的状态和参数.</p><pre class="language-c"><code><span class="Token COMMENT">// 读取/设置设备的状态</span><span class="Token LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">ioctl</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">fd</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">request</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>在操作系统中,设备被抽象为文件系统中的一个<b>对象</b>,这意味着我们可以使用文件描述符(fd)来引用和操作设备.文件描述符本质上是一个指针,指向操作系统中的特定对象,允许我们对其进行各种操作.这些操作与文件操作类似,因为操作系统遵循&quot;<b>一切皆文件</b>&quot;(everything is a file)的原则.read和write操作允许我们从设备读取数据或向设备发送数据,而I/O control操作则用于执行对设备的特定控制任务,例如查询设备状态或修改设备配置.</p><h2 id="h2-2">设备驱动程序</h2><p>设备驱动程序是计算机系统中的一个重要组成部分,它起着桥梁的作用,连接操作系统和硬件设备.当我们将一个新的硬件设备接入电脑时,设备可能无法立即正常工作,特别是对于一些功能复杂的设备,如显卡.这是因为操作系统可能没有内置与该设备完全兼容的驱动程序.</p><blockquote><p>在这种情况下,操作系统会尝试自动搜索并安装适合该硬件的驱动程序.例如,在Windows系统中,当我们插入一块显卡,系统会自动在互联网上寻找相应的驱动程序, 或者前往 NVIDIA 官网下载对应的驱动安装程序, 一旦驱动程序安装完成,显卡的性能会得到显著提升,例如,从低分辨率显示升级到高清分辨率显示.</p></blockquote><p>设备驱动程序是一段特殊的代码,由设备制造商提供,它详细定义了设备中每个寄存器的功能和如何操作这些寄存器.驱动程序的作用是<b>将操作系统发出的通用命令,如read、write和I/O control,翻译成硬件设备能够理解的特定操作</b>.这就像是设备和操作系统之间的翻译者.例如,当我们执行一个read操作时,设备驱动程序会根据设备的技术规范,将这个操作转换为对控制寄存器的特定设置,然后等待状态寄存器的某个位变化,以确定可以进行数据读取.这个过程是按照设备制造商设定的协议进行的.</p><p>在Linux系统中,设备驱动程序的概念尤为明显.系统中存在一个名为<code>/dev</code>的目录,其中包含了许多设备文件.这些设备文件代表了系统中的各种硬件设备,通过这些设备文件,应用程序可以进行I/O操作.设备驱动程序负责处理对这些设备文件的操作请求,并将其转换为实际的硬件操作.</p><p>在操作系统中,遵循&quot;一切皆文件&quot;(everything is a file)的原则,<b>设备也被当作文件来处理</b>.通过<code>ls -l /dev</code>命令,我们可以查看系统中的设备文件.设备文件主要分为两种类型:<b>字符设备</b>(character device)和<b>块设备</b>(block device).</p><ul><li>字符设备是以字节流的形式进行数据传输的设备.例如,键盘和鼠标都是字符设备,它们以字符为单位与系统交互.在<code>/dev</code>目录下,字符设备文件以字母&#x27;c&#x27;开头,表示它们是按字符进行操作的.</li></ul><ul><li>块设备则以数据块为单位进行数据传输,通常用于存储设备,如硬盘和SSD.在<code>/dev</code>目录下,块设备文件以字母&#x27;b&#x27;开头,表示它们按块进行操作.</li></ul><p>在Linux系统中,<code>/dev</code>目录包含了许多虚拟设备文件,这些文件代表了系统中的各种硬件设备和特殊文件,如<code>stdin</code>、<code>stdout</code>和<code>stderr</code>,分别代表标准输入、标准输出和标准错误输出.这些设备允许进程与终端进行交互.例如,我们可以通过<code>/dev/stderr</code>将错误信息重定向到其他地方</p><ol start="1"><li><b><code>/dev/null</code></b>: 这是一个特殊的文件,它丢弃所有写入其中的数据,同时返回写入操作成功完成的信号.它经常用于丢弃不需要的输出,例如:<code>command &gt; /dev/null</code>.</li></ol><ol start="2"><li><b><code>/dev/zero</code></b>: 这个设备文件提供了一个无尽的零字节流.读取<code>/dev/zero</code>会返回连续的零字节,这在需要生成大量零字节数据时非常有用.</li></ol><ol start="3"><li><b><code>/dev/random</code> 和 <code>/dev/urandom</code></b>: 这两个设备文件用于生成随机数.<code>/dev/random</code>提供高质量的随机数,它会等待收集足够的熵来生成随机数,而<code>/dev/urandom</code>则提供不那么高质量但速度更快的随机数.</li></ol><ol start="4"><li><b><code>/dev/tty</code></b>: 这个设备文件代表当前终端会话.它可以用来读取或写入当前终端的输入输出.</li></ol><ol start="5"><li><b><code>/dev/stdin</code>、<code>/dev/stdout</code> 和 <code>/dev/stderr</code></b>: 这些设备文件分别代表标准输入、标准输出和标准错误流.它们允许程序直接与这些流交互.</li></ol><ol start="6"><li><b><code>/dev/ptmx</code></b>: 这是一个伪终端主设备文件,用于创建伪终端对,允许非特权用户模拟终端会话.</li></ol><ol start="7"><li><b><code>/dev/full</code></b>: 当系统内存不足,无法创建新文件时,写入这个设备会使得写操作等待,直到有足够的空间.</li></ol><ol start="8"><li>*<i>`/dev/loop</i>`**: 这些设备文件代表循环设备,它们允许将文件作为块设备进行挂载.</li></ol><ol start="9"><li><i><i>`/dev/sda</i><code>、</code>/dev/sdb<i>` 等</i></i>: 这些是块设备的设备文件,代表系统中的硬盘和分区.例如,<code>/dev/sda1</code> 可能代表第一个硬盘的第一个分区.</li></ol><ol start="10"><li>*<i>`/dev/ttyS</i>`**: 这些是串行端口设备文件,用于串行通信.</li></ol><ol start="11"><li>*<i>`/dev/fb</i>`**: 这些设备文件代表帧缓冲设备,用于直接操作显示设备.</li></ol><p>这些虚拟设备文件是Linux系统中的重要组成部分,它们提供了与硬件设备交互的标准化接口,简化了硬件访问和管理工作,同时也为用户和开发者提供了丰富的操作选项.通过这些设备文件,Linux系统能够灵活地处理各种输入输出任务.</p><h2 id="h2-3">一切皆文件的问题</h2><p>设备驱动程序在概念上是简单的,其基本职责是实现数据的读取和写入.无论是高性能的NVMe磁盘还是日常使用的键盘和鼠标,它们都通过驱动程序来进行数据的输入输出.然而,实际的设备驱动程序开发远比这复杂得多.</p><p>现代的硬件设备通常不仅仅提供基本的读写功能,它们还具备各种高级特性和配置选项.例如,现代键盘可能带有背光灯效、多媒体控制键、宏命令键等.这些高级功能需要设备驱动程序来支持和控制.对于键盘的背光灯效,驱动程序需要实现特定的I/O控制操作来管理这些灯光的显示效果.打印机的打印质量/进纸/双面控制、卡纸、清洁、自动装订; 磁盘的健康状况、缓存控制 ...</p><p>所有和设备控制相关的功能都会集中到 <code>ioctl</code> 中, 每个设备有它自己的 ioctl, 设备驱动程序的复杂性来源于它需要支持设备的所有功能,包括基本的读写操作和高级的配置管理.Linux系统的设计哲学&quot;一切皆文件&quot;<b>将这些复杂性隐藏在文件系统之后</b>,使得开发者和用户可以通过标准的文件操作接口来与设备交互.<b>这种设计虽然在概念上简洁优雅,但实际上增加了文件系统和驱动程序的实现复杂度</b>.每个设备的独特功能和行为都需要在驱动程序中得到妥善处理,以确保系统的稳定性和可用性.</p><p>水面下有冰山</p><h2 id="h2-4">Linux 设备驱动</h2><p>编写设备驱动程序在Linux操作系统中是一个涉及创建操作系统对象的过程,这个对象支持标准的文件操作,如read、write和ioctl(input, output, control).这些操作使得设备能够与操作系统以及其他程序进行交互.设备驱动程序的核心是实现一组称为 <code>file operations</code>的结构体,该结构体定义了设备如何响应文件系统API的调用.</p><pre class="language-c"><code><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">file_operations</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">module</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">owner</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">loff_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">llseek</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">loff_t</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">ssize_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">read</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">__user</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">size_t</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">loff_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">ssize_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">write</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword QualifyType TypeSpecifier CONST">const</span><span class="Token Keyword QualifyType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token MacroDefine MacroDefine Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">__user</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">size_t</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">loff_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">ssize_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">read_iter</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">kiocb</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">iov_iter</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">ssize_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">write_iter</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">kiocb</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">iov_iter</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">iopoll</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">kiocb</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">kiocb</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier BOOL">bool</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">spin</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">iterate</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">dir_context</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">iterate_shared</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">dir_context</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">__poll_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">poll</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">poll_table_struct</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">unlocked_ioctl</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">compat_ioctl</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">mmap</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">vm_area_struct</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">mmap_supported_flags</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">open</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">inode</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">flush</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">fl_owner_t</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">id</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">release</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">inode</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">fsync</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">loff_t</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">loff_t</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">datasync</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">fasync</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP TypeSpecifier ID">lock</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">file_lock</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token DirectDeclaractor Declarator BraceDepth-1 RPAREN">)</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">// ...</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">__randomize_layout</span><span class="Token Declaration SEMI">;</span></code></pre><p>在Linux内核中,设备可以是物理的硬件组件,也可以是虚拟的软件构造.无论是物理设备还是虚拟设备,它们都可以通过file operations来定义其行为.例如,一个虚拟设备可能没有实际的硬件对应物,但它可以提供特定的服务或功能,如网络接口或伪终端.</p><p>因此如果想要编写一个内核模块来创建一个新的虚拟设备,只需要定义这个模块的file operations,并在其中指定如何处理对该设备的读写请求和控制请求, <b>完成函数实现并将其绑定到结构体的函数指针</b>. 这样的内核模块被加载到操作系统中,你的虚拟设备就会像任何其他文件一样出现在文件系统中,可以被应用程序通过标准的文件操作API进行访问.</p><blockquote><p>细心的同学可能会看到有两个 ioctl</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP ID">unlocked_ioctl</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP ID">compat_ioctl</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">file</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier LONG">long</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>unlocked_ioctl: BKL (Big Kernel Lock) 时代的遗产</p><ul><li>单处理器时代只有 ioctl</li></ul><ul><li>之后引入了 BKL, ioctl 执行时默认持有 BKL</li></ul><ul><li>(2.6.11) 高性能的驱动可以通过 unlocked_ioctl 避免锁</li></ul><ul><li>(2.6.36) ioctl 从 struct file_operations 中移除</li></ul><p>compact_ioctl: 机器字长的兼容性</p><ul><li>32-bit 程序在 64-bit 系统上可以 ioctl</li></ul><ul><li>此时应用程序和操作系统对 ioctl 数据结构的解读可能不同 (tty)</li></ul><p>简单来说新开发的设备驱动程序通常推荐使用 <code>compact_ioctl</code> 函数来代替 <code>unlocked_ioctl</code> 函数.</p></blockquote><h2 id="h2-5">内核模块(LKM)</h2><p>Linux内核模块(Kernel Module)是指可以动态加载到Linux操作系统内核中的独立代码片段.这些模块允许操作系统在<b>不重新编译内核的情况下扩展和更新功能</b>,使内核更加灵活和可扩展.</p><blockquote><p>从这一点上来说其实已经模糊了微内核和宏内核的概念</p></blockquote><p>LKM同样是ELF格式文件,但是其不能够独立运行,而只能作为内核的一部分存在; 同样的,对于LKM而言,其所处在的<b>内核空间与用户空间是分开的</b>,对于通常有着SMAP/SMEP保护的Linux而言,这意味着<b>LKM并不能够使用libc中的函数,也不能够直接与用户进行交互</b></p><blockquote><p>SMAP(Supervisor Mode Access Prevention)和 SMEP(Supervisor Mode Execution Prevention)是现代CPU(特别是x86架构)提供的两种安全特性,旨在防止内核代码<b>执行用户空间的代码</b> 和 <b>访问用户空间数据</b>.</p><p>当SMEP启用时,如果内核代码尝试执行用户空间的代码,CPU会触发一个异常(通常是页错误),从而阻止攻击者利用某些漏洞进行攻击. 当SMAP启用时,如果内核代码尝试直接访问用户空间的内存数据,CPU会触发一个异常.内核可以临时禁用SMAP以允许合法访问用户空间数据,但需要显式地使用内核指令(如<code>stac</code>和<code>clac</code>)进行控制.</p><p>SMAP/SMEP 通常在现代操作系统中默认启用.可以通过检查CPU特性来确认支持情况. 在Linux中,可以使用以下命令检查SMEP的支持情况:</p><pre class="language-shell"><code><span class="Token Program ID">dmesg</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">grep</span><span class="Token SPACE"> </span><span class="Token OPTION">-i</span><span class="Token SPACE"> </span><span class="Token ID">smep</span><span class="Token LF">
</span><span class="Token Program ID">dmesg</span><span class="Token SPACE"> </span><span class="Token PIPE">|</span><span class="Token SPACE"> </span><span class="Token Program ID">grep</span><span class="Token SPACE"> </span><span class="Token OPTION">-i</span><span class="Token SPACE"> </span><span class="Token ID">smap</span></code></pre></blockquote><p>虽然我们同样能够使用C语言编写LKM,但是作为内核的一部分,LKM编程在一定意义上便是内核编程, 内核版本的每次变化意味着某些函数名也会相应地发生变化,因此LKM编程与内核版本密切相关</p><h3 id="h3-6">简单的模块</h3><p>我们来编写这样一个简单的内核模块,其功能是在载入/卸载时会在内核缓冲区打印字符串:</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">linux/module.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">linux/kernel.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">linux/init.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">__init</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">kernel_module_init</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printk</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;&lt;1&gt;Hello the Linux kernel world!</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token MacroDefine Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">__exit</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">kernel_module_exit</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printk</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;&lt;1&gt;Good bye the Linux kernel world! See you again!</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Identifier PrimaryExpression FunctionCall ID">module_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier FunctionName PrimaryExpression ID">kernel_module_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token Identifier PrimaryExpression FunctionCall ID">module_exit</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier FunctionName PrimaryExpression ID">kernel_module_exit</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token Identifier MacroDefine PrimaryExpression ID">MODULE_LICENSE</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;GPL&quot;</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token Identifier MacroDefine PrimaryExpression ID">MODULE_AUTHOR</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;kkk&quot;</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span></code></pre><p><b>头文件</b></p><ul><li><code>linux/module.h</code>:对于LKM而言这是必须包含的一个头文件</li></ul><ul><li><code>linux/kernel.h</code>:载入内核相关信息</li></ul><ul><li><code>linux/init.h</code>:包含着一些有用的宏</li></ul><p>通常情况下,这三个头文件对于内核模块编程都是不可或缺的</p><p><b>入口点/出口点</b></p><p>内核模块的初始化函数在编译时通过 <code>module_init()</code> 定义,在内核模块被载入时会调用所定义的函数,这里我们将初始化函数设定为 <code>kernel_module_init</code></p><p>内核模块的卸载函数在编译时通过 <code>module_exit()</code> 定义,在内核模块被卸载时会调用所定义的函数,这里我们将卸载函数定义为 <code>kernel_module_exit</code></p><p><b>其他…</b></p><ul><li><code>__init</code> 与 <code>__exit</code> 宏:用来显式标识内核模块出入口函数</li></ul><ul><li><code>MODULE_AUTHOR() &amp; MODULE_LICENSE()</code>:声明内核作者与发行所用许可证</li></ul><p>与一般的可执行文件所不同的是,我们应当使用 Makefile 来构建一个内核模块,并使用 Kbuild 说明编译规则</p><p>首先创建一个 <code>Kbuild</code> 文件,写入如下内容</p><pre class="language-txt"><code><span class="Token ID">MODULE_NAME</span><span class="Token SPACE"> </span><span class="Token QUESTION">?</span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token ID">hellokernel</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">obj</span><span class="Token MINUS">-</span><span class="Token ID">m</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">MODULE_NAME</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token DOT">.</span><span class="Token ID">o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token DOLLAR">$</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">MODULE_NAME</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token MINUS">-</span><span class="Token ID">y</span><span class="Token SPACE"> </span><span class="Token PLUS">+</span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token ID">main</span><span class="Token DOT">.</span><span class="Token ID">o</span></code></pre><h2 id="h2-7">参考</h2><ul><li><a href="https://arttnba3.cn/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II/" target="_blank">【OS.0x01】Linux Kernel II:内核简易食用指北 </a></li></ul><ul><li><a href="https://www.bilibili.com/video/BV1m24y1A7Fi/" target="_blank">设备驱动程序与文件系统 (Linux 设备驱动;目录管理 API) [南京大学2023操作系统-P27] (蒋炎岩)</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../tutorial/编译内核" >tutorial</a><ul><li><a href="../../tutorial/编译内核" >编译内核</a></li></ul><ul><li><a href="../../tutorial/调试内核" >调试内核</a></li></ul><ul><li><a href="../../tutorial/开发环境搭建" >开发环境搭建</a></li></ul><ul><li><a href="../../tutorial/调试技巧" >调试技巧</a></li></ul><ul><li><a href="../../tutorial/制作linux发行版" >制作linux发行版</a></li></ul><ul><li><a href="../../tutorial/邮件订阅" >邮件订阅</a></li></ul><ul><li><a href="../../tutorial/git" >git</a></li></ul><ul><li><a href="../../tutorial/打包发布库" >打包发布库</a></li></ul></li></ul><ul><li><a href="../../mm/物理内存探测" >mm</a><ul><li><a href="../../mm/物理内存探测" >物理内存探测</a></li></ul><ul><li><a href="../../mm/虚拟地址转换" >虚拟地址转换</a></li></ul><ul><li><a href="../../mm/进程内存布局" >进程内存布局</a></li></ul><ul><li><a href="../../mm/页表" >页表</a></li></ul><ul><li><a href="../../mm/numa" >numa</a></li></ul><ul><li><a href="../../mm/vma" >vma</a></li></ul><ul><li><a href="../../mm/zone" >zone</a></li></ul><ul><li><a href="../../mm/buddy" >buddy</a></li></ul><ul><li><a href="../../mm/slab" >slab</a></li></ul><ul><li><a href="../../mm/compaction" >compaction</a></li></ul><ul><li><a href="../../mm/tier-mm" >tier-mm</a></li></ul><ul><li><a href="../../mm/migration" >migration</a></li></ul><ul><li><a href="../../mm/mm_struct" >mm_struct</a></li></ul><ul><li><a href="../../mm/mmio" >mmio</a></li></ul><ul><li><a href="../../mm/LRU" >LRU</a></li></ul><ul><li><a href="../../mm/MGLRU" >MGLRU</a></li></ul><ul><li><a href="../../mm/page" >page</a></li></ul><ul><li><a href="../../mm/folio" >folio</a></li></ul><ul><li><a href="../../mm/autonuma" >autonuma</a></li></ul><ul><li><a href="../../mm/kswapd" >kswapd</a></li></ul><ul><li><a href="../../mm/rmap" >rmap</a></li></ul><ul><li><a href="../../mm/ksm" >ksm</a></li></ul><ul><li><a href="../../mm/shared-memory" >shared-memory</a></li></ul></li></ul><ul><li><a href="../../runtime/ELF文件格式" >runtime</a><ul><li><a href="../../runtime/ELF文件格式" >ELF文件格式</a></li></ul><ul><li><a href="../../runtime/符号表" >符号表</a></li></ul><ul><li><a href="../../runtime/静态链接" >静态链接</a></li></ul><ul><li><a href="../../runtime/装载" >装载</a></li></ul><ul><li><a href="../../runtime/动态链接" >动态链接</a></li></ul><ul><li><a href="../../runtime/库与运行库" >库与运行库</a></li></ul><ul><li><a href="../../runtime/execve" >execve</a></li></ul><ul><li><a href="../../runtime/vsdo" >vsdo</a></li></ul><ul><li><a href="../../runtime/ipc" >ipc</a></li></ul></li></ul><ul><li><a href="../../kernel/init" >kernel</a><ul><li><a href="../../kernel/init" >init</a></li></ul><ul><li><a href="../../kernel/schedule" >schedule</a></li></ul><ul><li><a href="../../kernel/atomic" >atomic</a></li></ul><ul><li><a href="../../kernel/nice" >nice</a></li></ul><ul><li><a href="../../kernel/rcu" >rcu</a></li></ul><ul><li><a href="../../kernel/manage" >manage</a></li></ul><ul><li><a href="../../kernel/workqueue" >workqueue</a></li></ul><ul><li><a href="../../kernel/signal" >signal</a></li></ul><ul><li><a href="../../kernel/lock" >lock</a></li></ul><ul><li><a href="../../kernel/cgroup" >cgroup</a></li></ul><ul><li><a href="../../kernel/syscall" >syscall</a></li></ul><ul><li><a href="../../kernel/task_struct" >task_struct</a></li></ul><ul><li><a href="../../kernel/sync_io" >sync_io</a></li></ul><ul><li><a href="../../kernel/rb-tree" >rb-tree</a></li></ul><ul><li><a href="../../kernel/async_io" >async_io</a></li></ul><ul><li><a href="../../kernel/fork" >fork</a></li></ul><ul><li><a href="../../kernel/module" >module</a></li></ul><ul><li><a href="../../kernel/lock_stat" >lock_stat</a></li></ul><ul><li><a href="../../kernel/kallsyms" >kallsyms</a></li></ul><ul><li><a href="../../kernel/list" >list</a></li></ul><ul><li><a href="../../kernel/per-cpu" >per-cpu</a></li></ul><ul><li><a href="../../kernel/pipe" >pipe</a></li></ul></li></ul><ul><li><a href="../../arch/cpu" >arch</a><ul><li><a href="../../arch/cpu" >cpu</a></li></ul><ul><li><a href="../../arch/cache" >cache</a></li></ul><ul><li><a href="../../arch/multicore" >multicore</a></li></ul><ul><li><a href="../../arch/cache-coherence" >cache-coherence</a></li></ul><ul><li><a href="../../arch/memory-coherence" >memory-coherence</a></li></ul><ul><li><a href="../../arch/io" >io</a></li></ul><ul><li><a href="../../arch/bus" >bus</a></li></ul><ul><li><a href="../../arch/interrupt" >interrupt</a></li></ul><ul><li><a href="../../arch/dram" >dram</a></li></ul><ul><li><a href="../../arch/nvm" >nvm</a></li></ul><ul><li><a href="../../arch/iommu" >iommu</a></li></ul></li></ul><ul><li><a href="../../net/net-arch" >net</a><ul><li><a href="../../net/net-arch" >net-arch</a></li></ul><ul><li><a href="../../net/ip" >ip</a></li></ul><ul><li><a href="../../net/route" >route</a></li></ul><ul><li><a href="../../net/udp" >udp</a></li></ul><ul><li><a href="../../net/tcp" >tcp</a></li></ul><ul><li><a href="../../net/tools" >tools</a></li></ul><ul><li><a href="../../net/quic" >quic</a></li></ul><ul><li><a href="../../net/rdma" >rdma</a></li></ul><ul><li><a href="../../net/socket" >socket</a></li></ul><ul><li><a href="../../net/epoll" >epoll</a></li></ul></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul><ul><li><a href="../../fs/filesystem" >filesystem</a></li></ul><ul><li><a href="../../fs/fd" >fd</a></li></ul><ul><li><a href="../../fs/inode" >inode</a></li></ul><ul><li><a href="../../fs/directory" >directory</a></li></ul><ul><li><a href="../../fs/disk-layout" >disk-layout</a></li></ul><ul><li><a href="../../fs/mount" >mount</a></li></ul><ul><li><a href="../../fs/vfs" >vfs</a></li></ul><ul><li><a href="../../fs/ext4" >ext4</a></li></ul><ul><li><a href="../../fs/fuse" >fuse</a></li></ul><ul><li><a href="../../fs/distribute-fs" >distribute-fs</a></li></ul></li></ul><ul><li><a href="../../device/disk" >device</a><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul><ul><li><a href="../../device/driver" >driver</a></li></ul><ul><li><a href="../../device/pcie" >pcie</a></li></ul></li></ul><ul><li><a href="../../cve/dirtycow" >cve</a><ul><li><a href="../../cve/dirtycow" >dirtycow</a></li></ul><ul><li><a href="../../cve/dirtypipe" >dirtypipe</a></li></ul><ul><li><a href="../../cve/sudo" >sudo</a></li></ul><ul><li><a href="../../cve/meltdown" >meltdown</a></li></ul><ul><li><a href="../../cve/smashex" >smashex</a></li></ul></li></ul><ul><li><a href="../../tools/perf" >tools</a><ul><li><a href="../../tools/perf" >perf</a></li></ul><ul><li><a href="../../tools/fault-injection" >fault-injection</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../device/ssd","../../device/pcie","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/clipboard.svg","../../../img/clipboard-check.svg");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script>
            <script src="https://giscus.app/client.js" data-repo="luzhixing12345/klinux" 
            data-repo-id="R_kgDOJIKiEw" data-category="Q&A" data-category-id="DIC_kwDOJIKiE84CgFwK" data-mapping="pathname" data-strict="0"
            data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom"
            data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
            </script>
            <script type="text/javascript" src="../../../js/dir_tree_toggle.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>